<!-- =================== TESTER PAGE =================== -->
<div id="page-tester" class="page">
    <style>
        #page-tester .tester-container {
            background: var(--glass-bg, rgba(30, 41, 59, 0.7));
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border, rgba(255, 255, 255, 0.1));
            border-radius: 24px;
            padding: 40px;
            width: 100%;
            max-width: 900px;
            margin: 40px auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.5s ease-out;
            color: var(--text-main, #f8fafc);
        }

        #page-tester h1 {
            margin: 0 0 8px 0;
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(to right, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            /* standard property for compatibility */
        }

        #page-tester p.subtitle {
            margin: 0 0 32px 0;
            color: var(--text-muted, #94a3b8);
            font-size: 15px;
        }

        .models-list-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .models-list-table th,
        .models-list-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .models-list-table th {
            color: var(--text-muted, #94a3b8);
            font-weight: 500;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.05em;
        }

        .models-list-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .test-btn {
            background: var(--accent, #3b82f6);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .test-btn:hover {
            background: var(--accent-hover, #2563eb);
            transform: translateY(-1px);
        }

        .test-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        #tester-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        #tester-modal.visible {
            display: flex;
        }

        .tester-modal-content {
            background: #1e293b;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease-out;
            overflow: hidden;
        }

        .tester-modal-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tester-modal-header h2 {
            margin: 0;
            font-size: 20px;
            color: #f8fafc;
        }

        .tester-modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .tester-status-bar {
            padding: 16px 20px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .tb-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .tb-label {
            font-size: 11px;
            color: #94a3b8;
            text-transform: uppercase;
            font-weight: 600;
        }

        .tb-value {
            font-size: 14px;
            color: #f8fafc;
            font-weight: 500;
        }

        .pre-box {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 16px;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 13px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-all;
            margin-top: 16px;
            border-left: 3px solid #3b82f6;
        }

        .pre-box.error-box {
            border-left-color: #ef4444;
        }

        .pre-box.success-box {
            border-left-color: #10b981;
        }

        .loader-inline {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
    </style>

    <div class="tester-container">
        <h1>Gateway Model Tester</h1>
        <p class="subtitle">Validates models via the SoLoBot Cloud Gateway (exact same path as Chat)</p>

        <div id="tester-models-loading" style="padding: 20px; color: var(--text-muted); text-align:center;">
            Loading models from config...
        </div>

        <table class="models-list-table" id="tester-models-table" style="display:none;">
            <thead>
                <tr>
                    <th>Provider</th>
                    <th>Model ID</th>
                    <th>Name</th>
                    <th style="text-align:right;">Action</th>
                </tr>
            </thead>
            <tbody id="tester-models-tbody">
            </tbody>
        </table>
    </div>

    <!-- Modal for test results -->
    <div id="tester-modal">
        <div class="tester-modal-content">
            <div class="tester-modal-header">
                <h2 id="tm-title">Testing Model</h2>
                <button onclick="document.getElementById('tester-modal').classList.remove('visible')"
                    style="background:transparent; border:none; color:#f8fafc; cursor:pointer; font-size:24px;">&times;</button>
            </div>

            <div class="tester-status-bar" id="tm-status-bar" style="display:none;">
                <div class="tb-item">
                    <span class="tb-label">Status</span>
                    <span class="tb-value" id="tm-http-status">-</span>
                </div>
                <div class="tb-item">
                    <span class="tb-label">Latency</span>
                    <span class="tb-value" id="tm-latency">-</span>
                </div>
                <div class="tb-item" style="flex:1" id="tm-rl-reset-container">
                    <span class="tb-label">Rate Limit Resets In</span>
                    <span class="tb-value" id="tm-rl-reset" style="color:#ef4444;">-</span>
                </div>
            </div>

            <div class="tester-modal-body">
                <div id="tm-loading"
                    style="display:flex; align-items:center; gap:8px; justify-content:center; padding: 40px;">
                    <span class="loader-inline"></span>
                    <span>Waiting for response from provider...</span>
                </div>

                <div id="tm-results" style="display:none;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                        <div style="font-weight:600; font-size:14px; color:#f8fafc;">AI Response:</div>
                        <button onclick="document.getElementById('tester-modal').classList.remove('visible'); showPage('test-results');" 
                                style="background:var(--accent); color:white; border:none; border-radius:6px; padding:6px 12px; font-size:12px; cursor:pointer;">
                            ðŸ“Š View All Results
                        </button>
                    </div>
                    <div class="pre-box success-box" id="tm-response-text"></div>

                    <div style="font-weight:600; font-size:14px; color:#f8fafc; margin-top:24px; margin-bottom:8px;">Raw
                        HTTP Headers (Diagnostic):</div>
                    <div class="pre-box" id="tm-raw-headers" style="font-size:12px; border-left-color:#64748b;"></div>

                    <div style="font-weight:600; font-size:14px; color:#f8fafc; margin-top:24px; margin-bottom:8px;">Raw
                        JSON Response:</div>
                    <div class="pre-box" id="tm-raw-json" style="font-size:12px; border-left-color:#64748b;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let cachedTesterModelsList = [];

        async function initTesterPage() {
            document.getElementById('tester-models-loading').style.display = 'block';
            document.getElementById('tester-models-table').style.display = 'none';

            try {
                const res = await fetch('/api/tester/models');
                const providers = await res.json();

                const tbody = document.getElementById('tester-models-tbody');
                tbody.innerHTML = '';

                let hasModels = false;

                for (const providerId in providers) {
                    const providerModels = providers[providerId];
                    if (!Array.isArray(providerModels)) continue;

                    for (const model of providerModels) {
                        hasModels = true;
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td><span style="background:rgba(255,255,255,0.1); padding:4px 8px; border-radius:4px; font-size:12px; white-space:nowrap;">${providerId}</span></td>
                            <td style="font-family:monospace; color:#3b82f6;">${model.id}</td>
                            <td>${model.name || model.id}</td>
                            <td style="text-align:right;">
                                <button class="test-btn" onclick="runModelTest('${encodeURIComponent(providerId)}', '${encodeURIComponent(model.id)}')">Run Test</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    }
                }

                if (!hasModels) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">No models found in openclaw.json</td></tr>';
                }

                document.getElementById('tester-models-loading').style.display = 'none';
                document.getElementById('tester-models-table').style.display = 'table';

            } catch (e) {
                document.getElementById('tester-models-loading').textContent = 'Error loading models: ' + e.message;
            }
        }

        // Expose init function to the active page script mechanism
        window.initTesterRoutePage = initTesterPage;

        // Auto-run when the Tester page is shown
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.target.classList.contains('active') && mutation.target.id === 'page-tester') {
                    initTesterPage();
                }
            });
        });
        observer.observe(document.getElementById('page-tester'), { attributes: true, attributeFilter: ['class'] });

        // SIMPLIFIED TEST FUNCTION - Uses the EXACT same path as chat
        async function runModelTest(encodedProvider, encodedModelId) {
            const provider = decodeURIComponent(encodedProvider);
            const modelId = decodeURIComponent(encodedModelId);

            // UI Reset
            document.getElementById('tm-title').textContent = 'Testing: ' + modelId;
            document.getElementById('tester-modal').classList.add('visible');
            document.getElementById('tm-status-bar').style.display = 'none';
            document.getElementById('tm-loading').style.display = 'flex';
            document.getElementById('tm-results').style.display = 'none';

            const startTime = Date.now();
            
            try {
                // DEBUG: Log what we're working with
                console.log('[Tester] ===========================================');
                console.log('[Tester] Starting test for model:', modelId);
                console.log('[Tester] window.gateway exists:', !!window.gateway);
                console.log('[Tester] window.gateway.testModel exists:', window.gateway && typeof window.gateway.testModel);
                
                let resultData;
                let usedWebSocket = false;
                
                // ATTEMPT 1: Try WebSocket (same as chat)
                if (window.gateway && typeof window.gateway.testModel === 'function') {
                    console.log('[Tester] Attempting WebSocket test...');
                    try {
                        const wsResult = await window.gateway.testModel(modelId);
                        usedWebSocket = true;
                        const duration = Date.now() - startTime;
                        
                        console.log('[Tester] WebSocket SUCCESS:', wsResult);
                        
                        // Extract text content from various response formats
                        let responseText = '';
                        if (wsResult && wsResult.message && wsResult.message.content) {
                            const content = wsResult.message.content;
                            if (Array.isArray(content)) {
                                responseText = content.map(c => c.text || '').join('');
                            } else {
                                responseText = String(content);
                            }
                        } else if (typeof wsResult === 'string') {
                            responseText = wsResult;
                        } else {
                            responseText = JSON.stringify(wsResult, null, 2);
                        }
                        
                        resultData = {
                            status: 200,
                            statusText: 'OK (WebSocket)',
                            durationMs: duration,
                            headers: {
                                'X-Protocol': 'WebSocket',
                                'X-Session': window.gateway.sessionKey || 'unknown'
                            },
                            data: {
                                text: responseText,
                                raw: wsResult
                            }
                        };
                    } catch (wsErr) {
                        console.log('[Tester] WebSocket failed:', wsErr.message);
                        console.log('[Tester] Falling back to HTTP...');
                        throw wsErr; // Re-throw to trigger fallback
                    }
                } else {
                    console.log('[Tester] WebSocket not available, using HTTP fallback');
                }
                
                // ATTEMPT 2: HTTP fallback (if WebSocket unavailable or failed)
                if (!usedWebSocket) {
                    const res = await fetch('/api/tester/run', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            provider: provider, 
                            modelId: modelId,
                            sessionKey: (window.GATEWAY_CONFIG && window.GATEWAY_CONFIG.sessionKey) || 'agent:main:main'
                        })
                    });
                    resultData = await res.json();
                    if (resultData.error) throw new Error(resultData.error);
                }

                // Display results
                document.getElementById('tm-status-bar').style.display = 'flex';
                document.getElementById('tm-http-status').textContent = resultData.status + ' ' + resultData.statusText;
                document.getElementById('tm-http-status').style.color = resultData.status >= 200 && resultData.status < 300 ? '#10b981' : '#ef4444';
                document.getElementById('tm-latency').textContent = resultData.durationMs + 'ms';

                const hdrs = resultData.headers || {};
                let aimsg = '';
                let respIsSuccess = false;

                if (resultData.data && resultData.data.text) {
                    aimsg = resultData.data.text;
                    respIsSuccess = true;
                } else if (resultData.data && resultData.data.error) {
                    aimsg = 'Error: ' + JSON.stringify(resultData.data.error, null, 2);
                } else {
                    aimsg = JSON.stringify(resultData.data, null, 2);
                    respIsSuccess = true;
                }

                const rbText = document.getElementById('tm-response-text');
                rbText.textContent = aimsg;
                rbText.className = respIsSuccess ? 'pre-box success-box' : 'pre-box error-box';

                const rawHdrStr = Object.entries(hdrs).map(function(kv) { return kv[0] + ': ' + kv[1]; }).join('\n');
                document.getElementById('tm-raw-headers').textContent = rawHdrStr || 'No headers.';
                document.getElementById('tm-raw-json').textContent = JSON.stringify(resultData.data, null, 2);

                document.getElementById('tm-loading').style.display = 'none';
                document.getElementById('tm-results').style.display = 'block';
                
                console.log('[Tester] Test complete. Result:', resultData.statusText);
                console.log('[Tester] ===========================================');

                // Save test result
                await saveTestResult(provider, modelId, resultData, null);

            } catch (e) {
                console.error('[Tester] Test failed completely:', e);
                document.getElementById('tm-loading').style.display = 'none';
                document.getElementById('tm-status-bar').style.display = 'flex';
                document.getElementById('tm-http-status').textContent = 'FAILED';
                document.getElementById('tm-http-status').style.color = '#ef4444';

                const rbText = document.getElementById('tm-response-text');
                rbText.className = 'pre-box error-box';
                rbText.textContent = 'Test failed:\n\n' + e.message + '\n\nCheck browser console (F12) for detailed logs.';

                document.getElementById('tm-results').style.display = 'block';

                // Save failed test result
                await saveTestResult(provider, modelId, { status: 0, durationMs: Date.now() - startTime, data: {} }, e);
            }
        }
        
        // Backwards compatibility
        window.executeModelTest = runModelTest;

        // Polyfill for crypto.randomUUID if not available
        if (!crypto.randomUUID) {
            crypto.randomUUID = function() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            };
        }

        // Save test result to the Test Results Dashboard
        async function saveTestResult(provider, modelId, resultData, error) {
            try {
                const testResult = {
                    id: crypto.randomUUID(),
                    timestamp: new Date().toISOString(),
                    testType: 'model-test',
                    status: error ? 'fail' : (resultData.status >= 200 && resultData.status < 300 ? 'pass' : 'fail'),
                    durationMs: resultData.durationMs,
                    request: {
                        provider: provider,
                        modelId: modelId,
                        sessionKey: (window.GATEWAY_CONFIG && window.GATEWAY_CONFIG.sessionKey) || 'agent:main:main'
                    },
                    response: resultData.data || {},
                    targetAgent: modelId,
                    sessionKey: (window.GATEWAY_CONFIG && window.GATEWAY_CONFIG.sessionKey) || 'agent:main:main',
                    notes: error ? `Error: ${error.message}` : null
                };

                // Check for rate limiting info in headers
                if (resultData.headers) {
                    const headers = resultData.headers;
                    const rateLimitRemaining = headers['x-ratelimit-remaining'] || headers['X-RateLimit-Remaining'];
                    const rateLimitLimit = headers['x-ratelimit-limit'] || headers['X-RateLimit-Limit'];
                    const rateLimitReset = headers['x-ratelimit-reset'] || headers['X-RateLimit-Reset'];
                    const retryAfter = headers['retry-after'] || headers['Retry-After'];

                    if (rateLimitRemaining !== undefined && parseInt(rateLimitRemaining) === 0) {
                        testResult.status = 'rate-limited';
                        testResult.rateLimitInfo = {
                            hit: true,
                            retryAfter: retryAfter ? parseInt(retryAfter) : null,
                            limit: rateLimitLimit ? parseInt(rateLimitLimit) : null,
                            remaining: 0,
                            resetTime: rateLimitReset ? new Date(parseInt(rateLimitReset) * 1000).toISOString() : null
                        };
                    }
                }

                const res = await fetch('/api/test-results', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testResult)
                });

                if (res.ok) {
                    console.log('[Tester] Test result saved successfully');
                } else {
                    console.error('[Tester] Failed to save test result');
                }
            } catch (e) {
                console.error('[Tester] Error saving test result:', e);
            }
        }

        // Make available globally
        window.saveTestResult = saveTestResult;
    </script>
</div>
<!-- END TESTER PAGE -->