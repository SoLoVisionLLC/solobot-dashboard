<!DOCTYPE html>
<html lang="en" data-theme="midnight">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoLoVision Command Center</title>
    <link rel="icon" type="image/png" href="/solobot-avatar.png">
    <script>
        // Apply theme immediately before paint to prevent flash
        (function() {
            var m = { dark: 'midnight', light: 'snow' };
            var t = localStorage.getItem('solobot-theme') || localStorage.getItem('theme') || 'midnight';
            if (m[t]) t = m[t];
            document.documentElement.setAttribute('data-theme', t);
        })();
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ========================================
           DESIGN SYSTEM - SoLoVision Brand
           ======================================== */

        :root {
            /* Brand Colors */
            --brand-red: #BC2026;
            --brand-red-hover: #a51c21;
            --brand-navy: #1B2232;
            --brand-grey: #A9B2BC;
            --brand-white: #FFFFFF;
            --accent: #BC2026;

            /* Fallback theme values (midnight) — ensures UI isn't transparent
               if themes.css loads late or fails */
            --surface-base: #0c0d10;
            --surface-1: #14161a;
            --surface-2: #1c1e23;
            --surface-3: #24262c;
            --surface-overlay: #2c2f36;
            --text-primary: #FFFFFF;
            --text-secondary: #A9B2BC;
            --text-muted: rgba(169, 178, 188, 0.6);
            --text-faint: rgba(169, 178, 188, 0.4);
            --border-default: rgba(169, 178, 188, 0.12);
            --border-subtle: rgba(169, 178, 188, 0.08);
            --border-strong: rgba(169, 178, 188, 0.2);
            --border-focus: rgba(188, 32, 38, 0.5);
            --control-bg: #1B2232;
            --control-border: rgba(169, 178, 188, 0.2);
            --control-focus: rgba(188, 32, 38, 0.3);
            --success: #22c55e;
            --success-muted: rgba(34, 197, 94, 0.15);
            --warning: #BC2026;
            --warning-muted: rgba(188, 32, 38, 0.15);
            --error: #ef4444;
            --error-muted: rgba(239, 68, 68, 0.15);
            --scrollbar-track: #14161a;
            --scrollbar-thumb: #A9B2BC;

            /* Spacing Scale (8px base) */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            --space-8: 32px;
            --space-10: 40px;
            --space-12: 48px;

            /* Border Radius */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-full: 9999px;

            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-normal: 200ms ease;
        }

        /* Theme transition animation */
        body.theme-transitioning, body.theme-transitioning * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease !important;
        }

        /* === DARK THEMES === */
        [data-theme="dark"], [data-theme="midnight"] { --surface-base:#0c0d10; --surface-1:#14161a; --surface-2:#1c1e23; --surface-3:#24262c; --surface-overlay:#2c2f36; --text-primary:#FFF; --text-secondary:#A9B2BC; --text-muted:rgba(169,178,188,0.6); --text-faint:rgba(169,178,188,0.4); --border-default:rgba(169,178,188,0.12); --border-subtle:rgba(169,178,188,0.08); --border-strong:rgba(169,178,188,0.2); --border-focus:rgba(188,32,38,0.5); --control-bg:#1B2232; --control-border:rgba(169,178,188,0.2); --control-focus:rgba(188,32,38,0.3); --success:#22c55e; --success-muted:rgba(34,197,94,0.15); --warning:#BC2026; --warning-muted:rgba(188,32,38,0.15); --error:#ef4444; --error-muted:rgba(239,68,68,0.15); --scrollbar-track:#14161a; --scrollbar-thumb:#A9B2BC; --accent:#BC2026; --brand-red:#BC2026; }
        [data-theme="obsidian"] { --surface-base:#000; --surface-1:#0a0a0a; --surface-2:#141414; --surface-3:#1f1f1f; --surface-overlay:#2a2a2a; --text-primary:#FFF; --text-secondary:#b8b8b8; --text-muted:rgba(184,184,184,0.6); --text-faint:rgba(184,184,184,0.35); --border-default:rgba(255,255,255,0.1); --border-subtle:rgba(255,255,255,0.06); --border-strong:rgba(255,255,255,0.18); --border-focus:rgba(255,255,255,0.3); --control-bg:#141414; --control-border:rgba(255,255,255,0.15); --control-focus:rgba(255,255,255,0.2); --success:#10b981; --success-muted:rgba(16,185,129,0.15); --warning:#f59e0b; --warning-muted:rgba(245,158,11,0.15); --error:#ef4444; --error-muted:rgba(239,68,68,0.15); --scrollbar-track:#0a0a0a; --scrollbar-thumb:#3a3a3a; --accent:#fff; --brand-red:#fff; }
        [data-theme="nord"] { --surface-base:#2e3440; --surface-1:#3b4252; --surface-2:#434c5e; --surface-3:#4c566a; --surface-overlay:#5e6b7f; --text-primary:#eceff4; --text-secondary:#d8dee9; --text-muted:rgba(216,222,233,0.6); --text-faint:rgba(216,222,233,0.4); --border-default:rgba(76,86,106,0.5); --border-subtle:rgba(76,86,106,0.3); --border-strong:rgba(76,86,106,0.7); --border-focus:rgba(136,192,208,0.5); --control-bg:#3b4252; --control-border:rgba(76,86,106,0.5); --control-focus:rgba(136,192,208,0.3); --success:#a3be8c; --success-muted:rgba(163,190,140,0.2); --warning:#ebcb8b; --warning-muted:rgba(235,203,139,0.2); --error:#bf616a; --error-muted:rgba(191,97,106,0.2); --scrollbar-track:#3b4252; --scrollbar-thumb:#4c566a; --accent:#88c0d0; --brand-red:#88c0d0; }
        [data-theme="dracula"] { --surface-base:#1e1f29; --surface-1:#282a36; --surface-2:#343746; --surface-3:#44475a; --surface-overlay:#54576a; --text-primary:#f8f8f2; --text-secondary:#bfbfbf; --text-muted:rgba(191,191,191,0.6); --text-faint:rgba(191,191,191,0.4); --border-default:rgba(98,114,164,0.3); --border-subtle:rgba(98,114,164,0.15); --border-strong:rgba(98,114,164,0.45); --border-focus:rgba(255,121,198,0.5); --control-bg:#282a36; --control-border:rgba(98,114,164,0.3); --control-focus:rgba(255,121,198,0.3); --success:#50fa7b; --success-muted:rgba(80,250,123,0.15); --warning:#ffb86c; --warning-muted:rgba(255,184,108,0.15); --error:#ff5555; --error-muted:rgba(255,85,85,0.15); --scrollbar-track:#282a36; --scrollbar-thumb:#6272a4; --accent:#ff79c6; --brand-red:#ff79c6; }
        [data-theme="tokyo-night"] { --surface-base:#16161e; --surface-1:#1a1b26; --surface-2:#24283b; --surface-3:#2f3549; --surface-overlay:#3b4261; --text-primary:#c0caf5; --text-secondary:#a9b1d6; --text-muted:rgba(169,177,214,0.6); --text-faint:rgba(169,177,214,0.4); --border-default:rgba(122,162,247,0.15); --border-subtle:rgba(122,162,247,0.08); --border-strong:rgba(122,162,247,0.25); --border-focus:rgba(122,162,247,0.5); --control-bg:#1a1b26; --control-border:rgba(122,162,247,0.2); --control-focus:rgba(122,162,247,0.3); --success:#9ece6a; --success-muted:rgba(158,206,106,0.15); --warning:#e0af68; --warning-muted:rgba(224,175,104,0.15); --error:#f7768e; --error-muted:rgba(247,118,142,0.15); --scrollbar-track:#1a1b26; --scrollbar-thumb:#3b4261; --accent:#7aa2f7; --brand-red:#7aa2f7; }
        [data-theme="monokai"] { --surface-base:#1e1f1c; --surface-1:#272822; --surface-2:#34352f; --surface-3:#414339; --surface-overlay:#4e5046; --text-primary:#f8f8f2; --text-secondary:#a7a699; --text-muted:rgba(167,166,153,0.6); --text-faint:rgba(167,166,153,0.4); --border-default:rgba(117,113,94,0.3); --border-subtle:rgba(117,113,94,0.15); --border-strong:rgba(117,113,94,0.45); --border-focus:rgba(249,38,114,0.5); --control-bg:#272822; --control-border:rgba(117,113,94,0.3); --control-focus:rgba(249,38,114,0.3); --success:#a6e22e; --success-muted:rgba(166,226,46,0.15); --warning:#fd971f; --warning-muted:rgba(253,151,31,0.15); --error:#f92672; --error-muted:rgba(249,38,114,0.15); --scrollbar-track:#272822; --scrollbar-thumb:#75715e; --accent:#fd971f; --brand-red:#fd971f; }
        [data-theme="catppuccin-mocha"] { --surface-base:#11111b; --surface-1:#1e1e2e; --surface-2:#313244; --surface-3:#45475a; --surface-overlay:#585b70; --text-primary:#cdd6f4; --text-secondary:#bac2de; --text-muted:rgba(186,194,222,0.6); --text-faint:rgba(186,194,222,0.4); --border-default:rgba(127,132,156,0.3); --border-subtle:rgba(127,132,156,0.15); --border-strong:rgba(127,132,156,0.45); --border-focus:rgba(245,194,231,0.5); --control-bg:#1e1e2e; --control-border:rgba(127,132,156,0.3); --control-focus:rgba(245,194,231,0.3); --success:#a6e3a1; --success-muted:rgba(166,227,161,0.15); --warning:#f9e2af; --warning-muted:rgba(249,226,175,0.15); --error:#f38ba8; --error-muted:rgba(243,139,168,0.15); --scrollbar-track:#1e1e2e; --scrollbar-thumb:#585b70; --accent:#f5c2e7; --brand-red:#f5c2e7; }

        /* === LIGHT THEMES === */
        [data-theme="light"], [data-theme="snow"] { --surface-base:#F8FAFC; --surface-1:#FFF; --surface-2:#F1F5F9; --surface-3:#E2E8F0; --surface-overlay:#FFF; --text-primary:#1B2232; --text-secondary:#64748b; --text-muted:rgba(27,34,50,0.5); --text-faint:rgba(27,34,50,0.3); --border-default:rgba(27,34,50,0.1); --border-subtle:rgba(27,34,50,0.06); --border-strong:rgba(27,34,50,0.15); --border-focus:rgba(188,32,38,0.4); --control-bg:#FFF; --control-border:rgba(27,34,50,0.15); --control-focus:rgba(188,32,38,0.2); --success:#16a34a; --success-muted:rgba(22,163,74,0.1); --warning:#BC2026; --warning-muted:rgba(188,32,38,0.1); --error:#dc2626; --error-muted:rgba(220,38,38,0.1); --scrollbar-track:#F1F5F9; --scrollbar-thumb:#94a3b8; --accent:#BC2026; --brand-red:#BC2026; }
        [data-theme="latte"] { --surface-base:#eff1f5; --surface-1:#e6e9ef; --surface-2:#ccd0da; --surface-3:#bcc0cc; --surface-overlay:#acb0be; --text-primary:#4c4f69; --text-secondary:#5c5f77; --text-muted:rgba(76,79,105,0.6); --text-faint:rgba(76,79,105,0.35); --border-default:rgba(76,79,105,0.15); --border-subtle:rgba(76,79,105,0.08); --border-strong:rgba(76,79,105,0.25); --border-focus:rgba(234,118,203,0.5); --control-bg:#e6e9ef; --control-border:rgba(76,79,105,0.2); --control-focus:rgba(234,118,203,0.3); --success:#40a02b; --success-muted:rgba(64,160,43,0.12); --warning:#df8e1d; --warning-muted:rgba(223,142,29,0.12); --error:#d20f39; --error-muted:rgba(210,15,57,0.12); --scrollbar-track:#ccd0da; --scrollbar-thumb:#9ca0b0; --accent:#ea76cb; --brand-red:#ea76cb; }
        [data-theme="rose-pine-dawn"] { --surface-base:#faf4ed; --surface-1:#fffaf3; --surface-2:#f2e9e1; --surface-3:#e8dfd5; --surface-overlay:#fff; --text-primary:#575279; --text-secondary:#797593; --text-muted:rgba(87,82,121,0.5); --text-faint:rgba(87,82,121,0.3); --border-default:rgba(87,82,121,0.12); --border-subtle:rgba(87,82,121,0.06); --border-strong:rgba(87,82,121,0.2); --border-focus:rgba(214,93,146,0.5); --control-bg:#fffaf3; --control-border:rgba(87,82,121,0.15); --control-focus:rgba(214,93,146,0.25); --success:#56949f; --success-muted:rgba(86,148,159,0.12); --warning:#ea9d34; --warning-muted:rgba(234,157,52,0.12); --error:#b4637a; --error-muted:rgba(180,99,122,0.12); --scrollbar-track:#f2e9e1; --scrollbar-thumb:#9893a5; --accent:#d65d92; --brand-red:#d65d92; }
        [data-theme="solarized-light"] { --surface-base:#fdf6e3; --surface-1:#eee8d5; --surface-2:#e3dcc5; --surface-3:#d9d0b7; --surface-overlay:#eee8d5; --text-primary:#073642; --text-secondary:#586e75; --text-muted:rgba(7,54,66,0.5); --text-faint:rgba(7,54,66,0.3); --border-default:rgba(0,43,54,0.1); --border-subtle:rgba(0,43,54,0.06); --border-strong:rgba(0,43,54,0.15); --border-focus:rgba(38,139,210,0.5); --control-bg:#eee8d5; --control-border:rgba(0,43,54,0.15); --control-focus:rgba(38,139,210,0.25); --success:#859900; --success-muted:rgba(133,153,0,0.12); --warning:#b58900; --warning-muted:rgba(181,137,0,0.12); --error:#dc322f; --error-muted:rgba(220,50,47,0.12); --scrollbar-track:#e3dcc5; --scrollbar-thumb:#93a1a1; --accent:#268bd2; --brand-red:#268bd2; }
        [data-theme="paper"] { --surface-base:#fff; --surface-1:#fafafa; --surface-2:#f5f5f5; --surface-3:#eee; --surface-overlay:#fafafa; --text-primary:#212121; --text-secondary:#616161; --text-muted:rgba(33,33,33,0.5); --text-faint:rgba(33,33,33,0.3); --border-default:rgba(0,0,0,0.08); --border-subtle:rgba(0,0,0,0.04); --border-strong:rgba(0,0,0,0.12); --border-focus:rgba(33,33,33,0.4); --control-bg:#fafafa; --control-border:rgba(0,0,0,0.1); --control-focus:rgba(33,33,33,0.2); --success:#2e7d32; --success-muted:rgba(46,125,50,0.08); --warning:#f57c00; --warning-muted:rgba(245,124,0,0.08); --error:#c62828; --error-muted:rgba(198,40,40,0.08); --scrollbar-track:#f5f5f5; --scrollbar-thumb:#9e9e9e; --accent:#424242; --brand-red:#424242; }

        /* === SPECIAL THEMES === */
        [data-theme="solovision-red"] { --surface-base:#0f0506; --surface-1:#1a0a0c; --surface-2:#2d1215; --surface-3:#3d1a1e; --surface-overlay:#4d2327; --text-primary:#fff; --text-secondary:#e5c6c9; --text-muted:rgba(229,198,201,0.6); --text-faint:rgba(229,198,201,0.35); --border-default:rgba(188,32,38,0.2); --border-subtle:rgba(188,32,38,0.1); --border-strong:rgba(188,32,38,0.35); --border-focus:rgba(188,32,38,0.6); --control-bg:#1a0a0c; --control-border:rgba(188,32,38,0.3); --control-focus:rgba(188,32,38,0.4); --success:#22c55e; --success-muted:rgba(34,197,94,0.15); --warning:#f59e0b; --warning-muted:rgba(245,158,11,0.15); --error:#ef4444; --error-muted:rgba(239,68,68,0.15); --scrollbar-track:#1a0a0c; --scrollbar-thumb:#BC2026; --accent:#BC2026; --brand-red:#BC2026; }
        [data-theme="cyberpunk"] { --surface-base:#0a0e27; --surface-1:#0f1535; --surface-2:#1a1f4d; --surface-3:#252a5f; --surface-overlay:#303571; --text-primary:#00ff9f; --text-secondary:#b4c6ff; --text-muted:rgba(180,198,255,0.6); --text-faint:rgba(180,198,255,0.35); --border-default:rgba(0,255,159,0.2); --border-subtle:rgba(0,255,159,0.1); --border-strong:rgba(0,255,159,0.35); --border-focus:rgba(255,0,255,0.6); --control-bg:#0f1535; --control-border:rgba(0,255,159,0.25); --control-focus:rgba(255,0,255,0.35); --success:#00ff9f; --success-muted:rgba(0,255,159,0.15); --warning:#ffee00; --warning-muted:rgba(255,238,0,0.15); --error:#ff006e; --error-muted:rgba(255,0,110,0.15); --scrollbar-track:#0f1535; --scrollbar-thumb:#00ff9f; --accent:#ff00ff; --brand-red:#ff00ff; }
        [data-theme="ocean"] { --surface-base:#0a1628; --surface-1:#0e1e33; --surface-2:#15293f; --surface-3:#1d344d; --surface-overlay:#253f5b; --text-primary:#e0f2fe; --text-secondary:#7dd3fc; --text-muted:rgba(125,211,252,0.6); --text-faint:rgba(125,211,252,0.35); --border-default:rgba(14,165,233,0.2); --border-subtle:rgba(14,165,233,0.1); --border-strong:rgba(14,165,233,0.35); --border-focus:rgba(6,182,212,0.6); --control-bg:#0e1e33; --control-border:rgba(14,165,233,0.25); --control-focus:rgba(6,182,212,0.35); --success:#10b981; --success-muted:rgba(16,185,129,0.15); --warning:#f59e0b; --warning-muted:rgba(245,158,11,0.15); --error:#ef4444; --error-muted:rgba(239,68,68,0.15); --scrollbar-track:#0e1e33; --scrollbar-thumb:#0ea5e9; --accent:#06b6d4; --brand-red:#06b6d4; }

        /* Light mode overrides for themes with light base — uses :is() to match all light themes */
        :is([data-theme="light"], [data-theme="snow"], [data-theme="latte"], [data-theme="rose-pine-dawn"], [data-theme="solarized-light"], [data-theme="paper"]) .system-bubble {
            background: rgba(27, 34, 50, 0.08);
            border: 1px solid rgba(188, 32, 38, 0.2);
        }
        
        :is([data-theme="light"], [data-theme="snow"], [data-theme="latte"], [data-theme="rose-pine-dawn"], [data-theme="solarized-light"], [data-theme="paper"]) .system-bubble-content {
            color: var(--text-primary);
        }
        
        :is([data-theme="light"], [data-theme="snow"], [data-theme="latte"], [data-theme="rose-pine-dawn"], [data-theme="solarized-light"], [data-theme="paper"]) .system-bubble-time {
            color: var(--text-secondary);
        }
        
        :is([data-theme="light"], [data-theme="snow"], [data-theme="latte"], [data-theme="rose-pine-dawn"], [data-theme="solarized-light"], [data-theme="paper"]) .chat-page-message.solobot .chat-page-bubble {
            background: var(--surface-2);
            color: var(--text-primary);
        }

        /* ========================================
           BASE STYLES
           ======================================== */

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            overflow-x: hidden;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--surface-base);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--scrollbar-track); }
        ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }

        /* ========================================
           COMPONENTS
           ======================================== */

        /* Card */
        .card {
            background: var(--surface-1);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
        }

        .card-elevated {
            background: var(--surface-2);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all var(--transition-fast);
        }

        .btn-primary {
            background: var(--brand-red);
            color: white;
        }
        .btn-primary:hover {
            background: var(--brand-red-hover);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-default);
        }
        .btn-ghost:hover {
            background: var(--surface-2);
            color: var(--text-primary);
            border-color: var(--border-strong);
        }

        .btn-icon {
            padding: var(--space-2);
            background: transparent;
            color: var(--text-secondary);
            border: none;
            border-radius: var(--radius-md);
        }
        .btn-icon:hover {
            background: var(--surface-2);
            color: var(--text-primary);
        }

        /* Voice Input Button */
        .voice-btn {
            padding: var(--space-2);
            background: transparent;
            color: var(--text-secondary);
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .voice-btn:hover {
            background: var(--surface-2);
            color: var(--text-primary);
        }
        .voice-btn.listening {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            animation: pulse-voice 1.5s ease-in-out infinite;
        }
        .voice-btn.processing {
            color: var(--brand-primary);
        }
        .voice-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        @keyframes pulse-voice {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
        }
        .voice-btn svg {
            width: 20px;
            height: 20px;
        }
        /* Voice not supported tooltip */
        .voice-unsupported {
            font-size: 11px;
            color: var(--text-muted);
            padding: 4px 8px;
        }
        /* Voice auto-send toggle */
        .voice-auto-send-toggle {
            font-size: 10px;
            padding: 2px 6px;
            background: var(--surface-2);
            color: var(--text-muted);
            border: 1px solid var(--border-default);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .voice-auto-send-toggle:hover {
            background: var(--surface-3);
            color: var(--text-secondary);
        }
        .voice-auto-send-toggle.active {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
            border-color: rgba(34, 197, 94, 0.3);
        }
        .voice-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Inputs */
        .input {
            width: 100%;
            padding: var(--space-2) var(--space-3);
            background: var(--control-bg);
            border: 1px solid var(--control-border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 14px;
            transition: border-color var(--transition-fast);
        }
        .input::placeholder {
            color: var(--text-muted);
        }
        .input:focus {
            outline: none;
            border-color: var(--brand-red);
            box-shadow: 0 0 0 3px var(--control-focus);
        }

        /* Badge */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 2px var(--space-2);
            border-radius: var(--radius-full);
            font-size: 11px;
            font-weight: 500;
        }
        .badge-default {
            background: var(--surface-3);
            color: var(--text-secondary);
        }
        .badge-success {
            background: var(--success-muted);
            color: var(--success);
        }
        .badge-warning {
            background: var(--warning-muted);
            color: var(--warning);
        }
        .badge-error {
            background: var(--error-muted);
            color: var(--error);
        }

        /* Status dot */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .status-dot.success { background: var(--success); }
        .status-dot.warning { background: var(--warning); }
        .status-dot.error { background: var(--error); }
        .status-dot.idle { background: var(--text-muted); }
        .status-dot.pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; transform: translateY(-10px); }
        }

        /* Section heading */
        .section-title {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-4);
        }
        .section-title svg {
            width: 18px;
            height: 18px;
            color: var(--brand-red);
        }

        /* ========================================
           LAYOUT
           ======================================== */

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 var(--space-6);
            box-sizing: border-box;
        }

        /* Header */
        .header {
            background: var(--surface-1);
            border-bottom: 1px solid var(--border-default);
            height: 60px; /* Match sidebar-logo height */
            display: flex;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-inner {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .logo {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .header-status {
            display: flex;
            align-items: center;
            gap: var(--space-6);
        }

        .status-chip {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--surface-2);
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 500;
        }

        .header-meta {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            font-size: 13px;
            color: var(--text-secondary);
        }
        .header-meta span {
            color: var(--text-primary);
        }
        
        /* Header dropdown selectors */
        .header-select {
            background: var(--surface-2);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 12px;
            padding: 2px 4px;
            margin-left: 4px;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        
        .header-select:hover {
            border-color: var(--brand-red);
        }
        
        .header-select:focus {
            outline: none;
            border-color: var(--brand-red);
            box-shadow: 0 0 0 2px rgba(188, 32, 38, 0.2);
        }

        /* Theme toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2);
            background: var(--surface-2);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            cursor: pointer;
        }
        .theme-toggle:hover {
            border-color: var(--border-strong);
        }
        .theme-toggle svg {
            width: 18px;
            height: 18px;
            color: var(--text-secondary);
        }
        .theme-toggle:hover svg {
            color: var(--text-primary);
        }

        /* Main content */
        .main {
            padding: var(--space-6) 0;
        }

        /* Dashboard page doesn't use .main padding (has fixed layout) */
        #page-dashboard .container {
            padding: 0;
        }

        /* Grid layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-6);
            max-width: 100%;
        }
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-4);
        }
        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-4);
        }

        @media (max-width: 1024px) {
            .grid-2 { grid-template-columns: 1fr; }
            .grid-4 { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .grid-3 { grid-template-columns: 1fr; }
            .grid-4 { grid-template-columns: 1fr; }
        }

        /* Section spacing */
        .section {
            margin-bottom: var(--space-8);
        }

        /* ========================================
           TASK BOARD
           ======================================== */

        .board-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-4);
        }

        .board-actions {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .column {
            background: var(--surface-1);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            min-height: 300px;
        }

        .column-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-4);
        }

        .column-title {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: 14px;
            font-weight: 600;
        }

        .drop-zone {
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            
            border-radius: var(--radius-md);
            transition: background var(--transition-fast);
        }
        .drop-zone.drag-over {
            background: var(--surface-2);
        }

        .task-card {
            background: var(--surface-2);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            margin-bottom: var(--space-2);
            cursor: grab;
            transition: all var(--transition-fast);
            position: relative;
        }
        .task-card:hover {
            border-color: var(--border-strong);
        }
        .task-card:active {
            cursor: grabbing;
        }

        .task-card.selected {
            border-color: var(--brand-red);
            box-shadow: 0 0 0 2px var(--control-focus);
        }

        .priority-p0 { border-left: 3px solid var(--brand-red); }
        .priority-p1 { border-left: 3px solid var(--warning); }
        .priority-p2 { border-left: 3px solid #3b82f6; }

        .task-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: var(--space-1);
        }

        .task-meta {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Quick actions on hover */
        .task-quick-actions {
            position: absolute;
            right: var(--space-2);
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity var(--transition-fast);
        }
        .task-card:hover .task-quick-actions {
            opacity: 1;
        }

        /* ========================================
           TERMINAL
           ======================================== */

        .terminal {
            background: #0d1117;
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .terminal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-3) var(--space-4);
            background: var(--surface-2);
            border-bottom: 1px solid var(--border-default);
        }

        .terminal-dots {
            display: flex;
            gap: 6px;
        }
        .terminal-dots span {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .terminal-dots .red { background: #ff5f56; }
        .terminal-dots .yellow { background: #ffbd2e; }
        .terminal-dots .green { background: #27c93f; }

        .terminal-title {
            font-family: 'Fira Code', 'Monaco', monospace;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .terminal-output {
            padding: var(--space-4);
            font-family: 'Fira Code', 'Monaco', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.6;
            height: 250px;
            overflow-y: auto;
            
            color: var(--text-secondary);
        }
        .terminal-output .cmd { color: #7ee787; }
        .terminal-output .info { color: #58a6ff; } /* Brighter blue for timestamps */
        .terminal-output .error { color: #f85149; }
        .terminal-output .success { color: #7ee787; }
        .terminal-output .warning { color: #d29922; }

        /* ========================================
           CHAT
           ======================================== */

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-header {
            padding: var(--space-4);
            border-bottom: 1px solid var(--border-default);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-messages {
            flex: 1;
            min-height: 300px;
            max-height: 350px;
            overflow-y: auto;
            padding: var(--space-4);
            background: var(--surface-base);
            
        }

        .chat-input-area {
            padding: var(--space-3);
            border-top: 1px solid var(--border-default);
            display: flex;
            gap: var(--space-2);
            align-items: center;
        }

        /* Image preview - supports multiple images */
        .image-preview-container {
            padding: var(--space-2) var(--space-3);
            border-top: 1px solid var(--border-default);
            display: none;
        }
        .image-preview-container.visible {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
            align-items: flex-start;
        }
        .image-preview-wrapper {
            position: relative;
            display: inline-block;
        }
        .image-preview-wrapper img {
            max-height: 60px;
            max-width: 80px;
            object-fit: cover;
            border-radius: var(--radius-md);
        }
        .image-preview-close {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 18px;
            height: 18px;
            background: var(--brand-red);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ========================================
           ACTIVITY LOG
           ======================================== */

        .activity-list {
            height: 250px;
            overflow-y: auto;
            
        }

        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
            padding: var(--space-2) 0;
            border-bottom: 1px solid var(--border-subtle);
        }
        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-time {
            font-size: 11px;
            color: var(--text-muted);
            white-space: nowrap;
            min-width: 60px;
        }

        .activity-text {
            font-size: 13px;
            color: var(--text-secondary);
        }
        .activity-text.success { color: var(--success); }
        .activity-text.warning { color: var(--warning); }

        /* ========================================
           NOTES
           ======================================== */

        .notes-input {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-4);
        }

        .notes-list {
            height: 200px;
            overflow-y: auto;
            
        }

        .note-item {
            padding: var(--space-3);
            background: var(--surface-2);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-2);
        }

        .note-text {
            font-size: 13px;
            color: var(--text-primary);
            margin-bottom: var(--space-1);
        }

        .note-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-muted);
        }

        /* ========================================
           PRODUCT STATUS
           ======================================== */

        .product-card {
            background: var(--surface-1);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
        }

        .product-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-2);
        }

        .product-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .product-desc {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: var(--space-2);
        }

        .product-meta {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* ========================================
           DOCS HUB
           ======================================== */

        .docs-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-4);
        }

        .docs-search {
            width: 200px;
        }

        .doc-card {
            display: block;
            background: var(--surface-1);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            transition: border-color var(--transition-fast);
            text-decoration: none;
            overflow: hidden;
        }
        .doc-card:hover {
            border-color: var(--border-strong);
        }
        .doc-card * {
            max-width: 100%;
        }

        .doc-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .doc-icon.gdoc { background: rgba(66, 133, 244, 0.15); color: #4285f4; }
        .doc-icon.gsheet { background: rgba(52, 168, 83, 0.15); color: #34a853; }
        .doc-icon.pdf { background: rgba(234, 67, 53, 0.15); color: #ea4335; }
        .doc-icon.default { background: var(--surface-3); color: var(--text-secondary); }

        .doc-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .doc-meta {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* ========================================
           MODALS
           ======================================== */

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: var(--space-4);
        }
        .modal-overlay.visible {
            display: flex;
        }

        .modal {
            background: var(--surface-1, #14161a);
            border: 1px solid var(--border-default, rgba(169, 178, 188, 0.12));
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            width: 100%;
            max-width: 480px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-lg {
            max-width: 640px;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-4);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: var(--space-1);
        }
        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-section {
            margin-bottom: var(--space-6);
        }

        .modal-section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-3);
        }

        .modal-section-content {
            background: var(--surface-2);
            border-radius: var(--radius-md);
            padding: var(--space-4);
        }

        .form-group {
            margin-bottom: var(--space-3);
        }
        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: var(--space-1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-3);
        }

        .form-actions {
            display: flex;
            gap: var(--space-2);
            margin-top: var(--space-4);
        }
        .form-actions .btn {
            flex: 1;
        }

        /* Settings row */
        .setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-3) 0;
            border-bottom: 1px solid var(--border-subtle);
        }
        .setting-row:last-child {
            border-bottom: none;
        }

        .setting-info {
            flex: 1;
        }

        .setting-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .setting-desc {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Select styling */
        .select {
            padding: var(--space-2) var(--space-3);
            background: var(--control-bg);
            border: 1px solid var(--control-border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
        }
        .select:focus {
            outline: none;
            border-color: var(--brand-red);
        }

        /* Toggle switch */
        .toggle {
            position: relative;
            width: 44px;
            height: 24px;
        }
        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background: var(--surface-3);
            border-radius: var(--radius-full);
            transition: background var(--transition-fast);
        }
        .toggle-slider::before {
            content: '';
            position: absolute;
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: transform var(--transition-fast);
        }
        .toggle input:checked + .toggle-slider {
            background: var(--brand-red);
        }
        .toggle input:checked + .toggle-slider::before {
            transform: translateX(20px);
        }

        /* Danger zone */
        .danger-zone {
            background: var(--error-muted);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: var(--radius-md);
            padding: var(--space-4);
        }

        .btn-danger {
            background: var(--error);
            color: white;
        }
        .btn-danger:hover {
            background: #dc2626;
        }

        /* ========================================
           FOOTER
           ======================================== */

        .footer {
            background: var(--surface-1);
            border-top: 1px solid var(--border-default);
            padding: var(--space-3) 0;
            margin-top: var(--space-8);
        }

        .footer-inner {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-muted);
        }

        .footer-status {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            color: var(--success);
        }

        /* ========================================
           BULK ACTIONS BAR
           ======================================== */

        .bulk-action-bar {
            position: fixed;
            bottom: var(--space-6);
            left: 50%;
            transform: translateX(-50%);
            background: var(--surface-overlay);
            border: 1px solid var(--border-strong);
            border-radius: var(--radius-lg);
            padding: var(--space-3) var(--space-4);
            display: none;
            align-items: center;
            gap: var(--space-4);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 50;
            animation: slideUp 0.2s ease;
        }
        .bulk-action-bar.visible {
            display: flex;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        /* ========================================
           THEME PICKER
           ======================================== */
        .theme-picker-section { padding: 0; }
        .theme-picker-header { margin-bottom: 20px; }
        .theme-picker-title { font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; }
        .theme-picker-subtitle { font-size: 13px; color: var(--text-secondary); }
        .theme-category { margin-bottom: 24px; }
        .theme-category:last-child { margin-bottom: 0; }
        .theme-category-title { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); margin-bottom: 10px; }
        .theme-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .theme-card { background: var(--surface-2); border: 2px solid var(--border-default); border-radius: 10px; padding: 10px; cursor: pointer; transition: all 0.2s ease; position: relative; overflow: hidden; }
        .theme-card:hover { border-color: var(--border-strong); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .theme-card.active { border-color: var(--accent, var(--brand-red)); box-shadow: 0 0 0 3px var(--control-focus, rgba(188,32,38,0.15)); }
        .theme-card-preview { margin-bottom: 6px; }
        .theme-preview-colors { display: flex; gap: 3px; margin-bottom: 6px; }
        .theme-color { height: 16px; border-radius: 4px; flex: 1; border: 1px solid rgba(0,0,0,0.1); }
        .theme-preview-strip { display: flex; height: 20px; border-radius: 5px; overflow: hidden; border: 1px solid var(--border-default); }
        .preview-surface { flex: 3; }
        .preview-text { flex: 2; }
        .preview-accent { flex: 1; }
        .theme-card-name { font-size: 12px; font-weight: 600; color: var(--text-primary); margin-bottom: 1px; }
        .theme-card-desc { font-size: 10px; color: var(--text-muted); }
        .theme-card-check { position: absolute; top: 6px; right: 6px; width: 20px; height: 20px; background: var(--accent, var(--brand-red)); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; opacity: 0; transform: scale(0.8); transition: all 0.2s ease; }
        .theme-card.active .theme-card-check { opacity: 1; transform: scale(1); }

        /* ========================================
           UTILITIES
           ======================================== */

        .hidden { display: none !important; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-1 { gap: var(--space-1); }
        .gap-2 { gap: var(--space-2); }
        .gap-3 { gap: var(--space-3); }
        .gap-4 { gap: var(--space-4); }
        .flex-1 { flex: 1; }
        .text-center { text-align: center; }
        .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .space-y-2 > * + * { margin-top: var(--space-2); }
        .space-y-3 > * + * { margin-top: var(--space-3); }
        
        /* ========================================
           SIDEBAR LAYOUT
           ======================================== */
        
        .app-layout {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 64px;
            background: var(--surface-1);
            border-right: 1px solid var(--border-default);
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 150;
            transition: width var(--transition-normal);
        }
        
        .sidebar:hover,
        .sidebar.pinned {
            width: 200px;
        }
        
        .sidebar-toggle {
            position: absolute;
            top: 18px;
            right: 8px;
            width: 24px;
            height: 24px;
            border: none;
            background: var(--surface-2);
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background var(--transition-normal), opacity var(--transition-normal);
            font-size: 16px;
            font-weight: bold;
            z-index: 10;
            opacity: 0;
        }
        
        .sidebar:hover .sidebar-toggle,
        .sidebar.pinned .sidebar-toggle {
            opacity: 1;
        }
        
        .sidebar-toggle:hover {
            background: var(--surface-3);
            color: var(--text-primary);
        }
        
        .sidebar.pinned .sidebar-toggle {
            color: var(--accent);
            background: var(--surface-3);
        }
        
        .sidebar-logo {
            padding: var(--space-2);
            border-bottom: 1px solid var(--border-default);
            display: flex;
            align-items: center;
            justify-content: center;
            height: 60px;
        }
        
        .sidebar-logo-img {
            height: 40px;
            width: auto;
            object-fit: contain;
            transition: height var(--transition-normal);
        }
        
        .sidebar:hover .sidebar-logo-img,
        .sidebar.pinned .sidebar-logo-img {
            height: 48px;
        }
        
        .header-logo-img {
            height: 36px;
            width: auto;
            object-fit: contain;
        }
        
        .sidebar-nav {
            flex: 1;
            padding: var(--space-2) 6px; /* Slightly more horizontal padding to center items */
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
            transition: padding var(--transition-normal);
            /* Nav items stack at top, empty space goes below them */
        }
        
        .sidebar:hover .sidebar-nav,
        .sidebar.pinned .sidebar-nav {
            padding: var(--space-3); /* More padding when expanded */
        }
        
        .sidebar-item {
            display: flex;
            align-items: center;
            justify-content: center; /* Center everything when collapsed */
            gap: var(--space-3);
            padding: var(--space-3) 0; /* No horizontal padding - let nav padding handle it */
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
            text-decoration: none;
            line-height: 1.2; /* Slightly tighter line height */
            margin-top: -6px; /* Nudge up by 6px for better alignment */
        }
        
        .sidebar:hover .sidebar-item,
        .sidebar.pinned .sidebar-item {
            justify-content: flex-start;
            padding: var(--space-3);
        }
        
        .sidebar-item:hover {
            background: var(--surface-2);
            color: var(--text-primary);
        }
        
        .sidebar-item.active {
            background: var(--brand-red);
            color: white;
        }
        
        .sidebar-item-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .sidebar-item-text {
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            width: 0;
            overflow: hidden;
            transition: opacity var(--transition-normal), width var(--transition-normal);
        }
        
        .sidebar:hover .sidebar-item-text,
        .sidebar.pinned .sidebar-item-text {
            opacity: 1;
            width: auto;
        }

        .sidebar-section {
            margin-top: var(--space-3);
            padding: 0 6px;
        }

        .sidebar-section-title {
            font-size: 11px;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text-muted);
            padding: 6px 10px;
            opacity: 0;
            transition: opacity var(--transition-normal);
        }

        .sidebar:hover .sidebar-section-title,
        .sidebar.pinned .sidebar-section-title {
            opacity: 1;
        }

        .sidebar-agent {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 8px 0;
            border-radius: var(--radius-md);
            color: var(--text-primary);
            transition: background var(--transition-fast), border-color var(--transition-fast);
            border: 1px solid transparent;
            cursor: pointer;
        }
        
        .sidebar:hover .sidebar-agent,
        .sidebar.pinned .sidebar-agent {
            justify-content: flex-start;
            padding: 8px 10px;
        }

        .sidebar-agent:hover {
            background: var(--surface-2);
        }

        .sidebar-agent.active {
            background: rgba(188, 32, 38, 0.12);
            border: 1px solid rgba(188, 32, 38, 0.45);
        }

        .agent-avatar {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            border: 2px solid var(--border-default);
            object-fit: cover;
            flex-shrink: 0;
            background: var(--surface-2);
        }
        
        /* Agent-specific avatar colors */
        .agent-avatar[data-agent="main"], .agent-avatar[alt="Main"] { background: #BC2026; border-color: #BC2026; }
        .agent-avatar[data-agent="dev"], .agent-avatar[alt="DEV"] { background: #6366F1; border-color: #6366F1; }
        .agent-avatar[data-agent="exec"], .agent-avatar[alt="EXEC"] { background: #F59E0B; border-color: #F59E0B; }
        .agent-avatar[data-agent="coo"], .agent-avatar[alt="COO"] { background: #10B981; border-color: #10B981; }
        .agent-avatar[data-agent="cfo"], .agent-avatar[alt="CFO"] { background: #EAB308; border-color: #EAB308; }
        .agent-avatar[data-agent="cmp"], .agent-avatar[alt="CMP"] { background: #EC4899; border-color: #EC4899; }
        .agent-avatar[data-agent="family"], .agent-avatar[alt="Family"] { background: #14B8A6; border-color: #14B8A6; }
        .agent-avatar[data-agent="tax"], .agent-avatar[alt="TAX"] { background: #78716C; border-color: #78716C; }
        .agent-avatar[data-agent="sec"], .agent-avatar[alt="SEC"] { background: #3B82F6; border-color: #3B82F6; }
        
        .sidebar-footer {
            margin-top: auto; /* Push to bottom of sidebar */
            padding: 0 6px; /* No padding - use negative margin for alignment */
            transition: padding var(--transition-normal);
        }
        
        .sidebar:hover .sidebar-footer,
        .sidebar.pinned .sidebar-footer {
            padding: 4px var(--space-3);
        }
        
        .app-content {
            flex: 1;
            margin-left: 64px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            max-width: calc(100vw - 64px);
            overflow-x: hidden;
            transition: margin-left 0.2s ease, max-width 0.2s ease;
        }
        
        /* Adjust content when sidebar is expanded (pinned or hovered) */
        .sidebar.pinned ~ .app-content,
        .sidebar:hover ~ .app-content {
            margin-left: 200px;
            max-width: calc(100vw - 200px);
        }
        
        /* Page containers */
        .page {
            display: none;
            flex: 1;
        }
        
        .page.active {
            display: block;
        }
        
        /* Memory page specific styles */
        .memory-page {
            padding: var(--space-6);
        }
        
        .memory-page .page-header {
            margin-bottom: var(--space-6);
        }
        
        .memory-page .page-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        
        .memory-page .page-subtitle {
            color: var(--text-secondary);
            margin-top: var(--space-2);
        }
        
        .memory-search-bar {
            display: flex;
            gap: var(--space-3);
            margin-bottom: var(--space-6);
        }
        
        .memory-search-bar input {
            flex: 1;
            max-width: 400px;
        }
        
        .sync-status {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: 13px;
            color: var(--text-muted);
        }
        
        .sync-status.syncing {
            color: var(--warning);
        }
        
        .sync-status.synced {
            color: var(--success);
        }

        /* =================== CHAT PAGE STYLES =================== */
        
        /* Chat/system pages: below header, no scroll on body */
        #page-chat,
        #page-system {
            position: fixed;
            top: 60px; /* header height */
            left: 64px; /* sidebar collapsed width */
            right: 0;
            bottom: 0;
            overflow: hidden;
            z-index: 50;
        }
        
        /* Adjust for pinned/hovered sidebar */
        .sidebar.pinned ~ .app-content #page-chat,
        .sidebar.pinned ~ .app-content #page-system,
        .sidebar:hover ~ .app-content #page-chat,
        .sidebar:hover ~ .app-content #page-system {
            left: 200px;
        }
        
        .chat-page-wrapper {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            position: relative;
            overflow: hidden;
        }
        
        /* Hide footer on chat/system/dashboard pages (full viewport layouts) */
        body:has(#page-chat.active) .footer,
        body:has(#page-system.active) .footer,
        body:has(#page-dashboard.active) .footer {
            display: none;
        }
        
        /* Minimal header - just status */
        .chat-page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3) var(--space-5);
            background: var(--surface-1);
            border-bottom: 1px solid var(--border-default);
            flex-shrink: 0;
        }
        
        .chat-page-title {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        /* Session dropdown menu */
        .session-dropdown-menu {
            position: absolute;
            top: calc(100% + 4px);
            right: 0;
            background: var(--surface-1);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 280px;
            max-width: 320px;
            padding: 4px 0;
        }

        .session-dropdown-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 10px 12px;
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 13px;
            text-align: left;
            transition: background 0.15s;
            border-bottom: 1px solid var(--border-default);
        }

        .session-dropdown-item:last-child {
            border-bottom: none;
        }

        .session-dropdown-item:hover {
            background: var(--surface-2);
        }

        .session-dropdown-item.active {
            background: var(--accent-color);
            color: white;
        }

        .session-dropdown-item.active .session-meta,
        .session-dropdown-item.active .session-model {
            color: rgba(255,255,255,0.7);
        }

        .session-info {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 0;
        }

        .session-name {
            font-weight: 600;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .session-meta {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .session-model {
            font-size: 10px;
            color: var(--text-muted);
            background: var(--surface-2);
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }

        .session-dropdown-item.active .session-model {
            background: rgba(255,255,255,0.2);
        }

        .session-actions {
            display: flex;
            align-items: center;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .session-dropdown-item:hover .session-actions {
            opacity: 1;
        }

        .session-edit-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            color: var(--text-muted);
            font-size: 12px;
            line-height: 1;
        }

        .session-edit-btn:hover {
            background: var(--surface-elevated);
            color: var(--text-primary);
        }

        .session-dropdown-item.active .session-edit-btn:hover {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .chat-page-title h1 {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
            color: var(--text-primary);
        }
        
        .chat-page-status {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .chat-page-actions {
            display: flex;
            gap: var(--space-2);
        }
        
        .chat-page-actions .btn {
            font-size: 13px;
            padding: var(--space-2) var(--space-3);
        }
        
        /* Messages container - takes remaining space, only this scrolls */
        .chat-page-messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: var(--space-4) var(--space-5);
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.08) 0%, rgba(27, 34, 50, 0.4) 100%);
            background-attachment: fixed;
            scroll-behavior: auto;
            min-height: 0; /* Important for flex child scrolling */
        }
        
        .chat-page-messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-page-messages::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .chat-page-messages::-webkit-scrollbar-thumb {
            background: var(--border-default);
            border-radius: 3px;
        }
        
        .chat-page-messages::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
        
        /* Fixed input area at bottom */
        .chat-page-input-area {
            flex-shrink: 0;
            background: var(--surface-1);
            border-top: 1px solid var(--border-default);
            padding: 8px 16px; /* Match sidebar footer padding */
        }
        
        .chat-page-input-container {
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }
        
        .chat-page-input-row {
            display: flex;
            gap: var(--space-2);
            align-items: flex-end;
            background: var(--surface-2);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            padding: 4px 8px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .chat-page-input-row:focus-within {
            border-color: var(--brand-red);
            box-shadow: 0 0 0 3px rgba(188, 32, 38, 0.1);
        }
        
        .chat-page-input-row textarea {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            font-size: 14px;
            color: var(--text-primary);
            padding: 6px 8px;
            min-height: 32px;
            max-height: 150px;
            line-height: 1.5;
            resize: none;
            overflow-y: auto;
        }
        
        .chat-page-input-row textarea::placeholder {
            color: var(--text-muted);
        }
        
        .chat-page-input-row .btn {
            flex-shrink: 0;
        }
        
        .chat-page-input-row .btn-ghost {
            padding: var(--space-2);
            font-size: 18px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        .chat-page-input-row .btn-ghost:hover {
            opacity: 1;
            background: transparent;
        }
        
        #chat-page-image-preview {
            margin-bottom: var(--space-3);
            padding: var(--space-2);
            background: var(--surface-2);
            border-radius: var(--radius-md);
        }
        
        #chat-page-image-preview.visible {
            display: flex !important;
            flex-wrap: wrap;
            gap: var(--space-2);
        }
        
        /* Message bubbles in chat page */
        .chat-page-message {
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .chat-page-message.user {
            flex-direction: row-reverse;
            justify-content: flex-start;
        }
        
        .chat-page-message.solobot,
        .chat-page-message.system {
            justify-content: flex-start;
        }
        
        /* Chat avatars */
        .chat-page-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: var(--surface-2);
            border: 2px solid var(--border-default);
        }
        
        .chat-page-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .chat-page-avatar.user-avatar {
            background: linear-gradient(135deg, var(--brand-red) 0%, #8B1419 100%);
            color: white;
            font-weight: 600;
            font-size: 14px;
            border-color: var(--brand-red);
        }
        
        /* Chat page agent-specific avatar colors */
        .chat-page-avatar[data-agent="main"] { background: #BC2026; border-color: #BC2026; }
        .chat-page-avatar[data-agent="dev"] { background: #6366F1; border-color: #6366F1; }
        .chat-page-avatar[data-agent="exec"] { background: #F59E0B; border-color: #F59E0B; }
        .chat-page-avatar[data-agent="coo"] { background: #10B981; border-color: #10B981; }
        .chat-page-avatar[data-agent="cfo"] { background: #EAB308; border-color: #EAB308; }
        .chat-page-avatar[data-agent="cmp"] { background: #EC4899; border-color: #EC4899; }
        .chat-page-avatar[data-agent="family"] { background: #14B8A6; border-color: #14B8A6; }
        .chat-page-avatar[data-agent="tax"] { background: #78716C; border-color: #78716C; }
        .chat-page-avatar[data-agent="sec"] { background: #3B82F6; border-color: #3B82F6; }
        
        .chat-page-bubble {
            max-width: 70%;
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-lg);
            position: relative;
        }
        
        .chat-page-message.user .chat-page-bubble {
            background: linear-gradient(135deg, var(--brand-red) 0%, #8B1419 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .chat-page-message.solobot .chat-page-bubble {
            background: linear-gradient(135deg, #1B2232 0%, #2a3548 100%);
            border: 1px solid rgba(169, 178, 188, 0.2);
            border-bottom-left-radius: 4px;
            color: #ffffff;
        }
        
        .chat-page-message.system .chat-page-bubble {
            background: var(--warning-muted);
            border: 1px solid rgba(234, 179, 8, 0.3);
            font-size: 13px;
        }
        
        .chat-page-message.streaming .chat-page-bubble {
            opacity: 0.9;
            border-color: var(--brand-red);
        }
        
        .chat-page-bubble-header {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-2);
            font-size: 12px;
        }
        
        .chat-page-message.user .chat-page-bubble-header {
            justify-content: flex-end;
            color: rgba(255,255,255,0.7);
        }
        
        .chat-page-message.solobot .chat-page-bubble-header .chat-page-sender {
            color: var(--success);
            font-weight: 500;
        }
        
        .chat-page-message.user .chat-page-bubble-header .chat-page-sender {
            color: rgba(255,255,255,0.9);
        }
        
        .chat-page-bubble-time {
            color: var(--text-muted);
            font-size: 11px;
        }
        
        .chat-page-message.solobot .chat-page-bubble-time {
            color: rgba(169, 178, 188, 0.7);
        }
        
        .chat-page-message.user .chat-page-bubble-time {
            color: rgba(255,255,255,0.5);
        }
        
        .chat-page-bubble-content {
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            cursor: text;
        }
        
        /* Message action buttons - show on hover */
        .chat-page-bubble-actions {
            position: absolute;
            top: 4px;
            right: 4px;
            display: flex;
            gap: 2px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s ease, pointer-events 0s 0.15s;
        }
        
        .chat-page-bubble:hover .chat-page-bubble-actions {
            opacity: 1;
            pointer-events: auto;
            transition: opacity 0.15s ease, pointer-events 0s;
        }
        
        .chat-action-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }
        
        .chat-action-btn:hover {
            background: rgba(0, 0, 0, 0.5);
            transform: scale(1.1);
        }
        
        .chat-action-btn.copied {
            background: var(--success);
            color: white;
        }
        
        /* Typing indicator animation */
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 8px 12px;
            background: var(--surface-2);
            border-radius: var(--radius-md);
            margin-left: 48px;
        }
        
        .typing-indicator .dot {
            width: 8px;
            height: 8px;
            background: var(--brand-red);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out both;
        }
        
        .typing-indicator .dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator .dot:nth-child(2) { animation-delay: -0.16s; }
        .typing-indicator .dot:nth-child(3) { animation-delay: 0s; }
        
        @keyframes typingBounce {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        /* Command palette modal */
        .command-palette {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 560px;
            background: var(--surface-1);
            border: 1px solid var(--border-strong);
            border-radius: var(--radius-lg);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            z-index: 2000;
            overflow: hidden;
            display: none;
        }
        
        .command-palette.visible {
            display: block;
            animation: paletteIn 0.15s ease-out;
        }
        
        @keyframes paletteIn {
            from { opacity: 0; transform: translateX(-50%) scale(0.95); }
            to { opacity: 1; transform: translateX(-50%) scale(1); }
        }
        
        .command-palette-input {
            width: 100%;
            padding: 16px 20px;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 16px;
            border-bottom: 1px solid var(--border-default);
        }
        
        .command-palette-input:focus {
            outline: none;
        }
        
        .command-palette-input::placeholder {
            color: var(--text-muted);
        }
        
        .command-palette-results {
            max-height: 320px;
            overflow-y: auto;
        }
        
        .command-palette-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.1s;
        }
        
        .command-palette-item:hover,
        .command-palette-item.selected {
            background: var(--surface-2);
        }
        
        .command-palette-item-icon {
            font-size: 20px;
            width: 28px;
            text-align: center;
        }
        
        .command-palette-item-text {
            flex: 1;
        }
        
        .command-palette-item-title {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .command-palette-item-desc {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .command-palette-shortcut {
            font-size: 11px;
            padding: 2px 6px;
            background: var(--surface-3);
            border-radius: 4px;
            color: var(--text-muted);
        }
        
        .command-palette-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1999;
            display: none;
        }
        
        .command-palette-backdrop.visible {
            display: block;
        }
        
        /* Session search input */
        .session-search {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-default);
        }
        
        .session-search input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            background: var(--surface-2);
            color: var(--text-primary);
            font-size: 13px;
        }
        
        .session-search input:focus {
            outline: none;
            border-color: var(--brand-red);
        }
        
        .session-search input::placeholder {
            color: var(--text-muted);
        }
        
        /* Keyboard shortcut hint in chat input */
        .input-hint {
            position: absolute;
            right: 60px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 11px;
            color: var(--text-muted);
            opacity: 0.6;
            pointer-events: none;
        }
        
        .chat-page-bubble-image {
            max-width: 250px;
            max-height: 200px;
            border-radius: var(--radius-md);
            margin-bottom: var(--space-2);
            cursor: pointer;
            transition: transform 0.2s;
            object-fit: cover;
            border: 1px solid var(--border-default);
        }
        
        .chat-page-bubble-image:hover {
            transform: scale(1.02);
        }
        
        /* Image preview thumbnails in input area */
        .image-preview-wrapper img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-default);
        }
        
        /* Empty state */
        .chat-page-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            text-align: center;
            padding: var(--space-8);
        }
        
        .chat-page-empty-icon {
            font-size: 48px;
            margin-bottom: var(--space-4);
            opacity: 0.5;
        }
        
        .chat-page-empty-text {
            font-size: 15px;
            max-width: 300px;
        }
        
        .chat-page-empty a {
            color: var(--brand-red);
            text-decoration: none;
        }
        
        .chat-page-empty a:hover {
            text-decoration: underline;
        }
        
        /* New message indicator */
        .chat-page-new-message-indicator {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--brand-red);
            color: white;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-full);
            font-size: 13px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: opacity 0.2s, transform 0.2s;
            z-index: 10;
        }
        
        .chat-page-new-message-indicator:hover {
            transform: translateX(-50%) scale(1.05);
        }
        
        .chat-page-new-message-indicator.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        /* Floating scroll to bottom button */
        .scroll-to-bottom-btn {
            position: absolute;
            bottom: 100px;
            right: 24px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            border: none;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .scroll-to-bottom-btn:hover {
            transform: scale(1.1);
            background: var(--accent-hover);
        }
        .scroll-to-bottom-btn.hidden {
            opacity: 0;
            pointer-events: none;
            transform: scale(0.8);
        }

        /* =================== SYSTEM PAGE STYLES =================== */
        .system-message {
            display: flex;
            margin-bottom: var(--space-3);
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            justify-content: flex-start;
        }

        .system-bubble {
            max-width: 90%;
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-lg);
            background: rgba(27, 34, 50, 0.3); /* Dark Navy Blue #1B2232 with opacity */
            border: 1px solid rgba(188, 32, 38, 0.3); /* Deep Red #BC2026 with opacity */
        }

        .system-bubble-header {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-2);
            font-size: 12px;
        }

        .system-sender {
            color: #BC2026; /* Deep Red brand color */
            font-weight: 500;
        }

        .system-bubble-time {
            color: #A9B2BC; /* Cool Light Grey brand color */
            font-size: 11px;
        }

        .system-bubble-content {
            font-size: 13px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #A9B2BC; /* Cool Light Grey brand color */
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        }

        /* =================== FOCUS TIMER STYLES =================== */
        .focus-timer {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-1) var(--space-3);
            background: var(--surface-2);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-full);
            font-size: 13px;
            font-weight: 500;
            margin-right: var(--space-4);
        }
        .focus-timer.active {
            background: var(--success-muted);
            border-color: var(--success);
            color: var(--success);
        }
        .focus-timer.break {
            background: var(--warning-muted);
            border-color: var(--warning);
            color: var(--warning);
        }
        .focus-timer-display {
            font-family: 'SF Mono', 'Monaco', monospace;
            font-size: 14px;
            min-width: 50px;
            text-align: center;
        }
        .focus-timer-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px;
            color: inherit;
            display: flex;
            align-items: center;
            opacity: 0.8;
        }
        .focus-timer-btn:hover {
            opacity: 1;
        }
        .focus-timer-sessions {
            font-size: 11px;
            color: var(--text-muted);
            margin-left: var(--space-1);
        }

        /* =================== BENTO GRID DASHBOARD STYLES =================== */
        /* Dashboard page uses a fixed viewport bento grid layout */
        #page-dashboard {
            position: fixed;
            top: 60px; /* header height */
            left: 64px; /* sidebar collapsed width */
            right: 0;
            bottom: 0;
            overflow: hidden;
            z-index: 50;
            padding: var(--space-4);
        }

        /* Adjust for pinned/hovered sidebar */
        .sidebar.pinned ~ .app-content #page-dashboard,
        .sidebar:hover ~ .app-content #page-dashboard {
            left: 200px;
        }

        /* Bento grid container */
        .bento-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            grid-template-rows: 1.5fr 0.8fr 0.7fr;
            gap: var(--space-4);
            height: 100%;
            width: 100%;
        }

        /* Grid cell placement */
        .bento-task-board {
            grid-column: 1;
            grid-row: 1 / 3; /* span first two rows */
        }

        .bento-quick-stats {
            grid-column: 1;
            grid-row: 3;
        }

        .bento-terminal {
            grid-column: 2;
            grid-row: 1;
        }

        .bento-activity {
            grid-column: 2;
            grid-row: 2;
        }

        .bento-notes {
            grid-column: 2;
            grid-row: 3;
        }

        .bento-chat {
            grid-column: 3;
            grid-row: 1 / 4; /* span all three rows */
        }

        /* Tablet layout (2 columns) */
        @media (max-width: 1200px) {
            .bento-grid {
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto auto auto auto auto;
            }

            .bento-task-board {
                grid-column: 1 / 3;
                grid-row: 1;
                min-height: 400px;
            }

            .bento-quick-stats {
                grid-column: 1 / 3;
                grid-row: 2;
            }

            .bento-terminal {
                grid-column: 1;
                grid-row: 3;
                min-height: 300px;
            }

            .bento-chat {
                grid-column: 2;
                grid-row: 3 / 6; /* span multiple rows */
                min-height: 500px;
            }

            .bento-activity {
                grid-column: 1;
                grid-row: 4;
                min-height: 250px;
            }

            .bento-notes {
                grid-column: 1;
                grid-row: 5;
                min-height: 250px;
            }
        }

        /* Mobile layout (1 column) */
        @media (max-width: 768px) {
            .bento-grid {
                grid-template-columns: 1fr;
                grid-template-rows: auto;
                overflow-y: auto;
                height: auto;
                min-height: 100%;
            }

            .bento-task-board,
            .bento-quick-stats,
            .bento-terminal,
            .bento-activity,
            .bento-notes,
            .bento-chat {
                grid-column: 1;
                grid-row: auto;
            }
        }

        /* Bento widget card */
        .bento-widget {
            background: var(--surface-1);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0; /* Important for flex child scrolling */
        }

        /* Widget header */
        .bento-widget-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-3) var(--space-4);
            border-bottom: 1px solid var(--border-default);
            background: var(--surface-1);
            flex-shrink: 0;
        }

        .bento-widget-title {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .bento-widget-title svg {
            width: 18px;
            height: 18px;
            color: var(--brand-red);
        }

        .bento-widget-actions {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        /* Widget content - scrollable */
        .bento-widget-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: var(--space-4);
            min-height: 0; /* Important for flex child scrolling */
        }

        .bento-widget-content::-webkit-scrollbar {
            width: 6px;
        }

        .bento-widget-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .bento-widget-content::-webkit-scrollbar-thumb {
            background: var(--border-default);
            border-radius: 3px;
        }

        .bento-widget-content::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* =================== QUICK STATS STYLES (Bento Version) =================== */
        .quick-stats-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-3);
        }

        .quick-stats-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: var(--space-3);
        }

        @media (max-width: 1400px) {
            .quick-stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .quick-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .stat-item {
            text-align: center;
            padding: var(--space-3);
            background: var(--surface-2);
            border-radius: var(--radius-md);
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
        }

        .stat-value.brand {
            color: var(--brand-red);
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: var(--space-1);
        }

        /* Task board inside bento widget */
        .bento-widget.bento-task-board .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-3);
            height: 100%;
        }

        .bento-widget.bento-task-board .column {
            background: var(--surface-2);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .bento-widget.bento-task-board .drop-zone {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        /* =================== KEYBOARD SHORTCUTS MODAL =================== */
        .shortcuts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-4);
        }
        @media (max-width: 600px) {
            .shortcuts-grid {
                grid-template-columns: 1fr;
            }
        }
        .shortcut-group {
            margin-bottom: var(--space-4);
        }
        .shortcut-group-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--brand-red);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--space-2);
        }
        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-2) 0;
            border-bottom: 1px solid var(--border-subtle);
        }
        .shortcut-item:last-child {
            border-bottom: none;
        }
        .shortcut-keys {
            display: flex;
            gap: 4px;
        }
        .shortcut-key {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            height: 24px;
            padding: 0 6px;
            background: var(--surface-3);
            border: 1px solid var(--border-default);
            border-radius: 4px;
            font-family: 'SF Mono', 'Monaco', monospace;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
        }
        .shortcut-desc {
            font-size: 13px;
            color: var(--text-secondary);
        }
        .shortcuts-hint {
            position: fixed;
            bottom: var(--space-4);
            right: var(--space-4);
            background: var(--surface-2);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            padding: var(--space-2) var(--space-3);
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: var(--space-2);
            z-index: 100;
            opacity: 0.7;
            transition: opacity var(--transition-fast);
        }
        .shortcuts-hint:hover {
            opacity: 1;
            cursor: pointer;
        }

        }
    </style>
</head>
<body>

    <!-- App Layout with Sidebar -->
    <div class="app-layout">
    
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <button class="sidebar-toggle" onclick="toggleSidebarPin()" title="Pin sidebar">
            <span id="sidebar-pin-icon">🔓</span>
        </button>
        <div class="sidebar-logo">
            <img src="/solobot-avatar.png" alt="SoLoBot" class="sidebar-logo-img">
        </div>
        
        <nav class="sidebar-nav">
            <a class="sidebar-item active" onclick="showPage('dashboard')" data-page="dashboard">
                <span class="sidebar-item-icon">🏠</span>
                <span class="sidebar-item-text">Dashboard</span>
            </a>
            <a class="sidebar-item" onclick="showPage('memory')" data-page="memory">
                <span class="sidebar-item-icon">🧠</span>
                <span class="sidebar-item-text">Memory</span>
            </a>
            <a class="sidebar-item" onclick="showPage('chat')" data-page="chat">
                <span class="sidebar-item-icon">💬</span>
                <span class="sidebar-item-text">Chat</span>
            </a>
            <a class="sidebar-item" onclick="showPage('system')" data-page="system">
                <span class="sidebar-item-icon">📟</span>
                <span class="sidebar-item-text">System</span>
            </a>
            <a class="sidebar-item" onclick="showPage('products')" data-page="products">
                <span class="sidebar-item-icon">📦</span>
                <span class="sidebar-item-text">Products</span>
            </a>

            <div class="sidebar-section">
                <div class="sidebar-section-title">Agents</div>
                <div class="sidebar-agent" data-agent="main">
                    <img class="agent-avatar" src="/avatars/solobot.png" alt="Main">
                    <span class="sidebar-item-text">SoLoBot (Main)</span>
                </div>
                <div class="sidebar-agent" data-agent="exec">
                    <img class="agent-avatar" src="/avatars/exec.png" alt="EXEC">
                    <span class="sidebar-item-text">SoLoBot-EXEC</span>
                </div>
                <div class="sidebar-agent" data-agent="coo">
                    <img class="agent-avatar" src="/avatars/coo.png" alt="COO">
                    <span class="sidebar-item-text">SoLoBot-COO</span>
                </div>
                <div class="sidebar-agent" data-agent="cfo">
                    <img class="agent-avatar" src="/avatars/cfo.png" alt="CFO">
                    <span class="sidebar-item-text">SoLoBot-CFO</span>
                </div>
                <div class="sidebar-agent" data-agent="cmp">
                    <img class="agent-avatar" src="/avatars/cmp.png" alt="CMP">
                    <span class="sidebar-item-text">SoLoBot-CMP</span>
                </div>
                <div class="sidebar-agent" data-agent="dev">
                    <img class="agent-avatar" src="/avatars/dev.png" alt="DEV">
                    <span class="sidebar-item-text">SoLoBot-DEV</span>
                </div>
                <div class="sidebar-agent" data-agent="family">
                    <img class="agent-avatar" src="/avatars/family.png" alt="Family">
                    <span class="sidebar-item-text">SoLoBot-Family</span>
                </div>
                <div class="sidebar-agent" data-agent="tax">
                    <img class="agent-avatar" src="/avatars/tax.svg" alt="TAX">
                    <span class="sidebar-item-text">SoLoBot-Tax</span>
                </div>
                <div class="sidebar-agent" data-agent="sec">
                    <img class="agent-avatar" src="/avatars/sec.svg" alt="SEC">
                    <span class="sidebar-item-text">SoLoBot-SEC</span>
                </div>
            </div>
        </nav>
        
        <div class="sidebar-footer">
            <a class="sidebar-item" onclick="openSettingsModal()">
                <span class="sidebar-item-icon">🔧</span>
                <span class="sidebar-item-text">Settings</span>
            </a>
        </div>
    </aside>
    
    <!-- Main App Content -->
    <div class="app-content">
    
    <!-- Header -->
    <header class="header">
        <div class="container header-inner">
            <div class="logo">
                <span style="font-size: 1.25rem; font-weight: 600;">SoLoBot</span>
            </div>

            <div class="header-status">
                <!-- Focus Timer -->
                <div id="focus-timer" class="focus-timer" title="Focus Timer - Click to start a 25-min focus session">
                    <button class="focus-timer-btn" onclick="toggleFocusTimer()" title="Start/Pause">
                        <svg id="focus-play-icon" style="width: 16px; height: 16px;" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                        <svg id="focus-pause-icon" style="width: 16px; height: 16px; display: none;" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                        </svg>
                    </button>
                    <span class="focus-timer-display" id="focus-timer-display">25:00</span>
                    <button class="focus-timer-btn" onclick="resetFocusTimer()" title="Reset">
                        <svg style="width: 14px; height: 14px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                    </button>
                    <span class="focus-timer-sessions" id="focus-sessions">0 🎯</span>
                </div>

                <div class="status-chip">
                    <div id="status-indicator" class="status-dot success pulse"></div>
                    <span id="status-text">IDLE</span>
                </div>

                <div class="header-meta">
                    <div>
                        Provider: 
                        <select id="provider-select" class="header-select" onchange="updateProviderDisplay()">
                            <!-- Populated dynamically from /api/models/list -->
                        </select>
                    </div>
                    <div>
                        Model: 
                        <select id="model-select" class="header-select" onchange="changeSessionModel()" title="Change model for this session">
                            <!-- Populated dynamically -->
                        </select>
                    </div>
                </div>

                <button class="theme-toggle" onclick="openSettingsModal()" title="Settings">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                </button>

                <button class="theme-toggle" onclick="openSettingsModal(); scrollToThemePicker();" title="Change theme">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 18px; height: 18px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Sub-agent Banner -->
    <div id="subagent-banner" class="hidden" style="background: var(--warning-muted); border-bottom: 1px solid var(--border-default); padding: var(--space-2) 0;">
        <div class="container flex items-center gap-2" style="font-size: 13px;">
            <svg class="animate-spin" style="width: 16px; height: 16px; color: var(--warning);" fill="none" viewBox="0 0 24 24">
                <circle style="opacity: 0.25;" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path style="opacity: 0.75;" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span style="color: var(--warning); font-weight: 500;">Sub-agent active:</span>
            <span id="subagent-task">Researching...</span>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main">
        
        <!-- =================== DASHBOARD PAGE (BENTO GRID) =================== -->
        <div id="page-dashboard" class="page active">
            <div class="bento-grid">

                <!-- Task Board Widget -->
                <div class="bento-widget bento-task-board">
                    <div class="bento-widget-header">
                        <div class="bento-widget-title">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                            </svg>
                            Task Board
                        </div>
                        <div class="bento-widget-actions">
                            <button onclick="openArchiveModal()" class="btn btn-ghost" style="padding: 4px 8px; font-size: 12px;">
                                <span>📦</span>
                                <span id="archive-badge" class="badge badge-error hidden" style="margin-left: 4px;">0</span>
                            </button>
                            <button onclick="syncFromVPS()" class="btn btn-ghost" title="Pull latest state from VPS" style="padding: 4px 8px; font-size: 12px;">
                                <span>🔄</span>
                            </button>
                        </div>
                    </div>
                    <div class="bento-widget-content">
                        <div class="grid-3">
                            <!-- To-Do Column -->
                            <div class="column">
                                <div class="column-header">
                                    <h3 class="column-title">
                                        <span class="status-dot idle"></span>
                                        To-Do
                                        <span id="todo-count" class="badge badge-default">0</span>
                                    </h3>
                                    <button onclick="openAddTask('todo')" class="btn-icon" title="Add task">
                                        <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                        </svg>
                                    </button>
                                </div>
                                <div id="todo-tasks" class="drop-zone space-y-2"
                                     ondragover="handleDragOver(event)"
                                     ondragenter="handleDragEnter(event, 'todo')"
                                     ondragleave="handleDragLeave(event, 'todo')"
                                     ondrop="handleDrop(event, 'todo')">
                                </div>
                            </div>

                            <!-- In Progress Column -->
                            <div class="column">
                                <div class="column-header">
                                    <h3 class="column-title">
                                        <span class="status-dot warning"></span>
                                        In Progress
                                        <span id="progress-count" class="badge badge-default">0</span>
                                    </h3>
                                </div>
                                <div id="progress-tasks" class="drop-zone space-y-2"
                                     ondragover="handleDragOver(event)"
                                     ondragenter="handleDragEnter(event, 'progress')"
                                     ondragleave="handleDragLeave(event, 'progress')"
                                     ondrop="handleDrop(event, 'progress')">
                                </div>
                            </div>

                            <!-- Done Column -->
                            <div class="column">
                                <div class="column-header">
                                    <h3 class="column-title">
                                        <span class="status-dot success"></span>
                                        Done
                                        <span id="done-count" class="badge badge-default">0</span>
                                    </h3>
                                    <button onclick="clearDone()" class="btn-icon" title="Clear done" style="font-size: 11px; color: var(--text-muted);">
                                        Clear
                                    </button>
                                </div>
                                <div id="done-tasks" class="drop-zone space-y-2"
                                     ondragover="handleDragOver(event)"
                                     ondragenter="handleDragEnter(event, 'done')"
                                     ondragleave="handleDragLeave(event, 'done')"
                                     ondrop="handleDrop(event, 'done')">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats Widget -->
                <div class="bento-widget bento-quick-stats">
                    <div class="bento-widget-content" style="padding: var(--space-3);">
                        <div class="quick-stats-header">
                            <div class="bento-widget-title" style="margin-bottom: 0;">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                </svg>
                                Quick Stats
                            </div>
                            <span id="stats-last-updated" style="font-size: 10px; color: var(--text-muted);">Updated just now</span>
                        </div>
                        <div class="quick-stats-grid">
                            <div class="stat-item">
                                <div class="stat-value brand" id="stat-tasks-done">0</div>
                                <div class="stat-label">Tasks Done</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="stat-focus-sessions">0</div>
                                <div class="stat-label">Focus</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="stat-messages">0</div>
                                <div class="stat-label">Messages</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="stat-streak">0</div>
                                <div class="stat-label">Streak 🔥</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="stat-uptime">--</div>
                                <div class="stat-label">Session</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Terminal Widget -->
                <div class="bento-widget bento-terminal">
                    <div class="terminal" id="console-section" style="height: 100%; display: flex; flex-direction: column; border: none; border-radius: 0;">
                        <div class="terminal-header">
                            <div class="flex items-center gap-3">
                                <div class="terminal-dots">
                                    <span class="red"></span>
                                    <span class="yellow"></span>
                                    <span class="green"></span>
                                </div>
                                <span class="terminal-title">Terminal</span>
                                <span id="console-status-badge" class="badge badge-success">IDLE</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="clearConsole()" class="btn-icon" style="font-size: 11px;">Clear</button>
                            </div>
                        </div>
                        <div id="console-output" class="terminal-output" style="flex: 1; overflow-y: auto;">
                            <div class="cmd">$ solobot --init</div>
                            <div class="info">Ready for commands...</div>
                        </div>
                    </div>
                </div>

                <!-- Activity Log Widget -->
                <div class="bento-widget bento-activity">
                    <div class="bento-widget-header">
                        <div class="bento-widget-title">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Activity
                        </div>
                    </div>
                    <div class="bento-widget-content">
                        <div id="activity-log" class="activity-list">
                        </div>
                    </div>
                </div>

                <!-- Notes Widget -->
                <div class="bento-widget bento-notes">
                    <div class="bento-widget-header">
                        <div class="bento-widget-title">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                            Notes
                        </div>
                    </div>
                    <div class="bento-widget-content">
                        <div class="notes-input" style="margin-bottom: var(--space-3);">
                            <input type="text" id="note-input" class="input flex-1" placeholder="Leave a note for SoLoBot..." style="font-size: 13px;">
                            <button onclick="addNote()" class="btn btn-primary" style="padding: 6px 12px; font-size: 13px;">Add</button>
                        </div>
                        <div id="notes-list" class="notes-list">
                        </div>
                    </div>
                </div>

                <!-- Chat Widget -->
                <div class="bento-widget bento-chat">
                    <div class="bento-widget-header">
                        <div class="bento-widget-title">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                            </svg>
                            Chat
                            <div class="flex items-center gap-2" style="margin-left: auto;">
                                <span id="current-session-name" style="font-size: 11px; color: var(--accent-color); font-weight: 600; background: var(--surface-2); padding: 2px 6px; border-radius: 4px;">main</span>
                            </div>
                        </div>
                        <div class="bento-widget-actions">
                            <span id="gateway-status-dot" class="status-dot idle"></span>
                            <span id="gateway-status" style="font-size: 11px; color: var(--text-muted);">Disconnected</span>
                        </div>
                    </div>
                    <div style="flex: 1; display: flex; flex-direction: column; min-height: 0; overflow: hidden;">
                        <div id="chat-messages" class="chat-messages" style="flex: 1; overflow-y: auto; padding: var(--space-3);">
                            <div style="color: var(--text-muted); font-size: 12px; text-align: center; padding: var(--space-8) 0;">
                                🔌 Connect to Gateway in Settings to start chatting
                            </div>
                        </div>

                        <!-- Image Preview (supports multiple) -->
                        <div id="image-preview-container" class="image-preview-container">
                            <!-- Thumbnails rendered dynamically -->
                        </div>

                        <div class="chat-input-area" style="border-top: 1px solid var(--border-default); padding: var(--space-2);">
                            <label class="btn-icon" style="cursor: pointer;">
                                <input type="file" id="image-upload" accept="image/*" multiple class="hidden" onchange="handleImageSelect(event)">
                                <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                            </label>
                            <div class="voice-controls">
                                <button id="voice-input-btn" class="voice-btn" onclick="toggleVoiceInput()" title="Voice input">
                                    <svg id="voice-icon-mic" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                                    </svg>
                                    <svg id="voice-icon-stop" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: none; width: 16px; height: 16px;">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path>
                                    </svg>
                                </button>
                                <button class="voice-auto-send-toggle" onclick="toggleVoiceAutoSend()" title="Auto-send">⚡</button>
                            </div>
                            <input type="text" id="chat-input" class="input flex-1" placeholder="Message..."
                                   name="dashboard_chat_field_" 
                                   onkeypress="if(event.key==='Enter')sendChatMessage()"
                                   onpaste="handlePaste(event)"
                                   autocomplete="off"
                                   autocorrect="off"
                                   autocapitalize="off"
                                   spellcheck="false"
                                   data-lpignore="true"
                                   data-1p-ignore="true"
                                   data-form-type="other"
                                   style="font-size: 13px; padding: 6px 8px;">
                            <button onclick="sendChatMessage()" class="btn btn-primary" style="padding: 6px 12px; font-size: 13px;">Send</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Product Status (Hidden - moved out of main bento for now) -->
        <section class="section" style="display: none;">
            <h2 class="section-title">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                </svg>
                Product Status
            </h2>
            <div class="grid-4">
                <div class="product-card">
                    <div class="product-header">
                        <span class="product-name">SoLoLink</span>
                        <span class="status-dot success"></span>
                    </div>
                    <p class="product-desc">Link/widget tool</p>
                    <p class="product-meta">Last update: Active</p>
                </div>
                <div class="product-card">
                    <div class="product-header">
                        <span class="product-name">SoLoRecall</span>
                        <span class="status-dot warning"></span>
                    </div>
                    <p class="product-desc">AI productivity app</p>
                    <p class="product-meta">Last update: In dev</p>
                </div>
                    <div class="product-card">
                        <div class="product-header">
                            <span class="product-name">SoLoVoice</span>
                            <span class="status-dot success"></span>
                        </div>
                        <p class="product-desc">Voice/audio tool</p>
                        <p class="product-meta">Last update: Active</p>
                    </div>
                    <div class="product-card">
                        <div class="product-header">
                            <span class="product-name">SoLoFamilyPlan</span>
                            <span class="status-dot success"></span>
                        </div>
                        <p class="product-desc">Family organizer</p>
                        <p class="product-meta">Last update: Stable</p>
                    </div>
                    <div class="product-card">
                        <div class="product-header">
                            <span class="product-name">SoLoStandBy</span>
                            <span class="status-dot warning"></span>
                        </div>
                        <p class="product-desc">StandBy mode for Android</p>
                        <p class="product-meta">Last update: In Review</p>
                    </div>
                </div>
            </section>

        </div>
        </div>
        <!-- END DASHBOARD PAGE -->
        
        <!-- =================== MEMORY PAGE =================== -->
        <div id="page-memory" class="page">
            <div class="memory-page">
                <div class="page-header">
                    <h1 class="page-title">
                        🧠 Memory Files
                    </h1>
                    <p class="page-subtitle">
                        These are SoLoBot's live memory files. Edit them here and they'll sync back to the workspace.
                    </p>
                </div>
                
                <div class="memory-search-bar">
                    <input type="text" id="memory-search" class="input" placeholder="Search memory files..." oninput="renderMemoryFiles(this.value)">
                    <button class="btn btn-secondary" onclick="syncMemoryFilesNow()">
                        🔄 Sync Now
                    </button>
                    <div id="sync-status" class="sync-status">
                        <span class="status-dot success"></span>
                        Last synced: <span id="last-memory-sync">--</span>
                    </div>
                </div>
                
                <div id="memory-files-grid" class="docs-grid">
                    <!-- Memory files will be rendered here -->
                </div>
            </div>
        </div>
        <!-- END MEMORY PAGE -->
        
        <!-- =================== CHAT PAGE =================== -->
        <div id="page-chat" class="page">
            <div class="chat-page-wrapper">
                <!-- Chat Actions Bar -->
                <div class="chat-page-header">
                    <div class="chat-page-title">
                        <span id="chat-page-agent-name" style="font-size: 14px; font-weight: 600; color: var(--text-primary);"></span>
                        <span id="chat-page-status-dot" class="status-dot idle"></span>
                        <span id="chat-page-status-text">Disconnected</span>
                    </div>
                    <div class="chat-page-actions">
                        <div class="session-selector-wrapper" style="position: relative; display: inline-flex; align-items: center; margin-right: 8px;">
                            <span id="chat-page-session-name" style="font-size: 13px; color: var(--accent-color); font-weight: 600; background: var(--surface-elevated); padding: 4px 10px; border-radius: 6px; border: 1px solid var(--border-color);">main</span>
                            <button onclick="toggleChatPageSessionMenu()" class="btn btn-icon" style="padding: 4px; margin-left: 2px;" title="Switch session">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="chat-page-session-menu" class="hidden session-dropdown-menu" style="max-height: 300px; overflow-y: auto;">
                                <!-- Sessions populated dynamically -->
                            </div>
                        </div>
                        <button onclick="clearChatHistory()" class="btn btn-ghost" title="Clear chat">
                            🗑️
                        </button>
                    </div>
                </div>
                
                <!-- Messages Area -->
                <div id="chat-page-messages" class="chat-page-messages">
                    <!-- Messages rendered by JS -->
                </div>
                
                <!-- Floating scroll to bottom button -->
                <button id="scroll-to-bottom-btn" class="scroll-to-bottom-btn hidden" onclick="scrollChatToBottom()" title="Scroll to latest">
                    ↓
                </button>
                
                <!-- New message indicator (shown when scrolled up) -->
                <div id="chat-page-new-indicator" class="chat-page-new-message-indicator hidden" onclick="scrollChatToBottom()">
                    ↓ New messages
                </div>
                
                <!-- Fixed Input Area -->
                <div class="chat-page-input-area">
                    <div class="chat-page-input-container">
                        <!-- Image Preview (supports multiple) -->
                        <div id="chat-page-image-preview" class="hidden image-preview-container">
                            <!-- Thumbnails rendered dynamically -->
                        </div>
                        
                        <div class="chat-page-input-row">
                            <input type="file" id="chat-page-image-upload" accept="image/*" multiple class="hidden" onchange="handleChatPageImageSelect(event)">
                            <button onclick="document.getElementById('chat-page-image-upload').click()" class="btn btn-ghost" title="Attach image">
                                📎
                            </button>
                            <div class="voice-controls">
                                <button id="voice-input-btn-chatpage" class="voice-btn" onclick="toggleVoiceInputChatPage()" title="Voice input (click to speak, or hold spacebar)">
                                    <svg id="voice-icon-mic-chatpage" style="width:20px;height:20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                                    </svg>
                                    <svg id="voice-icon-stop-chatpage" style="width:20px;height:20px;display:none;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path>
                                    </svg>
                                </button>
                                <button class="voice-auto-send-toggle" onclick="toggleVoiceAutoSend()" title="Auto-send OFF (click to enable)">⚡</button>
                            </div>
                            <!-- Hidden decoy fields to trick password managers -->
                            <input type="text" name="fake_username_field" style="display:none;" tabindex="-1" aria-hidden="true">
                            <input type="password" name="fake_password_field" style="display:none;" tabindex="-1" aria-hidden="true">
                            <textarea id="chat-page-input" 
                                      name="chat_message_input_field_"
                                      placeholder="Message SoLoBot..." 
                                      onpaste="handleChatPagePaste(event)"
                                      autocomplete="off"
                                      autocorrect="off"
                                      autocapitalize="off"
                                      spellcheck="false"
                                      data-lpignore="true"
                                      data-form-type="other"
                                      data-1p-ignore="true"
                                      rows="1"></textarea>
                            <button onclick="sendChatPageMessage()" class="btn btn-primary">
                                Send
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- END CHAT PAGE -->

        <!-- =================== SYSTEM PAGE =================== -->
        <div id="page-system" class="page">
            <div class="chat-page-wrapper">
                <!-- Header -->
                <div class="chat-page-header">
                    <div class="chat-page-title">
                        <h1>📟 System Messages</h1>
                    </div>
                    <div class="chat-page-actions">
                        <button onclick="clearSystemHistory()" class="btn btn-ghost" title="Clear system messages">
                            🗑️
                        </button>
                    </div>
                </div>

                <!-- Messages Area -->
                <div id="system-page-messages" class="chat-page-messages">
                    <!-- System messages rendered by JS -->
                </div>
            </div>
        </div>
        <!-- END SYSTEM PAGE -->

        <!-- =================== PRODUCTS PAGE =================== -->
        <div id="page-products" class="page">
            <div class="container" style="padding: var(--space-6);">
                <div class="page-header" style="margin-bottom: var(--space-6);">
                    <h1 class="page-title" style="font-size: 24px; font-weight: 700;">
                        📦 SoLoVision Products
                    </h1>
                    <p class="page-subtitle" style="color: var(--text-secondary); margin-top: var(--space-2);">
                        Manage and monitor all SoLoVision products
                    </p>
                </div>
                <div id="products-page-grid" class="grid-3">
                    <!-- Products will be rendered here -->
                    <p style="color: var(--text-muted);">Expanded product management coming soon.</p>
                </div>
            </div>
        </div>
        <!-- END PRODUCTS PAGE -->

    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container footer-inner">
            <span>SoLoVision LLC © 2026</span>
            <div class="footer-status">
                <div class="live-indicator">
                    <span class="status-dot success pulse"></span>
                    <span>LIVE</span>
                </div>
                <span>Last sync: <span id="last-sync">--:--</span></span>
            </div>
        </div>
    </footer>

    <!-- Bulk Action Bar -->
    <div id="bulk-action-bar" class="bulk-action-bar">
        <span id="bulk-count" style="font-size: 13px; font-weight: 500;">0 selected</span>
        <button onclick="bulkMoveTo('todo')" class="btn btn-ghost">→ To-Do</button>
        <button onclick="bulkMoveTo('progress')" class="btn btn-ghost">→ In Progress</button>
        <button onclick="bulkMoveTo('done')" class="btn btn-ghost">→ Done</button>
        <button onclick="bulkMoveTo('archive')" class="btn btn-ghost">📦 Archive</button>
        <button onclick="clearSelection()" class="btn-icon">✕</button>
    </div>

    <!-- Add Task Modal -->
    <div id="add-task-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add New Task</h3>
                <button onclick="closeAddTask()" class="modal-close">✕</button>
            </div>
            <input type="text" id="new-task-title" class="input" placeholder="Task title..." style="margin-bottom: var(--space-4);">
            <div class="flex gap-2" style="margin-bottom: var(--space-4);">
                <button onclick="setTaskPriority(0)" id="priority-btn-0" class="btn btn-ghost flex-1" style="border-color: var(--brand-red); color: var(--brand-red);">P0</button>
                <button onclick="setTaskPriority(1)" id="priority-btn-1" class="btn btn-ghost flex-1" style="border-color: var(--warning); color: var(--warning);">P1</button>
                <button onclick="setTaskPriority(2)" id="priority-btn-2" class="btn btn-ghost flex-1" style="border-color: #3b82f6; color: #3b82f6;">P2</button>
            </div>
            <div class="form-actions">
                <button onclick="closeAddTask()" class="btn btn-ghost">Cancel</button>
                <button onclick="submitTask()" class="btn btn-primary">Add Task</button>
            </div>
        </div>
    </div>

    <!-- Task Action Modal -->
    <div id="task-action-modal" class="modal-overlay">
        <div class="modal" style="max-width: 360px;">
            <div class="modal-header">
                <div>
                    <h3 class="modal-title">Task Actions</h3>
                    <p id="action-modal-task-title" style="font-size: 13px; color: var(--text-muted); margin-top: var(--space-1); max-width: 250px;" class="truncate"></p>
                </div>
                <button onclick="closeActionModal()" class="modal-close">✕</button>
            </div>

            <div class="space-y-2" style="margin-bottom: var(--space-4);">
                <button id="action-move-todo" onclick="modalMoveTask('todo')" class="btn btn-ghost" style="width: 100%; justify-content: flex-start;">
                    <span class="status-dot idle"></span> Move to To-Do
                </button>
                <button id="action-move-progress" onclick="modalMoveTask('progress')" class="btn btn-ghost" style="width: 100%; justify-content: flex-start;">
                    <span class="status-dot warning"></span> Move to In Progress
                </button>
                <button id="action-move-done" onclick="modalMoveTask('done')" class="btn btn-ghost" style="width: 100%; justify-content: flex-start;">
                    <span class="status-dot success"></span> Move to Done
                </button>
                <button id="action-move-archive" onclick="modalMoveTask('archive')" class="btn btn-ghost" style="width: 100%; justify-content: flex-start;">
                    📦 Archive
                </button>
            </div>

            <div style="border-top: 1px solid var(--border-default); padding-top: var(--space-4);" class="space-y-2">
                <button onclick="modalEditTitle()" class="btn btn-ghost" style="width: 100%; justify-content: flex-start;">
                    ✏️ Edit Title
                </button>
                <button onclick="modalCyclePriority()" class="btn btn-ghost" style="width: 100%; justify-content: flex-start;">
                    🔄 <span id="action-priority-text">Change Priority (P1)</span>
                </button>
            </div>

            <div style="border-top: 1px solid var(--border-default); padding-top: var(--space-4); margin-top: var(--space-4);">
                <button onclick="modalDeleteTask()" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; color: var(--error);">
                    🗑️ Delete Task
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Title Modal -->
    <div id="edit-title-modal" class="modal-overlay">
        <div class="modal" style="max-width: 360px;">
            <div class="modal-header">
                <h3 class="modal-title">Edit Task Title</h3>
                <button onclick="closeEditTitleModal()" class="modal-close">✕</button>
            </div>
            <input type="text" id="edit-title-input" class="input" placeholder="Task title..." style="margin-bottom: var(--space-4);">
            <div class="form-actions">
                <button onclick="closeEditTitleModal()" class="btn btn-ghost">Cancel</button>
                <button onclick="saveEditedTitle()" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="confirm-delete-modal" class="modal-overlay">
        <div class="modal" style="max-width: 360px;">
            <div class="modal-header">
                <h3 class="modal-title">Delete Task?</h3>
                <button onclick="closeDeleteModal()" class="modal-close">✕</button>
            </div>
            <p id="delete-modal-task-title" style="font-size: 13px; color: var(--text-muted); margin-bottom: var(--space-4);" class="truncate"></p>
            <div class="form-actions">
                <button onclick="closeDeleteModal()" class="btn btn-ghost">Cancel</button>
                <button onclick="confirmDeleteTask()" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>
    
    <!-- Task Detail Modal (Trello-like) -->
    <div id="task-detail-modal" class="modal-overlay">
        <div class="modal" style="max-width: 600px; max-height: 85vh; display: flex; flex-direction: column;">
            <div class="modal-header" style="border-bottom: 1px solid var(--border-default);">
                <div style="flex: 1;">
                    <input type="text" id="task-detail-title" class="input" 
                           style="font-size: 18px; font-weight: 600; border: none; background: transparent; padding: 0; width: 100%;"
                           placeholder="Task title...">
                    <div style="display: flex; align-items: center; gap: var(--space-3); margin-top: var(--space-2);">
                        <span id="task-detail-status" class="badge">To-Do</span>
                        <span id="task-detail-priority" class="badge badge-primary">P1</span>
                        <span id="task-detail-date" style="font-size: 12px; color: var(--text-muted);"></span>
                    </div>
                </div>
                <button onclick="closeTaskDetailModal()" class="modal-close">✕</button>
            </div>
            
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: var(--space-4) var(--space-6);">
                <!-- Description -->
                <div style="margin-bottom: var(--space-5);">
                    <label style="font-size: 13px; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: var(--space-2);">
                        📝 Description
                    </label>
                    <textarea id="task-detail-description" 
                              class="input" 
                              placeholder="Add a more detailed description..."
                              style="min-height: 100px; resize: vertical; font-size: 14px; line-height: 1.6;"></textarea>
                </div>
                
                <!-- Attachments -->
                <div style="margin-bottom: var(--space-5);">
                    <label style="font-size: 13px; font-weight: 600; color: var(--text-secondary); display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                        📎 Attachments
                        <button onclick="document.getElementById('task-image-upload').click()" 
                                class="btn btn-ghost" style="font-size: 12px; padding: 4px 8px;">
                            + Add Image
                        </button>
                    </label>
                    <input type="file" id="task-image-upload" accept="image/*" class="hidden" onchange="handleTaskImageUpload(event)">
                    <div id="task-detail-images" style="display: flex; flex-wrap: wrap; gap: var(--space-3);">
                        <!-- Images rendered here -->
                        <div style="color: var(--text-muted); font-size: 13px;">No attachments yet</div>
                    </div>
                </div>
                
                <!-- Move/Priority Actions -->
                <div style="border-top: 1px solid var(--border-default); padding-top: var(--space-4);">
                    <label style="font-size: 13px; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: var(--space-2);">
                        ⚡ Actions
                    </label>
                    <div style="display: flex; flex-wrap: wrap; gap: var(--space-2);">
                        <button onclick="taskDetailMove('todo')" class="btn btn-ghost" style="font-size: 12px;">
                            <span class="status-dot idle"></span> To-Do
                        </button>
                        <button onclick="taskDetailMove('progress')" class="btn btn-ghost" style="font-size: 12px;">
                            <span class="status-dot warning"></span> In Progress
                        </button>
                        <button onclick="taskDetailMove('done')" class="btn btn-ghost" style="font-size: 12px;">
                            <span class="status-dot success"></span> Done
                        </button>
                        <button onclick="taskDetailCyclePriority()" class="btn btn-ghost" style="font-size: 12px;">
                            🔄 Priority
                        </button>
                        <button onclick="taskDetailDelete()" class="btn btn-ghost" style="font-size: 12px; color: var(--error);">
                            🗑️ Delete
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer" style="border-top: 1px solid var(--border-default); padding: var(--space-4) var(--space-6); display: flex; justify-content: flex-end; gap: var(--space-3);">
                <button onclick="closeTaskDetailModal()" class="btn btn-ghost">Close</button>
                <button onclick="saveTaskDetails()" class="btn btn-primary">💾 Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Memory File Viewer Modal -->
    <div id="memory-file-modal" class="modal-overlay">
        <div class="modal modal-lg" style="max-width: 1100px; height: 85vh; display: flex; flex-direction: column; padding: 0; overflow: hidden;">
            <div class="modal-header" style="flex-shrink: 0; padding: var(--space-4) var(--space-6); border-bottom: 1px solid var(--border-default);">
                <h3 class="modal-title" id="memory-file-title">Memory File</h3>
                <button onclick="closeMemoryModal()" class="modal-close">✕</button>
            </div>
            <div class="modal-body" style="flex: 1; display: flex; overflow: hidden; padding: 0; min-height: 0;">
                <!-- Editor panel -->
                <div style="flex: 1; display: flex; flex-direction: column; min-width: 0;">
                    <textarea id="memory-file-content" 
                        style="flex: 1; 
                               width: 100%;
                               min-height: 0;
                               font-family: 'SF Mono', 'Monaco', 'Consolas', monospace; 
                               font-size: 13px; 
                               line-height: 1.6; 
                               padding: var(--space-4) var(--space-6);
                               border: none;
                               resize: none;
                               background: var(--surface-2);
                               color: var(--text-primary);
                               outline: none;"
                        placeholder="Loading..."></textarea>
                </div>
                <!-- Version history sidebar -->
                <div class="version-history-panel" style="width: 280px; flex-shrink: 0; border-left: 1px solid var(--border-default); background: var(--surface-1); display: flex; flex-direction: column;">
                    <div style="padding: var(--space-3) var(--space-4); border-bottom: 1px solid var(--border-default); font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                        📜 Version History
                    </div>
                    <div id="version-history-list" style="flex: 1; overflow-y: auto; padding: var(--space-2);">
                        <div style="color: var(--text-muted); font-size: 12px; padding: var(--space-3);">No versions yet</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="flex-shrink: 0; padding: var(--space-4) var(--space-6); border-top: 1px solid var(--border-default); display: flex; justify-content: space-between;">
                <div style="font-size: 12px; color: var(--text-muted);">
                    💡 Changes are saved with version history
                </div>
                <div style="display: flex; gap: var(--space-2);">
                    <button onclick="closeMemoryModal()" class="btn btn-ghost">Close</button>
                    <button id="memory-save-btn" onclick="saveMemoryFile()" class="btn btn-primary">💾 Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Diff View Modal -->
    <div id="diff-modal" class="modal-overlay">
        <div class="modal" style="max-width: 95vw; width: 1400px; height: 85vh; display: flex; flex-direction: column; padding: 0; overflow: hidden;">
            <div class="modal-header" style="flex-shrink: 0; padding: var(--space-4) var(--space-6); border-bottom: 1px solid var(--border-default);">
                <h3 class="modal-title" id="diff-modal-title">Compare Versions</h3>
                <button onclick="closeDiffModal()" class="modal-close">✕</button>
            </div>
            <div class="modal-body" style="flex: 1; display: flex; overflow: hidden; padding: 0; min-height: 0;">
                <!-- Current Version -->
                <div style="flex: 1; display: flex; flex-direction: column; min-width: 0; border-right: 1px solid var(--border-default);">
                    <div style="padding: var(--space-3) var(--space-4); background: var(--surface-1); border-bottom: 1px solid var(--border-default); font-weight: 600; font-size: 13px;">
                        📄 Current Version
                    </div>
                    <div id="diff-current" style="flex: 1; overflow: auto; padding: var(--space-4); font-family: 'SF Mono', 'Monaco', 'Consolas', monospace; font-size: 13px; line-height: 1.6; white-space: pre-wrap; background: var(--surface-2);"></div>
                </div>
                <!-- Historical Version -->
                <div style="flex: 1; display: flex; flex-direction: column; min-width: 0;">
                    <div style="padding: var(--space-3) var(--space-4); background: var(--surface-1); border-bottom: 1px solid var(--border-default); font-weight: 600; font-size: 13px;">
                        📜 <span id="diff-version-date">Historical Version</span>
                    </div>
                    <div id="diff-historical" style="flex: 1; overflow: auto; padding: var(--space-4); font-family: 'SF Mono', 'Monaco', 'Consolas', monospace; font-size: 13px; line-height: 1.6; white-space: pre-wrap; background: var(--surface-2);"></div>
                </div>
            </div>
            <div class="modal-footer" style="flex-shrink: 0; padding: var(--space-4) var(--space-6); border-top: 1px solid var(--border-default); display: flex; justify-content: space-between; align-items: center;">
                <div style="font-size: 12px; color: var(--text-muted);">
                    <span style="background: var(--success); color: white; padding: 2px 6px; border-radius: 3px; margin-right: 8px;">Added</span>
                    <span style="background: var(--error); color: white; padding: 2px 6px; border-radius: 3px;">Removed</span>
                </div>
                <div style="display: flex; gap: var(--space-2);">
                    <button onclick="closeDiffModal()" class="btn btn-ghost">Close</button>
                    <button id="diff-restore-btn" onclick="restoreFromDiff()" class="btn btn-primary">↩️ Restore This Version</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3 class="modal-title">⚙️ Dashboard Settings</h3>
                <button onclick="closeSettingsModal()" class="modal-close">✕</button>
            </div>

            <!-- Theme Picker -->
            <div class="modal-section" id="theme-picker-container">
                <div class="theme-picker-section">
                    <div class="theme-picker-header">
                        <h3 class="theme-picker-title">🎨 Appearance</h3>
                        <span class="theme-picker-subtitle">Choose your preferred color theme</span>
                    </div>
                    <div class="theme-category">
                        <div class="theme-category-title">Dark Themes</div>
                        <div class="theme-grid">
                            <div class="theme-card" data-theme="midnight"><div class="theme-card-preview"><div class="theme-preview-colors"><span class="theme-color" style="background:#0c0d10"></span><span class="theme-color" style="background:#1c1e23"></span><span class="theme-color" style="background:#A9B2BC"></span><span class="theme-color" style="background:#BC2026"></span><span class="theme-color" style="background:#22c55e"></span></div><div class="theme-preview-strip"><div class="preview-surface" style="background:#14161a"></div><div class="preview-text" style="background:#FFF;opacity:0.9"></div><div class="preview-accent" style="background:#BC2026"></div></div></div><div class="theme-card-info"><div class="theme-card-name">Midnight</div><div class="theme-card-desc">Deep slate grays</div></div><div class="theme-card-check"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M13.5 4L6 11.5L2.5 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div>
                            <div class="theme-card" data-theme="obsidian"><div class="theme-card-preview"><div class="theme-preview-colors"><span class="theme-color" style="background:#000"></span><span class="theme-color" style="background:#141414"></span><span class="theme-color" style="background:#b8b8b8"></span><span class="theme-color" style="background:#fff"></span><span class="theme-color" style="background:#10b981"></span></div><div class="theme-preview-strip"><div class="preview-surface" style="background:#0a0a0a"></div><div class="preview-text" style="background:#FFF;opacity:0.9"></div><div class="preview-accent" style="background:#fff"></div></div></div><div class="theme-card-info"><div class="theme-card-name">Obsidian</div><div class="theme-card-desc">Pure black elegance</div></div><div class="theme-card-check"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M13.5 4L6 11.5L2.5 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div>
                            <div class="theme-card" data-theme="nord"><div class="theme-card-preview"><div class="theme-preview-colors"><span class="theme-color" style="background:#2e3440"></span><span class="theme-color" style="background:#4c566a"></span><span class="theme-color" style="background:#d8dee9"></span><span class="theme-color" style="background:#88c0d0"></span><span class="theme-color" style="background:#a3be8c"></span></div><div class="theme-preview-strip"><div class="preview-surface" style="background:#3b4252"></div><div class="preview-text" style="background:#eceff4;opacity:0.9"></div><div class="preview-accent" style="background:#88c0d0"></div></div></div><div class="theme-card-info"><div class="theme-card-name">Nord</div><div class="theme-card-desc">Nordic blue-gray</div></div><div class="theme-card-check"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M13.5 4L6 11.5L2.5 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div>
                            <div class="theme-card" data-theme="dracula"><div class="theme-card-preview"><div class="theme-preview-colors"><span class="theme-color" style="background:#282a36"></span><span class="theme-color" style="background:#44475a"></span><span class="theme-color" style="background:#f8f8f2"></span><span class="theme-color" style="background:#ff79c6"></span><span class="theme-color" style="background:#50fa7b"></span></div><div class="theme-preview-strip"><div class="preview-surface" style="background:#282a36"></div><div class="preview-text" style="background:#f8f8f2;opacity:0.9"></div><div class="preview-accent" style="background:#ff79c6"></div></div></div><div class="theme-card-info"><div class="theme-card-name">Dracula</div><div class="theme-card-desc">Purple & pink</div></div><div class="theme-card-check"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M13.5 4L6 11.5L2.5 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div>
                            <div class="theme-card" data-theme="tokyo-night"><div class="theme-card-preview"><div class="theme-preview-colors"><span class="theme-color" style="background:#1a1b26"></span><span class="theme-color" style="background:#24283b"></span><span class="theme-color" style="background:#c0caf5"></span><span class="theme-color" style="background:#7aa2f7"></span><span class="theme-color" style="background:#9ece6a"></span></div><div class="theme-preview-strip"><div class="preview-surface" style="background:#1a1b26"></div><div class="preview-text" style="background:#c0caf5;opacity:0.9"></div><div class="preview-accent" style="background:#7aa2f7"></div></div></div><div class="theme-card-info"><div class="theme-card-name">Tokyo Night</div><div class="theme-card-desc">Neon blue accents</div></div><div class="theme-card-check"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M13.5 4L6 11.5L2.5 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div>
                            <div class="theme-card" data-theme="monokai"><div class="theme-card-preview"><div class="theme-preview-colors"><span class="theme-color" style="background:#272822"></span><span class="theme-color" style="background:#414339"></span><span class="theme-color" style="background:#f8f8f2"></span><span class="theme-color" style="background:#fd971f"></span><span class="theme-color" style="background:#a6e22e"></span></div><div class="theme-preview-strip"><div class="preview-surface" style="background:#272822"></div><div class="preview-text" style="background:#f8f8f2;opacity:0.9"></div><div class="preview-accent" style="background:#fd971f"></div></div></div><div class="theme-card-info"><div class="theme-card-name">Monokai</div><div class="theme-card-desc">Warm & vibrant</div></div><div class="theme-card-check"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M13.5 4L6 11.5L2.5 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div>
                            <div class="theme-card" data-theme="catppuccin-mocha"><div class="theme-card-preview"><div class="theme-preview-colors"><span class="theme-color" style="background:#1e1e2e"></span><span class="theme-color" style="background:#45475a"></span><span class="theme-color" style="background:#cdd6f4"></span><span class="theme-color" style="background:#f5c2e7"></span><span class="theme-color" style="background:#a6e3a1"></span></div><div class="theme-preview-strip"><div class="preview-surface" style="background:#1e1e2e"></div><div class="preview-text" style="background:#cdd6f4;opacity:0.9"></div><div class="preview-accent" style="background:#f5c2e7"></div></div></div><div class="theme-card-info"><div class="theme-card-name">Catppuccin Mocha</div><div class="theme-card-desc">Soft pastels</div></div><div class="theme-card-check"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M13.5 4L6 11.5L2.5 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div>
                        </div>
                    </div>
                    <div class="theme-category">
                        <div class="theme-category-title">Light Themes</div>
                        <div class="theme-grid">
                            <div class="theme-card" data-theme="snow"><div class="theme-card-preview"><div class="theme-preview-colors"><span class="theme-color" style="background:#F8FAFC"></span><span class="theme-color" style="background:#E2E8F0"></span><span class="theme-color" style="background:#1B2232"></span><span class="theme-color" style="background:#BC2026"></span><span class="theme-color" style="background:#16a34a"></span></div><div class="theme-preview-strip"><div class="preview-surface" style="background:#FFF"></div><div class="preview-text" style="background:#1B2232;opacity:0.9"></div><div class="preview-accent" style="background:#BC2026"></div></div></div><div class="theme-card-info"><div class="theme-card-name">Snow</div><div class="theme-card-desc">Clean & minimal</div></div><div class="theme-card-check"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M13.5 4L6 11.5L2.5 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div>
                            <div class="theme-card" data-theme="latte"><div class="theme-card-preview"><div class="theme-preview-colors"><span class="theme-color" style="background:#eff1f5"></span><span class="theme-color" style="background:#ccd0da"></span><span class="theme-color" style="background:#4c4f69"></span><span class="theme-color" style="background:#ea76cb"></span><span class="theme-color" style="background:#40a02b"></span></div><div class="theme-preview-strip"><div class="preview-surface" style="background:#e6e9ef"></div><div class="preview-text" style="background:#4c4f69;opacity:0.9"></div><div class="preview-accent" style="background:#ea76cb"></div></div></div><div class="theme-card-info"><div class="theme-card-name">Latte</div><div class="theme-card-desc">Warm cream tones</div></div><div class="theme-card-check"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M13.5 4L6 11.5L2.5 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div>
                            <div class="theme-card" data-theme="rose-pine-dawn"><div class="theme-card-preview"><div class="theme-preview-colors"><span class="theme-color" style="background:#faf4ed"></span><span class="theme-color" style="background:#f2e9e1"></span><span class="theme-color" style="background:#575279"></span><span class="theme-color" style="background:#d65d92"></span><span class="theme-color" style="background:#56949f"></span></div><div class="theme-preview-strip"><div class="preview-surface" style="background:#fffaf3"></div><div class="preview-text" style="background:#575279;opacity:0.9"></div><div class="preview-accent" style="background:#d65d92"></div></div></div><div class="theme-card-info"><div class="theme-card-name">Rose Pine Dawn</div><div class="theme-card-desc">Soft pink warmth</div></div><div class="theme-card-check"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M13.5 4L6 11.5L2.5 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div>
                            <div class="theme-card" data-theme="solarized-light"><div class="theme-card-preview"><div class="theme-preview-colors"><span class="theme-color" style="background:#fdf6e3"></span><span class="theme-color" style="background:#eee8d5"></span><span class="theme-color" style="background:#073642"></span><span class="theme-color" style="background:#268bd2"></span><span class="theme-color" style="background:#859900"></span></div><div class="theme-preview-strip"><div class="preview-surface" style="background:#eee8d5"></div><div class="preview-text" style="background:#073642;opacity:0.9"></div><div class="preview-accent" style="background:#268bd2"></div></div></div><div class="theme-card-info"><div class="theme-card-name">Solarized Light</div><div class="theme-card-desc">Classic warm</div></div><div class="theme-card-check"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M13.5 4L6 11.5L2.5 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div>
                            <div class="theme-card" data-theme="paper"><div class="theme-card-preview"><div class="theme-preview-colors"><span class="theme-color" style="background:#fff"></span><span class="theme-color" style="background:#f5f5f5"></span><span class="theme-color" style="background:#212121"></span><span class="theme-color" style="background:#424242"></span><span class="theme-color" style="background:#2e7d32"></span></div><div class="theme-preview-strip"><div class="preview-surface" style="background:#fafafa"></div><div class="preview-text" style="background:#212121;opacity:0.9"></div><div class="preview-accent" style="background:#424242"></div></div></div><div class="theme-card-info"><div class="theme-card-name">Paper</div><div class="theme-card-desc">Ultra minimal</div></div><div class="theme-card-check"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M13.5 4L6 11.5L2.5 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div>
                        </div>
                    </div>
                    <div class="theme-category">
                        <div class="theme-category-title">Special Themes</div>
                        <div class="theme-grid">
                            <div class="theme-card" data-theme="solovision-red"><div class="theme-card-preview"><div class="theme-preview-colors"><span class="theme-color" style="background:#0f0506"></span><span class="theme-color" style="background:#2d1215"></span><span class="theme-color" style="background:#e5c6c9"></span><span class="theme-color" style="background:#BC2026"></span><span class="theme-color" style="background:#22c55e"></span></div><div class="theme-preview-strip"><div class="preview-surface" style="background:#1a0a0c"></div><div class="preview-text" style="background:#fff;opacity:0.9"></div><div class="preview-accent" style="background:#BC2026"></div></div></div><div class="theme-card-info"><div class="theme-card-name">SoLoVision Red</div><div class="theme-card-desc">Brand essence</div></div><div class="theme-card-check"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M13.5 4L6 11.5L2.5 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div>
                            <div class="theme-card" data-theme="cyberpunk"><div class="theme-card-preview"><div class="theme-preview-colors"><span class="theme-color" style="background:#0a0e27"></span><span class="theme-color" style="background:#1a1f4d"></span><span class="theme-color" style="background:#00ff9f"></span><span class="theme-color" style="background:#ff00ff"></span><span class="theme-color" style="background:#ffee00"></span></div><div class="theme-preview-strip"><div class="preview-surface" style="background:#0f1535"></div><div class="preview-text" style="background:#00ff9f;opacity:0.9"></div><div class="preview-accent" style="background:#ff00ff"></div></div></div><div class="theme-card-info"><div class="theme-card-name">Cyberpunk</div><div class="theme-card-desc">Neon future</div></div><div class="theme-card-check"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M13.5 4L6 11.5L2.5 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div>
                            <div class="theme-card" data-theme="ocean"><div class="theme-card-preview"><div class="theme-preview-colors"><span class="theme-color" style="background:#0a1628"></span><span class="theme-color" style="background:#15293f"></span><span class="theme-color" style="background:#7dd3fc"></span><span class="theme-color" style="background:#06b6d4"></span><span class="theme-color" style="background:#10b981"></span></div><div class="theme-preview-strip"><div class="preview-surface" style="background:#0e1e33"></div><div class="preview-text" style="background:#e0f2fe;opacity:0.9"></div><div class="preview-accent" style="background:#06b6d4"></div></div></div><div class="theme-card-info"><div class="theme-card-name">Ocean</div><div class="theme-card-desc">Deep teal waters</div></div><div class="theme-card-check"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M13.5 4L6 11.5L2.5 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gateway Connection -->
            <div class="modal-section">
                <h4 class="modal-section-title">🔌 Gateway Connection</h4>
                <div class="modal-section-content">
                    <div class="flex items-center gap-2" style="margin-bottom: var(--space-3);">
                        <span id="settings-gateway-dot" class="status-dot idle"></span>
                        <span id="settings-gateway-status" style="font-size: 13px; color: var(--text-muted);">Disconnected</span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Gateway Host</label>
                        <input type="text" id="gateway-host" class="input" placeholder="e.g., moltbot.local or 192.168.1.100">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Port</label>
                            <input type="number" id="gateway-port" class="input" placeholder="443" value="443">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Session Key</label>
                            <input type="text" id="gateway-session" class="input" placeholder="main" value="main">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Token (optional)</label>
                        <input type="password" id="gateway-token" class="input" placeholder="Gateway auth token">
                    </div>
                    <div class="form-actions" style="margin-top: var(--space-3);">
                        <button id="gateway-connect-btn" onclick="connectToGateway()" class="btn btn-primary" style="background: var(--success);">Connect</button>
                        <button id="gateway-disconnect-btn" onclick="disconnectFromGateway()" class="btn btn-danger hidden">Disconnect</button>
                        <button onclick="requestGatewayRestart()" class="btn btn-ghost" title="Ask bot to restart gateway">Restart</button>
                    </div>
                    <p style="font-size: 12px; color: var(--text-muted); margin-top: var(--space-2);">
                        Connect to the same session as Telegram/Android for mirrored chat.
                    </p>
                </div>
            </div>

            <!-- AI Provider & Model -->
            <div class="modal-section">
                <h4 class="modal-section-title">🤖 AI Provider & Model</h4>
                <div class="modal-section-content">
                    <div class="setting-row">
                        <div class="setting-info">
                            <div class="setting-title">Current Provider</div>
                            <div class="setting-desc">AI service currently in use</div>
                        </div>
                        <div id="current-provider-display" style="font-weight: 600; color: var(--text-primary);">--</div>
                    </div>
                    <div class="setting-row">
                        <div class="setting-info">
                            <div class="setting-title">Current Model</div>
                            <div class="setting-desc">Specific model in use</div>
                        </div>
                        <div id="current-model-display" style="font-weight: 600; color: var(--text-primary);">--</div>
                    </div>
                    <div class="setting-row">
                        <div class="setting-info">
                            <div class="setting-title">Change Default Model</div>
                            <div class="setting-desc">Change the global default for all agents</div>
                        </div>
                        <select id="setting-model" class="select">
                            <!-- Populated dynamically -->
                        </select>
                        <button onclick="changeGlobalModel()" class="btn btn-primary" style="margin-left: 8px; padding: 4px 12px; font-size: 12px;" title="Apply as global default">
                            Apply
                        </button>
                    </div>
                    <p style="font-size: 12px; color: var(--text-muted); margin-top: var(--space-2);">
                        ⚡ Header dropdown changes the current session only<br>
                        🌐 This setting changes the global default (restarts gateway)
                    </p>
                </div>
            </div>

            <!-- SoLoBot Behavior -->
            <div class="modal-section">
                <h4 class="modal-section-title">🤖 SoLoBot Behavior</h4>
                <div class="modal-section-content">
                    <div class="setting-row">
                        <div class="setting-info">
                            <div class="setting-title">Task Pickup Frequency</div>
                            <div class="setting-desc">How often SoLoBot checks for In Progress tasks</div>
                        </div>
                        <select id="setting-pickup-freq" onchange="updateSetting('pickupFreq', this.value)" class="select">
                            <option value="disabled">Disabled</option>
                            <option value="60000">Every 1 min</option>
                            <option value="300000">Every 5 min</option>
                            <option value="1800000">Every 30 min</option>
                        </select>
                    </div>
                    <div class="setting-row">
                        <div class="setting-info">
                            <div class="setting-title">Work Priority Order</div>
                            <div class="setting-desc">How tasks are prioritized</div>
                        </div>
                        <select id="setting-priority-order" onchange="updateSetting('priorityOrder', this.value)" class="select">
                            <option value="priority">P0 → P1 → P2</option>
                            <option value="fifo">First In, First Out</option>
                            <option value="lifo">Last In, First Out</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Dashboard Settings -->
            <div class="modal-section">
                <h4 class="modal-section-title">📊 Dashboard</h4>
                <div class="modal-section-content">
                    <div class="setting-row">
                        <div class="setting-info">
                            <div class="setting-title">Auto-Refresh</div>
                            <div class="setting-desc">How often dashboard reloads data</div>
                        </div>
                        <select id="setting-refresh" onchange="updateSetting('refreshInterval', this.value)" class="select">
                            <option value="5000">Every 5 sec</option>
                            <option value="10000">Every 10 sec</option>
                            <option value="30000">Every 30 sec</option>
                            <option value="60000">Every 1 min</option>
                            <option value="0">Disabled</option>
                        </select>
                    </div>
                    <div class="setting-row">
                        <div class="setting-info">
                            <div class="setting-title">Default New Task Priority</div>
                            <div class="setting-desc">Priority for new tasks</div>
                        </div>
                        <select id="setting-default-priority" onchange="updateSetting('defaultPriority', this.value)" class="select">
                            <option value="0">P0 (Urgent)</option>
                            <option value="1">P1 (Normal)</option>
                            <option value="2">P2 (Low)</option>
                        </select>
                    </div>
                    <div class="setting-row">
                        <div class="setting-info">
                            <div class="setting-title">Compact Mode</div>
                            <div class="setting-desc">Denser task cards</div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="setting-compact" onchange="updateSetting('compactMode', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Visible Panels -->
            <div class="modal-section">
                <h4 class="modal-section-title">👁️ Visible Panels</h4>
                <div class="modal-section-content">
                    <div class="setting-row">
                        <span class="setting-title">SoLoBot Live Panel</span>
                        <input type="checkbox" id="setting-show-live" onchange="updateSetting('showLive', this.checked)" checked style="accent-color: var(--brand-red);">
                    </div>
                    <div class="setting-row">
                        <span class="setting-title">Activity Log</span>
                        <input type="checkbox" id="setting-show-activity" onchange="updateSetting('showActivity', this.checked)" checked style="accent-color: var(--brand-red);">
                    </div>
                    <div class="setting-row">
                        <span class="setting-title">Notes Panel</span>
                        <input type="checkbox" id="setting-show-notes" onchange="updateSetting('showNotes', this.checked)" checked style="accent-color: var(--brand-red);">
                    </div>
                    <div class="setting-row">
                        <span class="setting-title">Product Status</span>
                        <input type="checkbox" id="setting-show-products" onchange="updateSetting('showProducts', this.checked)" checked style="accent-color: var(--brand-red);">
                    </div>
                    <div class="setting-row">
                        <span class="setting-title">Docs Hub</span>
                        <input type="checkbox" id="setting-show-docs" onchange="updateSetting('showDocs', this.checked)" checked style="accent-color: var(--brand-red);">
                    </div>
                </div>
            </div>

            <!-- Danger Zone -->
            <div class="modal-section">
                <h4 class="modal-section-title" style="color: var(--error);">⚠️ Danger Zone</h4>
                <div class="danger-zone">
                    <div class="setting-row">
                        <div class="setting-info">
                            <div class="setting-title">Reset Local Data</div>
                            <div class="setting-desc">Reload all data from server</div>
                        </div>
                        <button onclick="resetToServerState()" class="btn btn-danger" style="padding: var(--space-2) var(--space-3);">Reset</button>
                    </div>
                    <div class="setting-row">
                        <div class="setting-info">
                            <div class="setting-title">Clear All Data</div>
                            <div class="setting-desc">Delete all local data and tasks</div>
                        </div>
                        <button onclick="clearAllData()" class="btn btn-danger" style="padding: var(--space-2) var(--space-3);">Clear</button>
                    </div>
                </div>
            </div>

            <div style="text-align: center; font-size: 12px; color: var(--text-muted); margin-top: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--border-default);">
                Dashboard v3.2.0 • Gateway WebSocket Chat
            </div>
        </div>
    </div>

    <!-- Archive Modal -->
    <div id="archive-modal" class="modal-overlay">
        <div class="modal modal-lg" style="max-height: 80vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h3 class="modal-title flex items-center gap-2">
                    📦 Archived Tasks
                    <span id="archive-modal-count" class="badge badge-error">0</span>
                </h3>
                <div class="flex items-center gap-2">
                    <button onclick="clearArchive()" style="font-size: 12px; color: var(--error); background: none; border: none; cursor: pointer;">Clear All</button>
                    <button onclick="closeArchiveModal()" class="modal-close">✕</button>
                </div>
            </div>
            <div id="archive-tasks-list" style="flex: 1; overflow-y: auto; min-height: 200px;" class="space-y-2">
            </div>
        </div>
    </div>
    
    </div><!-- END app-content -->
    </div><!-- END app-layout -->

    <!-- New Session Name Modal -->
    <div id="new-session-modal" class="modal-overlay">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h3 class="modal-title">Enter session name:</h3>
                <button onclick="closeNewSessionModal(null)" class="modal-close">✕</button>
            </div>
            <div class="modal-body" style="padding: var(--space-4) var(--space-6);">
                <input type="text" id="new-session-name-input" class="input" style="width: 100%; font-size: 14px;" placeholder="Session name">
            </div>
            <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: var(--space-3); padding: var(--space-4) var(--space-6); border-top: 1px solid var(--border-default);">
                <button onclick="closeNewSessionModal(null)" class="btn btn-ghost">Cancel</button>
                <button onclick="submitNewSessionModal()" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title" id="confirm-modal-title">Confirm</h3>
                <button onclick="closeConfirmModal(false)" class="modal-close">✕</button>
            </div>
            <div class="modal-body" style="padding: var(--space-4) var(--space-6);">
                <p id="confirm-modal-message" style="margin: 0; color: var(--text-primary); line-height: 1.5; white-space: pre-line;"></p>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: var(--space-3); padding: var(--space-4) var(--space-6); border-top: 1px solid var(--border-default);">
                <button onclick="closeConfirmModal(false)" class="btn btn-ghost">Cancel</button>
                <button onclick="closeConfirmModal(true)" class="btn btn-primary" id="confirm-modal-ok">OK</button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications Container -->
    <!-- Keyboard Shortcuts Modal -->
    <div id="shortcuts-modal" class="modal-overlay">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3>⌨️ Keyboard Shortcuts</h3>
                <button onclick="hideModal('shortcuts-modal')" class="btn-icon">✕</button>
            </div>
            <div class="modal-body">
                <div class="shortcuts-grid">
                    <div class="shortcut-group">
                        <div class="shortcut-group-title">Navigation</div>
                        <div class="shortcut-item">
                            <span class="shortcut-desc">Dashboard</span>
                            <div class="shortcut-keys"><span class="shortcut-key">G</span><span class="shortcut-key">D</span></div>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-desc">Chat</span>
                            <div class="shortcut-keys"><span class="shortcut-key">G</span><span class="shortcut-key">C</span></div>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-desc">Memory</span>
                            <div class="shortcut-keys"><span class="shortcut-key">G</span><span class="shortcut-key">M</span></div>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-desc">Products</span>
                            <div class="shortcut-keys"><span class="shortcut-key">G</span><span class="shortcut-key">P</span></div>
                        </div>
                    </div>
                    <div class="shortcut-group">
                        <div class="shortcut-group-title">Focus Timer</div>
                        <div class="shortcut-item">
                            <span class="shortcut-desc">Start/Pause Timer</span>
                            <div class="shortcut-keys"><span class="shortcut-key">F</span></div>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-desc">Reset Timer</span>
                            <div class="shortcut-keys"><span class="shortcut-key">Shift</span><span class="shortcut-key">F</span></div>
                        </div>
                    </div>
                    <div class="shortcut-group">
                        <div class="shortcut-group-title">Tasks</div>
                        <div class="shortcut-item">
                            <span class="shortcut-desc">New Task</span>
                            <div class="shortcut-keys"><span class="shortcut-key">N</span></div>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-desc">Sync Tasks</span>
                            <div class="shortcut-keys"><span class="shortcut-key">S</span></div>
                        </div>
                    </div>
                    <div class="shortcut-group">
                        <div class="shortcut-group-title">General</div>
                        <div class="shortcut-item">
                            <span class="shortcut-desc">Show Shortcuts</span>
                            <div class="shortcut-keys"><span class="shortcut-key">?</span></div>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-desc">Toggle Theme</span>
                            <div class="shortcut-keys"><span class="shortcut-key">T</span></div>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-desc">Settings</span>
                            <div class="shortcut-keys"><span class="shortcut-key">Ctrl</span><span class="shortcut-key">,</span></div>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-desc">Focus Chat Input</span>
                            <div class="shortcut-keys"><span class="shortcut-key">/</span></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="hideModal('shortcuts-modal')" class="btn btn-ghost">Close</button>
            </div>
        </div>
    </div>

    <!-- Shortcuts Hint (bottom right) -->
    <div class="shortcuts-hint" onclick="showModal('shortcuts-modal')">
        <span class="shortcut-key">?</span>
        <span>Shortcuts</span>
    </div>

    <div id="toast-container" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column-reverse; gap: 10px;"></div>

    <script src="gateway-client.js?v=3.6.0"></script>
    <script src="docs-hub-memory-files.js?v=2.5.0"></script>
    <script src="dashboard.js?v=3.51.0"></script>
    <script>
        // Valid page names
        const VALID_PAGES = ['dashboard', 'memory', 'chat', 'system', 'products'];

        // Get page from URL path
        function getPageFromURL() {
            const path = window.location.pathname.replace(/^\/+|\/+$/g, ''); // trim slashes
            if (path && VALID_PAGES.includes(path)) {
                return path;
            }
            return 'dashboard'; // default
        }

        // Sidebar pin toggle
        function toggleSidebarPin() {
            const sidebar = document.getElementById('sidebar');
            const icon = document.getElementById('sidebar-pin-icon');
            const isPinned = sidebar.classList.toggle('pinned');
            localStorage.setItem('sidebarPinned', isPinned);
            icon.textContent = isPinned ? '🔒' : '🔓';
            console.log('Sidebar pinned:', isPinned);
        }
        
        // Restore sidebar state on load
        if (localStorage.getItem('sidebarPinned') === 'true') {
            document.getElementById('sidebar').classList.add('pinned');
            document.getElementById('sidebar-pin-icon').textContent = '🔒';
        }

        // Page navigation with URL update
        function showPage(pageName, updateURL = true) {
            // Validate page name
            if (!VALID_PAGES.includes(pageName)) {
                pageName = 'dashboard';
            }

            // Save chat scroll position before leaving chat page
            const currentActivePage = document.querySelector('.page.active');
            if (currentActivePage && currentActivePage.id === 'page-chat') {
                if (typeof saveChatScrollPosition === 'function') {
                    saveChatScrollPosition();
                }
            }
            
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            // Show selected page
            const targetPage = document.getElementById('page-' + pageName);
            if (targetPage) {
                targetPage.classList.add('active');
            }

            // Update sidebar active state
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === pageName) {
                    item.classList.add('active');
                }
            });

            // Update URL without reload
            if (updateURL) {
                const newPath = pageName === 'dashboard' ? '/' : '/' + pageName;
                if (window.location.pathname !== newPath) {
                    history.pushState({ page: pageName }, '', newPath);
                }
            }

            // If showing memory page, load files
            if (pageName === 'memory') {
                renderMemoryFilesForPage();
            }
            
            // If showing chat page, restore scroll position
            if (pageName === 'chat') {
                setTimeout(() => {
                    if (typeof restoreChatScrollPosition === 'function') {
                        restoreChatScrollPosition();
                    }
                }, 50); // Small delay to ensure DOM is ready
            }

            // If showing chat page, render chat
            if (pageName === 'chat' && typeof renderChatPage === 'function') {
                renderChatPage();
            }

            // If showing system page, render system messages
            if (pageName === 'system' && typeof renderSystemPage === 'function') {
                renderSystemPage();
            }
        }

        // Handle browser back/forward buttons
        window.addEventListener('popstate', (event) => {
            const pageName = event.state?.page || getPageFromURL();
            showPage(pageName, false); // Don't update URL on popstate
        });

        // Initialize page from URL on load
        document.addEventListener('DOMContentLoaded', () => {
            const initialPage = getPageFromURL();
            showPage(initialPage, false); // Don't push state on initial load
        });
        
        // Render memory files for the Memory page
        async function renderMemoryFilesForPage(filter = '') {
            const container = document.getElementById('memory-files-grid');
            if (!container) return;
            
            container.innerHTML = '<div class="loading-state">Loading memory files...</div>';
            
            // Use the existing fetch function
            const files = await fetchMemoryFiles();
            
            if (files.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>⚠️ No memory files found</p></div>';
                return;
            }
            
            // Filter files
            const filtered = files.filter(file =>
                file.name.toLowerCase().includes(filter.toLowerCase()) ||
                (file.description && file.description.toLowerCase().includes(filter.toLowerCase())) ||
                (file.category && file.category.toLowerCase().includes(filter.toLowerCase()))
            );
            
            // Group by category
            const grouped = filtered.reduce((groups, file) => {
                const category = file.category || 'Other';
                if (!groups[category]) groups[category] = [];
                groups[category].push(file);
                return groups;
            }, {});
            
            // Sort categories
            const categoryOrder = ['Core Identity', 'Guides & Reference', 'Daily Logs', 'Other Documents'];
            const sortedCategories = Object.keys(grouped).sort((a, b) => {
                return categoryOrder.indexOf(a) - categoryOrder.indexOf(b);
            });
            
            // Render
            let html = '';
            sortedCategories.forEach(category => {
                html += `<div class="docs-category">`;
                html += `<h3 class="category-title">${category}</h3>`;
                html += `<div class="docs-category-grid">`;
                
                const sortedFiles = grouped[category].sort((a, b) => {
                    if (category === 'Daily Logs') return b.name.localeCompare(a.name);
                    return a.name.localeCompare(b.name);
                });
                
                sortedFiles.forEach(file => {
                    const modifiedDate = file.modified ? new Date(file.modified).toLocaleDateString() : '';
                    const botBadge = file.botUpdated && !file.acknowledged 
                        ? `<span class="badge badge-warning bot-updated-badge" title="Updated by SoLoBot">🤖 Updated</span>` 
                        : '';
                    const botUpdatedClass = file.botUpdated && !file.acknowledged ? 'bot-updated' : '';
                    html += `
                        <div class="doc-card memory-file ${botUpdatedClass}" onclick="viewMemoryFile('${file.path || file.name}')" data-filepath="${file.path || file.name}">
                            <div style="display: flex; align-items: center; gap: var(--space-3);">
                                <div class="doc-icon icon-md">📄</div>
                                <div style="min-width: 0; flex: 1;">
                                    <div class="doc-title" style="display: flex; align-items: center; gap: var(--space-2);">
                                        ${file.name}
                                        ${botBadge}
                                    </div>
                                    <div class="doc-description">${file.description || ''}</div>
                                    ${modifiedDate ? `<div class="doc-meta">Modified: ${modifiedDate}</div>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            });
            
            container.innerHTML = html || '<div class="empty-state">No files match your search</div>';
        }
        
        // Sync memory files now (manual trigger)
        function syncMemoryFilesNow() {
            const statusEl = document.getElementById('sync-status');
            if (statusEl) {
                statusEl.className = 'sync-status syncing';
                statusEl.innerHTML = '<span class="status-dot warning"></span> Syncing...';
            }
            
            // Clear cache and reload
            if (typeof memoryFilesCache !== 'undefined') {
                memoryFilesCache = [];
                lastFetchTime = 0;
            }
            
            renderMemoryFilesForPage(document.getElementById('memory-search')?.value || '').then(() => {
                if (statusEl) {
                    statusEl.className = 'sync-status synced';
                    const now = new Date().toLocaleTimeString();
                    statusEl.innerHTML = `<span class="status-dot success"></span> Last synced: ${now}`;
                }
            });
        }
        
        // Theme toggle
        // Toggle theme (keyboard shortcut T) — opens settings to theme picker
        function toggleTheme() {
            openSettingsModal();
            scrollToThemePicker();
        }

        // Scroll the settings modal to the theme picker section
        function scrollToThemePicker() {
            setTimeout(() => {
                const container = document.getElementById('theme-picker-container');
                if (container) container.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        // Legacy stub — no longer needed but called by some init code
        function updateThemeIcon() {}

        // Load saved theme — migrate old 'theme' key to new 'solobot-theme'
        // Also handle stale "dark"/"light" values from before theme system
        const THEME_MIGRATION = { 'dark': 'midnight', 'light': 'snow' };
        const legacyTheme = localStorage.getItem('theme');
        let savedTheme = localStorage.getItem('solobot-theme');
        
        // Migrate from old key
        if (!savedTheme && legacyTheme) {
            savedTheme = THEME_MIGRATION[legacyTheme] || 'midnight';
            localStorage.setItem('solobot-theme', savedTheme);
            localStorage.removeItem('theme');
        }
        
        // Fix any stale "dark"/"light" values in the new key too
        if (savedTheme && THEME_MIGRATION[savedTheme]) {
            savedTheme = THEME_MIGRATION[savedTheme];
            localStorage.setItem('solobot-theme', savedTheme);
        }
        
        savedTheme = savedTheme || 'midnight';
        document.documentElement.setAttribute('data-theme', savedTheme);
        updateThemeIcon(savedTheme);

        // Theme picker is inlined — cards init via ThemePicker constructor at end of body

        // Strict scroll containment - route scroll to element under cursor
        let currentScrollTarget = null;
        const scrollableSelectors = '.chat-messages, .activity-list, .notes-list, .terminal-output, .drop-zone';

        function updateScrollTarget(e) {
            const el = document.elementFromPoint(e.clientX, e.clientY);
            if (el) {
                currentScrollTarget = el.closest(scrollableSelectors);
            } else {
                currentScrollTarget = null;
            }
        }

        document.addEventListener('mousemove', updateScrollTarget, { passive: true });

        document.addEventListener('wheel', (e) => {
            // Find scrollable element under cursor RIGHT NOW
            const el = document.elementFromPoint(e.clientX, e.clientY);
            const scrollable = el?.closest(scrollableSelectors);

            if (scrollable) {
                const hasOverflow = scrollable.scrollHeight > scrollable.clientHeight;
                if (!hasOverflow) {
                    // No overflow - let page scroll
                    return;
                }
                
                const atTop = scrollable.scrollTop <= 0;
                const atBottom = scrollable.scrollTop + scrollable.clientHeight >= scrollable.scrollHeight - 1;
                const scrollingUp = e.deltaY < 0;
                const scrollingDown = e.deltaY > 0;
                
                // If at boundary and trying to scroll past it, let page scroll
                if ((atTop && scrollingUp) || (atBottom && scrollingDown)) {
                    // Don't prevent default - let page scroll take over
                    return;
                }
                
                // Otherwise, scroll the module
                e.preventDefault();
                scrollable.scrollTop += e.deltaY;
            }
            // If not over a scrollable area, let page scroll normally
        }, { passive: false });

        window.setupScrollContainment = () => {}; // No-op now, handled globally

        // Modal helpers for the new class system
        function showModal(id) {
            document.getElementById(id).classList.add('visible');
        }
        function hideModal(id) {
            document.getElementById(id).classList.remove('visible');
        }
        
        // Click outside to close modals
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal-overlay') && e.target.classList.contains('visible')) {
                e.target.classList.remove('visible');
            }
        });

        // Override modal functions for new system
        const originalOpenSettingsModal = window.openSettingsModal;
        window.openSettingsModal = function() {
            showModal('settings-modal');
            if (typeof originalOpenSettingsModal === 'function') {
                // Call original to load settings
            }
        };
        window.closeSettingsModal = function() { hideModal('settings-modal'); };

        window.openAddTask = function(column) {
            window.addTaskColumn = column;
            showModal('add-task-modal');
            document.getElementById('new-task-title').focus();
        };
        window.closeAddTask = function() { hideModal('add-task-modal'); };

        window.openArchiveModal = function() { showModal('archive-modal'); renderArchive(); };
        window.closeArchiveModal = function() { hideModal('archive-modal'); };

        window.closeActionModal = function() { hideModal('task-action-modal'); };
        window.closeEditTitleModal = function() { hideModal('edit-title-modal'); };
        window.closeDeleteModal = function() { hideModal('confirm-delete-modal'); };

        // Image preview visibility
        function showImagePreview(src) {
            const container = document.getElementById('image-preview-container');
            const img = document.getElementById('image-preview');
            img.src = src;
            container.classList.add('visible');
        }
        function clearImagePreview() {
            const container = document.getElementById('image-preview-container');
            container.classList.remove('visible');
            pendingImage = null;
            document.getElementById('image-upload').value = '';
        }
        
        // =================== TASK DETAIL MODAL ===================
        let currentDetailTask = null;
        let currentDetailColumn = null;
        
        window.openTaskDetail = function(taskId, column) {
            const task = state.tasks[column]?.find(t => t.id === taskId);
            if (!task) return;
            
            currentDetailTask = task;
            currentDetailColumn = column;
            taskModalOpen = true; // Pause auto-refresh while editing
            
            // Populate modal
            document.getElementById('task-detail-title').value = task.title || '';
            document.getElementById('task-detail-description').value = task.description || '';
            
            // Status badge
            const statusEl = document.getElementById('task-detail-status');
            const statusMap = { todo: 'To-Do', progress: 'In Progress', done: 'Done', archive: 'Archived' };
            statusEl.textContent = statusMap[column] || column;
            statusEl.className = 'badge ' + (column === 'done' ? 'badge-success' : column === 'progress' ? 'badge-warning' : '');
            
            // Priority badge
            const priorityEl = document.getElementById('task-detail-priority');
            priorityEl.textContent = 'P' + (task.priority || 1);
            priorityEl.className = 'badge badge-primary';
            
            // Date
            const dateEl = document.getElementById('task-detail-date');
            dateEl.textContent = task.createdAt ? new Date(task.createdAt).toLocaleDateString() : '';
            
            // Render images
            renderTaskImages();
            
            showModal('task-detail-modal');
        };
        
        window.closeTaskDetailModal = async function() {
            // Auto-save changes before closing
            if (currentDetailTask && currentDetailColumn) {
                currentDetailTask.title = document.getElementById('task-detail-title').value;
                currentDetailTask.description = document.getElementById('task-detail-description').value;
                await saveState('Updated task');
                render();
            }
            hideModal('task-detail-modal');
            currentDetailTask = null;
            currentDetailColumn = null;
            taskModalOpen = false; // Resume auto-refresh
        };
        
        function renderTaskImages() {
            const container = document.getElementById('task-detail-images');
            const images = currentDetailTask?.images || [];
            
            if (images.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted); font-size: 13px;">No attachments yet</div>';
                return;
            }
            
            container.innerHTML = images.map((img, idx) => `
                <div style="position: relative; width: 120px; height: 90px; border-radius: var(--radius-md); overflow: hidden; border: 1px solid var(--border-default);">
                    <img src="${img}" style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;" 
                         onclick="window.open('${img}', '_blank')">
                    <button onclick="removeTaskImage(${idx})" 
                            style="position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px;">
                        ✕
                    </button>
                </div>
            `).join('');
        }
        
        window.handleTaskImageUpload = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            addImageToTask(file);
            event.target.value = ''; // Reset input
        };
        
        // Shared function to add image to current task
        function addImageToTask(file) {
            if (!file || !file.type.startsWith('image/')) return;
            if (!currentDetailTask) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                if (!currentDetailTask.images) currentDetailTask.images = [];
                currentDetailTask.images.push(e.target.result);
                renderTaskImages();
                saveState('Added image to task');
                showToast('Image added!', 'success');
            };
            reader.readAsDataURL(file);
        }
        
        // Drag and drop support for task detail modal
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('task-detail-modal');
            if (!modal) return;
            
            // Prevent default drag behaviors on the modal
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                modal.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            // Highlight drop zone
            ['dragenter', 'dragover'].forEach(eventName => {
                modal.addEventListener(eventName, () => {
                    if (currentDetailTask) {
                        modal.querySelector('.modal').style.boxShadow = '0 0 0 3px var(--brand-red)';
                    }
                }, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                modal.addEventListener(eventName, () => {
                    modal.querySelector('.modal').style.boxShadow = '';
                }, false);
            });
            
            // Handle drop
            modal.addEventListener('drop', function(e) {
                if (!currentDetailTask) return;
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    [...files].forEach(file => {
                        if (file.type.startsWith('image/')) {
                            addImageToTask(file);
                        }
                    });
                }
            }, false);
            
            // Paste support for description field
            const descField = document.getElementById('task-detail-description');
            if (descField) {
                descField.addEventListener('paste', handleTaskPaste);
            }
        });
        
        // Handle paste event (Ctrl+V or right-click paste)
        function handleTaskPaste(e) {
            if (!currentDetailTask) return;
            
            const items = e.clipboardData?.items;
            if (!items) return;
            
            for (const item of items) {
                if (item.type.startsWith('image/')) {
                    e.preventDefault();
                    const file = item.getAsFile();
                    if (file) addImageToTask(file);
                    return;
                }
            }
        }
        
        window.removeTaskImage = function(index) {
            if (currentDetailTask?.images) {
                currentDetailTask.images.splice(index, 1);
                renderTaskImages();
                saveState('Removed image from task');
            }
        };
        
        window.saveTaskDetails = function() {
            if (!currentDetailTask || !currentDetailColumn) return;
            
            currentDetailTask.title = document.getElementById('task-detail-title').value;
            currentDetailTask.description = document.getElementById('task-detail-description').value;
            
            saveState('Updated task details');
            render();
            showToast('Task saved!', 'success');
        };
        
        window.taskDetailMove = function(newColumn) {
            if (!currentDetailTask || !currentDetailColumn || currentDetailColumn === newColumn) return;
            
            // Save current details first
            currentDetailTask.title = document.getElementById('task-detail-title').value;
            currentDetailTask.description = document.getElementById('task-detail-description').value;
            
            // Remove from current column
            const idx = state.tasks[currentDetailColumn].findIndex(t => t.id === currentDetailTask.id);
            if (idx > -1) state.tasks[currentDetailColumn].splice(idx, 1);
            
            // Add to new column
            if (newColumn === 'done') currentDetailTask.completedAt = Date.now();
            state.tasks[newColumn].unshift(currentDetailTask);
            
            currentDetailColumn = newColumn;
            
            // Update status badge
            const statusEl = document.getElementById('task-detail-status');
            const statusMap = { todo: 'To-Do', progress: 'In Progress', done: 'Done', archive: 'Archived' };
            statusEl.textContent = statusMap[newColumn] || newColumn;
            statusEl.className = 'badge ' + (newColumn === 'done' ? 'badge-success' : newColumn === 'progress' ? 'badge-warning' : '');
            
            saveState('Moved task to ' + newColumn);
            render();
            showToast('Task moved!', 'success');
        };
        
        window.taskDetailCyclePriority = function() {
            if (!currentDetailTask) return;
            currentDetailTask.priority = (currentDetailTask.priority || 1) % 4 + 1;
            document.getElementById('task-detail-priority').textContent = 'P' + currentDetailTask.priority;
            saveState('Changed priority');
            render();
        };
        
        window.taskDetailDelete = async function() {
            if (!currentDetailTask || !currentDetailColumn) return;
            
            const confirmed = await showConfirm('Delete this task permanently?', 'Delete Task', 'Delete');
            if (!confirmed) return;
            
            const idx = state.tasks[currentDetailColumn].findIndex(t => t.id === currentDetailTask.id);
            if (idx > -1) state.tasks[currentDetailColumn].splice(idx, 1);
            
            saveState('Deleted task');
            render();
            closeTaskDetailModal();
            showToast('Task deleted', 'success');
        };
    </script>
    
    <!-- Memory Files Styles -->
    <style>
        .docs-category {
            margin-bottom: var(--space-6);
        }
        
        .category-title {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-2);
            border-bottom: 1px solid var(--border-subtle);
        }
        
        .docs-category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--space-4);
        }
        
        .memory-file {
            cursor: pointer;
            transition: all var(--transition-normal);
        }
        
        .memory-file:hover {
            background: var(--surface-2);
            border-color: var(--brand-red);
            transform: translateY(-1px);
        }
        
        .doc-description {
            font-size: 13px;
            color: var(--text-muted);
            line-height: 1.4;
            margin-top: var(--space-1);
        }
        
        .docs-separator {
            grid-column: 1 / -1;
            margin-top: var(--space-6);
            margin-bottom: var(--space-4);
        }
        
        .empty-state {
            text-align: center;
            color: var(--text-muted);
            padding: var(--space-10);
        }
        
        .loading-state {
            text-align: center;
            color: var(--text-muted);
            padding: var(--space-10);
            font-style: italic;
        }
        
        .doc-meta {
            font-size: 11px;
            color: var(--text-faint);
            margin-top: var(--space-1);
        }
        
        /* Bot-updated file styling */
        .memory-file.bot-updated {
            border-color: var(--brand-red);
            background: rgba(188, 32, 38, 0.05);
        }
        
        .memory-file.bot-updated:hover {
            border-color: var(--brand-red);
            background: rgba(188, 32, 38, 0.1);
        }
        
        .bot-updated-badge {
            animation: pulse-badge 2s ease-in-out infinite;
        }
        
        @keyframes pulse-badge {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Version history panel */
        .version-item:hover {
            background: var(--surface-2);
        }
        
        .version-item:last-child {
            border-bottom: none;
        }
        
        /* Drag and drop highlight for chat */
        .chat-page-wrapper.drag-over {
            outline: 3px dashed var(--brand-red);
            outline-offset: -3px;
            background: rgba(188, 32, 38, 0.05);
        }
        
        .chat-page-wrapper.drag-over::after {
            content: '📷 Drop image here';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--surface-overlay);
            padding: var(--space-4) var(--space-6);
            border-radius: var(--radius-lg);
            font-size: 16px;
            font-weight: 500;
            color: var(--brand-red);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 100;
        }
    </style>
    <script>
    // ===== THEME PICKER ENGINE =====
    class ThemePicker {
        constructor() {
            const M = { dark: 'midnight', light: 'snow' };
            let s = localStorage.getItem('solobot-theme');
            if (s && M[s]) { s = M[s]; localStorage.setItem('solobot-theme', s); }
            this.currentTheme = s || 'midnight';
            this.applyTheme(this.currentTheme, false);
            this.setupThemeCards();
            this.observeThemeChanges();
        }
        setupThemeCards() {
            document.querySelectorAll('.theme-card').forEach(card => {
                const t = card.getAttribute('data-theme');
                if (!t) return;
                card.classList.toggle('active', t === this.currentTheme);
                card.onclick = () => this.selectTheme(t);
            });
        }
        selectTheme(t) {
            if (t === this.currentTheme) return;
            this.currentTheme = t;
            this.applyTheme(t, true);
            localStorage.setItem('solobot-theme', t);
            this.updateActiveCard();
            window.dispatchEvent(new CustomEvent('themeChanged', { detail: { theme: t } }));
        }
        applyTheme(t, animated) {
            if (animated) {
                document.body.classList.add('theme-transitioning');
                setTimeout(() => document.body.classList.remove('theme-transitioning'), 350);
            }
            document.documentElement.setAttribute('data-theme', t);
        }
        updateActiveCard() {
            document.querySelectorAll('.theme-card').forEach(c => {
                c.classList.toggle('active', c.getAttribute('data-theme') === this.currentTheme);
            });
        }
        observeThemeChanges() {
            new MutationObserver(muts => {
                muts.forEach(m => {
                    if (m.attributeName === 'data-theme') {
                        const nt = document.documentElement.getAttribute('data-theme');
                        if (nt && nt !== this.currentTheme) { this.currentTheme = nt; this.updateActiveCard(); }
                    }
                });
            }).observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });
        }
        setTheme(t) { this.selectTheme(t); }
        getTheme() { return this.currentTheme; }
    }
    window.themePicker = new ThemePicker();
    </script>
</body>
</html>
