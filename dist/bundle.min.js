let state={status:"idle",model:"opus 4.5",currentTask:null,subagent:null,tasks:{todo:[],progress:[],done:[],archive:[]},notes:[],activity:[],docs:[],pendingNotify:null,live:{status:"idle",task:null,taskStarted:null,thoughts:[],lastActive:null,tasksToday:0},console:{logs:[],expanded:!1},chat:{messages:[]},system:{messages:[]}};function chatStorageKey(e){return"solobot-chat-"+(e||GATEWAY_CONFIG?.sessionKey||localStorage.getItem("gateway_session")||"main")}const _sessionMessageCache=new Map;function cacheSessionMessages(e,t){!e||!t||_sessionMessageCache.set(e,t.slice(-100))}function getCachedSessionMessages(e){return _sessionMessageCache.get(e)||null}function loadPersistedMessages(){try{const e=localStorage.getItem("solobot-system-messages");if(e){const a=JSON.parse(e);if(Array.isArray(a)){const i=Date.now()-864e5;state.system.messages=a.filter(r=>r.time>i)}}const t=chatStorageKey(),n=localStorage.getItem(t),s=n?null:localStorage.getItem("solobot-chat-messages"),o=n||s;if(o){const a=JSON.parse(o);if(Array.isArray(a)&&a.length>0){state.chat.messages=a,s&&!n&&localStorage.setItem(t,o);return}}loadChatFromServer()}catch{loadChatFromServer()}}async function loadChatFromServer(){try{const t=await(await fetch("/api/state")).json();t.chat?.messages?.length>0&&(state.chat.messages=t.chat.messages,localStorage.setItem(chatStorageKey(),JSON.stringify(state.chat.messages)),typeof renderChatMessages=="function"&&renderChatMessages(),typeof renderChatPage=="function"&&renderChatPage())}catch{}}function persistSystemMessages(){try{const e=state.system.messages.slice(-30);localStorage.setItem("solobot-system-messages",JSON.stringify(e))}catch{}}function persistChatMessages(){try{const e=state.chat.messages.slice(-200),t=chatStorageKey();localStorage.setItem(t,JSON.stringify(e)),cacheSessionMessages(currentSessionName||GATEWAY_CONFIG.sessionKey,e),syncChatToServer(e)}catch{}}let chatSyncTimeout=null;function syncChatToServer(e){chatSyncTimeout&&clearTimeout(chatSyncTimeout),chatSyncTimeout=setTimeout(async()=>{try{await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:e})})}catch{}},2e3)}loadPersistedMessages();const GATEWAY_CONFIG={host:localStorage.getItem("gateway_host")||"",port:parseInt(localStorage.getItem("gateway_port"))||443,token:localStorage.getItem("gateway_token")||"",sessionKey:localStorage.getItem("gateway_session")||"main",maxMessages:500};function saveGatewaySettings(e,t,n,s){localStorage.setItem("gateway_host",e),localStorage.setItem("gateway_port",t.toString()),localStorage.setItem("gateway_token",n),localStorage.setItem("gateway_session",s),state.gatewayConfig={host:e,port:t,token:n,sessionKey:s},saveState("Gateway settings updated")}function loadGatewaySettingsFromServer(){state.gatewayConfig&&state.gatewayConfig.host&&(GATEWAY_CONFIG.host=state.gatewayConfig.host,GATEWAY_CONFIG.port=state.gatewayConfig.port||443,GATEWAY_CONFIG.token=state.gatewayConfig.token||"",GATEWAY_CONFIG.sessionKey=state.gatewayConfig.sessionKey||"main",localStorage.setItem("gateway_host",GATEWAY_CONFIG.host),localStorage.setItem("gateway_port",GATEWAY_CONFIG.port.toString()),localStorage.setItem("gateway_token",GATEWAY_CONFIG.token),localStorage.setItem("gateway_session",GATEWAY_CONFIG.sessionKey))}let gateway=null,streamingText="",isProcessing=!1,lastProcessingEndTime=0,historyPollInterval=null,sessionVersion=0,newTaskPriority=1,newTaskColumn="todo",selectedTasks=new Set,editingTaskId=null,currentModalTask=null,currentModalColumn=null,refreshIntervalId=null,taskModalOpen=!1;const DISABLE_SYSTEM_FILTER=!1;async function loadState(){const e=state.chat,t=state.system,n=state.console,s=i=>{if(!i||!i.tasks)return 0;const r=i.tasks;return(r.todo?.length||0)+(r.progress?.length||0)+(r.done?.length||0)};let o=null;try{const i=localStorage.getItem("solovision-dashboard");if(i){const r=JSON.parse(i);r.tasks&&s(r)>0&&(o=JSON.parse(JSON.stringify(r.tasks)))}}catch{}!o&&s(state)>0&&(o=JSON.parse(JSON.stringify(state.tasks)));try{const i=await fetch("/api/state",{cache:"no-store"});if(i.ok){const r=await i.json();r.tasks||(r.tasks={todo:[],progress:[],done:[],archive:[]}),r.tasks.archive||(r.tasks.archive=[]),delete r.pendingChat,delete r.chat;const c=s(r),l=o?s({tasks:o}):0,d=Array.isArray(r.activity)?r.activity.length:0,u=Array.isArray(state.activity)?state.activity.length:0,m=l>c&&o?o:r.tasks,p=u>d?state.activity:r.activity;if(l>c&&o&&console.warn(`[loadState] Preserving local tasks (${l}) over server (${c})`),u>d&&console.warn(`[loadState] Preserving local activity (${u}) over server (${d})`),state={...state,...r,tasks:m,activity:p||[],chat:e,system:t,console:n},l>c||u>d){const g={};l>c&&(g.tasks=m),u>d&&(g.activity=p),fetch("/api/sync",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(g)}).then(()=>console.log("[loadState] Pushed preserved data back to server")).catch(()=>{})}delete state.localModified,localStorage.setItem("solovision-dashboard",JSON.stringify(state));return}}catch{}const a=localStorage.getItem("solovision-dashboard");if(a){const i=JSON.parse(a);delete i.system,delete i.console,state={...state,...i,chat:e,system:t,console:n}}else initSampleData()}const SYNC_API="/api/sync";async function saveState(e=null){state.localModified=Date.now(),e&&(state.lastChange=e);try{const t=JSON.parse(JSON.stringify(state));t.chat&&t.chat.messages&&(t.chat.messages=t.chat.messages.slice(-200)),t.console&&t.console.logs&&(t.console.logs=t.console.logs.slice(-500)),t.activity&&(t.activity=t.activity.slice(-200)),localStorage.setItem("solovision-dashboard",JSON.stringify(t))}catch(t){t.name==="QuotaExceededError"?(console.warn("[Dashboard] localStorage full, clearing old data..."),localStorage.removeItem("solovision-dashboard"),localStorage.removeItem("solobot-chat"),localStorage.removeItem("solobot-system-messages")):console.error("[Dashboard] saveState error:",t)}updateLastSync(),await syncToServer()}async function syncToServer(){try{let e=0,t=0;try{const i=await fetch("/api/state",{cache:"no-store"});if(i.ok){const r=await i.json(),c=r.tasks||{};e=(c.todo?.length||0)+(c.progress?.length||0)+(c.done?.length||0),t=Array.isArray(r.activity)?r.activity.length:0}}catch{}const n=JSON.parse(JSON.stringify(state)),s=(state.tasks?.todo?.length||0)+(state.tasks?.progress?.length||0)+(state.tasks?.done?.length||0),o=Array.isArray(state.activity)?state.activity.length:0;e>0&&s<e&&(console.warn(`[Sync] Skipping tasks \u2014 server has ${e}, local has ${s}`),delete n.tasks),t>0&&o<t&&(console.warn(`[Sync] Skipping activity \u2014 server has ${t}, local has ${o}`),delete n.activity),delete n.chat,delete n.system,delete n.console;const a=await fetch(SYNC_API,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(a.ok){const i=await a.json();(i.protected?.tasks||i.protected?.activity)&&console.log("[Sync] Server protected data:",i.protected),state.console&&state.console.logs&&(state.console.logs.push({text:"State synced to server",type:"info",time:Date.now()}),state.console.logs.length>500&&(state.console.logs=state.console.logs.slice(-500)),renderConsole())}}catch(e){console.error("Sync error:",e)}}function initSampleData(){state.tasks={todo:[],progress:[],done:[],archive:[]},state.notes=[],state.activity=[],state.docs=[],saveState()}function formatTime(e){if(!e)return"";const t=new Date(e);return isNaN(t.getTime())?"":t.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"})}function formatSmartTime(e){if(!e)return"";const n=Date.now()-e;return n<3e4?"just now":n<6e4?`${Math.floor(n/1e3)}s ago`:n<36e5?`${Math.floor(n/6e4)}m ago`:n<864e5?`${Math.floor(n/36e5)}h ago`:n<6048e5?`${Math.floor(n/864e5)}d ago`:new Date(e).toLocaleDateString("en-US",{month:"short",day:"numeric"})}function formatTimeShort(e){return e?new Date(e).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}):""}function formatRelativeTime(e){if(!e)return"Unknown";const t=Date.now()-e,n=Math.floor(t/6e4);if(n<1)return"Just now";if(n<60)return`${n}m ago`;const s=Math.floor(n/60);return s<24?`${s}h ago`:formatDate(e)}function formatDate(e){return new Date(e).toLocaleDateString("en-US",{month:"short",day:"numeric"})}function updateLastSync(){document.getElementById("last-sync").textContent=formatTime(Date.now())}function getPriorityClass(e){return e===0?"badge-error":e===1?"badge-warning":"badge-default"}function getPriorityBadgeClass(e){return e===0?"badge-error":e===1?"badge-warning":"badge-default"}function getLogColor(e){switch(e){case"command":return"text-green-400";case"success":return"text-green-300";case"error":return"text-red-400";case"warning":return"text-yellow-400";case"info":return"text-blue-400";case"thinking":return"text-purple-400";case"output":return"text-gray-300";default:return"text-gray-400"}}function getLogPrefix(e){switch(e){case"command":return"$ ";case"thinking":return"\u{1F9E0} ";case"success":return"\u2713 ";case"error":return"\u2717 ";case"warning":return"\u26A0 ";default:return""}}function getDocIcon(e){return getDocIconSymbol(e,"")}function addActivity(e,t="info"){state.activity.push({time:Date.now(),action:e,type:t}),state.activity.length>500&&(state.activity=state.activity.slice(-500))}function updateArchiveBadge(){const e=document.getElementById("archive-badge");if(!e)return;const t=(state.tasks.archive||[]).length;e.textContent=t,t>0?e.classList.remove("hidden"):e.classList.add("hidden")}let confirmResolver=null;function showToast(e,t="info",n=4e3){const s=document.getElementById("toast-container");if(!s)return;const o=document.createElement("div");switch(o.style.cssText=`
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        animation: slideIn 0.3s ease;
        max-width: 350px;
        word-wrap: break-word;
    `,t){case"success":o.style.background="var(--success)";break;case"error":o.style.background="var(--error)";break;case"warning":o.style.background="#f59e0b";break;default:o.style.background="var(--accent)";break}o.textContent=e,s.appendChild(o),setTimeout(()=>{o.style.animation="fadeOut 0.3s ease",setTimeout(()=>o.remove(),300)},n)}window.showConfirm=showConfirm,window.closeConfirmModal=closeConfirmModal,window.showToast=showToast,window.alert=function(e){showToast(e,"info",5e3)};const _originalConfirm=window.confirm;window.confirm=function(e){return console.warn("[Dashboard] Native confirm() intercepted. Use showConfirm() for proper async handling."),showToast("Action blocked - please try again","warning"),showConfirm(e,"Confirm"),!1};let confirmModalCallback=null;function showConfirm(e,t,n="OK",s="Cancel",o=!1){return new Promise(a=>{const i=document.getElementById("confirm-modal-title"),r=document.getElementById("confirm-modal-message"),c=document.getElementById("confirm-modal-ok"),l=document.getElementById("confirm-modal-cancel");i&&(i.textContent=e),r&&(r.textContent=t),c&&(c.textContent=n,c.className=o?"btn btn-danger":"btn btn-primary"),l&&(l.textContent=s),confirmModalCallback=a,showModal("confirm-modal")})}function closeConfirmModal(e){hideModal("confirm-modal"),confirmModalCallback&&(confirmModalCallback(e),confirmModalCallback=null)}window.showConfirm=showConfirm,window.closeConfirmModal=closeConfirmModal;async function clearChatHistory(e=!1,t=!1){!e&&!await showConfirm("Clear Chat History","Clear all chat messages? They may reload from Gateway on next sync.","Clear","Cancel",!0)||(state.chat.messages=[],chatPageNewMessageCount=0,chatPageUserScrolled=!1,t&&localStorage.removeItem(chatStorageKey()),renderChat(),renderChatPage())}function getTaskAgent(e){if(e.agent)return e.agent;const t=(e.title||"").toLowerCase(),n=(e.description||"").toLowerCase(),s=["dev","exec","coo","cfo","cmp","sec","smm","family","tax"];for(const o of s)if(t.startsWith(`${o}:`)||t.startsWith(`${o} -`)||t.startsWith(`${o} `))return o;return t.startsWith("solobot-android:")||t.startsWith("android:")||t.includes("dashboard:")||t.includes("android")||t.includes("api ")||t.includes("fix ")||t.includes("deploy")||t.includes("cache")||t.includes("sync")||t.includes("notification")||t.includes("server.js")?"dev":t.includes("marketing")||t.includes("social")||t.includes("content")?"cmp":t.includes("budget")||t.includes("invoice")||t.includes("financial")?"cfo":t.includes("security")||t.includes("audit")?"sec":"main"}function getAgentColor(e){return getComputedStyle(document.documentElement).getPropertyValue(`--agent-${e}`).trim()||"#888"}function getFilteredSortedTasks(e){let t=[...state.tasks[e]||[]];const n=(document.getElementById("task-search")?.value||"").toLowerCase().trim();n&&(t=t.filter(i=>(i.title||"").toLowerCase().includes(n)||(i.description||"").toLowerCase().includes(n)));const s=document.getElementById("task-filter-priority")?.value||"all";if(s!=="all"){const i=parseInt(s);t=t.filter(r=>(r.priority??1)===i)}const o=document.getElementById("task-filter-agent")?.value||"all";switch(o!=="all"&&(t=t.filter(i=>getTaskAgent(i)===o)),document.getElementById("task-sort")?.value||"newest"){case"newest":t.sort((i,r)=>(r.created||0)-(i.created||0));break;case"oldest":t.sort((i,r)=>(i.created||0)-(r.created||0));break;case"priority-high":t.sort((i,r)=>(i.priority??1)-(r.priority??1));break;case"priority-low":t.sort((i,r)=>(r.priority??1)-(i.priority??1));break;case"alpha-az":t.sort((i,r)=>(i.title||"").localeCompare(r.title||""));break;case"alpha-za":t.sort((i,r)=>(r.title||"").localeCompare(i.title||""));break}return t}function applyTaskFilters(){renderTasks(),updateBulkActionsUI()}function populateAgentFilter(){const e=document.getElementById("task-filter-agent");if(!e)return;const t=new Set;["todo","progress","done"].forEach(o=>{(state.tasks[o]||[]).forEach(a=>t.add(getTaskAgent(a)))});const n=e.value;e.innerHTML='<option value="all">All agents</option>';const s=[...t].sort();for(const o of s){const a=getAgentColor(o),i=document.createElement("option");i.value=o,i.textContent=o.toUpperCase(),i.style.color=a,e.appendChild(i)}e.value=n||"all"}function updateTaskStats(){const e=document.getElementById("task-stats");if(!e)return;const t=(state.tasks.todo||[]).length,n=(state.tasks.progress||[]).length,s=(state.tasks.done||[]).length,o=t+n+s,a=o>0?Math.round(s/o*100):0;e.innerHTML=`${o} tasks \u2022 ${a}% done`}function updateBulkActionsUI(){const e=document.getElementById("task-bulk-actions"),t=document.getElementById("task-selected-count");e&&(selectedTasks.size>0?(e.style.display="flex",t&&(t.textContent=`${selectedTasks.size} selected`)):e.style.display="none")}function bulkDelete(){selectedTasks.size!==0&&confirm(`Delete ${selectedTasks.size} task(s)?`)&&(["todo","progress","done"].forEach(e=>{state.tasks[e]=(state.tasks[e]||[]).filter(t=>!selectedTasks.has(t.id))}),selectedTasks.clear(),saveState("Bulk deleted tasks"),renderTasks())}function renderTasks(){populateAgentFilter(),["todo","progress","done"].forEach(e=>{const t=document.getElementById(`${e==="progress"?"progress":e}-tasks`),n=document.getElementById(`${e==="progress"?"progress":e}-count`);if(!t){console.warn("[renderTasks] Missing container for",e);return}const s=getFilteredSortedTasks(e),o=(state.tasks[e]||[]).length;if(s.length===0){const a=o>0?"No tasks match filters":"No tasks";t.innerHTML=`<div style="color: var(--text-muted); font-size: 13px; text-align: center; padding: var(--space-6) var(--space-2);">${a}</div>`,n&&(n.textContent=o);return}t.innerHTML=s.map((a,i)=>{const r=selectedTasks.has(a.id),c=e==="done"?"text-decoration: line-through; color: var(--text-muted);":"",l=getTaskAgent(a),d=getAgentColor(l),u=Math.floor((Date.now()-(a.created||0))/864e5),m=u===0?"today":u===1?"1d ago":`${u}d ago`;return`
            <div class="task-card priority-p${a.priority} ${r?"selected":""} ${a.images?.length?"has-attachments":""}"
                 data-task-id="${a.id}" data-column="${e}"
                 onclick="openTaskDetail('${a.id}', '${e}')">
                <div style="display: flex; align-items: flex-start; gap: var(--space-3);">
                    <span class="drag-handle" draggable="true"
                          ondragstart="handleDragStart(event, '${a.id}', '${e}')"
                          ondragend="handleDragEnd(event)"
                          title="Drag to move">\u283F</span>
                    <input type="checkbox"
                           style="margin-top: 2px; accent-color: var(--brand-red); cursor: pointer;"
                           ${r?"checked":""}
                           onclick="toggleTaskSelection('${a.id}', event)">
                    <div style="flex: 1; min-width: 0;">
                        <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: var(--space-2);">
                            <span class="task-title" style="${c}">${escapeHtml(a.title)}</span>
                            <div style="display: flex; gap: 4px; align-items: center; flex-shrink: 0;">
                                <span style="font-size: 9px; padding: 1px 5px; border-radius: 8px; background: ${d}22; color: ${d}; font-weight: 600; text-transform: uppercase;">${l}</span>
                                <span class="badge ${getPriorityBadgeClass(a.priority)}">P${a.priority}</span>
                            </div>
                        </div>
                        ${a.description?`<div style="font-size: 11px; color: var(--text-muted); margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 100%;">${escapeHtml(a.description.slice(0,80))}${a.description.length>80?"\u2026":""}</div>`:""}
                        <div class="task-meta">
                            ${m} \u2022 ${formatTime(a.created||a.completedAt||a.id?.replace("t",""))}
                            ${a.description?" \u2022 \u{1F4DD}":""}
                            ${a.images?.length?` \u2022 \u{1F4CE}${a.images.length}`:""}
                        </div>
                    </div>
                </div>

                <div class="task-quick-actions">
                    ${e==="todo"?`
                        <button onclick="quickMoveTask('${a.id}', '${e}', 'progress', event)"
                                class="btn btn-ghost" style="width: 28px; height: 28px; padding: 0; border-radius: 50%;"
                                title="Start Working">\u25B6</button>
                    `:""}
                    ${e!=="done"?`
                        <button onclick="quickMoveTask('${a.id}', '${e}', 'done', event)"
                                class="btn btn-primary" style="width: 28px; height: 28px; padding: 0; border-radius: 50%;"
                                title="Mark Done">\u2713</button>
                    `:""}
                    ${e==="done"?`
                        <button onclick="quickMoveTask('${a.id}', '${e}', 'todo', event)"
                                class="btn btn-ghost" style="width: 28px; height: 28px; padding: 0; border-radius: 50%;"
                                title="Reopen">\u21A9</button>
                    `:""}
                </div>
            </div>
        `}).join(""),n&&(n.textContent=s.length===o?o:`${s.length}/${o}`)}),updateTaskStats(),updateBulkActionsUI(),updateDoneColumnCollapse(),typeof updateQuickStats=="function"&&updateQuickStats()}let doneColumnCollapsed=localStorage.getItem("doneColumnCollapsed")!=="false";function updateDoneColumnCollapse(){const e=document.getElementById("done-tasks"),t=document.getElementById("done-collapsed-summary"),n=document.getElementById("done-toggle-btn"),s=document.getElementById("done-collapsed-text");if(!e)return;const o=(state.tasks.done||[]).length;if(s&&(s.textContent=`${o} completed task${o!==1?"s":""}`),o===0){e.classList.remove("done-hidden"),t&&(t.style.display="none"),n&&(n.textContent="Show");return}doneColumnCollapsed?(e.classList.add("done-hidden"),t&&(t.style.display=""),n&&(n.textContent="Show")):(e.classList.remove("done-hidden"),t&&(t.style.display="none"),n&&(n.textContent="Hide"))}function toggleDoneColumn(){doneColumnCollapsed=!doneColumnCollapsed,localStorage.setItem("doneColumnCollapsed",doneColumnCollapsed.toString()),updateDoneColumnCollapse()}function renderNotes(){const e=document.getElementById("notes-list");e.innerHTML=state.notes.map(t=>`
        <div class="note-item" style="${t.seen?"opacity: 0.6;":""}">
            <div style="display: flex; align-items: flex-start; justify-content: space-between;">
                <span class="note-text">${escapeHtml(t.text)}</span>
                ${t.seen?'<span class="badge badge-success">\u2713 Seen</span>':'<span class="badge badge-warning">Pending</span>'}
            </div>
            <div class="note-meta">${formatTime(t.created)}</div>
        </div>
    `).join("")||'<div style="text-align: center; color: var(--text-muted); padding: var(--space-4);">No notes yet</div>'}function renderActivity(){const e=document.getElementById("activity-log");if(!e)return;const t=state.activity.slice().reverse().slice(0,50);if(t.length===0){e.innerHTML='<div style="text-align: center; color: var(--text-muted); padding: var(--space-4);">No activity yet</div>';return}const n=Date.now(),s=new Date().toDateString(),o=new Date(n-864e5).toDateString(),a=n-7*864e5,i={today:[],yesterday:[],thisWeek:[],older:[]},r=[];t.forEach(d=>{const u=new Date(d.time).toDateString();if(/system|heartbeat|audit|auto/i.test(d.action)){r.push(d);return}u===s?i.today.push(d):u===o?i.yesterday.push(d):d.time>a?i.thisWeek.push(d):i.older.push(d)});const c=d=>{const u=formatTime(d.time);let m="\u{1F4CB}",p=escapeHtml(d.action);const g=d.action.toLowerCase();g.includes("completed")||g.includes("done")?m="\u2705":g.includes("started")||g.includes("began")?m="\u25B6\uFE0F":g.includes("created")||g.includes("added")?m="\u2795":g.includes("deleted")||g.includes("removed")?m="\u{1F5D1}\uFE0F":g.includes("updated")||g.includes("edited")?m="\u270F\uFE0F":(g.includes("error")||g.includes("failed"))&&(m="\u274C");const f=d.type==="success"?"success":d.type==="error"?"warning":"";return`
            <div class="activity-item">
                <span style="font-size: 14px; margin-right: 6px;">${m}</span>
                <div style="flex: 1; min-width: 0;">
                    <span class="activity-text ${f}">${p}</span>
                    <span class="activity-time" style="font-size: 10px; color: var(--text-muted); margin-left: 6px;">${u}</span>
                </div>
            </div>
        `};let l="";i.today.length>0&&(l+='<div class="activity-group-header">Today</div>',l+=i.today.map(c).join("")),i.yesterday.length>0&&(l+='<div class="activity-group-header">Yesterday</div>',l+=i.yesterday.map(c).join("")),i.thisWeek.length>0&&(l+='<div class="activity-group-header">This Week</div>',l+=i.thisWeek.map(c).join("")),i.older.length>0&&(l+='<div class="activity-group-header">Older</div>',l+=i.older.map(c).join("")),r.length>0&&(l+=`
            <div class="activity-system-toggle" onclick="toggleSystemActivity()" style="cursor: pointer; padding: var(--space-2); margin-top: var(--space-2); background: var(--surface-2); border-radius: var(--radius-md); text-align: center; font-size: 11px; color: var(--text-muted);">
                <span id="system-activity-toggle-text">Show ${r.length} system entries \u25BC</span>
            </div>
            <div id="system-activity-list" style="display: none;">
                <div class="activity-group-header">System</div>
                ${r.map(c).join("")}
            </div>
        `),e.innerHTML=l}function toggleSystemActivity(){const e=document.getElementById("system-activity-list"),t=document.getElementById("system-activity-toggle-text");if(!e||!t)return;const n=e.style.display==="none";e.style.display=n?"block":"none";const s=(state.activity||[]).filter(o=>/system|heartbeat|audit|auto/i.test(o.action)).length;t.textContent=n?"Hide system entries \u25B2":`Show ${s} system entries \u25BC`}function renderDocs(e=""){const t=document.getElementById("docs-grid");if(!t)return;renderMemoryFiles(e);const n=state.docs.filter(s=>s.name.toLowerCase().includes(e.toLowerCase()));if(n.length>0){t.innerHTML&&n.length>0&&(t.innerHTML+='<div class="docs-separator"><h3 class="category-title">Google Drive Documents</h3></div>');const s=n.map(o=>{const a=getDocIconClass(o.type,o.url),i=getDocIconSymbol(o.type,o.url);return`
            <a href="${o.url}" target="_blank" class="doc-card">
                <div style="display: flex; align-items: center; gap: var(--space-3);">
                    <div class="doc-icon ${a}">${i}</div>
                    <div style="min-width: 0; flex: 1;">
                        <div class="doc-title">${escapeHtml(o.name)}</div>
                        <div class="doc-meta">Updated: ${formatDate(o.updated)}</div>
                    </div>
                </div>
            </a>
        `}).join("");t.innerHTML+=s}t.innerHTML||(t.innerHTML='<div style="color: var(--text-muted); font-size: 13px; grid-column: 1 / -1; text-align: center; padding: var(--space-4);">No documents found</div>')}function getDocIconClass(e,t){return t?.includes("docs.google.com/document")?"gdoc":t?.includes("docs.google.com/spreadsheets")?"gsheet":e==="pdf"||t?.includes(".pdf")?"pdf":"default"}function getDocIconSymbol(e,t){return t?.includes("docs.google.com/document")?"\u{1F4C4}":t?.includes("docs.google.com/spreadsheets")?"\u{1F4CA}":e==="pdf"||t?.includes(".pdf")?"\u{1F4D5}":"\u{1F4C1}"}let statsState={tasksDoneThisWeek:0,messagesToday:0,streak:parseInt(localStorage.getItem("dashboardStreak")||"0"),sessionStartTime:Date.now(),history:{tasks:JSON.parse(localStorage.getItem("stats_history_tasks")||"[]"),messages:JSON.parse(localStorage.getItem("stats_history_messages")||"[]"),focus:JSON.parse(localStorage.getItem("stats_history_focus")||"[]")}};function generateSparkline(e,t=60,n=24,s="neutral"){if(!e||e.length<2)return`<svg width="${t}" height="${n}" class="sparkline"><line x1="0" y1="${n/2}" x2="${t}" y2="${n/2}" stroke="var(--text-muted)" stroke-width="1" stroke-dasharray="2,2"/></svg>`;const o=Math.max(...e,1),a=Math.min(...e,0),i=o-a||1,r=e.map((d,u)=>{const m=u/(e.length-1)*t,p=n-(d-a)/i*n*.8-n*.1;return`${m},${p}`}).join(" "),c=`0,${n} ${r} ${t},${n}`;return`
        <svg width="${t}" height="${n}" class="sparkline ${s==="positive"?"sparkline-positive":s==="negative"?"sparkline-negative":"sparkline-neutral"}" viewBox="0 0 ${t} ${n}">
            <polygon points="${c}" class="sparkline-area" />
            <polyline points="${r}" class="sparkline-path" />
        </svg>
    `}function updateSparklineData(e,t){const n=statsState.history[e];n.push(t),n.length>7&&n.shift(),localStorage.setItem(`stats_history_${e}`,JSON.stringify(n))}function generateProgressRing(e,t,n=50,s=4,o=null){const a=(n-s)/2,i=2*Math.PI*a,r=Math.min(Math.max(e/t,0),1),c=i-r*i,l=o||"var(--brand-red)";return`
        <div class="progress-ring" style="width: ${n}px; height: ${n}px;">
            <svg width="${n}" height="${n}">
                <circle
                    class="progress-ring-bg"
                    cx="${n/2}" cy="${n/2}" r="${a}"
                    fill="none"
                    stroke-width="${s}"
                />
                <circle
                    class="progress-ring-circle"
                    cx="${n/2}" cy="${n/2}" r="${a}"
                    fill="none"
                    stroke="${l}"
                    stroke-width="${s}"
                    stroke-linecap="round"
                    stroke-dasharray="${i}"
                    stroke-dashoffset="${c}"
                />
            </svg>
            <span class="progress-ring-value">${Math.round(r*100)}%</span>
        </div>
    `}function generateMiniHeatmap(e,t=4,n=7){const s=[];for(let o=0;o<t*n;o++){const a=e[o]||0,i=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][o%7];s.push(`<div class="heatmap-cell level-${a}" title="${i}: Level ${a}"></div>`)}return`<div class="mini-heatmap" style="grid-template-columns: repeat(${n}, 1fr);">${s.join("")}</div>`}function generateActivityHeatmap(e){return`<div class="activity-heatmap">${e.map((n,s)=>{const o=`${s}:00`;return`<div class="activity-heatmap-cell ${n>0?"active":""}" style="opacity: ${.2+n/5*.8}" title="${o}: Level ${n}"></div>`}).join("")}</div>`}function getRealActivityData(){const t=Date.now(),n=864e5,s=new Array(28).fill(0);if(!state.activity||state.activity.length===0)return null;state.activity.forEach(a=>{const i=a.time||0,r=Math.floor((t-i)/n);r>=0&&r<28&&s[27-r]++});const o=Math.max(...s,1);return s.map(a=>{if(a===0)return 0;const i=a/o;return i<.2?1:i<.4?2:i<.6?3:i<.8?4:5})}function getRealHourlyActivityData(){const t=Date.now(),n=36e5,s=new Array(24).fill(0);if(!state.activity||state.activity.length===0)return null;state.activity.forEach(a=>{const i=a.time||0,r=Math.floor((t-i)/n);r>=0&&r<24&&s[23-r]++});const o=Math.max(...s,1);return s.map(a=>{if(a===0)return 0;const i=a/o;return i<.2?1:i<.4?2:i<.6?3:i<.8?4:5})}function updateQuickStats(){const e=state.tasks?.done?.length||0,t=document.getElementById("stat-tasks-done");t&&(t.textContent=e,updateSparklineData("tasks",e));const n=document.getElementById("stat-focus-sessions");n&&(n.textContent=focusTimer.sessions,updateSparklineData("focus",focusTimer.sessions));const s=new Date().toDateString(),o=(state.chat?.messages||[]).filter(c=>new Date(c.time).toDateString()===s).length,a=document.getElementById("stat-messages");a&&(a.textContent=o,updateSparklineData("messages",o)),updateStreak();const i=document.getElementById("stat-streak");i&&(i.textContent=statsState.streak);const r=document.getElementById("stat-uptime");if(r){const c=Math.floor((Date.now()-statsState.sessionStartTime)/6e4);if(c<60)r.textContent=`${c}m`;else{const l=Math.floor(c/60),d=c%60;r.textContent=`${l}h ${d}m`}}renderSparklines(),renderProgressRings(),renderHeatmaps()}function renderSparklines(){const e=document.getElementById("sparkline-tasks");if(e){const s=statsState.history.tasks.length>1?statsState.history.tasks[statsState.history.tasks.length-1]-statsState.history.tasks[statsState.history.tasks.length-2]:0,o=s>0?"positive":s<0?"negative":"neutral";e.innerHTML=generateSparkline(statsState.history.tasks,40,20,o)}const t=document.getElementById("sparkline-messages");t&&(t.innerHTML=generateSparkline(statsState.history.messages,40,20,"neutral"));const n=document.getElementById("sparkline-focus");n&&(n.innerHTML=generateSparkline(statsState.history.focus,40,20,"positive"))}function renderHeatmaps(){const e=document.getElementById("activity-heatmap-container");if(e){const n=getRealActivityData();n?e.innerHTML=generateMiniHeatmap(n,4,7):e.innerHTML=`
                <div style="text-align: center; padding: var(--space-4); color: var(--text-muted);">
                    <div style="font-size: 24px; margin-bottom: var(--space-2); opacity: 0.5;">\u{1F4CA}</div>
                    <div style="font-size: 11px;">Activity data builds over time</div>
                </div>
            `}const t=document.getElementById("hourly-heatmap-container");if(t){const n=getRealHourlyActivityData();n?t.innerHTML=generateActivityHeatmap(n):t.innerHTML=`
                <div style="text-align: center; padding: var(--space-4); color: var(--text-muted);">
                    <div style="font-size: 24px; margin-bottom: var(--space-2); opacity: 0.5;">\u23F1\uFE0F</div>
                    <div style="font-size: 11px;">Hourly activity will appear here</div>
                </div>
            `}}function renderProgressRings(){const e=document.getElementById("progress-ring-tasks");if(e){const n=(state.tasks?.todo?.length||0)+(state.tasks?.progress?.length||0)+(state.tasks?.done?.length||0),s=state.tasks?.done?.length||0;e.innerHTML=generateProgressRing(s,n||1,40,3,"var(--success)")}const t=document.getElementById("progress-ring-daily");if(t){const n=new Date().toDateString(),s=(state.tasks?.done||[]).filter(o=>(o.completedAt?new Date(o.completedAt).toDateString():null)===n).length;t.innerHTML=generateProgressRing(s,10,40,3,"var(--brand-red)")}}function updateStreak(){const e=localStorage.getItem("lastActiveDate"),t=new Date().toDateString(),n=new Date(Date.now()-864e5).toDateString();e!==t&&(e===n?statsState.streak++:e!==t&&(statsState.streak=1),localStorage.setItem("dashboardStreak",statsState.streak.toString()),localStorage.setItem("lastActiveDate",t))}function initSparklineData(){["tasks","messages","focus"].forEach(t=>{const n=localStorage.getItem(`stats_history_${t}`);(!n||n==="[]")&&(localStorage.setItem(`stats_history_${t}`,JSON.stringify([])),statsState.history[t]=[])})}initSparklineData(),setInterval(updateQuickStats,6e4),window.QuickStats={update:updateQuickStats,generateSparkline,generateProgressRing,generateMiniHeatmap,generateActivityHeatmap};const Sparklines={generatePath(e,t=60,n=24){if(!e||e.length<2)return"";const s=Math.min(...e),a=Math.max(...e)-s||1;return`M ${e.map((r,c)=>{const l=c/(e.length-1)*t,d=n-(r-s)/a*n;return`${l},${d}`}).join(" L ")}`},generateAreaPath(e,t=60,n=24){if(!e||e.length<2)return"";const s=Math.min(...e),a=Math.max(...e)-s||1;return`M ${e.map((r,c)=>{const l=c/(e.length-1)*t,d=n-(r-s)/a*n;return`${l},${d}`}).join(" L ")} L ${t},${n} L 0,${n} Z`},render(e,t,n="neutral"){const s=document.getElementById(e);if(!s||!t||t.length<2)return;const o=60,a=24,i=n==="positive"?"var(--success)":n==="negative"?"var(--error)":"var(--brand-red)",r=n==="positive"?"var(--success)":n==="negative"?"var(--error)":"var(--brand-red)",c=this.generatePath(t,o,a),l=this.generateAreaPath(t,o,a);s.innerHTML=`
            <svg class="sparkline sparkline-${n}" viewBox="0 0 ${o} ${a}" style="width: 100%; height: 100%;">
                <path class="sparkline-area" d="${l}" fill="${r}" opacity="0.15"></path>
                <path class="sparkline-path" d="${c}" stroke="${i}" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        `},generateSampleData(e=10,t="random"){const n=[];let s=50;for(let o=0;o<e;o++)t==="up"?s+=Math.random()*10-2:t==="down"?s-=Math.random()*10-2:s+=Math.random()*20-10,s=Math.max(0,Math.min(100,s)),n.push(s);return n}},ProgressRings={render(e,t,n="",s=48,o=4){const a=document.getElementById(e);if(!a)return;const i=(s-o)/2,r=2*Math.PI*i,c=r-t/100*r;let l="var(--brand-red)";t>=80?l="var(--success)":t>=50&&(l="var(--warning)"),a.innerHTML=`
            <div class="progress-ring" style="width: ${s}px; height: ${s}px;">
                <svg width="${s}" height="${s}">
                    <circle class="progress-ring-bg" 
                            cx="${s/2}" cy="${s/2}" r="${i}" 
                            fill="none" stroke-width="${o}"></circle>
                    <circle class="progress-ring-circle" 
                            cx="${s/2}" cy="${s/2}" r="${i}" 
                            fill="none" stroke="${l}" stroke-width="${o}"
                            stroke-dasharray="${r}" 
                            stroke-dashoffset="${c}"></circle>
                </svg>
                ${n?`<span class="progress-ring-value">${n}</span>`:""}
            </div>
        `},renderStats(e,t){const n=document.getElementById(e);if(!n||!t)return;const s=t.map(o=>{const c=2*Math.PI*18.5,l=c-o.percent/100*c;let d="var(--brand-red)";return o.percent>=80?d="var(--success)":o.percent>=50&&(d="var(--warning)"),`
                <div class="stat-ring-item" style="text-align: center;">
                    <div class="progress-ring" style="width: 40px; height: 40px; margin: 0 auto;">
                        <svg width="40" height="40">
                            <circle class="progress-ring-bg" 
                                    cx="${40/2}" cy="${40/2}" r="${18.5}" 
                                    fill="none" stroke-width="3"></circle>
                            <circle class="progress-ring-circle" 
                                    cx="${40/2}" cy="${40/2}" r="${18.5}" 
                                    fill="none" stroke="${d}" stroke-width="3"
                                    stroke-dasharray="${c}" 
                                    stroke-dashoffset="${l}"></circle>
                        </svg>
                        <span class="progress-ring-value" style="font-size: 11px;">${o.value}</span>
                    </div>
                    <div class="progress-ring-label">${o.label}</div>
                </div>
            `}).join("");n.innerHTML=`<div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">${s}</div>`}},MiniHeatmap={render(e,t,n="week"){const s=document.getElementById(e);if(!s)return;let o=7,a=1;n==="day"?(o=24,a=1):n==="hour"&&(o=12,a=1);const i=t.map((r,c)=>`<div class="heatmap-cell ${`level-${Math.min(5,Math.max(0,r))}`}" title="Activity level: ${r}"></div>`).join("");s.innerHTML=`
            <div class="mini-heatmap" style="grid-template-columns: repeat(${o}, 1fr);">
                ${i}
            </div>
        `},generateSampleData(e=28){return Array.from({length:e},()=>Math.floor(Math.random()*6))},renderWeekHeatmap(e,t){const n=document.getElementById(e);if(!n)return;const s=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],o=t.map((a,i)=>{const r=s[i%7];return`
                <div style="text-align: center;">
                    <div class="heatmap-cell ${`level-${Math.min(5,Math.max(0,a))}`}" title="${r}: Activity level ${a}"></div>
                    <div style="font-size: 9px; color: var(--text-muted); margin-top: 2px;">${r}</div>
                </div>
            `}).join("");n.innerHTML=`<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;">${o}</div>`}},QuickStatsEnhanced={init(){this.renderSparklines(),this.renderProgressRings(),this.renderActivityHeatmap()},renderSparklines(){const e=Sparklines.generateSampleData(10,"up"),t=Sparklines.generateSampleData(10,"random");document.querySelectorAll(".stat-item").forEach((s,o)=>{if(s.querySelector(".stat-value")&&!s.querySelector(".sparkline")){const i=`sparkline-stat-${o}`,r=document.createElement("div");r.id=r,r.className="sparkline",r.style.cssText="width: 40px; height: 16px; margin-top: 4px;";const c=s.querySelector(".stat-label");c&&c.after(r);const l=o%2===0?"positive":"neutral",d=o%2===0?e:t;Sparklines.render(r,d,l)}})},renderProgressRings(){const e=document.querySelector(".bento-task-board");if(e&&!e.querySelector(".progress-ring")){const t=e.querySelector(".bento-widget-header");if(t){const n=document.createElement("div");n.id="task-completion-ring",n.style.cssText="margin-left: auto;";const s=t.querySelector(".bento-widget-actions");if(s){s.before(n);const o=state.tasks?.todo?.length||0,a=state.tasks?.progress?.length||0,i=state.tasks?.done?.length||0,r=o+a+i,c=r>0?Math.round(i/r*100):0;ProgressRings.render("task-completion-ring",c,`${c}%`,36,3)}}}},renderActivityHeatmap(){const e=document.querySelector(".bento-activity");if(e&&!e.querySelector(".mini-heatmap")){const t=e.querySelector(".bento-widget-content");if(t){const n=document.createElement("div");n.id="activity-heatmap-mini",n.style.cssText="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-light);",n.innerHTML='<div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">Activity Pattern (Last 7 Days)</div>';const s=document.createElement("div");s.id="activity-heatmap-grid",n.appendChild(s),t.appendChild(n);const o=MiniHeatmap.generateSampleData(7);MiniHeatmap.renderWeekHeatmap("activity-heatmap-grid",o)}}},update(){this.renderProgressRings()}},WidgetAnimations={fadeInWidgets(){document.querySelectorAll(".bento-widget").forEach((t,n)=>{t.style.opacity="0",t.style.transform="translateY(10px)",t.style.transition="opacity 0.4s ease, transform 0.4s ease",setTimeout(()=>{t.style.opacity="1",t.style.transform="translateY(0)"},n*50)})},setupHoverEffects(){document.querySelectorAll(".bento-widget").forEach(e=>{e.addEventListener("mouseenter",()=>{e.style.transform="translateY(-3px)"}),e.addEventListener("mouseleave",()=>{e.style.transform="translateY(0)"})})}};document.addEventListener("DOMContentLoaded",()=>{setTimeout(()=>{QuickStatsEnhanced.init(),WidgetAnimations.fadeInWidgets(),WidgetAnimations.setupHoverEffects()},500)}),typeof module<"u"&&module.exports&&(module.exports={Sparklines,ProgressRings,MiniHeatmap,QuickStatsEnhanced,WidgetAnimations});let agentStatusInterval=null;function initAgentStatusPanel(){loadAgentStatuses(),agentStatusInterval&&clearInterval(agentStatusInterval),agentStatusInterval=setInterval(loadAgentStatuses,15e3)}async function loadAgentStatuses(){const e=document.getElementById("agent-status-list");if(e){if(!gateway||!gateway.isConnected()){e.innerHTML=`
            <div class="empty-state">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <div class="empty-state-title">No Agent Data</div>
                <div class="empty-state-desc">Connect to gateway to see agent status</div>
            </div>
        `;return}try{const n=(await gateway._request("sessions.list",{includeGlobal:!0}))?.sessions||[];renderAgentStatuses(n)}catch(t){console.warn("[Agents] Failed to fetch sessions:",t.message),e.innerHTML='<div style="color: var(--text-muted); font-size: 12px; text-align: center;">Failed to load</div>'}}}function renderAgentStatuses(e){const t=document.getElementById("agent-status-list");if(!t)return;const n={},s=["main","exec","coo","cfo","cmp","dev","family","tax","sec","smm"];for(const i of e){const r=i.key?.match(/^agent:([^:]+):/),c=r?r[1]:"main";n[c]||(n[c]={sessions:[],lastActivity:0,lastPreview:""}),n[c].sessions.push(i);const l=i.updatedAt?new Date(i.updatedAt).getTime():0;l>n[c].lastActivity&&(n[c].lastActivity=l,n[c].lastPreview=i.displayName||i.key||"")}for(const i of s)n[i]||(n[i]={sessions:[],lastActivity:0,lastPreview:""});const o=Object.entries(n).sort((i,r)=>r[1].lastActivity-i[1].lastActivity),a={main:"SoLoBot",exec:"EXEC",coo:"COO",cfo:"CFO",cmp:"CMP",dev:"DEV",family:"Family",tax:"Tax",sec:"SEC",smm:"SMM"};t.innerHTML=o.map(([i,r])=>{const c=a[i]||i.toUpperCase(),l=r.sessions.length,d=r.lastActivity?timeAgo(r.lastActivity):"No activity",u=r.lastActivity&&Date.now()-r.lastActivity<3e5,m=r.lastActivity&&Date.now()-r.lastActivity<36e5,p=u?"success":m?"warning":"idle",g=u?"Active":m?"Recent":"Idle",f=getComputedStyle(document.documentElement).getPropertyValue(`--agent-${i}`).trim()||"#888";return`
        <div class="agent-status-row" onclick="switchToAgent('${i}')" style="cursor: pointer;">
            <span class="status-dot ${p}"></span>
            <div style="flex: 1; min-width: 0;">
                <div style="display: flex; align-items: center; gap: 6px;">
                    <span style="font-weight: 600; font-size: 13px; color: ${f};">${c}</span>
                    <span style="font-size: 10px; color: var(--text-muted);">${l} session${l!==1?"s":""}</span>
                </div>
                <div style="font-size: 11px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    ${d}${r.lastPreview?" \xB7 "+escapeHtml(r.lastPreview):""}
                </div>
            </div>
            <span style="font-size: 10px; padding: 2px 6px; border-radius: 8px; background: var(--surface-2); color: var(--text-muted);">${g}</span>
        </div>`}).join("")}function timeAgo(e){const t=Date.now()-e;return t<6e4?"just now":t<36e5?Math.floor(t/6e4)+"m ago":t<864e5?Math.floor(t/36e5)+"h ago":Math.floor(t/864e5)+"d ago"}function switchToAgent(e){typeof showPage=="function"&&showPage("chat"),typeof setActiveSidebarAgent=="function"&&setActiveSidebarAgent(e),currentAgentId=e,typeof fetchSessions=="function"&&fetchSessions()}document.addEventListener("DOMContentLoaded",()=>{setTimeout(initAgentStatusPanel,2e3)});let channelStatusInterval=null;function initChannelStatus(){loadChannelStatuses(),channelStatusInterval&&clearInterval(channelStatusInterval),channelStatusInterval=setInterval(loadChannelStatuses,3e4)}async function loadChannelStatuses(){const e=document.getElementById("channel-status-list");if(e){if(!gateway||!gateway.isConnected()){e.innerHTML=`
            <div class="empty-state">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                <div class="empty-state-title">No Channel Data</div>
                <div class="empty-state-desc">Connect to gateway to view active channels</div>
            </div>
        `;return}try{const t=await gateway._request("channels.status",{});renderChannelStatuses(t?.channels||t||[])}catch{renderChannelStatuses([{name:"WhatsApp",status:"unknown"},{name:"Telegram",status:"unknown"},{name:"Discord",status:"unknown"},{name:"Signal",status:"unknown"},{name:"Webchat",status:"connected"}])}}}function renderChannelStatuses(e){const t=document.getElementById("channel-status-list");if(!t)return;const n={whatsapp:"\u{1F4F1}",telegram:"\u2708\uFE0F",discord:"\u{1F3AE}",signal:"\u{1F512}",webchat:"\u{1F4AC}",email:"\u{1F4E7}",sms:"\u{1F4F2}"};let s=Array.isArray(e)?e:Object.entries(e).map(([o,a])=>({name:o,...typeof a=="object"?a:{status:a}}));s.length===0&&(s=[{name:"WhatsApp",status:"unknown"},{name:"Telegram",status:"unknown"},{name:"Discord",status:"unknown"},{name:"Signal",status:"unknown"},{name:"Webchat",status:"connected"}]),t.innerHTML=s.map(o=>{const a=o.name||o.channel||"Unknown",i=(o.status||o.state||"unknown").toLowerCase(),r=n[a.toLowerCase()]||"\u{1F4E1}",c=i==="connected"||i==="online"||i==="ready"?"success":i==="error"||i==="disconnected"||i==="failed"?"error":"warning",l=o.lastMessageAt?timeAgo(new Date(o.lastMessageAt).getTime()):"";return`
        <div class="channel-status-row">
            <span style="font-size: 16px;">${r}</span>
            <div style="flex: 1; min-width: 0;">
                <span style="font-weight: 500; font-size: 13px;">${escapeHtml(a)}</span>
                ${l?`<span style="font-size: 10px; color: var(--text-muted); margin-left: 6px;">${l}</span>`:""}
            </div>
            <span class="status-dot ${c}"></span>
        </div>`}).join("")}document.addEventListener("DOMContentLoaded",()=>{setTimeout(initChannelStatus,2500)});let costsInterval=null;function initCostTracker(){loadCostData(),costsInterval&&clearInterval(costsInterval),costsInterval=setInterval(loadCostData,6e4)}async function loadCostData(){const e=document.getElementById("cost-tracker-content");if(e){if(!gateway||!gateway.isConnected()){e.innerHTML=`
            <div class="empty-state">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div class="empty-state-title">No Cost Data</div>
                <div class="empty-state-desc">Connect to gateway to view usage & costs</div>
            </div>
        `;return}try{const n=(await gateway._request("sessions.list",{includeGlobal:!0}))?.sessions||[];let s=null;try{s=await gateway._request("status",{})}catch{}renderCostData(n,s)}catch(t){console.warn("[Costs] Failed:",t.message)}}}function renderCostData(e,t){const n=document.getElementById("cost-tracker-content");if(!n)return;const s={};let o=0,a=0,i=0;for(const d of e){const u=d.key?.match(/^agent:([^:]+):/),m=u?u[1]:"main";s[m]||(s[m]={input:0,output:0,total:0});const p=d.inputTokens||0,g=d.outputTokens||0,f=d.totalTokens||p+g;s[m].input+=p,s[m].output+=g,s[m].total+=f,o+=f,a+=p,i+=g}const r=((a*3+i*15)/1e6).toFixed(2),c=Object.entries(s).sort((d,u)=>u[1].total-d[1].total),l=c.length>0?c[0][1].total:1;n.innerHTML=`
        <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px;">
            <div>
                <span style="font-size: 20px; font-weight: 700; color: var(--text-primary);">${formatTokens(o)}</span>
                <span style="font-size: 11px; color: var(--text-muted);"> tokens</span>
            </div>
            <div style="text-align: right;">
                <span style="font-size: 16px; font-weight: 600; color: var(--success);">~$${r}</span>
                <div style="font-size: 10px; color: var(--text-muted);">est. cost</div>
            </div>
        </div>
        <div style="display: flex; gap: 12px; margin-bottom: 10px; font-size: 11px; color: var(--text-muted);">
            <span>\u2197 In: ${formatTokens(a)}</span>
            <span>\u2199 Out: ${formatTokens(i)}</span>
            <span>\u{1F4CA} ${e.length} sessions</span>
        </div>
        <div style="space-y: 4px;">
            ${c.slice(0,6).map(([d,u])=>{const m=getComputedStyle(document.documentElement).getPropertyValue(`--agent-${d}`).trim()||"#888",p=l>0?u.total/l*100:0,g=typeof getAgentLabel=="function"?getAgentLabel(d):d.toUpperCase();return`
                <div style="margin-bottom: 6px;">
                    <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 2px;">
                        <span style="color: ${m}; font-weight: 600;">${g}</span>
                        <span style="color: var(--text-muted);">${formatTokens(u.total)}</span>
                    </div>
                    <div style="height: 4px; background: var(--surface-2); border-radius: 2px; overflow: hidden;">
                        <div style="height: 100%; width: ${p}%; background: ${m}; border-radius: 2px;"></div>
                    </div>
                </div>`}).join("")}
        </div>
    `}function formatTokens(e){return e>=1e6?(e/1e6).toFixed(1)+"M":e>=1e3?(e/1e3).toFixed(1)+"K":e.toString()}document.addEventListener("DOMContentLoaded",()=>{setTimeout(initCostTracker,3e3)});let analyticsInterval=null;function initAnalytics(){loadAnalyticsData(),analyticsInterval&&clearInterval(analyticsInterval),analyticsInterval=setInterval(loadAnalyticsData,6e4)}async function loadAnalyticsData(){const e=document.getElementById("analytics-content");if(e){if(!gateway||!gateway.isConnected()){e.innerHTML=`
            <div class="empty-state">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                <div class="empty-state-title">No Analytics Data</div>
                <div class="empty-state-desc">Connect to gateway to view session analytics</div>
            </div>
        `;return}try{const n=(await gateway._request("sessions.list",{includeGlobal:!0}))?.sessions||[];renderAnalytics(n)}catch(t){console.warn("[Analytics] Failed:",t.message)}}}function renderAnalytics(e){const t=document.getElementById("analytics-content");if(!t)return;const n={},s={},o=Date.now();for(const c of e){const l=c.key?.match(/^agent:([^:]+):/),d=l?l[1]:"main",u=c.totalTokens||(c.inputTokens||0)+(c.outputTokens||0);if(n[d]||(n[d]=0),n[d]+=u>0?1:0,c.updatedAt){const m=new Date(c.updatedAt),p=m.toLocaleDateString("en-US",{weekday:"short"}),g=m.getTime();o-g<7*864e5&&(s[p]||(s[p]=0),s[p]++)}}const a=[...e].filter(c=>c.updatedAt).sort((c,l)=>new Date(l.updatedAt).getTime()-new Date(c.updatedAt).getTime()).slice(0,5),i=Math.max(...Object.values(n),1),r=Math.max(...Object.values(s),1);t.innerHTML=`
        <div style="margin-bottom: 12px;">
            <div style="font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 6px;">Sessions by Agent</div>
            ${Object.entries(n).sort((c,l)=>l[1]-c[1]).slice(0,6).map(([c,l])=>{const d=getComputedStyle(document.documentElement).getPropertyValue(`--agent-${c}`).trim()||"#888",u=l/i*100;return`<div style="display: flex; align-items: center; gap: 6px; margin-bottom: 3px;">
                    <span style="width: 40px; font-size: 10px; color: ${d}; font-weight: 600; text-align: right;">${c.toUpperCase()}</span>
                    <div style="flex: 1; height: 6px; background: var(--surface-2); border-radius: 3px; overflow: hidden;">
                        <div style="height: 100%; width: ${u}%; background: ${d}; border-radius: 3px;"></div>
                    </div>
                    <span style="width: 24px; font-size: 10px; color: var(--text-muted);">${l}</span>
                </div>`}).join("")}
        </div>
        <div style="margin-bottom: 12px;">
            <div style="font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 6px;">Activity (7 days)</div>
            <div style="display: flex; align-items: flex-end; gap: 4px; height: 40px;">
                ${Object.entries(s).slice(-7).map(([c,l])=>`<div style="flex: 1; text-align: center;">
                        <div style="height: ${Math.max(4,l/r*36)}px; background: var(--brand-red); border-radius: 2px; margin: 0 auto; width: 80%;"></div>
                        <div style="font-size: 9px; color: var(--text-muted); margin-top: 2px;">${c}</div>
                    </div>`).join("")}
            </div>
        </div>
        <div>
            <div style="font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Most Active</div>
            ${a.map(c=>{const l=c.displayName||c.key?.replace(/^agent:[^:]+:/,"")||"unnamed",d=c.updatedAt?timeAgo(new Date(c.updatedAt).getTime()):"";return`<div style="font-size: 11px; padding: 2px 0; display: flex; justify-content: space-between;">
                    <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(l)}</span>
                    <span style="color: var(--text-muted); flex-shrink: 0; margin-left: 8px;">${d}</span>
                </div>`}).join("")}
        </div>
    `}document.addEventListener("DOMContentLoaded",()=>{setTimeout(initAnalytics,3500)});let focusTimer={running:!1,isBreak:!1,timeLeft:1500,interval:null,sessions:parseInt(localStorage.getItem("focusSessions")||"0"),workDuration:1500,breakDuration:300,sessionStart:null};function toggleFocusTimer(){focusTimer.running?pauseFocusTimer():startFocusTimer()}function startFocusTimer(){focusTimer.running=!0,focusTimer.sessionStart=Date.now(),updateFocusTimerUI(),focusTimer.interval=setInterval(()=>{focusTimer.timeLeft--,updateFocusTimerDisplay(),focusTimer.timeLeft<=0&&completeFocusSession()},1e3),showToast(focusTimer.isBreak?"\u2615 Break started!":"\u{1F3AF} Focus session started!","success",2e3)}function pauseFocusTimer(){focusTimer.running=!1,clearInterval(focusTimer.interval),updateFocusTimerUI(),showToast("\u23F8\uFE0F Timer paused","info",1500)}function resetFocusTimer(){focusTimer.running=!1,focusTimer.isBreak=!1,clearInterval(focusTimer.interval),focusTimer.timeLeft=focusTimer.workDuration,updateFocusTimerUI(),updateFocusTimerDisplay(),showToast("\u{1F504} Timer reset","info",1500)}function completeFocusSession(){if(clearInterval(focusTimer.interval),focusTimer.running=!1,focusTimer.isBreak)showToast("\u2615 Break over! Ready for another focus session?","info",3e3),focusTimer.isBreak=!1,focusTimer.timeLeft=focusTimer.workDuration;else{focusTimer.sessions++,localStorage.setItem("focusSessions",focusTimer.sessions.toString()),localStorage.setItem("focusSessionsDate",new Date().toDateString()),updateQuickStats();try{const e=new Audio("data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2telehn2d7DYv49iHxtfns/hoGwaCEGWz9+1aTIOO4nK2sBxIg0zdsXN0HgsEjFnusbRgjQXKVmrxNKTPSkfSJ28zZpDKhhAd6/J0p9JLRlAd6/J0p9JLRlAd6/K0p9JLRlAd6/K0p9JLRk/dq/K0p9JLRk/dq/K0aBKLRk/dq/K0aBKLRk=");e.volume=.3,e.play().catch(()=>{})}catch{}showToast(`\u{1F389} Focus session complete! (${focusTimer.sessions} today)`,"success",3e3),focusTimer.isBreak=!0,focusTimer.timeLeft=focusTimer.breakDuration}updateFocusTimerUI(),updateFocusTimerDisplay()}function updateFocusTimerUI(){const e=document.getElementById("focus-timer"),t=document.getElementById("focus-play-icon"),n=document.getElementById("focus-pause-icon"),s=document.getElementById("focus-sessions");e&&(e.classList.remove("active","break"),focusTimer.running&&e.classList.add(focusTimer.isBreak?"break":"active"),t&&n&&(t.style.display=focusTimer.running?"none":"block",n.style.display=focusTimer.running?"block":"none"),s&&(s.textContent=`${focusTimer.sessions} \u{1F3AF}`))}function updateFocusTimerDisplay(){const e=document.getElementById("focus-timer-display");if(!e)return;const t=Math.floor(focusTimer.timeLeft/60),n=focusTimer.timeLeft%60;e.textContent=`${t.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`}function checkFocusSessionsReset(){const e=localStorage.getItem("focusSessionsDate"),t=new Date().toDateString();e!==t&&(focusTimer.sessions=0,localStorage.setItem("focusSessions","0"),localStorage.setItem("focusSessionsDate",t))}function showShortcutsModal(){showModal("shortcuts-modal")}window.toggleFocusTimer=toggleFocusTimer,window.resetFocusTimer=resetFocusTimer,window.showShortcutsModal=showShortcutsModal,document.addEventListener("DOMContentLoaded",()=>{checkFocusSessionsReset(),updateFocusTimerUI(),updateFocusTimerDisplay(),updateQuickStats()});let commandPaletteOpen=!1,commandPaletteSelectedIndex=0;const commands=[{id:"chat",icon:"\u{1F4AC}",title:"Go to Chat",desc:"Open chat page",shortcut:"C",action:()=>showPage("chat")},{id:"system",icon:"\u{1F527}",title:"System Messages",desc:"View system/debug messages",shortcut:"S",action:()=>showPage("system")},{id:"health",icon:"\u{1F3E5}",title:"Model Health",desc:"Check model status",shortcut:"H",action:()=>showPage("health")},{id:"memory",icon:"\u{1F9E0}",title:"Memory Lane",desc:"Browse memory files",shortcut:"M",action:()=>showPage("memory")},{id:"settings",icon:"\u2699\uFE0F",title:"Settings",desc:"Open settings modal",shortcut:",",action:()=>openSettingsModal()},{id:"theme",icon:"\u{1F3A8}",title:"Themes",desc:"Open theme picker",shortcut:"T",action:()=>toggleTheme()},{id:"new-session",icon:"\u2795",title:"New Session",desc:"Create a new chat session",shortcut:"N",action:()=>createNewSession()},{id:"refresh",icon:"\u{1F504}",title:"Refresh Sessions",desc:"Reload session list",shortcut:"R",action:()=>fetchSessions()},{id:"focus-chat",icon:"\u2328\uFE0F",title:"Focus Chat Input",desc:"Jump to chat input",shortcut:"/",action:()=>focusChatInput()}];function initCommandPalette(){if(document.getElementById("command-palette"))return;const e=document.createElement("div");e.id="command-palette-backdrop",e.className="command-palette-backdrop",e.onclick=closeCommandPalette;const t=document.createElement("div");t.id="command-palette",t.className="command-palette",t.innerHTML=`
        <input type="text" class="command-palette-input" placeholder="Type a command... (\u2191\u2193 to navigate, Enter to select)" id="command-palette-input">
        <div class="command-palette-results" id="command-palette-results"></div>
    `,document.body.appendChild(e),document.body.appendChild(t);const n=document.getElementById("command-palette-input");n.addEventListener("input",s=>filterCommands(s.target.value)),n.addEventListener("keydown",handlePaletteKeydown),renderCommands(commands)}function renderCommands(e){const t=document.getElementById("command-palette-results");t&&(t.innerHTML=e.map((n,s)=>`
        <div class="command-palette-item${s===commandPaletteSelectedIndex?" selected":""}" 
             data-index="${s}" 
             onclick="executeCommand('${n.id}')">
            <span class="command-palette-item-icon">${n.icon}</span>
            <div class="command-palette-item-text">
                <div class="command-palette-item-title">${n.title}</div>
                <div class="command-palette-item-desc">${n.desc}</div>
            </div>
            ${n.shortcut?`<span class="command-palette-shortcut">${n.shortcut}</span>`:""}
        </div>
    `).join(""))}function filterCommands(e){const t=e.toLowerCase().trim();let n=commands;t&&(n=commands.filter(s=>s.title.toLowerCase().includes(t)||s.desc.toLowerCase().includes(t)||s.id.toLowerCase().includes(t))),commandPaletteSelectedIndex=0,renderCommands(n)}function handlePaletteKeydown(e){const t=document.querySelectorAll(".command-palette-item"),n=t.length-1;switch(e.key){case"ArrowDown":e.preventDefault(),commandPaletteSelectedIndex=Math.min(commandPaletteSelectedIndex+1,n),updatePaletteSelection();break;case"ArrowUp":e.preventDefault(),commandPaletteSelectedIndex=Math.max(commandPaletteSelectedIndex-1,0),updatePaletteSelection();break;case"Enter":e.preventDefault();const s=t[commandPaletteSelectedIndex];if(s){const o=parseInt(s.dataset.index),a=getFilteredCommands();a[o]&&executeCommand(a[o].id)}break;case"Escape":closeCommandPalette();break}}function getFilteredCommands(){const t=(document.getElementById("command-palette-input")?.value||"").toLowerCase().trim();return t?commands.filter(n=>n.title.toLowerCase().includes(t)||n.desc.toLowerCase().includes(t)||n.id.toLowerCase().includes(t)):commands}function updatePaletteSelection(){document.querySelectorAll(".command-palette-item").forEach((t,n)=>{t.classList.toggle("selected",n===commandPaletteSelectedIndex),n===commandPaletteSelectedIndex&&t.scrollIntoView({block:"nearest"})})}window.executeCommand=function(e){const t=commands.find(n=>n.id===e);t&&(closeCommandPalette(),t.action())};function openCommandPalette(){initCommandPalette(),commandPaletteOpen=!0,commandPaletteSelectedIndex=0;const e=document.getElementById("command-palette-backdrop"),t=document.getElementById("command-palette"),n=document.getElementById("command-palette-input");e&&e.classList.add("visible"),t&&t.classList.add("visible"),n&&(n.value="",n.focus()),renderCommands(commands)}function closeCommandPalette(){commandPaletteOpen=!1;const e=document.getElementById("command-palette-backdrop"),t=document.getElementById("command-palette");e&&e.classList.remove("visible"),t&&t.classList.remove("visible")}function focusChatInput(){showPage("chat"),setTimeout(()=>{const e=document.getElementById("chat-page-input");e&&e.focus()},100)}function createNewSession(){const t=`session-${new Date().toISOString().slice(0,16).replace("T","-").replace(":","")}`;typeof switchToSession=="function"?(switchToSession(t),showToast(`Created new session: ${t}`,"success")):showToast("Session creation not available","warning")}document.addEventListener("keydown",e=>{const t=e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"||e.target.isContentEditable;if((e.metaKey||e.ctrlKey)&&e.key==="k"){e.preventDefault(),commandPaletteOpen?closeCommandPalette():openCommandPalette();return}if(e.key==="Escape"){if(commandPaletteOpen){closeCommandPalette();return}const n=document.querySelector(".modal-overlay.visible");if(n){n.classList.remove("visible");return}}if(!t){switch(e.key.toLowerCase()){case"c":showPage("chat");break;case"s":e.shiftKey?syncFromVPS():showPage("system");break;case"h":showPage("health");break;case"m":showPage("memory");break;case"d":showPage("dashboard");break;case"p":showPage("products");break;case"t":toggleTheme();break;case"f":e.shiftKey?resetFocusTimer():toggleFocusTimer();break;case"n":e.ctrlKey||e.metaKey?(e.preventDefault(),createNewSession()):openAddTask("todo");break;case"/":e.preventDefault(),focusChatInput();break;case"?":e.preventDefault(),showModal("shortcuts-modal");break;case",":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),openSettingsModal());break}if(e.key>="1"&&e.key<="9"&&!e.ctrlKey&&!e.metaKey&&!e.altKey){const n=parseInt(e.key)-1,s=filterSessionsForAgent(availableSessions,currentAgentId);s[n]&&(switchToSession(s[n].key),showToast(`Switched to session ${e.key}`,"success",1500))}}}),document.addEventListener("DOMContentLoaded",()=>{initCommandPalette()});let currentMemoryFile=null;window.viewMemoryFile=async function(e){const t=document.getElementById("memory-file-title"),n=document.getElementById("memory-file-content"),s=document.getElementById("memory-save-btn");if(!(!t||!n)){t.textContent=e,n.value="Loading...",n.disabled=!0,s&&(s.disabled=!0),currentMemoryFile=e,showModal("memory-file-modal");try{const a=await(await fetch(`/api/memory/${encodeURIComponent(e)}`)).json();if(a.error){n.value=`Error: ${a.error}`;return}n.value=a.content||"",n.disabled=!1,s&&(s.disabled=!1),a.botUpdated&&!a.acknowledged?t.innerHTML=`
                ${escapeHtml(a.name)}
                <span class="badge badge-warning" style="margin-left: 8px;">\u{1F916} Updated by SoLoBot</span>
                <button onclick="this.style.color='var(--text-muted)'; this.textContent='\u2713 Read'; this.disabled=true; window.acknowledgeUpdate && window.acknowledgeUpdate('${escapeHtml(e)}')" 
                        class="btn btn-ghost" style="margin-left: 8px; font-size: 12px; color: var(--error);">
                    \u2713 Mark as Read
                </button>
            `:t.textContent=a.name,typeof window.loadVersionHistory=="function"&&window.loadVersionHistory(e)}catch(o){console.error("Error loading memory file:",o),n.value=`Error loading file: ${o.message}`}}},window.saveMemoryFile=async function(){if(!currentMemoryFile)return;const e=document.getElementById("memory-file-content"),t=document.getElementById("memory-save-btn");if(!e)return;const n=e.value;t&&(t.disabled=!0,t.textContent="Saving...");try{const o=await(await fetch(`/api/memory/${encodeURIComponent(currentMemoryFile)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:n})})).json();if(o.ok)t&&(t.textContent="\u2713 Saved!",setTimeout(()=>{t.textContent="Save",t.disabled=!1},1500)),typeof renderMemoryFilesForPage=="function"&&renderMemoryFilesForPage("");else throw new Error(o.error||"Save failed")}catch(s){console.error("Error saving memory file:",s),showToast(`Failed to save: ${s.message}`,"error"),t&&(t.textContent="Save",t.disabled=!1)}},window.closeMemoryModal=function(){currentMemoryFile=null,hideModal("memory-file-modal")};let memoryTree=[],memorySearchResults=[];function initMemoryBrowser(){loadMemoryTree()}async function loadMemoryTree(){const e=document.getElementById("memory-tree");if(e){if(e.innerHTML='<div style="color: var(--text-muted); font-size: 12px; padding: 8px;">Loading...</div>',gateway&&gateway.isConnected())try{const t=await gateway._request("memory.list",{recursive:!0});memoryTree=t?.files||t||[],renderMemoryTree(memoryTree);return}catch(t){console.warn("[Memory] Gateway memory.list not available:",t.message)}try{const t=typeof fetchMemoryFiles=="function"?await fetchMemoryFiles():[];memoryTree=t,renderMemoryTree(t)}catch{e.innerHTML='<div style="color: var(--text-muted); font-size: 12px; padding: 8px;">Could not load memory files</div>'}}}function renderMemoryTree(e){const t=document.getElementById("memory-tree");if(!t)return;if(!e||e.length===0){t.innerHTML='<div style="color: var(--text-muted); font-size: 12px; padding: 8px;">No files found</div>';return}const n={};for(const s of e){const o=s.path||s.name||"",a=o.split("/").filter(Boolean);let i=n;for(let r=0;r<a.length;r++){const c=a[r];r===a.length-1?(i._files||(i._files=[]),i._files.push({...s,fileName:c})):(i[c]||(i[c]={}),i=i[c])}a.length<=1&&(n._files||(n._files=[]),n._files.find(r=>r.fileName===(a[0]||o))||n._files.push({...s,fileName:a[0]||o}))}t.innerHTML=renderTreeNode(n,"")}function renderTreeNode(e,t){let n="";const s=Object.keys(e).filter(a=>a!=="_files").sort();for(const a of s){const i=t?`${t}/${a}`:a,r=countFiles(e[a]);n+=`
        <div class="memory-tree-dir" onclick="toggleTreeDir(this)">
            <span class="tree-chevron">\u25B6</span>
            <span style="font-size: 13px;">\u{1F4C1} ${escapeHtml(a)}</span>
            <span style="font-size: 10px; color: var(--text-muted); margin-left: 4px;">(${r})</span>
        </div>
        <div class="memory-tree-children hidden">
            ${renderTreeNode(e[a],i)}
        </div>`}const o=e._files||[];for(const a of o.sort((i,r)=>(i.fileName||"").localeCompare(r.fileName||""))){const i=a.path||a.name||a.fileName;n+=`
        <div class="memory-tree-file" onclick="previewMemoryFile('${escapeHtml(i)}')">
            <span style="font-size: 12px;">\u{1F4C4}</span>
            <span style="font-size: 12px;">${escapeHtml(a.fileName||i)}</span>
        </div>`}return n}function countFiles(e){let t=(e._files||[]).length;for(const n of Object.keys(e).filter(s=>s!=="_files"))t+=countFiles(e[n]);return t}window.toggleTreeDir=function(e){const t=e.nextElementSibling;if(!t)return;const n=e.querySelector(".tree-chevron");t.classList.contains("hidden")?(t.classList.remove("hidden"),n&&(n.textContent="\u25BC")):(t.classList.add("hidden"),n&&(n.textContent="\u25B6"))},window.previewMemoryFile=async function(e){const t=document.getElementById("memory-file-preview");if(!t){typeof viewMemoryFile=="function"&&viewMemoryFile(e);return}t.innerHTML='<div style="color: var(--text-muted); padding: 12px;">Loading...</div>';try{let n="";if(gateway&&gateway.isConnected())try{const s=await gateway._request("memory.read",{path:e});n=s?.content||s||""}catch{const o=await fetch(`/api/memory/file?path=${encodeURIComponent(e)}`);n=o.ok?await o.text():"Could not load file"}else{const s=await fetch(`/api/memory/file?path=${encodeURIComponent(e)}`);n=s.ok?await s.text():"Could not load file"}t.innerHTML=`
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-bottom: 1px solid var(--border-default);">
                <span style="font-weight: 600; font-size: 13px;">\u{1F4C4} ${escapeHtml(e)}</span>
                <div style="display: flex; gap: 4px;">
                    <button onclick="editMemoryFile('${escapeHtml(e)}')" class="btn btn-ghost" style="font-size: 11px; padding: 2px 8px;">Edit</button>
                </div>
            </div>
            <pre style="padding: 12px; margin: 0; font-size: 12px; white-space: pre-wrap; word-break: break-word; overflow-y: auto; max-height: 500px; color: var(--text-primary);">${escapeHtml(typeof n=="string"?n:JSON.stringify(n,null,2))}</pre>
        `}catch(n){t.innerHTML=`<div style="color: var(--error); padding: 12px;">Error: ${n.message}</div>`}},window.editMemoryFile=function(e){typeof viewMemoryFile=="function"&&viewMemoryFile(e)},window.searchMemoryFiles=async function(){const e=document.getElementById("memory-browser-search")?.value?.trim();if(!e){renderMemoryTree(memoryTree);return}const t=e.toLowerCase(),n=memoryTree.filter(s=>{const o=(s.name||s.path||"").toLowerCase(),a=(s.description||"").toLowerCase();return o.includes(t)||a.includes(t)});renderMemoryTree(n)},document.addEventListener("DOMContentLoaded",()=>{setTimeout(initMemoryBrowser,1e3)});function isSystemMessage(e,t){if(DISABLE_SYSTEM_FILTER||!e)return!1;const n=e.trim(),s=n.toLowerCase();if(t==="system"||n.startsWith("{")&&n.includes('"')||n.startsWith("Successfully replaced text in")||n.startsWith("Successfully wrote")||n==="(no output)"||n.startsWith("[main ")&&n.includes("file changed")||n.startsWith("To https://github.com")||/^\[main [a-f0-9]+\]/.test(n)||n.startsWith("Exported ")&&n.includes(" activities")||n.startsWith("Posted ")&&n.includes(" activities")||/^ghp_[A-Za-z0-9]+$/.test(n)||/^sk_[A-Za-z0-9]+$/.test(n)||n.startsWith("# ")&&n.length>500||/^\d+:\s*(if|const|let|var|function|class|return|import|export)\s/.test(n)||/^\d+[-:].*\.(js|ts|py|md|json|html|css)/.test(n))return!0;const o=/^\d+:/,a=n.split(`
`);if(a.length>2&&a.filter(i=>o.test(i.trim())).length>a.length/2||n.includes("state.chat.messages")||n.includes("GATEWAY_CONFIG")||n.includes("maxMessages:")&&/\d+:/.test(n)||n==="HEARTBEAT_OK"||n==="NO_REPLY"||n==="NO"||n==="REPLY_SKIP"||n==="ANNOUNCE_SKIP"||n.startsWith("Agent-to-agent announce")||n.startsWith("System: [")||n.startsWith("System:")||/^System:\s*\[/i.test(n)||n.includes("] HEARTBEAT:")||n.includes("] Cron:")||n.includes("] EMAIL CHECK:")||n.startsWith("Read HEARTBEAT.md if it exists"))return!0;if(t==="solobot"&&n.length<200){const i=["following heartbeat routine","following the heartbeat routine","checking current status via heartbeat"];for(const r of i)if(s.startsWith(r))return!0}return!1}window.changeProvider=function(){console.warn("[Dashboard] Provider selection not implemented - providers are configured at OpenClaw gateway level"),showToast("Providers must be configured at the OpenClaw gateway level","warning")},window.updateProviderDisplay=function(){const e=document.getElementById("provider-select");if(!e)return;const t=e.value,n=document.getElementById("provider-name");n&&(n.textContent=t),updateModelDropdown(t)};async function populateProviderDropdown(){const e=[document.getElementById("provider-select"),document.getElementById("setting-provider")].filter(Boolean);if(e.length===0)return console.warn("[Dashboard] No provider-select elements found"),[];try{const t=await fetch("/api/models/list");if(!t.ok)throw new Error(`API returned ${t.status}`);const n=await t.json(),s=Object.keys(n);for(const o of e)o.innerHTML="",s.forEach(a=>{const i=document.createElement("option");i.value=a,i.textContent=a.split("-").map(r=>r.charAt(0).toUpperCase()+r.slice(1)).join(" "),a===currentProvider&&(i.selected=!0),o.appendChild(i)});return s}catch(t){return console.error("[Dashboard] Failed to fetch providers:",t),[]}}window.onSettingsProviderChange=async function(){const e=document.getElementById("setting-provider"),t=document.getElementById("setting-model");if(!e||!t)return;const n=e.value,s=await getModelsForProvider(n);t.innerHTML="",s.forEach(o=>{const a=document.createElement("option");a.value=o.value,a.textContent=o.name,o.selected&&(a.selected=!0),t.appendChild(a)})},window.refreshModels=async function(){showToast("Refreshing models from CLI...","info");try{const t=await(await fetch("/api/models/refresh",{method:"POST"})).json();if(t.ok){showToast(`${t.message}`,"success"),await populateProviderDropdown();const s=document.getElementById("provider-select")?.value||currentProvider||"openrouter";await updateModelDropdown(s)}else showToast(t.message||"Failed to refresh models","warning")}catch(e){console.error("[Dashboard] Failed to refresh models:",e),showToast("Failed to refresh models: "+e.message,"error")}},window.changeSessionModel=async function(){const t=document.getElementById("model-select")?.value;if(!t){showToast("Please select a model","warning");return}if(!gateway||!gateway.isConnected()){showToast("Not connected to gateway","warning");return}window._lastManualModelChange=Date.now();try{const n=GATEWAY_CONFIG.sessionKey||"main";if(console.log(`[Dashboard] Changing model to: ${t} (session: ${n})`),t==="global/default"){await gateway.patchSession(n,{model:null});const o=await(await fetch("/api/models/current")).json();o?.modelId&&(currentModel=o.modelId,currentProvider=o.provider||currentModel.split("/")[0],syncModelDisplay(currentModel,currentProvider),showToast("Reverted to Global Default","success"))}else{await gateway.patchSession(n,{model:t}),fetch("/api/models/set",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({modelId:t})}).catch(r=>console.error("Failed to update global default:",r)),currentModel=t;const s=t.split("/")[0];currentProvider=s,localStorage.setItem("selected_model",t),localStorage.setItem("selected_provider",s);const o=document.getElementById("current-model-display");o&&(o.textContent=t);const a=document.getElementById("current-provider-display");a&&(a.textContent=s);const i=document.getElementById("provider-select");if(i){if(!Array.from(i.options).find(c=>c.value===s)){const c=document.createElement("option");c.value=s,c.textContent=s.split("-").map(l=>l.charAt(0).toUpperCase()+l.slice(1)).join(" "),i.appendChild(c)}i.value=s}showToast(`Model set to ${t.split("/").pop()}`,"success")}}catch(n){console.error("[Dashboard] Failed to change model:",n),showToast(`Failed: ${n.message}`,"error")}},window.changeGlobalModel=async function(){const e=document.getElementById("setting-model"),t=document.getElementById("setting-provider"),n=e?.value,s=t?.value;if(!n){showToast("Please select a model","warning");return}if(n.includes("ERROR")){showToast("Cannot change model - configuration error","error");return}try{console.log(`[Dashboard] Changing global default model to: ${n}`);const o=await fetch("/api/models/set",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({modelId:n})}),a=await o.json();if(o.ok){currentModel=n;const i=n.split("/")[0];currentProvider=i,localStorage.setItem("selected_provider",i),localStorage.setItem("selected_model",n);const r=document.getElementById("current-model-display"),c=document.getElementById("current-provider-display");r&&(r.textContent=n),c&&(c.textContent=i),selectModelInDropdowns(n),showToast(`Global default \u2192 ${n.split("/").pop()}. Gateway restarting...`,"success")}else showToast(`Failed: ${a.error||"Unknown error"}`,"error")}catch(o){console.error("[Dashboard] Error changing global model:",o),showToast(`Failed: ${o.message}`,"error")}},window.changeModel=window.changeSessionModel;async function updateModelDropdown(e){const t=await getModelsForProvider(e),n=[document.getElementById("model-select"),document.getElementById("setting-model")].filter(Boolean);for(const s of n){s.innerHTML="";const o=document.createElement("option");o.value="global/default",o.textContent="Global Default \u{1F310}",o.style.fontWeight="bold",s.appendChild(o);const a=document.createElement("option");a.disabled=!0,a.textContent="\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500",s.appendChild(a),t.forEach(i=>{const r=document.createElement("option");r.value=i.value,r.textContent=i.name,i.selected&&(r.selected=!0),s.appendChild(r)})}}async function getModelsForProvider(e){if(window._gatewayModels&&window._gatewayModels[e])return window._gatewayModels[e].map(n=>({value:n.id,name:n.name,selected:n.id===currentModel}));try{const t=await fetch("/api/models/list");if(!t.ok)throw new Error(`API returned ${t.status}`);return((await t.json())[e]||[]).map(a=>({value:a.id,name:a.name,selected:a.id===currentModel}))}catch(t){return console.error("[Dashboard] Failed to get models from API:",t),[]}}function getConfiguredModels(){try{const e=require("child_process").execSync,t=e("moltbot models list 2>/dev/null | tail -n +4",{encoding:"utf8"}),n=[],s=t.split(`
`).filter(o=>o.trim());for(const o of s){const a=o.trim().split(/\s+/);if(a.length>=2){const i=a[0],r=a[a.length-1]||"";n.push({value:i,name:i.split("/").pop()||i,selected:r.includes("default")||r.includes("configured")})}}return n}catch{return[]}}let currentProvider="anthropic",currentModel="anthropic/claude-opus-4-5";function syncModelDisplay(e,t){if(!e||window._lastManualModelChange&&Date.now()-window._lastManualModelChange<3e3||e===currentModel&&t===currentProvider)return;console.log(`[Dashboard] Model sync: ${currentModel} \u2192 ${e} (provider: ${t||currentProvider})`),currentModel=e,!t&&e.includes("/")&&(t=e.split("/")[0]),t&&(currentProvider=t),localStorage.setItem("selected_model",e),t&&localStorage.setItem("selected_provider",t);const n=document.getElementById("current-model-display");if(n&&(n.textContent=e),t){const s=document.getElementById("current-provider-display");s&&(s.textContent=t);const o=document.getElementById("provider-select");if(o){if(!Array.from(o.options).find(i=>i.value===t)){const i=document.createElement("option");i.value=t,i.textContent=t.split("-").map(r=>r.charAt(0).toUpperCase()+r.slice(1)).join(" "),o.appendChild(i)}o.value=t}updateModelDropdown(t).then(()=>{selectModelInDropdowns(e)})}else selectModelInDropdowns(e)}async function applySessionModelOverride(e){if(!e)return;let t=null;const n=availableSessions.find(o=>o.key===e),s=n?.model&&n.model!=="unknown"?n.model:null;if(s&&(t=s),!t)try{const o=await gateway?.listSessions?.({});if(o?.sessions?.length){availableSessions=o.sessions.map(r=>({key:r.key,name:getFriendlySessionName(r.key),displayName:getFriendlySessionName(r.key),updatedAt:r.updatedAt,totalTokens:r.totalTokens||(r.inputTokens||0)+(r.outputTokens||0),model:r.model||"unknown",sessionId:r.sessionId}));const a=availableSessions.find(r=>r.key===e),i=a?.model&&a.model!=="unknown"?a.model:null;i&&(t=i)}}catch(o){console.warn("[Dashboard] Failed to refresh sessions for model override:",o.message)}if(!t)try{if(gateway&&gateway.isConnected()){const o=await gateway.getConfig();let a=o;typeof o=="string"&&(a=JSON.parse(o)),a?.raw&&(a=JSON.parse(a.raw));const i=a?.agents?.defaults?.model?.primary;i&&(t=i,console.log(`[Dashboard] Session ${e} using global default: ${t}`))}}catch(o){console.warn("[Dashboard] Failed to fetch global default model:",o.message)}if(t){const o=t.includes("/")?t.split("/")[0]:currentProvider;syncModelDisplay(t,o)}else console.warn(`[Dashboard] No model found for session ${e}, keeping current display`)}async function fetchModelsFromGateway(){if(!(!gateway||!gateway.isConnected()))try{const e=await gateway.getConfig();let t=e;typeof e=="string"&&(t=JSON.parse(e)),t?.raw&&(t=JSON.parse(t.raw));const n=t?.agents?.defaults?.model;if(!n){console.warn("[Dashboard] No model config in gateway response");return}const s=n.primary,o=n.fallbacks||[],a=n.picker||[],i=[...new Set([...s?[s]:[],...a,...o])];if(i.length===0)return;console.log(`[Dashboard] Got ${i.length} models from gateway config`);const r={};for(const l of i){const d=l.indexOf("/");if(d===-1)continue;const u=l.substring(0,d),m=l.substring(d+1);r[u]||(r[u]=[]);const p=l===s,g=m+(p?" \u2B50":"");r[u].some(f=>f.id===l)||r[u].push({id:l,name:g,tier:p?"default":"fallback"})}const c=document.getElementById("provider-select");if(c){const l=Object.keys(r);c.innerHTML="",l.forEach(d=>{const u=document.createElement("option");u.value=d,u.textContent=d.split("-").map(m=>m.charAt(0).toUpperCase()+m.slice(1)).join(" "),c.appendChild(u)})}window._gatewayModels=r}catch(e){console.warn("[Dashboard] Failed to fetch models from gateway:",e.message)}}function selectModelInDropdowns(e){const t=e.split("/").pop()||e,n=document.getElementById("model-select"),s=document.getElementById("setting-model");[n,s].forEach(o=>{if(!o)return;if(Array.from(o.options).find(r=>r.value===e))o.value=e;else{const r=document.createElement("option");r.value=e,r.textContent=t,r.selected=!0,o.appendChild(r)}})}document.addEventListener("DOMContentLoaded",async function(){try{await populateProviderDropdown();let e=null,t=null;try{const r=await(await fetch("/api/models/current")).json();e=r?.modelId,t=r?.provider,console.log(`[Dashboard] Model from API: ${e} (provider: ${t})`)}catch(i){console.warn("[Dashboard] Failed to fetch current model from API:",i.message),e=localStorage.getItem("selected_model"),t=localStorage.getItem("selected_provider")}e||(e="anthropic/claude-opus-4-5"),t||(t=e.split("/")[0]),currentProvider=t,currentModel=e,console.log(`[Dashboard] Init model: ${currentModel} (provider: ${currentProvider})`);const n=document.getElementById("current-provider-display"),s=document.getElementById("current-model-display"),o=document.getElementById("provider-select");n&&(n.textContent=currentProvider),s&&(s.textContent=currentModel),o&&(o.value=currentProvider);const a=document.getElementById("setting-provider");a&&(a.value=currentProvider),await updateModelDropdown(currentProvider),selectModelInDropdowns(currentModel)}catch(e){console.error("[Dashboard] Failed to initialize model display:",e)}});const defaultSettings={pickupFreq:"disabled",priorityOrder:"priority",refreshInterval:"10000",defaultPriority:"1",compactMode:!1,showLive:!0,showActivity:!0,showNotes:!0,showProducts:!0,showDocs:!0},READ_ACK_PREFIX="[[read_ack]]",unreadSessions=new Map,NOTIFICATION_DEBUG=!0;function notifLog(...e){NOTIFICATION_DEBUG&&console.log(...e)}function requestNotificationPermission(){"Notification"in window&&Notification.permission==="default"&&Notification.requestPermission().then(e=>{console.log(`[Notifications] Permission: ${e}`)})}function subscribeToAllSessions(){if(!gateway||!gateway.isConnected())return;const e=availableSessions.map(t=>t.key).filter(t=>t);e.length>0&&(gateway.subscribeToAllSessions(e),console.log(`[Notifications] Subscribed to ${e.length} sessions for cross-session notifications`))}function handleCrossSessionNotification(e){const{sessionKey:t,content:n}=e;if(notifLog(`[Notifications] \u{1F4E5} Cross-session notification received: session=${t}, content=${(n||"").slice(0,80)}...`),typeof n=="string"&&n.startsWith(READ_ACK_PREFIX)){notifLog(`[Notifications] Ignoring read-ack cross-session event for ${t}`),t&&clearUnreadForSession(t);return}if(typeof n=="string"){const a=n.trim();if(a==="NO_REPLY"||a==="NO"){notifLog(`[Notifications] Ignoring silent placeholder notification for ${t}: ${a}`);return}}if(t&&typeof currentSessionName<"u"&&t===currentSessionName&&document.visibilityState==="visible"){notifLog(`[Notifications] Ignoring notification for active session ${t}`);return}const s=getFriendlySessionName(t),o=n.length>120?n.slice(0,120)+"\u2026":n;if(notifLog(`[Notifications] \u{1F514} Message from ${s}: ${o.slice(0,60)}`),unreadSessions.set(t,(unreadSessions.get(t)||0)+1),updateUnreadBadges(),notifLog(`[Notifications] Unread total: ${Array.from(unreadSessions.values()).reduce((a,i)=>a+i,0)}`),showNotificationToast(s,o,t),"Notification"in window&&Notification.permission==="granted")try{const a=new Notification(`${s}`,{body:o,icon:"/solobot-avatar.png",tag:`session-${t}`,silent:!1});a.onclick=()=>{window.focus(),navigateToSession(t),a.close()},setTimeout(()=>a.close(),8e3)}catch(a){console.warn("[Notifications] Browser notification failed:",a)}playNotificationSound()}function navigateToSession(e){typeof showPage=="function"&&showPage("chat");const t=e.match(/^agent:([^:]+):/);t&&typeof setActiveSidebarAgent=="function"&&setActiveSidebarAgent(t[1]),typeof switchToSessionKey=="function"&&switchToSessionKey(e),unreadSessions.delete(e),updateUnreadBadges()}function showNotificationToast(e,t,n){let s=document.getElementById("notification-toast-container");s||(s=document.createElement("div"),s.id="notification-toast-container",s.style.cssText="position: fixed; top: 12px; right: 12px; z-index: 10000; display: flex; flex-direction: column; gap: 8px; max-width: 360px; pointer-events: none;",document.body.appendChild(s));const o=n?.match(/^agent:([^:]+):/),a=o?o[1]:"main",r={main:"#BC2026",dev:"#6366F1",exec:"#F59E0B",coo:"#10B981",cfo:"#EAB308",cmp:"#EC4899",family:"#14B8A6",tax:"#78716C",sec:"#3B82F6",smm:"#8B5CF6"}[a]||"#BC2026",c=document.createElement("div");c.className="notification-toast",c.style.cssText=`
        pointer-events: auto; cursor: pointer;
        background: var(--card-bg, #1a1a2e); color: var(--text-primary, #e0e0e0);
        border: 1px solid color-mix(in srgb, ${r} 60%, transparent);
        border-left: 4px solid ${r}; border-radius: 8px;
        padding: 10px 14px; box-shadow: 0 6px 24px rgba(0,0,0,0.35);
        opacity: 0; transform: translateX(100%);
        transition: all 0.3s ease; max-width: 360px;
        font-family: var(--font-family, system-ui);
        backdrop-filter: blur(6px);
    `,c.innerHTML=`
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
            <span style="width: 8px; height: 8px; border-radius: 50%; background: ${r}; flex-shrink: 0; box-shadow: 0 0 0 2px color-mix(in srgb, ${r} 30%, transparent);"></span>
            <strong style="color: var(--text-primary, #e0e0e0); font-size: 13px;">${e}</strong>
            <span style="margin-left: auto; color: var(--text-muted, #666); font-size: 11px; cursor: pointer;" class="toast-close">\u2715</span>
        </div>
        <div style="color: var(--text-secondary, #c9c9c9); font-size: 12px; line-height: 1.4; padding-left: 16px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">${t.replace(/</g,"&lt;")}</div>
    `,c.addEventListener("click",d=>{if(d.target.classList?.contains("toast-close")){dismissToast(c);return}navigateToSession(n),dismissToast(c)}),s.appendChild(c),notifLog(`[Notifications] Toast rendered for ${e} (session=${n})`),requestAnimationFrame(()=>{c.style.opacity="1",c.style.transform="translateX(0)"});const l=setTimeout(()=>dismissToast(c),12e3);for(c._dismissTimer=l;s.children.length>4;)dismissToast(s.firstChild)}function dismissToast(e){!e||e._dismissed||(e._dismissed=!0,clearTimeout(e._dismissTimer),e.style.opacity="0",e.style.transform="translateX(100%)",setTimeout(()=>e.remove(),300))}function toggleNotificationPanel(){if(unreadSessions.size===0){const n=document.getElementById("notification-bell");n&&(n.style.animation="none",n.offsetHeight,n.style.animation="bellPulse 0.3s ease-in-out");return}let e=null,t=0;for(const[n,s]of unreadSessions)s>t&&(t=s,e=n);e&&navigateToSession(e)}function playNotificationSound(){try{const e=new(window.AudioContext||window.webkitAudioContext),t=e.createOscillator(),n=e.createGain();t.connect(n),n.connect(e.destination),t.frequency.setValueAtTime(880,e.currentTime),t.frequency.setValueAtTime(1047,e.currentTime+.1),n.gain.setValueAtTime(.08,e.currentTime),n.gain.exponentialRampToValueAtTime(.001,e.currentTime+.3),t.start(e.currentTime),t.stop(e.currentTime+.3)}catch{}}function updateUnreadBadges(){document.querySelectorAll(".session-option, [data-session-key]").forEach(s=>{const o=s.dataset?.sessionKey||s.getAttribute("data-session-key");if(!o)return;let a=s.querySelector(".unread-badge");const i=unreadSessions.get(o)||0;i>0?(a||(a=document.createElement("span"),a.className="unread-badge",s.appendChild(a)),a.textContent=i>99?"99+":i,a.style.cssText="background: var(--brand-red, #BC2026); color: white; border-radius: 50%; min-width: 18px; height: 18px; font-size: 11px; font-weight: 700; display: inline-flex; align-items: center; justify-content: center; padding: 0 4px; margin-left: 6px;"):a&&a.remove()}),document.querySelectorAll(".sidebar-agent[data-agent]").forEach(s=>{const o=s.getAttribute("data-agent");if(!o)return;let a=0;for(const[r,c]of unreadSessions)(r.startsWith(`agent:${o}:`)||o==="main"&&r==="main")&&(a+=c);let i=s.querySelector(".agent-unread-dot");a>0?(i||(i=document.createElement("span"),i.className="agent-unread-dot",i.style.cssText="position: absolute; top: 2px; right: 2px; background: var(--brand-red, #BC2026); color: white; border-radius: 50%; min-width: 16px; height: 16px; font-size: 10px; font-weight: 700; display: flex; align-items: center; justify-content: center; padding: 0 3px; pointer-events: none;",s.style.position="relative",s.appendChild(i)),i.textContent=a>99?"99+":a):i&&i.remove()});const e=Array.from(unreadSessions.values()).reduce((s,o)=>s+o,0),t=document.getElementById("notification-bell-badge");t&&(e>0?(t.textContent=e>99?"99+":e,t.style.display="flex"):t.style.display="none");const n="SoLoVision Dashboard";document.title=e>0?`(${e}) ${n}`:n}async function sendReadAck(e){try{gateway&&gateway.isConnected()&&await gateway.injectChat(e,READ_ACK_PREFIX,"read-sync")}catch(t){console.warn("[Notifications] Failed to send read ack:",t.message)}}function clearUnreadForSession(e){unreadSessions.has(e)&&(unreadSessions.delete(e),updateUnreadBadges(),sendReadAck(e))}function connectToGateway(){const e=document.getElementById("gateway-host")?.value||GATEWAY_CONFIG.host,t=parseInt(document.getElementById("gateway-port")?.value)||GATEWAY_CONFIG.port,n=document.getElementById("gateway-token")?.value||GATEWAY_CONFIG.token,s=document.getElementById("gateway-session")?.value||GATEWAY_CONFIG.sessionKey||"main";if(!e){showToast("Please enter a gateway host in Settings","warning");return}GATEWAY_CONFIG.host=e,GATEWAY_CONFIG.port=t,GATEWAY_CONFIG.token=n,GATEWAY_CONFIG.sessionKey=s,saveGatewaySettings(e,t,n,s),updateConnectionUI("connecting","Connecting..."),gateway||initGateway(),gateway.sessionKey=s,gateway.connect(e,t,n)}function disconnectFromGateway(){gateway&&gateway.disconnect(),updateConnectionUI("disconnected","Disconnected")}window.requestGatewayRestart=async function(){if(!gateway||!gateway.isConnected()){showToast("Not connected to gateway","warning");return}showToast("Restarting gateway...","info");try{await gateway.restartGateway("manual restart from dashboard"),showToast("Gateway restart initiated. Reconnecting...","success")}catch(e){console.error("[Dashboard] Gateway restart failed:",e),showToast("Restart failed: "+e.message,"error")}};function updateConnectionUI(e,t){const n=document.getElementById("gateway-status"),s=document.getElementById("gateway-status-dot"),o=document.getElementById("settings-gateway-status"),a=document.getElementById("settings-gateway-dot"),i=document.getElementById("gateway-connect-btn"),r=document.getElementById("gateway-disconnect-btn"),c=t||e;n&&(n.textContent=c),o&&(o.textContent=c);const d=(()=>{switch(e){case"connected":return"success";case"connecting":return"warning pulse";case"error":return"error";default:return"idle"}})();s&&(s.className=`status-dot ${d}`),a&&(a.className=`status-dot ${d}`),i&&r&&(e==="connected"?(i.classList.add("hidden"),r.classList.remove("hidden")):(i.classList.remove("hidden"),r.classList.add("hidden"))),renderChat(),renderChatPage()}function handleChatEvent(e){const{state:t,content:n,role:s,errorMessage:o,model:a,provider:i,stopReason:r,sessionKey:c}=e;if(n&&n.startsWith(READ_ACK_PREFIX)){c&&clearUnreadForSession(c);return}if(c&&c.startsWith("health-check-")){const l=pendingHealthChecks.get(c);l&&(t==="final"?(l.resolve({success:!0,content:n,model:a,provider:i}),pendingHealthChecks.delete(c)):t==="error"&&(l.reject(new Error(o||"Gateway error")),pendingHealthChecks.delete(c)));return}if(a&&(window._lastResponseModel=a,window._lastResponseProvider=i,syncModelDisplay(a,i)),s==="user"&&t==="final"&&n){state.chat.messages.some(d=>d.from==="user"&&d.text===n&&Date.now()-d.time<5e3)||addLocalChatMessage(n,"user");return}switch(t){case"start":case"thinking":isProcessing=!0,streamingText="",renderChat(),renderChatPage();break;case"delta":streamingText&&streamingText.length>100&&n.length<streamingText.length*.5&&addLocalChatMessage(streamingText,"solobot"),streamingText=n,isProcessing=!0,renderChat(),renderChatPage();break;case"final":const l=streamingText||n;l&&s!=="user"&&(state.chat.messages.some(u=>u.from==="solobot"&&u.text===l&&Date.now()-u.time<1e4)||addLocalChatMessage(l,"solobot",window._lastResponseModel)),streamingText="",isProcessing=!1,lastProcessingEndTime=Date.now(),setTimeout(_doHistoryRefresh,2e3),renderChat(),renderChatPage();break;case"error":addLocalChatMessage(`Error: ${o||"Unknown error"}`,"system"),streamingText="",isProcessing=!1,lastProcessingEndTime=Date.now(),renderChat(),renderChatPage();break}}function loadHistoryMessages(e){const t=state.chat.messages.filter(c=>c.id.startsWith("m")),n=[],s=[],o=c=>{if(!c)return{text:"",images:[]};let l="",d=[];if(Array.isArray(c.content))for(const u of c.content)if(u.type==="text")l+=u.text||"";else if(u.type==="input_text")l+=u.text||u.input_text||"";else if(u.type==="image")if(u.content&&u.mimeType)d.push(`data:${u.mimeType};base64,${u.content}`);else if(u.source?.data){const m=u.source.media_type||"image/jpeg";d.push(`data:${m};base64,${u.source.data}`)}else u.data&&d.push(`data:image/jpeg;base64,${u.data}`);else u.type==="image_url"&&u.image_url?.url&&d.push(u.image_url.url);else typeof c.content=="string"&&(l=c.content);if(Array.isArray(c.attachments))for(const u of c.attachments)u.type==="image"&&u.content&&u.mimeType&&d.push(`data:${u.mimeType};base64,${u.content}`);return!l&&typeof c.text=="string"&&(l=c.text),{text:(l||"").trim(),images:d}};e.forEach(c=>{if(c.role==="toolResult"||c.role==="tool")return;let l=o(c);!l.text&&!l.images.length&&c.message&&(l=o(c.message));const d={id:c.id||"m"+Date.now()+Math.random(),from:c.role==="user"?"user":"solobot",text:l.text,image:l.images[0]||null,images:l.images,time:c.timestamp||Date.now()};isSystemMessage(l.text,d.from)?s.push(d):n.push(d)});const a=new Set(n.map(c=>c.id)),i=new Set(n.map(c=>c.text)),r=t.filter(c=>!a.has(c.id)&&!i.has(c.text));state.chat.messages=[...n,...r],console.log(`[Dashboard] Set ${state.chat.messages.length} chat messages (${n.length} from history, ${r.length} local)`),state.chat.messages.sort((c,l)=>c.time-l.time),state.chat.messages.length>GATEWAY_CONFIG.maxMessages&&(state.chat.messages=state.chat.messages.slice(-GATEWAY_CONFIG.maxMessages)),state.system.messages=[...state.system.messages,...s],state.system.messages.sort((c,l)=>c.time-l.time),state.system.messages.length>GATEWAY_CONFIG.maxMessages&&(state.system.messages=state.system.messages.slice(-GATEWAY_CONFIG.maxMessages)),persistSystemMessages(),persistChatMessages(),renderChat(),renderChatPage(),renderSystemPage()}let _historyRefreshFn=null,_historyVisibilityFn=null,_historyRefreshInFlight=!1,_lastHistoryLoadTime=0;const HISTORY_MIN_INTERVAL=2e3;function _doHistoryRefresh(){if(!gateway||!gateway.isConnected()||isProcessing||Date.now()-lastProcessingEndTime<1500||_historyRefreshInFlight||Date.now()-_lastHistoryLoadTime<HISTORY_MIN_INTERVAL)return;_historyRefreshInFlight=!0,_lastHistoryLoadTime=Date.now();const e=sessionVersion;gateway.loadHistory().then(t=>{_historyRefreshInFlight=!1,e===sessionVersion&&t?.messages&&mergeHistoryMessages(t.messages)}).catch(()=>{_historyRefreshInFlight=!1})}function startHistoryPolling(){stopHistoryPolling(),historyPollInterval=setInterval(_doHistoryRefresh,3e3),_historyRefreshFn||(_historyRefreshFn=_doHistoryRefresh,_historyVisibilityFn=()=>{document.visibilityState==="visible"&&_doHistoryRefresh()},window.addEventListener("focus",_historyRefreshFn),document.addEventListener("visibilitychange",_historyVisibilityFn))}function stopHistoryPolling(){historyPollInterval&&(clearInterval(historyPollInterval),historyPollInterval=null),_historyRefreshFn&&(window.removeEventListener("focus",_historyRefreshFn),document.removeEventListener("visibilitychange",_historyVisibilityFn),_historyRefreshFn=null,_historyVisibilityFn=null)}function mergeHistoryMessages(e){const t=new Set(state.chat.messages.map(c=>c.id)),n=new Set(state.system.messages.map(c=>c.id)),s=new Set(state.chat.messages.map(c=>c.text)),o=new Set(state.system.messages.map(c=>c.text));let a=0,i=0;const r=c=>{if(!c)return"";let l="";if(Array.isArray(c.content))for(const d of c.content)d.type==="text"&&(l+=d.text||""),d.type==="input_text"&&(l+=d.text||d.input_text||"");else typeof c.content=="string"&&(l=c.content);return!l&&typeof c.text=="string"&&(l=c.text),(l||"").trim()};for(const c of e){const l=c.id||"m"+c.timestamp;if(!(t.has(l)||n.has(l))&&!(c.role==="toolResult"||c.role==="tool")){let d=r(c);if(!d&&c.message&&(d=r(c.message)),d){const u=isSystemMessage(d,c.role==="user"?"user":"solobot");if(u&&o.has(d)||!u&&s.has(d))continue;const m={id:l,from:c.role==="user"?"user":"solobot",text:d,time:c.timestamp||Date.now()};u?(state.system.messages.push(m),o.add(d),i++):(state.chat.messages.push(m),t.add(l),s.add(d),a++)}}}if(a>0||i>0){state.chat.messages.sort((d,u)=>d.time-u.time),state.chat.messages.length>GATEWAY_CONFIG.maxMessages&&(state.chat.messages=state.chat.messages.slice(-GATEWAY_CONFIG.maxMessages)),state.system.messages.sort((d,u)=>d.time-u.time),state.system.messages.length>GATEWAY_CONFIG.maxMessages&&(state.system.messages=state.system.messages.slice(-GATEWAY_CONFIG.maxMessages)),persistSystemMessages(),persistChatMessages();const c=window.getSelection();if(!(c&&c.toString().trim().length>0))renderChat(),renderChatPage(),renderSystemPage();else if(console.log("[Dashboard] Deferring render \u2014 text is selected"),!window._pendingRender){window._pendingRender=!0;const d=()=>{const u=window.getSelection();!u||u.toString().trim().length===0?(window._pendingRender=!1,renderChat(),renderChatPage(),renderSystemPage()):requestAnimationFrame(d)};requestAnimationFrame(d)}}}let securityInterval=null;function initSecurityPage(){loadSecurityData(),securityInterval&&clearInterval(securityInterval),securityInterval=setInterval(loadSecurityData,3e4)}async function loadSecurityData(){if(!gateway||!gateway.isConnected()){renderSecurityDisconnected();return}try{const e=await gateway._request("exec.approvals.list",{});renderExecApprovals(e?.items||e||[])}catch{renderExecApprovals([])}try{const e=await gateway._request("audit.events",{limit:50});renderConnectionLog(e?.events||e||[])}catch{renderConnectionLog([])}try{const e=await gateway._request("devices.list",{});renderDevices(e?.devices||e||[])}catch{renderDevices([])}}function renderSecurityDisconnected(){const e=document.getElementById("exec-approvals");e&&(e.innerHTML='<div class="empty-state">Connect to gateway</div>');const t=document.getElementById("connection-log");t&&(t.innerHTML="")}function renderExecApprovals(e){const t=document.getElementById("exec-approvals");if(t){if(e.length===0){t.innerHTML='<div style="color: var(--text-muted); font-size: 12px; text-align: center; padding: 16px;">No pending approvals</div>';return}t.innerHTML=e.map(n=>{const s=n.status||"pending",o=s==="approved"?"success":s==="denied"?"error":"warning",a=n.createdAt?new Date(n.createdAt).toLocaleString():"";return`
        <div style="background: var(--surface-1); border: 1px solid var(--border-default); border-radius: var(--radius-md); padding: 10px; margin-bottom: 6px;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div style="flex: 1; min-width: 0;">
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span class="status-dot ${o}"></span>
                        <span style="font-weight: 600; font-size: 13px;">${escapeHtml(n.command||n.action||"Unknown")}</span>
                    </div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">
                        ${n.agent?`Agent: ${escapeHtml(n.agent)} \xB7 `:""}${a}
                    </div>
                    ${n.reason?`<div style="font-size: 11px; color: var(--text-muted);">Reason: ${escapeHtml(n.reason)}</div>`:""}
                </div>
                ${s==="pending"?`
                <div style="display: flex; gap: 4px; flex-shrink: 0;">
                    <button onclick="approveExec('${n.id}')" class="btn btn-primary" style="padding: 4px 10px; font-size: 11px;">Approve</button>
                    <button onclick="denyExec('${n.id}')" class="btn btn-ghost" style="padding: 4px 10px; font-size: 11px; color: var(--error);">Deny</button>
                </div>`:""}
            </div>
        </div>`}).join("")}}window.approveExec=async function(e){try{await gateway._request("exec.approvals.approve",{id:e}),showToast("Approved","success"),loadSecurityData()}catch(t){showToast("Failed: "+t.message,"error")}},window.denyExec=async function(e){try{await gateway._request("exec.approvals.deny",{id:e}),showToast("Denied","success"),loadSecurityData()}catch(t){showToast("Failed: "+t.message,"error")}};function renderConnectionLog(e){const t=document.getElementById("connection-log");if(t){if(e.length===0){t.innerHTML='<div style="color: var(--text-muted); font-size: 12px; text-align: center; padding: 12px;">No events recorded</div>';return}t.innerHTML=e.slice(0,30).map(n=>{const s=n.type||n.event||"event",o=s.includes("connect")?"\u{1F517}":s.includes("disconnect")?"\u{1F50C}":s.includes("error")?"\u26A0\uFE0F":"\u{1F4CB}",a=n.timestamp?new Date(n.timestamp).toLocaleString():"";return`
        <div style="font-size: 11px; padding: 4px 0; display: flex; gap: 6px; border-bottom: 1px solid var(--border-default);">
            <span>${o}</span>
            <span style="flex: 1;">${escapeHtml(n.message||n.description||s)}</span>
            <span style="color: var(--text-muted); flex-shrink: 0;">${a}</span>
        </div>`}).join("")}}function renderDevices(e){const t=document.getElementById("devices-list");if(t){if(e.length===0){t.innerHTML='<div style="color: var(--text-muted); font-size: 12px; text-align: center; padding: 8px;">No devices</div>';return}t.innerHTML=e.map(n=>`
        <div style="display: flex; align-items: center; gap: 8px; padding: 6px 0; border-bottom: 1px solid var(--border-default);">
            <span style="font-size: 16px;">\u{1F4BB}</span>
            <div style="flex: 1;">
                <div style="font-size: 13px; font-weight: 500;">${escapeHtml(n.name||n.id||"Unknown")}</div>
                <div style="font-size: 10px; color: var(--text-muted);">${n.lastSeen?new Date(n.lastSeen).toLocaleString():""}</div>
            </div>
            <span class="status-dot ${n.online?"success":"idle"}"></span>
        </div>`).join("")}}function getFriendlySessionName(e){if(!e)return"main";const t=e.match(/^agent:[^:]+:(.+)$/);return t?t[1]:e}let currentSessionName="main";window.toggleSessionMenu=function(){const e=document.getElementById("session-menu");e&&e.classList.toggle("hidden")},window.renameSession=async function(){toggleSessionMenu();const e=prompt("Enter new session name:",currentSessionName);if(!(!e||e===currentSessionName))try{const t=await fetch("/api/session/rename",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({oldName:currentSessionName,newName:e})});if(t.ok){currentSessionName=e;const n=document.getElementById("current-session-name");n&&(n.textContent=e),showToast(`Session renamed to "${e}"`,"success")}else{const n=await t.json();showToast(`Failed to rename: ${n.error||"Unknown error"}`,"error")}}catch(t){console.error("[Dashboard] Failed to rename session:",t),showToast("Failed to rename session","error")}},window.showSessionSwitcher=function(){toggleSessionMenu(),showToast("Session switcher coming soon","info")},window.toggleChatPageSessionMenu=function(){const e=document.getElementById("chat-page-session-menu");e&&e.classList.toggle("hidden")},document.addEventListener("click",function(e){const t=document.getElementById("chat-page-session-menu"),n=e.target.closest('[onclick*="toggleChatPageSessionMenu"]');t&&!t.classList.contains("hidden")&&!t.contains(e.target)&&!n&&t.classList.add("hidden")});let availableSessions=[],currentAgentId="main";function getAgentIdFromSession(e){const t=e?.match(/^agent:([^:]+):/);return t?t[1]:"main"}function filterSessionsForAgent(e,t){return e.filter(n=>!!(getAgentIdFromSession(n.key)===t||n.key?.startsWith("agent:main:subagent:")&&(n.displayName||n.name||"").toLowerCase().startsWith(t.toLowerCase()+"-")))}function checkUrlSessionParam(){const t=new URLSearchParams(window.location.search).get("session");return t?(console.log(`[Dashboard] URL session param detected: ${t}`),t):null}function handleSubagentSessionAgent(){if(!currentSessionName?.startsWith("agent:main:subagent:"))return;const e=availableSessions.find(s=>s.key===currentSessionName);if(!e){console.log(`[Dashboard] Subagent session not found in available sessions: ${currentSessionName}`);return}const t=e.displayName||e.name||"";console.log(`[Dashboard] Subagent session label: ${t}`);const n=t.match(/^([a-z]+)-/i);if(n){const s=n[1].toLowerCase();console.log(`[Dashboard] Determined agent from label: ${s}`),currentAgentId=s,setActiveSidebarAgent(s);const o=document.getElementById("chat-page-agent-name");o&&(o.textContent=getAgentLabel(s))}}async function fetchSessions(){const e=availableSessions.filter(t=>t.sessionId===null);if(gateway&&gateway.isConnected())try{const s=((await gateway.listSessions({}))?.sessions||[]).map(i=>{const r=getFriendlySessionName(i.key);return{key:i.key,name:r,displayName:r,updatedAt:i.updatedAt,totalTokens:i.totalTokens||(i.inputTokens||0)+(i.outputTokens||0),model:i.model||"unknown",sessionId:i.sessionId}}),o=new Set(s.map(i=>i.key)),a=e.filter(i=>!o.has(i.key));if(availableSessions=[...s,...a],console.log(`[Dashboard] Fetched ${s.length} from gateway + ${a.length} local = ${availableSessions.length} total`),handleSubagentSessionAgent(),populateSessionDropdown(),typeof updateSidebarAgentsFromSessions=="function")try{updateSidebarAgentsFromSessions(availableSessions)}catch(i){console.warn("[SidebarAgents] update failed:",i.message)}return subscribeToAllSessions(),availableSessions}catch(t){console.warn("[Dashboard] Gateway sessions.list failed, falling back to server:",t.message)}try{const t=await fetch("/api/sessions");if(!t.ok)throw new Error(`HTTP ${t.status}`);const o=((await t.json()).sessions||[]).map(r=>{const c=getFriendlySessionName(r.key);return{key:r.key,name:c,displayName:r.displayName||c,updatedAt:r.updatedAt,totalTokens:r.totalTokens||(r.inputTokens||0)+(r.outputTokens||0),model:r.model||"unknown",sessionId:r.sessionId}}),a=new Set(o.map(r=>r.key)),i=e.filter(r=>!a.has(r.key));if(availableSessions=[...o,...i],console.log(`[Dashboard] Fetched ${o.length} from server + ${i.length} local = ${availableSessions.length} total`),handleSubagentSessionAgent(),populateSessionDropdown(),typeof updateSidebarAgentsFromSessions=="function")try{updateSidebarAgentsFromSessions(availableSessions)}catch(r){console.warn("[SidebarAgents] update failed:",r.message)}return availableSessions}catch(t){return console.error("[Dashboard] Failed to fetch sessions:",t),[]}}function populateSessionDropdown(){const e=document.getElementById("chat-page-session-menu");if(!e)return;const t=filterSessionsForAgent(availableSessions,currentAgentId);console.log(`[Dashboard] populateSessionDropdown: agent=${currentAgentId}, total=${availableSessions.length}, filtered=${t.length}`),console.log("[Dashboard] Available sessions:",availableSessions.map(o=>o.key));let n="";const s=getAgentLabel(currentAgentId);if(n+=`<div style="padding: 8px 12px; font-size: 11px; text-transform: uppercase; color: var(--text-muted); border-bottom: 1px solid var(--border-default); display: flex; justify-content: space-between; align-items: center;">
        <span>${escapeHtml(s)} Sessions</span>
        <button onclick="startNewAgentSession('${currentAgentId}')" style="background: var(--brand-red); color: white; border: none; border-radius: 4px; padding: 2px 8px; font-size: 11px; cursor: pointer;" title="New session for ${s}">+ New</button>
    </div>`,t.length===0){n+='<div style="padding: 12px; color: var(--text-muted); font-size: 13px;">No sessions for this agent yet</div>',e.innerHTML=n;return}n+=t.map(o=>{const a=o.key===currentSessionName,i=o.updatedAt?new Date(o.updatedAt).toLocaleDateString():"",r=o.updatedAt?new Date(o.updatedAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"";return`
        <div class="session-dropdown-item ${a?"active":""}" data-session-key="${o.key}" onclick="if(event.target.closest('.session-edit-btn')) return; switchToSession('${o.key}')">
            <div class="session-info">
                <div class="session-name">${escapeHtml(o.displayName||o.name||o.key||"unnamed")}${unreadSessions.get(o.key)?` <span class="unread-badge" style="background: var(--brand-red, #BC2026); color: white; border-radius: 50%; min-width: 18px; height: 18px; font-size: 11px; font-weight: 700; display: inline-flex; align-items: center; justify-content: center; padding: 0 4px; margin-left: 4px;">${unreadSessions.get(o.key)}</span>`:""}</div>
                <div class="session-meta">${i} ${r} \u2022 ${o.totalTokens?.toLocaleString()||0} tokens</div>
            </div>
            <span class="session-model">${o.model}</span>
            <div class="session-actions">
                <button class="session-edit-btn" onclick="editSessionName('${o.key}', '${escapeHtml(o.displayName||o.name||o.key||"unnamed")}')" title="Rename session">
                    \u270F\uFE0F
                </button>
                <button class="session-edit-btn" onclick="deleteSession('${o.key}', '${escapeHtml(o.displayName||o.name||o.key||"unnamed")}')" title="Delete session" style="color: var(--error);">
                    \u{1F5D1}\uFE0F
                </button>
            </div>
        </div>
        `}).join(""),e.innerHTML=n}function getAgentLabel(e){return{main:"SoLoBot",exec:"EXEC",coo:"COO",cfo:"CFO",cmp:"CMP",dev:"DEV",family:"Family",tax:"Tax",smm:"SMM"}[e]||e.toUpperCase()}function getAgentDisplayName(e){return!e||e==="main"?"SoLoBot":`SoLoBot-${getAgentLabel(e)}`}function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}window.editSessionName=function(e,t){const n=prompt("Enter new session name:",t);!n||n===t||fetch("/api/session/rename",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({oldName:e,newName:n})}).then(s=>s.json()).then(s=>{if(s.ok){showToast("Session rename requested. Will update shortly.","success");const o=availableSessions.find(a=>a.key===e);if(o&&(o.displayName=n,populateSessionDropdown(),e===currentSessionName)){const a=document.getElementById("chat-page-session-name");a&&(a.textContent=e,a.title=e)}}else showToast(`Failed: ${s.error||"Unknown error"}`,"error")}).catch(s=>{console.error("[Dashboard] Failed to rename session:",s),showToast("Failed to rename session","error")})},window.deleteSession=async function(e,t){if(e===currentSessionName){showToast("Cannot delete the active session. Switch to another session first.","warning");return}if(confirm(`Delete session "${t}"?

This will permanently delete all messages in this session.`))try{if(gateway&&gateway.isConnected()){const n=await gateway.request("sessions.delete",{sessionKey:e});n&&n.ok?(showToast(`Session "${t}" deleted`,"success"),availableSessions=availableSessions.filter(s=>s.key!==e),populateSessionDropdown()):showToast(`Failed to delete: ${n?.error||"Unknown error"}`,"error")}else showToast("Not connected to gateway","error")}catch(n){console.error("[Dashboard] Failed to delete session:",n),showToast("Failed to delete session: "+n.message,"error")}},window.switchToSessionKey=window.switchToSession=async function(e){if(toggleChatPageSessionMenu(),clearUnreadForSession(e),e===currentSessionName){showToast("Already on this session","info");return}showToast(`Switching to ${getFriendlySessionName(e)}...`,"info");try{await saveCurrentChat(),cacheSessionMessages(currentSessionName||GATEWAY_CONFIG.sessionKey,state.chat.messages),sessionVersion++,console.log(`[Dashboard] Session version now ${sessionVersion}`),currentSessionName=e,GATEWAY_CONFIG.sessionKey=e,localStorage.setItem("gateway_session",e);const t=document.getElementById("gateway-session");t&&(t.value=e);const n=e.match(/^agent:([^:]+):/);n&&(currentAgentId=n[1]),await clearChatHistory(!0,!0);const s=getCachedSessionMessages(e);s&&s.length>0&&(state.chat.messages=s.slice(),typeof renderChatPage=="function"&&renderChatPage(),console.log(`[Dashboard] Restored ${s.length} cached messages for ${e}`)),gateway&&gateway.isConnected()&&(gateway.disconnect(),await new Promise(a=>setTimeout(a,150)),connectToGateway()),await loadSessionHistory(e),await applySessionModelOverride(e);const o=document.getElementById("chat-page-session-name");o&&(o.textContent=e,o.title=e),populateSessionDropdown(),n?(setActiveSidebarAgent(n[1]),saveLastAgentSession(n[1],e)):setActiveSidebarAgent(null),showToast(`Switched to ${getFriendlySessionName(e)}`,"success")}catch(t){console.error("[Dashboard] Failed to switch session:",t),showToast("Failed to switch session","error")}},window.goToSession=async function(e){if(!e){showToast("No session key provided","warning");return}if(console.log(`[Dashboard] goToSession called with: ${e}`),!gateway||!gateway.isConnected()){showToast("Connecting to gateway...","info"),GATEWAY_CONFIG.sessionKey=e,currentSessionName=e,localStorage.setItem("gateway_session",e);const t=document.getElementById("gateway-session");t&&(t.value=e),GATEWAY_CONFIG.host?connectToGateway():showToast("Please configure gateway settings first","warning");return}showPage("chat"),await switchToSession(e)},window.getSessionUrl=function(e){return`${window.location.origin+window.location.pathname}?session=${encodeURIComponent(e)}`};async function saveCurrentChat(){try{const t=await(await fetch("/api/state")).json();t.archivedChats||(t.archivedChats={}),t.archivedChats[currentSessionName]={savedAt:Date.now(),messages:chatHistory.slice(-100)},await fetch("/api/sync",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}catch{}}async function loadSessionHistory(e){try{const t=availableSessions.find(n=>n.key===e);t?.messages&&t.messages.length>0?(chatHistory=t.messages.map(n=>({role:n.role==="assistant"?"model":n.role,content:n.content||"",timestamp:n.timestamp||Date.now(),name:n.name})),renderChat(),renderChatPage(),console.log(`[Dashboard] Loaded ${t.messages.length} messages from ${e}`)):(console.warn("[Dashboard] No messages in session:",e),await loadArchivedChat(e))}catch(t){console.error("[Dashboard] Failed to load session history:",t),await loadArchivedChat(e)}}async function loadArchivedChat(e){try{const s=(await(await fetch("/api/state")).json()).archivedChats?.[e];s?.messages?(chatHistory=s.messages,renderChat(),renderChatPage()):(chatHistory=[],renderChat(),renderChatPage())}catch(t){console.warn("[Dashboard] Failed to load archived chat:",t),chatHistory=[],renderChat(),renderChatPage()}}function initGateway(){gateway=new GatewayClient({sessionKey:GATEWAY_CONFIG.sessionKey,onConnected:(e,t)=>{console.log(`[Dashboard] Connected to ${e}, session: ${t}`),updateConnectionUI("connected",e),GATEWAY_CONFIG.sessionKey=t,fetchModelsFromGateway().then(()=>applySessionModelOverride(t)),currentSessionName=t;const n=document.getElementById("current-session-name");n&&(n.textContent=t,n.title=t);const s=document.getElementById("chat-page-session-name");s&&(s.textContent=t,s.title=t);const o=t.match(/^agent:([^:]+):/);o&&saveLastAgentSession(o[1],t),checkRestartToast(),_historyRefreshInFlight=!0,_lastHistoryLoadTime=Date.now();const a=sessionVersion;gateway.loadHistory().then(i=>{if(_historyRefreshInFlight=!1,a!==sessionVersion){console.log(`[Dashboard] Ignoring stale history (version ${a} != ${sessionVersion})`);return}i?.messages&&(state.chat?.messages?.length?mergeHistoryMessages(i.messages):loadHistoryMessages(i.messages))}).catch(()=>{_historyRefreshInFlight=!1}),startHistoryPolling(),fetchSessions()},onDisconnected:e=>{updateConnectionUI("disconnected",e),isProcessing=!1,streamingText="",stopHistoryPolling()},onChatEvent:e=>{handleChatEvent(e)},onToolEvent:e=>{e.phase==="start"&&e.summary&&addTerminalLog(e.summary,"info",e.timestamp)},onCrossSessionMessage:e=>{handleCrossSessionNotification(e)},onError:e=>{console.error(`[Dashboard] Gateway error: ${e}`),updateConnectionUI("error",e)}})}let newSessionModalResolve=null;window.openNewSessionModal=function(e){return new Promise(t=>{newSessionModalResolve=t;const n=document.getElementById("new-session-modal"),s=document.getElementById("new-session-name-input");n&&s?(s.value=e||"",n.classList.add("visible"),setTimeout(()=>{s.focus(),s.select()},50)):t(null)})},window.closeNewSessionModal=function(e){const t=document.getElementById("new-session-modal");t&&t.classList.remove("visible"),newSessionModalResolve&&(newSessionModalResolve(e),newSessionModalResolve=null)},window.submitNewSessionModal=function(){const e=document.getElementById("new-session-name-input"),t=e?e.value:null;closeNewSessionModal(t)},document.addEventListener("keydown",function(e){const t=document.getElementById("new-session-modal");t&&t.classList.contains("visible")&&(e.key==="Enter"?(e.preventDefault(),submitNewSessionModal()):e.key==="Escape"&&(e.preventDefault(),closeNewSessionModal(null)))}),window.startNewAgentSession=async function(e){toggleChatPageSessionMenu();const t=new Date,n=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getDate()).padStart(2,"0"),o=t.getFullYear();let a=t.getHours();const i=a>=12?"PM":"AM";a=a%12,a=a||12;const r=String(t.getMinutes()).padStart(2,"0"),c=String(t.getSeconds()).padStart(2,"0"),l=`${n}/${s}/${o} ${String(a).padStart(2,"0")}:${r}:${c} ${i}`,d=getAgentLabel(e),u=await openNewSessionModal(l);if(!u||!u.trim())return;const m=`${e.toLowerCase()}-${u.trim()}`,p=`agent:${e}:${m}`;if(availableSessions.some(y=>y.key===p)){showToast(`Session "${u.trim()}" already exists. Switching to it.`,"info"),await switchToSession(p);return}showToast(`Creating new ${d} session "${u.trim()}"...`,"info"),sessionVersion++,console.log(`[Dashboard] Session version now ${sessionVersion} (new agent session)`),state.chat.messages=[],state.system.messages=[],chatPageNewMessageCount=0,chatPageUserScrolled=!1,localStorage.removeItem(chatStorageKey()),currentAgentId=e,renderChat(),renderChatPage(),currentSessionName=p,GATEWAY_CONFIG.sessionKey=p,localStorage.setItem("gateway_session",p);const g=document.getElementById("gateway-session");g&&(g.value=p);const f=u.trim(),h=document.getElementById("chat-page-session-name");h&&(h.textContent=f),gateway&&gateway.isConnected()&&(gateway.disconnect(),await new Promise(y=>setTimeout(y,300)),connectToGateway());const v={key:p,name:m,displayName:f,updatedAt:Date.now(),totalTokens:0,model:currentModel||"unknown",sessionId:null};availableSessions.unshift(v),await fetchSessions(),availableSessions.some(y=>y.key===p)||availableSessions.unshift(v),populateSessionDropdown(),setActiveSidebarAgent(e),renderChat(),renderChatPage(),renderSystemPage(),showToast(`New ${d} session "${f}" created`,"success")},window.startNewSession=async function(){await startNewAgentSession(currentAgentId)};let sessionSearchQuery="";function filterSessionsBySearch(e,t){if(!t)return e;const n=t.toLowerCase();return e.filter(s=>{const o=(s.displayName||s.name||s.key||"").toLowerCase(),a=(s.model||"").toLowerCase();return o.includes(n)||a.includes(n)})}const originalPopulateSessionDropdown=window.populateSessionDropdown;typeof originalPopulateSessionDropdown=="function"&&(window.populateSessionDropdown=function(){originalPopulateSessionDropdown();const e=document.getElementById("chat-page-session-menu");if(e&&!e.querySelector(".session-search")){const t=document.createElement("div");t.className="session-search",t.innerHTML=`
                <input type="text" placeholder="Search sessions..." 
                       oninput="filterSessionDropdown(this.value)"
                       onclick="event.stopPropagation()">
            `,e.insertBefore(t,e.firstChild)}}),window.filterSessionDropdown=function(e){sessionSearchQuery=e;const t=document.getElementById("chat-page-session-menu");if(!t)return;const n=t.querySelectorAll(".session-menu-item"),s=e.toLowerCase();n.forEach(o=>{const a=o.textContent.toLowerCase();o.style.display=a.includes(s)?"":"none"})};async function checkRestartToast(){try{const e=await fetch("/api/state");if(!e.ok)return;const t=await e.json();t.restartPending&&(showToast("Gateway restarted successfully","success"),delete t.restartPending,await fetch("/api/sync",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}))}catch(e){console.warn("[Dashboard] Restart toast check failed:",e)}}const SIDEBAR_AGENTS_ORDER_KEY="sidebar_agents_order_v1",SIDEBAR_AGENTS_HIDDEN_KEY="sidebar_agents_hidden_v1",SIDEBAR_AGENTS_PREFS_KEY="sidebar_agents_prefs_v1";function getSidebarAgentsPrefs(){try{return JSON.parse(localStorage.getItem(SIDEBAR_AGENTS_PREFS_KEY)||"{}")}catch{return{}}}function setSidebarAgentsPrefs(e){try{localStorage.setItem(SIDEBAR_AGENTS_PREFS_KEY,JSON.stringify(e||{}))}catch{}}function getSidebarAgentsHiddenSet(){try{const e=JSON.parse(localStorage.getItem(SIDEBAR_AGENTS_HIDDEN_KEY)||"[]");return new Set(Array.isArray(e)?e:[])}catch{return new Set}}function setSidebarAgentsHiddenSet(e){try{localStorage.setItem(SIDEBAR_AGENTS_HIDDEN_KEY,JSON.stringify(Array.from(e||[])))}catch{}}function getSidebarAgentsOrder(){try{const e=JSON.parse(localStorage.getItem(SIDEBAR_AGENTS_ORDER_KEY)||"[]");return Array.isArray(e)?e:[]}catch{return[]}}function setSidebarAgentsOrder(e){try{localStorage.setItem(SIDEBAR_AGENTS_ORDER_KEY,JSON.stringify(e||[]))}catch{}}function getSidebarAgentsContainer(){return document.getElementById("sidebar-agents-list")}function getSidebarAgentElements(){const e=getSidebarAgentsContainer();return e?Array.from(e.querySelectorAll(".sidebar-agent[data-agent]")):[]}function applySidebarAgentsOrder(){const e=getSidebarAgentsContainer();if(!e)return;const t=getSidebarAgentsOrder();if(!t.length)return;const n=new Map;for(const o of getSidebarAgentElements())n.set(o.getAttribute("data-agent"),o);for(const o of t){const a=n.get(o);a&&e.appendChild(a),n.delete(o)}for(const o of n.values())e.appendChild(o);const s=getSidebarAgentElements().map(o=>o.getAttribute("data-agent"));setSidebarAgentsOrder(s)}function applySidebarAgentsHidden(){const e=getSidebarAgentsHiddenSet();for(const t of getSidebarAgentElements()){const n=t.getAttribute("data-agent"),s=e.has(n);t.classList.toggle("is-hidden",s)}}function computeLastActivityByAgent(e){const t={};for(const n of e||[]){const s=n.key?.match(/^agent:([^:]+):/),o=s?s[1]:"main",a=n.updatedAt?new Date(n.updatedAt).getTime():0;(!t[o]||a>t[o])&&(t[o]=a)}return t}function updateSidebarAgentActivityIndicators(e){const t=getSidebarAgentsPrefs(),n=t.hideInactive===!0,s=typeof t.inactivityMs=="number"?t.inactivityMs:900*1e3,o=computeLastActivityByAgent(e),a=Date.now();for(const i of getSidebarAgentElements()){const r=i.getAttribute("data-agent"),c=o[r]||0,l=c?a-c:1/0;i.dataset.lastActivity=String(c||""),i.classList.toggle("is-inactive",l>s),i.classList.toggle("is-never-active",!c);const d=n&&r!=="main"&&l>s;i.classList.toggle("auto-hidden",d)}}function updateSidebarAgentsFromSessions(e){updateSidebarAgentActivityIndicators(e),applySidebarAgentsHidden()}let sidebarAgentsDragging=!1;function setupSidebarAgentsDragAndDrop(){const e=getSidebarAgentElements();if(e.length){for(const t of e){if(t.setAttribute("draggable","true"),t.classList.add("draggable"),!t.querySelector(".agent-drag-handle")){const n=document.createElement("span");n.className="agent-drag-handle",n.title="Drag to reorder",n.textContent="\u283F",n.addEventListener("click",s=>s.stopPropagation()),n.addEventListener("mousedown",s=>s.stopPropagation()),t.insertBefore(n,t.firstChild)}t.addEventListener("dragstart",n=>{sidebarAgentsDragging=!0,t.classList.add("dragging"),n.dataTransfer.effectAllowed="move",n.dataTransfer.setData("text/plain",t.getAttribute("data-agent")||"")}),t.addEventListener("dragend",()=>{sidebarAgentsDragging=!1,t.classList.remove("dragging");const n=getSidebarAgentElements().map(s=>s.getAttribute("data-agent"));setSidebarAgentsOrder(n)}),t.addEventListener("dragover",n=>{n.preventDefault(),n.dataTransfer.dropEffect="move"}),t.addEventListener("drop",n=>{n.preventDefault();const s=getSidebarAgentsContainer();if(!s)return;const o=n.dataTransfer.getData("text/plain"),a=s.querySelector(`.sidebar-agent[data-agent="${CSS.escape(o)}"]`);!a||a===t||s.insertBefore(a,t)})}e.forEach(t=>{t.addEventListener("click",n=>{sidebarAgentsDragging&&(n.preventDefault(),n.stopPropagation())},!0)})}}function openSidebarAgentsModal(){const e=document.getElementById("sidebar-agents-modal");e&&(renderSidebarAgentsModal(),e.classList.add("visible"))}function closeSidebarAgentsModal(){const e=document.getElementById("sidebar-agents-modal");e&&e.classList.remove("visible")}function renderSidebarAgentsModal(){const e=document.getElementById("sidebar-agents-modal-list"),t=document.getElementById("sidebar-hide-inactive"),n=document.getElementById("sidebar-inactivity-threshold");if(!e||!t||!n)return;const s=getSidebarAgentsPrefs(),o=getSidebarAgentsHiddenSet();t.checked=s.hideInactive===!0;const a=typeof s.inactivityMs=="number"?s.inactivityMs:900*1e3;n.value=String(a);const i=getSidebarAgentElements().map(r=>{const c=r.getAttribute("data-agent"),l=r.querySelector(".sidebar-item-text"),d=l?l.textContent.trim():c,u=Number(r.dataset.lastActivity||0);return{id:c,label:d,last:u}});i.sort((r,c)=>0),e.innerHTML=i.map(r=>{const c=!o.has(r.id),l=r.last?typeof timeAgo=="function"?timeAgo(r.last):"":"no activity";return`
            <label class="sidebar-agent-pref-row">
                <input type="checkbox" data-agent="${r.id}" ${c?"checked":""} />
                <span class="sidebar-agent-pref-label">${r.label}</span>
                <span class="sidebar-agent-pref-meta">${l}</span>
            </label>
        `}).join(""),e.querySelectorAll('input[type="checkbox"][data-agent]').forEach(r=>{r.addEventListener("change",()=>{const c=r.getAttribute("data-agent");if(!c)return;const l=getSidebarAgentsHiddenSet();r.checked?l.delete(c):l.add(c),setSidebarAgentsHiddenSet(l),applySidebarAgentsHidden()})}),t.onchange=()=>{const r=getSidebarAgentsPrefs();r.hideInactive=t.checked,r.inactivityMs=Number(n.value||0)||900*1e3,setSidebarAgentsPrefs(r),updateSidebarAgentActivityIndicators(window.availableSessions||[]),applySidebarAgentsHidden()},n.onchange=()=>{const r=getSidebarAgentsPrefs();r.hideInactive=t.checked,r.inactivityMs=Number(n.value||0)||900*1e3,setSidebarAgentsPrefs(r),updateSidebarAgentActivityIndicators(window.availableSessions||[]),applySidebarAgentsHidden()}}function resetSidebarAgentsOrder(){try{localStorage.removeItem(SIDEBAR_AGENTS_ORDER_KEY)}catch{}location.reload()}function setupSidebarAgentsManageButton(){const e=document.getElementById("sidebar-agents-manage-btn");e&&e.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),openSidebarAgentsModal()})}function initSidebarAgentsUI(){applySidebarAgentsOrder(),applySidebarAgentsHidden(),setupSidebarAgentsDragAndDrop(),setupSidebarAgentsManageButton(),window.availableSessions&&updateSidebarAgentActivityIndicators(window.availableSessions)}document.addEventListener("DOMContentLoaded",()=>{setTimeout(initSidebarAgentsUI,50)}),window.openSidebarAgentsModal=openSidebarAgentsModal,window.closeSidebarAgentsModal=closeSidebarAgentsModal,window.resetSidebarAgentsOrder=resetSidebarAgentsOrder,window.updateSidebarAgentsFromSessions=updateSidebarAgentsFromSessions;let skillsList=[],skillsInterval=null,skillsPageBound=!1;const skillsUi={search:"",onlyIssues:!1};function initSkillsPage(){bindSkillsPageControls(),loadSkills(),skillsInterval&&clearInterval(skillsInterval),skillsInterval=setInterval(loadSkills,6e4)}function bindSkillsPageControls(){if(skillsPageBound)return;skillsPageBound=!0;const e=document.getElementById("skills-search"),t=document.getElementById("skills-only-issues"),n=document.getElementById("skills-refresh");e&&e.addEventListener("input",()=>{skillsUi.search=(e.value||"").trim().toLowerCase(),renderSkills()}),t&&t.addEventListener("change",()=>{skillsUi.onlyIssues=!!t.checked,renderSkills()}),n&&n.addEventListener("click",()=>loadSkills())}async function loadSkills(){const e=document.getElementById("skills-list");if(e){if(!gateway||!gateway.isConnected()){e.innerHTML='<div class="empty-state">Connect to gateway to view skills</div>';return}try{let t;try{t=await gateway._request("skills.status",{}),skillsList=t?.skills||[]}catch{t=await gateway._request("skills.list",{}),skillsList=t?.skills||t||[]}renderSkills()}catch(t){console.warn("[Skills] Failed:",t.message),e.innerHTML='<div class="empty-state">Could not load skills. The skills RPC may not be available.</div>'}}}function skillHasIssues(e){const t=e?.missing||{},n=(t.bins?.length||0)+(t.anyBins?.length||0)+(t.env?.length||0)+(t.config?.length||0)+(t.os?.length||0);return!!(e?.disabled||e?.blockedByAllowlist||e?.eligible===!1||n>0)}function renderMissingBadges(e){const t=e?.missing||{},n=[],s=(o,a)=>{if(!a||a.length===0)return;const i=a.map(escapeHtml).join(", ");n.push(`<div style="margin-top: 6px; font-size: 11px; color: var(--text-muted);">
            <span style="font-weight: 600; color: var(--warning);">Missing ${escapeHtml(o)}:</span> ${i}
        </div>`)};return s("bins",t.bins),s("any bins",t.anyBins),s("env",t.env),s("config",t.config),s("os",t.os),e?.blockedByAllowlist&&n.push(`<div style="margin-top: 6px; font-size: 11px; color: var(--error);">
            Blocked by bundled allowlist
        </div>`),n.join("")}function skillIsReady(e){const t=e?.missing||{};return(t.bins?.length||0)+(t.anyBins?.length||0)===0}function renderInstallButtons(e){const t=e?.install||[];if(!Array.isArray(t)||t.length===0)return"";const n=e?.name;if(!n)return"";const s=e?.installed===!0,a=skillIsReady(e)?'<span class="badge" style="background: rgba(34,197,94,.12); border: 1px solid rgba(34,197,94,.25); color: var(--success); padding: 3px 8px; border-radius: 999px; font-size: 10px; font-weight: 600;">Ready</span>':"",i=t.map(r=>{const c=r?.label||"Install",l=r?.id;if(!l)return"";const d=s?"Reinstall":c;return`<button class="${s?"btn btn-ghost":"btn btn-primary"}" style="padding: 4px 10px; font-size: 11px;" onclick="installSkill('${escapeHtml(n)}','${escapeHtml(l)}')">${escapeHtml(d)}</button>`}).join("");return[a,i].filter(Boolean).join("")}function renderSkills(){const e=document.getElementById("skills-list");if(!e)return;if((!Array.isArray(skillsList)||skillsList.length===0)&&(typeof skillsList=="object"&&!Array.isArray(skillsList)&&(skillsList=Object.entries(skillsList).map(([s,o])=>({name:s,...typeof o=="object"?o:{status:o}}))),!skillsList||skillsList.length===0)){e.innerHTML='<div class="empty-state">No skills installed</div>';return}const t=skillsUi.search,n=skillsList.filter(s=>{const o=(s?.name||s?.id||"").toString(),a=(s?.description||"").toString(),i=(s?.skillKey||"").toString();return t?o.toLowerCase().includes(t)||a.toLowerCase().includes(t)||i.toLowerCase().includes(t):!0}).filter(s=>skillsUi.onlyIssues?skillHasIssues(s):!0).sort((s,o)=>(s?.name||"").localeCompare(o?.name||""));e.innerHTML=n.map(s=>{const o=s?.name||s?.id||"Unknown",a=s?.skillKey||o,i=s?.disabled?!1:s?.enabled!==!1,r=s?.eligible,c=typeof r=="boolean",l=!i||s?.disabled?"idle":r===!0?"success":r===!1?"error":"idle",d=s?.description||"",u=s?.emoji||"\u{1F9E9}",m=s?.source?`\u2022 ${escapeHtml(s.source)}`:"",p=[c?r?'<span style="font-size: 10px; color: var(--success);">Ready</span>':'<span style="font-size: 10px; color: var(--warning);">Needs attention</span>':"",s?.bundled?'<span style="font-size: 10px; color: var(--text-muted);">Bundled</span>':"",s?.always?'<span style="font-size: 10px; color: var(--text-muted);">Always</span>':""].filter(Boolean).join('<span style="opacity:.35">\u2022</span>'),g=renderInstallButtons(s),f=renderMissingBadges(s),h=s?.homepage?`<a href="${escapeHtml(s.homepage)}" target="_blank" style="font-size: 11px; color: var(--accent); text-decoration: none;">Homepage</a>`:"";return`
        <div style="background: var(--surface-1); border: 1px solid var(--border-default); border-radius: var(--radius-md); padding: 12px; margin-bottom: 10px;">
            <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 10px;">
                <div style="flex: 1; min-width: 0;">
                    <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                        <span class="status-dot ${l}"></span>
                        <span style="font-weight: 650; font-size: 14px;">${escapeHtml(u)} ${escapeHtml(o)}</span>
                        ${p?`<span style="font-size: 10px; color: var(--text-muted);">${p}</span>`:""}
                        ${m?`<span style="font-size: 10px; color: var(--text-muted);">${m}</span>`:""}
                    </div>
                    ${d?`<div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">${escapeHtml(d)}</div>`:""}
                    <div style="margin-top: 6px; display:flex; align-items:center; gap: 10px; flex-wrap: wrap;">
                        <span style="font-size: 10px; color: var(--text-faint);">skillKey: <span style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;">${escapeHtml(a)}</span></span>
                        ${h}
                    </div>
                    ${f}
                </div>

                <div style="display: flex; gap: 6px; align-items: center; flex-shrink: 0; flex-wrap: wrap; justify-content: flex-end;">
                    ${g}
                    <button onclick="viewSkillFiles('${escapeHtml(a)}', '${escapeHtml(s?.path||"")}')" 
                            class="btn btn-ghost" 
                            style="padding: 4px 10px; font-size: 11px;"
                            title="View and edit skill files">
                        \u{1F4C2} Files
                    </button>
                    <button onclick="toggleSkill('${escapeHtml(a)}', ${i?"false":"true"})" 
                            class="btn ${i?"btn-ghost":"btn-primary"}" 
                            style="padding: 4px 10px; font-size: 11px;">
                        ${i?"Disable":"Enable"}
                    </button>
                    <button onclick="promptSetApiKey('${escapeHtml(a)}', '${escapeHtml(s?.primaryEnv||"")}')" class="btn btn-ghost" style="padding: 4px 10px; font-size: 11px;">
                        Set key
                    </button>
                    <button onclick="promptSetEnv('${escapeHtml(a)}')" class="btn btn-ghost" style="padding: 4px 10px; font-size: 11px;">
                        Set env
                    </button>
                </div>
            </div>
        </div>`}).join(""),e.innerHTML.trim()||(e.innerHTML='<div class="empty-state">No matching skills</div>')}function showInstallModal(e,t,n){const s=document.getElementById("skills-install-modal-title"),o=document.getElementById("skills-install-modal-subtitle"),a=document.getElementById("skills-install-modal-body");s&&(s.textContent=e||"Skill installer"),o&&(o.textContent=t||""),a&&(a.textContent=n||""),showModal("skills-install-modal")}window.installSkill=async function(e,t){if(!gateway||!gateway.isConnected()){showToast("Connect to gateway first","warning");return}showInstallModal(`Installing ${e}`,`Installer: ${t}`,"Running\u2026");try{const n=await gateway._request("skills.install",{name:e,installId:t},6e5),s=Array.isArray(n?.warnings)&&n.warnings.length>0?`

WARNINGS:
- ${n.warnings.join(`
- `)}`:"",o=[`ok: ${String(n?.ok)}`,n?.message?`message: ${n.message}`:"",typeof n?.code<"u"?`code: ${String(n.code)}`:"","",n?.stdout?`STDOUT:
${n.stdout}`:"STDOUT: (empty)","",n?.stderr?`STDERR:
${n.stderr}`:"STDERR: (empty)"].filter(Boolean).join(`
`);showInstallModal(`Install: ${e}`,`Installer: ${t}`,o+s),showToast(n?.ok?"Install complete":"Install failed",n?.ok?"success":"error"),loadSkills()}catch(n){showInstallModal(`Install: ${e}`,`Installer: ${t}`,`ERROR: ${n.message}`),showToast("Install failed: "+n.message,"error")}},window.toggleSkill=async function(e,t){try{await gateway._request("skills.update",{skillKey:e,enabled:t}),showToast(`Skill ${t?"enabled":"disabled"}`,"success"),loadSkills()}catch(n){showToast("Failed: "+n.message,"error")}},window.promptSetApiKey=async function(e,t){if(!gateway||!gateway.isConnected()){showToast("Connect to gateway first","warning");return}const n=t?` (primary env: ${t})`:"",s=window.prompt(`Enter API key for ${e}${n}.

Leave blank to clear.`);if(s!==null)try{await gateway._request("skills.update",{skillKey:e,apiKey:s}),showToast("Saved key","success"),loadSkills()}catch(o){showToast("Failed: "+o.message,"error")}},window.promptSetEnv=async function(e){if(!gateway||!gateway.isConnected()){showToast("Connect to gateway first","warning");return}const t=window.prompt(`Env var name for ${e} (e.g., FOO_TOKEN).

Leave blank to cancel.`);if(t===null)return;const n=(t||"").trim();if(!n)return;const s=window.prompt(`Env var value for ${n}.

Leave blank to clear this key.`);if(s!==null)try{await gateway._request("skills.update",{skillKey:e,env:{[n]:s}}),showToast("Saved env override","success"),loadSkills()}catch(o){showToast("Failed: "+o.message,"error")}};let currentSkillFiles=[],currentSkillPath="",currentSkillName="",currentEditingFile=null;window.viewSkillFiles=async function(e,t){currentSkillPath=t||"",currentSkillName=e;const n=document.getElementById("skill-files-modal-title"),s=document.getElementById("skill-files-tree"),o=document.getElementById("skill-file-preview");n&&(n.textContent=`\u{1F4C2} ${e}`),s&&(s.innerHTML='<div style="color: var(--text-muted); padding: 8px;">Loading...</div>'),o&&(o.innerHTML='<div style="color: var(--text-muted); padding: 20px; text-align: center;">Select a file to view</div>'),showModal("skill-files-modal");try{const a=await fetch(`/api/skills/${encodeURIComponent(e)}/files`);if(!a.ok)throw new Error(await a.text()||"Failed to load files");const i=await a.json();if(currentSkillFiles=i?.files||[],currentSkillPath=i?.path||t||"",currentSkillFiles.length===0){s&&(s.innerHTML='<div style="color: var(--text-muted); padding: 8px;">No files found</div>');return}renderSkillFilesTree(currentSkillFiles);const r=currentSkillFiles.find(c=>c.name==="SKILL.md"||c.relativePath==="SKILL.md");r&&previewSkillFile(r.relativePath||"SKILL.md")}catch(a){console.warn("[Skills] Failed to load files:",a.message),s&&(s.innerHTML=`<div style="color: var(--error); padding: 8px;">Error: ${escapeHtml(a.message)}</div>`)}};function renderSkillFilesTree(e){const t=document.getElementById("skill-files-tree");if(!t)return;const n={};for(const s of e){const o=s.relativePath||s.name||"",a=o.split("/").filter(Boolean);let i=n;for(let r=0;r<a.length;r++){const c=a[r];r===a.length-1?(i._files||(i._files=[]),i._files.push({...s,fileName:c,relPath:o})):(i[c]||(i[c]={}),i=i[c])}}t.innerHTML=renderSkillTreeNode(n,"")}function renderSkillTreeNode(e,t){let n="";const s=Object.keys(e).filter(a=>a!=="_files").sort();for(const a of s)n+=`
        <div class="skill-tree-dir" onclick="toggleSkillTreeDir(this)" style="display: flex; align-items: center; gap: 4px; padding: 4px 8px; cursor: pointer; border-radius: 4px;">
            <span class="tree-chevron" style="font-size: 10px; color: var(--text-muted);">\u25B6</span>
            <span style="font-size: 12px;">\u{1F4C1} ${escapeHtml(a)}</span>
        </div>
        <div class="skill-tree-children hidden" style="padding-left: 16px;">
            ${renderSkillTreeNode(e[a],t?`${t}/${a}`:a)}
        </div>`;const o=e._files||[];for(const a of o.sort((i,r)=>(i.fileName||"").localeCompare(r.fileName||""))){const i=getFileIcon(a.fileName);n+=`
        <div class="skill-tree-file" onclick="previewSkillFile('${escapeHtml(a.relPath)}')" 
             style="display: flex; align-items: center; gap: 4px; padding: 4px 8px; cursor: pointer; border-radius: 4px; font-size: 12px;"
             onmouseover="this.style.background='var(--surface-2)'" onmouseout="this.style.background='transparent'">
            <span>${i}</span>
            <span>${escapeHtml(a.fileName)}</span>
        </div>`}return n}function getFileIcon(e){if(!e)return"\u{1F4C4}";const t=e.split(".").pop()?.toLowerCase();return{md:"\u{1F4DD}",py:"\u{1F40D}",sh:"\u{1F527}",js:"\u{1F4DC}",json:"\u{1F4CB}",yaml:"\u{1F4CB}",yml:"\u{1F4CB}",txt:"\u{1F4C4}"}[t]||"\u{1F4C4}"}window.toggleSkillTreeDir=function(e){const t=e.nextElementSibling;if(!t)return;const n=e.querySelector(".tree-chevron");t.classList.contains("hidden")?(t.classList.remove("hidden"),n&&(n.textContent="\u25BC")):(t.classList.add("hidden"),n&&(n.textContent="\u25B6"))},window.previewSkillFile=async function(e){const t=document.getElementById("skill-file-preview");if(t){t.innerHTML='<div style="color: var(--text-muted); padding: 20px; text-align: center;">Loading...</div>',currentEditingFile=e;try{const n=await fetch(`/api/skills/${encodeURIComponent(currentSkillName)}/files/${encodeURIComponent(e)}`);if(!n.ok)throw new Error(await n.text()||"Failed to load file");const o=(await n.json())?.content||"",a=e.split("/").pop(),i=/\.(md|txt|py|sh|js|json|yaml|yml)$/i.test(a),r=!currentSkillPath.includes("/workspace/skills");t.innerHTML=`
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-bottom: 1px solid var(--border-default); background: var(--surface-1);">
                <span style="font-weight: 600; font-size: 12px; font-family: ui-monospace, monospace;">${escapeHtml(a)}</span>
                <div style="display: flex; gap: 6px; align-items: center;">
                    ${r?'<span style="font-size: 10px; color: var(--warning);">Read-only (bundled)</span>':""}
                    ${i&&!r?`<button onclick="editSkillFile('${escapeHtml(e)}')" class="btn btn-primary" style="font-size: 11px; padding: 4px 10px;">Edit</button>`:""}
                </div>
            </div>
            <pre id="skill-file-content" style="padding: 12px; margin: 0; font-size: 11px; line-height: 1.5; white-space: pre-wrap; word-break: break-word; overflow-y: auto; flex: 1; background: var(--surface-0); color: var(--text-primary);">${escapeHtml(o)}</pre>
        `}catch(n){t.innerHTML=`<div style="color: var(--error); padding: 20px;">Error: ${escapeHtml(n.message)}</div>`}}},window.editSkillFile=async function(e){const t=document.getElementById("skill-file-preview");if(t)try{const n=await fetch(`/api/skills/${encodeURIComponent(currentSkillName)}/files/${encodeURIComponent(e)}`);if(!n.ok)throw new Error(await n.text()||"Failed to load file");const o=(await n.json())?.content||"",a=e.split("/").pop();t.innerHTML=`
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-bottom: 1px solid var(--border-default); background: var(--surface-1);">
                <span style="font-weight: 600; font-size: 12px; font-family: ui-monospace, monospace;">\u270F\uFE0F Editing: ${escapeHtml(a)}</span>
                <div style="display: flex; gap: 6px;">
                    <button onclick="previewSkillFile('${escapeHtml(e)}')" class="btn btn-ghost" style="font-size: 11px; padding: 4px 10px;">Cancel</button>
                    <button onclick="saveSkillFile('${escapeHtml(e)}')" class="btn btn-primary" style="font-size: 11px; padding: 4px 10px;">\u{1F4BE} Save</button>
                </div>
            </div>
            <textarea id="skill-file-editor" style="width: 100%; flex: 1; padding: 12px; margin: 0; font-size: 11px; line-height: 1.5; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; border: none; resize: none; background: var(--surface-0); color: var(--text-primary);">${escapeHtml(o)}</textarea>
        `;const i=document.getElementById("skill-file-editor");i&&i.focus()}catch(n){showToast("Failed to load file: "+n.message,"error")}},window.saveSkillFile=async function(e){const t=document.getElementById("skill-file-editor");if(!t)return;const n=t.value;try{const s=await fetch(`/api/skills/${encodeURIComponent(currentSkillName)}/files/${encodeURIComponent(e)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:n})});if(!s.ok){const o=await s.json().catch(()=>({}));throw new Error(o.error||"Failed to save file")}showToast("File saved","success"),previewSkillFile(e)}catch(s){showToast("Failed to save: "+s.message,"error")}};function renderSystemPage(){const e=document.getElementById("system-page-messages");if(!e)return;const t=state.system?.messages||[];if(e.innerHTML="",t.length===0){e.innerHTML=`
            <div class="chat-page-empty">
                <div class="chat-page-empty-icon">\u2699\uFE0F</div>
                <div class="chat-page-empty-text">
                    No system messages yet. This tab shows heartbeats, errors, and other system noise.
                </div>
            </div>
        `;return}t.forEach(n=>{const s=createSystemMessage(n);s&&e.appendChild(s)}),e.scrollTop=e.scrollHeight}function createSystemMessage(e){if(!e||typeof e.text!="string")return null;const t=document.createElement("div");t.className="system-message";const n=document.createElement("div");n.className="system-bubble";const s=document.createElement("div");s.className="system-bubble-header";const o=document.createElement("span");o.className="system-sender",o.textContent=e.from==="solobot"?"SoLoBot (System)":"System";const a=document.createElement("span");a.className="system-bubble-time",a.textContent=formatTime(e.time),s.appendChild(o),s.appendChild(a),n.appendChild(s);const i=document.createElement("div");return i.className="system-bubble-content",i.textContent=e.text,n.appendChild(i),t.appendChild(n),t}async function clearSystemHistory(){await showConfirm("Clear all system messages?","Clear History")&&(state.system.messages=[],persistSystemMessages(),renderSystemPage(),showToast("System messages cleared","success"))}function render(e={}){try{renderStatus(),renderConsole(),renderTasks(),renderNotes(),renderActivity(),renderDocs(),renderChat(),renderChatPage(),e.includeSystem&&renderSystemPage(),renderBulkActionBar(),updateArchiveBadge(),window.setupScrollContainment&&window.setupScrollContainment()}catch(t){console.error("[render] Error during render:",t)}}function renderStatus(){const e=document.getElementById("status-indicator"),t=document.getElementById("status-text"),n=document.getElementById("model-name"),s=document.getElementById("current-task"),o=document.getElementById("task-name"),a=document.getElementById("subagent-banner"),i=document.getElementById("subagent-task");if(e)switch(e.className="status-dot",state.status){case"working":e.classList.add("success","pulse");break;case"thinking":e.classList.add("warning","pulse");break;case"offline":e.classList.add("error");break;default:e.classList.add("success")}if(t)switch(state.status){case"working":t.textContent="WORKING";break;case"thinking":t.textContent="THINKING";break;case"offline":t.textContent="OFFLINE";break;default:t.textContent="IDLE"}n&&(n.textContent=state.model||"opus 4.5");const r=document.getElementById("provider-name");r&&(r.textContent=state.provider||"anthropic"),state.currentTask?(s?.classList.remove("hidden"),o&&(o.textContent=state.currentTask)):s?.classList.add("hidden"),state.subagent?(a?.classList.remove("hidden"),i&&(i.textContent=state.subagent)):a?.classList.add("hidden")}function renderConsole(){const e=state.live||{status:"idle"},t=state.console||{logs:[]},n=document.getElementById("console-status-badge");if(n){const o={working:{text:"WORKING",badgeClass:"badge-success"},thinking:{text:"THINKING",badgeClass:"badge-warning"},idle:{text:"IDLE",badgeClass:"badge-success"},offline:{text:"OFFLINE",badgeClass:"badge-default"}},a=o[e.status]||o.idle;n.textContent=a.text,n.className=`badge ${a.badgeClass}`}const s=document.getElementById("console-output");s&&t.logs&&t.logs.length>0&&(s.innerHTML=t.logs.map(o=>{const a=formatTimeShort(o.time),i=getLogColor(o.type),r=getLogPrefix(o.type);return`<div class="${i}"><span class="info">[${a}]</span> ${r}${escapeHtml(o.text)}</div>`}).join(""),s.scrollTop=s.scrollHeight)}function renderBulkActionBar(){const e=document.getElementById("bulk-action-bar");if(e)if(selectedTasks.size>0){e.classList.add("visible");const t=document.getElementById("bulk-count");t&&(t.textContent=`${selectedTasks.size} selected`)}else e.classList.remove("visible")}function showModal(e){document.getElementById(e)?.classList.add("visible")}function hideModal(e){document.getElementById(e)?.classList.remove("visible")}async function openSettingsModal(){showModal("settings-modal");try{const a=await(await fetch("/api/models/current")).json();document.getElementById("current-provider-display").textContent=a.provider,document.getElementById("current-model-display").textContent=a.modelId,document.getElementById("setting-provider").value=a.provider,await updateModelDropdown(a.provider)}catch(o){console.error("[Dashboard] Failed to get current model:",o),document.getElementById("current-provider-display").textContent="anthropic",document.getElementById("current-model-display").textContent="anthropic/claude-opus-4-5",document.getElementById("setting-provider").value="anthropic",await updateModelDropdown("anthropic")}const e=document.getElementById("gateway-host"),t=document.getElementById("gateway-port"),n=document.getElementById("gateway-token"),s=document.getElementById("gateway-session");e&&(e.value=GATEWAY_CONFIG.host||""),t&&(t.value=GATEWAY_CONFIG.port||443),n&&(n.value=GATEWAY_CONFIG.token||""),s&&(s.value=GATEWAY_CONFIG.sessionKey||"main")}function closeSettingsModal(){hideModal("settings-modal")}function syncFromVPS(){loadState().then(()=>{render(),updateLastSync()})}function openAddTask(e="todo"){newTaskColumn=e,showModal("add-task-modal"),document.getElementById("new-task-title")?.focus()}function closeAddTask(){hideModal("add-task-modal");const e=document.getElementById("new-task-title");e&&(e.value="")}function setTaskPriority(e){newTaskPriority=e,[0,1,2].forEach(t=>{const n=document.getElementById(`priority-btn-${t}`);n&&n.classList.toggle("bg-opacity-50",t!==e)})}function submitTask(){const t=document.getElementById("new-task-title")?.value?.trim();if(!t)return;const n={id:"t"+Date.now(),title:t,priority:newTaskPriority,created:Date.now()};state.tasks[newTaskColumn].push(n),saveState("Added task: "+t),closeAddTask(),renderTasks()}function openActionModal(e,t){currentModalTask=e,currentModalColumn=t;const n=state.tasks[t]?.find(s=>s.id===e);n&&(document.getElementById("action-modal-task-title").textContent=n.title,document.getElementById("action-priority-text").textContent=`Change Priority (P${n.priority})`,["todo","progress","done","archive"].forEach(s=>{const o=document.getElementById(`action-move-${s}`);o&&o.classList.toggle("hidden",s===t)}),showModal("task-action-modal"))}function closeActionModal(){hideModal("task-action-modal"),currentModalTask=null,currentModalColumn=null}function modalMoveTask(e){if(!currentModalTask||!currentModalColumn)return;const t=state.tasks[currentModalColumn].findIndex(s=>s.id===currentModalTask);if(t===-1)return;const[n]=state.tasks[currentModalColumn].splice(t,1);state.tasks[e].push(n),saveState(`Moved task to ${e}`),closeActionModal(),renderTasks(),updateArchiveBadge()}function modalEditTitle(){if(!currentModalTask||!currentModalColumn)return;const e=state.tasks[currentModalColumn]?.find(t=>t.id===currentModalTask);e&&(closeActionModal(),document.getElementById("edit-title-input").value=e.title,showModal("edit-title-modal"),document.getElementById("edit-title-input")?.focus())}function closeEditTitleModal(){hideModal("edit-title-modal")}function saveEditedTitle(){if(!currentModalTask||!currentModalColumn)return;const e=state.tasks[currentModalColumn]?.find(n=>n.id===currentModalTask);if(!e)return;const t=document.getElementById("edit-title-input")?.value?.trim();t&&(e.title=t,saveState("Edited task title"),renderTasks()),closeEditTitleModal()}function modalCyclePriority(){if(!currentModalTask||!currentModalColumn)return;const e=state.tasks[currentModalColumn]?.find(t=>t.id===currentModalTask);e&&(e.priority=(e.priority+1)%3,document.getElementById("action-priority-text").textContent=`Change Priority (P${e.priority})`,saveState("Changed priority"),renderTasks())}function modalDeleteTask(){document.getElementById("delete-modal-task-title").textContent=state.tasks[currentModalColumn]?.find(e=>e.id===currentModalTask)?.title||"",closeActionModal(),showModal("confirm-delete-modal")}function closeDeleteModal(){hideModal("confirm-delete-modal")}function confirmDeleteTask(){if(!currentModalTask||!currentModalColumn)return;const e=state.tasks[currentModalColumn].findIndex(t=>t.id===currentModalTask);e!==-1&&(state.tasks[currentModalColumn].splice(e,1),saveState("Deleted task"),renderTasks()),closeDeleteModal()}function quickMoveTask(e,t,n,s){s?.stopPropagation();const o=state.tasks[t].findIndex(i=>i.id===e);if(o===-1)return;const[a]=state.tasks[t].splice(o,1);state.tasks[n].push(a),saveState(`Moved task to ${n}`),renderTasks()}function toggleTaskSelection(e,t){t?.stopPropagation(),selectedTasks.has(e)?selectedTasks.delete(e):selectedTasks.add(e),renderTasks(),typeof renderBulkActionBar=="function"&&renderBulkActionBar()}function selectAllTasks(){["todo","progress","done"].forEach(e=>{state.tasks[e].forEach(t=>selectedTasks.add(t.id))}),renderTasks(),typeof renderBulkActionBar=="function"&&renderBulkActionBar()}function clearSelection(){selectedTasks.clear(),renderTasks(),typeof renderBulkActionBar=="function"&&renderBulkActionBar()}function bulkMoveTo(e){selectedTasks.size!==0&&(selectedTasks.forEach(t=>{["todo","progress","done"].forEach(n=>{const s=state.tasks[n].findIndex(o=>o.id===t);if(s!==-1){const[o]=state.tasks[n].splice(s,1);state.tasks[e].push(o)}})}),saveState(`Bulk moved ${selectedTasks.size} tasks to ${e}`),clearSelection(),renderTasks(),updateArchiveBadge())}function clearDone(){const e=state.tasks.done.splice(0);state.tasks.archive.push(...e),saveState("Archived done tasks"),renderTasks(),updateArchiveBadge()}function openArchiveModal(){renderArchive(),showModal("archive-modal")}function renderArchive(){const e=document.getElementById("archive-tasks-list"),t=document.getElementById("archive-modal-count");if(!e)return;const n=state.tasks.archive||[];t&&(t.textContent=n.length),e.innerHTML=n.map(s=>`
        <div class="task-card" style="display: flex; align-items: center; justify-content: space-between;">
            <div>
                <span class="task-title">${escapeHtml(s.title)}</span>
                <div class="task-meta">${formatTime(s.created)}</div>
            </div>
            <button onclick="restoreFromArchive('${s.id}')" class="btn btn-ghost" style="font-size: 12px;">
                Restore
            </button>
        </div>
    `).join("")||'<div style="color: var(--text-muted); font-size: 13px; text-align: center; padding: var(--space-8);">No archived tasks</div>'}function closeArchiveModal(){hideModal("archive-modal")}function restoreFromArchive(e){const t=state.tasks.archive.findIndex(s=>s.id===e);if(t===-1)return;const[n]=state.tasks.archive.splice(t,1);state.tasks.todo.push(n),saveState("Restored task from archive"),renderArchive(),renderTasks(),updateArchiveBadge()}async function clearArchive(){await showConfirm("Delete all archived tasks permanently?","Clear Archive","Delete All")&&(state.tasks.archive=[],saveState("Cleared archive"),renderArchive(),updateArchiveBadge(),showToast("Archive cleared","success"))}function addNote(){const e=document.getElementById("note-input"),t=e?.value?.trim();t&&(state.notes.push({id:"n"+Date.now(),text:t,created:Date.now(),seen:!1}),e.value="",saveState("Added note"),renderNotes())}function clearConsole(){state.console&&(state.console.logs=[]),saveState(),renderConsole()}function addTerminalLog(e,t="info",n=null){state.console||(state.console={logs:[]});const s={time:n||Date.now(),text:e,type:t},o=state.console.logs[state.console.logs.length-1];o&&o.text===e&&Math.abs(s.time-o.time)<5e3||(state.console.logs.push(s),state.console.logs.length>500&&(state.console.logs=state.console.logs.slice(-500)),renderConsole())}let lastActivitySync=0;async function syncActivitiesFromFile(){try{if(!gateway||!gateway.isConnected())return;const e=await fetch("/api/memory/recent-activity.json");if(!e.ok)return;const t=await e.json(),n=typeof t.content=="string"?JSON.parse(t.content):t.content;if(!n||!n.activities||n.updatedMs<=lastActivitySync)return;lastActivitySync=n.updatedMs;const s=n.activities.map(i=>({time:i.timestamp,text:i.text,type:"info"}));state.console||(state.console={logs:[]});const o=new Set(state.console.logs.map(i=>`${i.time}-${i.text}`));let a=0;for(const i of s){const r=`${i.time}-${i.text}`;o.has(r)||(state.console.logs.push(i),o.add(r),a++)}a>0&&(state.console.logs.sort((i,r)=>i.time-r.time),state.console.logs=state.console.logs.slice(-100),renderConsole())}catch{}}setInterval(syncActivitiesFromFile,3e4),setTimeout(syncActivitiesFromFile,2e3);function toggleConsoleExpand(){const e=document.getElementById("console-section"),t=document.getElementById("console-output"),n=document.getElementById("console-expand-btn");if(!e||!t||!n)return;t.classList.contains("h-[500px]")?(t.classList.remove("h-[500px]"),t.classList.add("h-[250px]"),n.textContent="Expand"):(t.classList.remove("h-[250px]"),t.classList.add("h-[500px]"),n.textContent="Collapse")}function updateSetting(e,t){if(e==="provider"||e==="model"){console.warn(`[Dashboard] Cannot change ${e} from dashboard - must be configured at OpenClaw gateway level`),showToast(`${e.charAt(0).toUpperCase()+e.slice(1)} must be configured at OpenClaw gateway level`,"warning");return}localStorage.setItem(`setting_${e}`,JSON.stringify(t))}async function resetToServerState(){await showConfirm("This will reload all data from the server. Continue?","Reset to Server","Reload")&&(localStorage.removeItem("solovision-dashboard"),location.reload())}async function clearAllData(){await showConfirm("This will delete ALL local data. Are you sure?","\u26A0\uFE0F Delete All Data","Delete Everything")&&(localStorage.clear(),state={status:"idle",model:"opus 4.5",tasks:{todo:[],progress:[],done:[],archive:[]},notes:[],activity:[],docs:[],console:{logs:[]},chat:{messages:[]}},saveState(),render())}let draggedTaskId=null,draggedFromColumn=null;function handleDragStart(e,t,n){draggedTaskId=t,draggedFromColumn=n,e.dataTransfer.effectAllowed="move";const s=e.target.closest(".task-card");s&&s.classList.add("opacity-50")}function handleDragEnd(e){const t=e.target.closest(".task-card");t&&t.classList.remove("opacity-50"),draggedTaskId=null,draggedFromColumn=null,document.querySelectorAll(".drop-zone").forEach(n=>{n.classList.remove("bg-slate-600/30","ring-2","ring-solo-primary")})}function handleDragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="move"}function handleDragEnter(e,t){e.preventDefault(),document.getElementById(`${t==="progress"?"progress":t}-tasks`)?.classList.add("bg-slate-600/30","ring-2","ring-solo-primary")}function handleDragLeave(e,t){document.getElementById(`${t==="progress"?"progress":t}-tasks`)?.classList.remove("bg-slate-600/30","ring-2","ring-solo-primary")}function handleDrop(e,t){if(e.preventDefault(),document.getElementById(`${t==="progress"?"progress":t}-tasks`)?.classList.remove("bg-slate-600/30","ring-2","ring-solo-primary"),!draggedTaskId||!draggedFromColumn||draggedFromColumn===t)return;const s=state.tasks[draggedFromColumn].findIndex(a=>a.id===draggedTaskId);if(s===-1)return;const[o]=state.tasks[draggedFromColumn].splice(s,1);state.tasks[t].push(o),saveState(`Moved task to ${t}`),renderTasks()}function closeAllTaskMenus(){document.querySelectorAll(".task-menu").forEach(e=>e.classList.add("hidden"))}let cronJobs=[],cronInterval=null;function initCronPage(){loadCronJobs(),cronInterval&&clearInterval(cronInterval),cronInterval=setInterval(loadCronJobs,3e4)}async function loadCronJobs(){const e=document.getElementById("cron-jobs-list");if(e){if(!gateway||!gateway.isConnected()){e.innerHTML='<div class="empty-state">Connect to gateway to manage cron jobs</div>';return}try{const t=await gateway._request("cron.list",{});cronJobs=t?.jobs||t||[],renderCronJobs()}catch(t){console.warn("[Cron] Failed to fetch jobs:",t.message),e.innerHTML='<div class="empty-state">Could not load cron jobs. The cron RPC may not be available.</div>'}}}function renderCronJobs(){const e=document.getElementById("cron-jobs-list");if(e){if(cronJobs.length===0){e.innerHTML='<div class="empty-state">No cron jobs configured</div>';return}e.innerHTML=cronJobs.map((t,n)=>{const s=t.enabled!==!1,o=t.lastRunStatus||t.lastStatus||"--",a=o==="success"?"success":o==="error"?"error":"",i=t.nextRun?new Date(t.nextRun).toLocaleString():"--",r=t.lastRun?timeAgo(new Date(t.lastRun).getTime()):"Never";return`
        <div class="cron-job-card" style="background: var(--surface-1); border: 1px solid var(--border-default); border-radius: var(--radius-md); padding: 12px; margin-bottom: 8px;">
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">
                <div style="flex: 1; min-width: 0;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-weight: 600; font-size: 14px;">${escapeHtml(t.name||t.id||"Unnamed Job")}</span>
                        ${s?"":'<span class="badge" style="background: var(--surface-2); font-size: 10px;">Disabled</span>'}
                        ${a?`<span class="badge badge-${a}" style="font-size: 10px;">${o}</span>`:""}
                    </div>
                    <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">
                        <code style="background: var(--surface-2); padding: 1px 4px; border-radius: 3px; font-size: 11px;">${escapeHtml(t.schedule||t.cron||"--")}</code>
                        <span style="margin-left: 8px;">Next: ${i}</span>
                        <span style="margin-left: 8px;">Last: ${r}</span>
                    </div>
                    ${t.description?`<div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">${escapeHtml(t.description)}</div>`:""}
                </div>
                <div style="display: flex; gap: 4px; align-items: center; flex-shrink: 0;">
                    <button onclick="toggleCronJob('${t.id||n}', ${!s})" class="btn btn-ghost" style="padding: 4px 8px; font-size: 11px;" title="${s?"Disable":"Enable"}">
                        ${s?"\u23F8":"\u25B6"}
                    </button>
                    <button onclick="runCronJob('${t.id||n}')" class="btn btn-ghost" style="padding: 4px 8px; font-size: 11px;" title="Run Now">
                        \u{1F680}
                    </button>
                    <button onclick="showCronHistory('${t.id||n}')" class="btn btn-ghost" style="padding: 4px 8px; font-size: 11px;" title="History">
                        \u{1F4CB}
                    </button>
                </div>
            </div>
            <div id="cron-history-${t.id||n}" class="cron-history hidden" style="margin-top: 8px; border-top: 1px solid var(--border-default); padding-top: 8px;"></div>
        </div>`}).join("")}}async function toggleCronJob(e,t){try{await gateway._request("cron.toggle",{id:e,enabled:t}),showToast(`Job ${t?"enabled":"disabled"}`,"success"),loadCronJobs()}catch(n){showToast("Failed: "+n.message,"error")}}async function runCronJob(e){try{await gateway._request("cron.run",{id:e}),showToast("Job triggered","success")}catch(t){showToast("Failed: "+t.message,"error")}}async function showCronHistory(e){const t=document.getElementById(`cron-history-${e}`);if(t){if(!t.classList.contains("hidden")){t.classList.add("hidden");return}t.innerHTML='<div style="font-size: 11px; color: var(--text-muted);">Loading...</div>',t.classList.remove("hidden");try{const s=(await gateway._request("cron.runs",{id:e,limit:10}))?.runs||[];if(s.length===0){t.innerHTML='<div style="font-size: 11px; color: var(--text-muted);">No run history</div>';return}t.innerHTML=s.map(o=>{const a=o.status||"unknown",i=o.startedAt?new Date(o.startedAt).toLocaleString():"--";return`<div style="font-size: 11px; padding: 2px 0;"><span style="${a==="success"?"color: var(--success)":a==="error"?"color: var(--error)":""}">${a}</span> \u2014 ${i}${o.duration?` (${o.duration}ms)`:""}</div>`}).join("")}catch{t.innerHTML='<div style="font-size: 11px; color: var(--error);">Failed to load history</div>'}}}window.openAddCronModal=function(){const e=document.getElementById("add-cron-modal");e&&e.classList.add("visible")},window.closeAddCronModal=function(){const e=document.getElementById("add-cron-modal");e&&e.classList.remove("visible")},window.submitNewCronJob=async function(){const e=document.getElementById("cron-new-name")?.value?.trim(),t=document.getElementById("cron-new-schedule")?.value?.trim(),n=document.getElementById("cron-new-command")?.value?.trim();if(!e||!t){showToast("Name and schedule are required","warning");return}try{await gateway._request("cron.add",{name:e,schedule:t,command:n}),showToast("Cron job added","success"),closeAddCronModal(),loadCronJobs()}catch(s){showToast("Failed: "+s.message,"error")}};let healthTestResults={},healthTestInProgress=!1,pendingHealthChecks=new Map;function initHealthPage(){updateHealthGatewayStatus(),loadHealthModels()}function updateHealthGatewayStatus(){const e=document.getElementById("health-gateway-status");e&&(gateway&&gateway.isConnected()?e.innerHTML=`
            <span style="font-size: 20px;">\u2705</span>
            <span style="font-weight: 500; color: var(--success);">Connected</span>
        `:e.innerHTML=`
            <span style="font-size: 20px;">\u274C</span>
            <span style="font-weight: 500; color: var(--error);">Disconnected</span>
        `)}async function loadHealthModels(){try{const e=await fetch("/api/models/list");if(!e.ok)throw new Error("Failed to fetch models");const t=await e.json();let n=[];if(t.models)n=t.models;else for(const o of Object.keys(t))Array.isArray(t[o])&&(n=n.concat(t[o]));const s=document.getElementById("health-model-count");return s&&(s.textContent=n.length),renderHealthModelList(n,{}),n}catch(e){console.error("[Health] Failed to load models:",e);const t=document.getElementById("health-model-count");return t&&(t.textContent="?"),[]}}async function testSingleModel(e){const t=Date.now();try{if(!gateway||!gateway.isConnected())return{success:!1,error:"Gateway not connected",latencyMs:Date.now()-t};const n="health-check-"+e.replace(/\//g,"-").replace(/[^a-zA-Z0-9-]/g,"");console.log(`[Health] Setting model for session ${n} to ${e}`);try{await gateway._request("sessions.patch",{key:n,model:e},1e4)}catch(i){return console.error(`[Health] Failed to patch session model: ${i.message}`),{success:!1,error:`Model config failed: ${i.message}`,latencyMs:Date.now()-t}}const s=new Promise((i,r)=>{const c=setTimeout(()=>{pendingHealthChecks.has(n)&&(pendingHealthChecks.delete(n),r(new Error("Response timeout (60s)")))},6e4);pendingHealthChecks.set(n,{resolve:l=>{clearTimeout(c),i(l)},reject:l=>{clearTimeout(c),r(l)}})});console.log(`[Health] Sending test message to ${e}`),await gateway._request("chat.send",{message:"Respond with exactly: OK",sessionKey:n,idempotencyKey:crypto.randomUUID()},1e4);const o=await s,a=Date.now()-t;return{success:!0,response:o?.content||"OK",latencyMs:a}}catch(n){return{success:!1,error:n.message||"Test failed",latencyMs:Date.now()-t}}}window.runAllModelTests=async function(){if(healthTestInProgress){showToast("Health check already in progress","warning");return}healthTestInProgress=!0,healthTestResults={};const e=document.getElementById("test-all-btn"),t=document.getElementById("health-test-progress");e&&(e.disabled=!0,e.innerHTML="\u23F3 Testing...");try{const n=await loadHealthModels();if(n.length===0){showToast("No models found to test","warning");return}n.forEach(r=>{healthTestResults[r.id]={status:"testing"}}),renderHealthModelList(n,healthTestResults);let s=0,o=0,a=0;for(const r of n){s++,t&&(t.textContent=`Testing ${s}/${n.length}...`);const c=await testSingleModel(r.id);healthTestResults[r.id]={status:c.success?"success":"error",error:c.error,latencyMs:c.latencyMs,response:c.response},c.success?o++:a++,renderHealthModelList(n,healthTestResults)}const i=document.getElementById("health-last-test");i&&(i.textContent=new Date().toLocaleTimeString()),t&&(t.textContent=`\u2705 ${o} passed, \u274C ${a} failed`),showToast(`Health check complete: ${o}/${n.length} models working`,a>0?"warning":"success")}catch(n){console.error("[Health] Test failed:",n),showToast("Health check failed: "+n.message,"error")}finally{healthTestInProgress=!1,e&&(e.disabled=!1,e.innerHTML="\u{1F680} Test All Models")}};function renderHealthModelList(e,t){const n=document.getElementById("health-model-list");if(n){if(e.length===0){n.innerHTML=`
            <div style="padding: var(--space-4); color: var(--text-muted); text-align: center;">
                <p>No models available. Check gateway connection.</p>
            </div>
        `;return}n.innerHTML=e.map(s=>{const o=t[s.id]||{status:"pending"};let a,i,r;switch(o.status){case"success":a="\u2705",i="var(--success)",r=`${o.latencyMs}ms`;break;case"error":a="\u274C",i="var(--error)",r=o.error||"Failed";break;case"testing":a="\u23F3",i="var(--warning)",r="Testing...";break;default:a="\u26AA",i="var(--text-muted)",r="Not tested"}const c=s.id.split("/")[0]||"unknown",l=s.id.split("/").slice(1).join("/")||s.id;return`
            <div style="display: flex; align-items: center; justify-content: space-between; padding: var(--space-3) var(--space-4); border-bottom: 1px solid var(--border-subtle);">
                <div style="display: flex; align-items: center; gap: var(--space-3);">
                    <span style="font-size: 18px;">${a}</span>
                    <div>
                        <div style="font-weight: 500; color: var(--text-primary);">${l}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">
                            <span style="background: var(--surface-3); padding: 1px 6px; border-radius: 3px;">${c}</span>
                            ${s.displayName?`<span style="margin-left: 8px;">${s.displayName}</span>`:""}
                        </div>
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="color: ${i}; font-size: 13px; font-weight: 500; margin-bottom: 2px;">${r}</div>
                    ${o.status!=="testing"&&!healthTestInProgress?`
                        <button onclick="testSingleModelUI('${s.id}')" class="btn btn-ghost" style="font-size: 10px; padding: 1px 6px; height: auto;">
                            ${o.status==="pending"?"Test":"Re-test"}
                        </button>
                    `:""}
                </div>
            </div>
        `}).join("")}}window.testSingleModelUI=async function(e){const t=await loadHealthModels();healthTestResults[e]={status:"testing"},renderHealthModelList(t,healthTestResults);const n=await testSingleModel(e);healthTestResults[e]={status:n.success?"success":"error",error:n.error,latencyMs:n.latencyMs},renderHealthModelList(t,healthTestResults),showToast(n.success?`${e.split("/").pop()} is working!`:`${e.split("/").pop()} failed: ${n.error}`,n.success?"success":"error")};const originalShowPage=window.showPage;typeof originalShowPage=="function"&&(window.showPage=function(e,t=!0){originalShowPage(e,t),e==="health"&&initHealthPage(),e==="chat"&&forceRefreshHistory()});let voiceRecognition=null,voiceInputState="idle",voiceAutoSend=localStorage.getItem("voice_auto_send")==="true",voicePushToTalk=!1,lastVoiceTranscript="";function showLiveTranscriptIndicator(){}function hideLiveTranscriptIndicator(){}function updateLiveTranscriptIndicator(e,t){}function initVoiceInput(){const e=window.SpeechRecognition||window.webkitSpeechRecognition,t=[document.getElementById("voice-input-btn"),document.getElementById("voice-input-btn-chatpage")];if(!e){for(const n of t)n&&(n.disabled=!0,n.title="Voice input not supported in this browser",n.innerHTML='<span class="voice-unsupported">\u{1F3A4}\u2717</span>');console.log("[Voice] Web Speech API not supported");return}t.every(n=>!n)||(voiceRecognition=new e,voiceRecognition.continuous=!0,voiceRecognition.interimResults=!0,voiceRecognition.lang="en-US",voiceRecognition.maxAlternatives=1,voiceRecognition.onstart=()=>{console.log("[Voice] Started listening, target input:",activeVoiceTarget),lastVoiceTranscript="",setVoiceState("listening");const n=document.getElementById(activeVoiceTarget);n&&(n.focus(),n.placeholder="Listening... (speak now)")},voiceRecognition.onaudiostart=()=>{console.log("[Voice] Audio capture started - microphone is working")},voiceRecognition.onsoundstart=()=>{console.log("[Voice] Sound detected")},voiceRecognition.onspeechstart=()=>{console.log("[Voice] Speech detected - processing...");const n=document.getElementById(activeVoiceTarget);n&&(n.placeholder="Hearing you...")},voiceRecognition.onresult=n=>{console.log("[Voice] onresult fired, resultIndex:",n.resultIndex,"results.length:",n.results.length,"target:",activeVoiceTarget);const s=document.getElementById(activeVoiceTarget);if(!s){console.error("[Voice] Input not found:",activeVoiceTarget,"- trying fallback");const c=document.getElementById("chat-page-input")||document.getElementById("chat-input");if(!c){console.error("[Voice] No input found at all!");return}console.log("[Voice] Using fallback input:",c.id)}const o=s||document.getElementById("chat-page-input")||document.getElementById("chat-input");console.log("[Voice] Updating input element:",o?.id,o?.tagName);let a="",i="";for(let c=0;c<n.results.length;c++){const l=n.results[c],d=l[0].transcript,u=l[0].confidence;console.log(`[Voice] Result[${c}]: isFinal=${l.isFinal}, confidence=${u?.toFixed(2)||"n/a"}, text="${d}"`),l.isFinal?i+=d:a+=d}const r=i+a;console.log("[Voice] Display text:",r,"(final:",i.length,"interim:",a.length,")"),console.log("[Voice] Setting targetInput.value to:",r),o.value=r,a?(o.style.fontStyle="italic",o.style.color="var(--text-secondary)"):i&&(o.style.fontStyle="normal",o.style.color="var(--text-primary)"),o.dispatchEvent(new Event("input",{bubbles:!0})),o.focus(),o.setSelectionRange&&o.setSelectionRange(o.value.length,o.value.length),i&&(lastVoiceTranscript=i,console.log("[Voice] Final transcript stored:",i))},voiceRecognition.onerror=n=>{console.error("[Voice] Error:",n.error,n.message||""),n.error==="not-allowed"?(setVoiceState("idle"),showToast("Microphone access denied. Click the lock icon in your browser address bar to allow.","error")):n.error==="no-speech"?(console.log("[Voice] No speech detected yet, still listening..."),(!voiceRecognition||voiceInputState!=="listening")&&showToast("No speech detected. Make sure your microphone is working.","info")):n.error==="audio-capture"?(setVoiceState("idle"),showToast("No microphone found. Please connect a microphone and try again.","error")):n.error==="network"?(setVoiceState("idle"),showToast("Network error. Speech recognition requires internet connection.","error")):n.error!=="aborted"&&(setVoiceState("idle"),showToast(`Voice error: ${n.error}`,"error"))},voiceRecognition.onend=()=>{console.log("[Voice] Ended, last transcript:",lastVoiceTranscript);for(const n of["chat-input","chat-page-input"]){const s=document.getElementById(n);s&&(s.style.fontStyle="normal",s.style.color="var(--text-primary)",n==="chat-input"?s.placeholder="Type a message...":s.placeholder="Message SoLoBot...")}voiceAutoSend&&lastVoiceTranscript.trim()&&(console.log("[Voice] Auto-sending:",lastVoiceTranscript),activeVoiceTarget==="chat-page-input"?sendChatPageMessage():sendChatMessage(),lastVoiceTranscript=""),setVoiceState("idle"),voicePushToTalk=!1,activeVoiceTarget="chat-input"},console.log("[Voice] Initialized successfully"))}function startVoiceInput(){if(voiceRecognition)try{voiceRecognition.start(),console.log("[Voice] Starting...")}catch(e){console.error("[Voice] Start error:",e),e.message.includes("already started")&&stopVoiceInput()}}function stopVoiceInput(){if(voiceRecognition)try{voiceRecognition.stop(),console.log("[Voice] Stopping...")}catch(e){console.error("[Voice] Stop error:",e)}}function setVoiceState(e,t="chat-input"){voiceInputState=e,e==="idle"&&void 0;const n=[{btn:document.getElementById("voice-input-btn"),mic:document.getElementById("voice-icon-mic"),stop:document.getElementById("voice-icon-stop")},{btn:document.getElementById("voice-input-btn-chatpage"),mic:document.getElementById("voice-icon-mic-chatpage"),stop:document.getElementById("voice-icon-stop-chatpage")}];for(const{btn:s,mic:o,stop:a}of n)if(s)switch(s.classList.remove("listening","processing"),e){case"listening":s.classList.add("listening"),s.title="Listening... (click to stop)",o&&(o.style.display="none"),a&&(a.style.display="block");break;case"processing":s.classList.add("processing"),s.title="Processing...";break;default:s.title="Voice input (click to speak)",o&&(o.style.display="block"),a&&(a.style.display="none");break}}let activeVoiceTarget="chat-input";function toggleVoiceInputChatPage(){activeVoiceTarget="chat-page-input",toggleVoiceInput()}const originalToggleVoiceInput=toggleVoiceInput;function toggleVoiceInput(){if(activeVoiceTarget!=="chat-page-input"&&voiceInputState!=="listening"&&(activeVoiceTarget="chat-input"),!voiceRecognition){showToast("Voice input not available","error");return}voiceInputState==="listening"?stopVoiceInput():startVoiceInput()}function toggleVoiceAutoSend(){voiceAutoSend=!voiceAutoSend,localStorage.setItem("voice_auto_send",voiceAutoSend),updateVoiceAutoSendUI(),showToast(voiceAutoSend?"Voice auto-send enabled":"Voice auto-send disabled","info")}function updateVoiceAutoSendUI(){document.querySelectorAll(".voice-auto-send-toggle").forEach(t=>{t.classList.toggle("active",voiceAutoSend),t.title=voiceAutoSend?"Auto-send ON (click to disable)":"Auto-send OFF (click to enable)"})}function initPushToTalk(){document.addEventListener("keydown",e=>{e.code==="Space"&&e.altKey&&!voicePushToTalk&&voiceInputState!=="listening"&&(e.preventDefault(),voicePushToTalk=!0,activeVoiceTarget=document.getElementById("page-chat")?.classList.contains("active")?"chat-page-input":"chat-input",console.log("[Voice] Push-to-talk started (Alt+Space), target:",activeVoiceTarget),startVoiceInput())}),document.addEventListener("keyup",e=>{(e.code==="Space"||e.key==="Alt")&&voicePushToTalk&&(e.preventDefault(),console.log("[Voice] Push-to-talk released"),voicePushToTalk=!1,stopVoiceInput())}),console.log("[Voice] Push-to-talk initialized (hold Alt+Space to speak)")}function isTypingInInput(e){if(!e)return!1;const t=e.tagName.toLowerCase(),n=e.isContentEditable;return t==="input"||t==="textarea"||t==="select"||n}let pendingImages=[];function handleImageSelect(e){const t=e.target.files;for(const n of t)n.type.startsWith("image/")&&processImageFile(n)}function handlePaste(e){const t=e.clipboardData?.items;if(t){for(const n of t)if(n.type.startsWith("image/")){e.preventDefault();const s=n.getAsFile();s&&processImageFile(s);return}}}let chatInputSelection={start:0,end:0};function handleChatInputKeydown(e){const t=e.target;if(!(e.key!=="Enter"||!t)){if(e.ctrlKey||e.metaKey){e.preventDefault(),sendChatMessage();return}if(e.shiftKey){e.preventDefault();const n=t.selectionStart,s=t.selectionEnd,o=t.value,a=o.slice(0,n),i=o.slice(s),r=`${a}
${i}`;t.value=r;const c=n+1;t.setSelectionRange(c,c),adjustChatInputHeight(t);return}}}function cacheChatInputSelection(e){e&&(chatInputSelection.start=e.selectionStart,chatInputSelection.end=e.selectionEnd)}function restoreChatInputSelection(e){if(!e)return;const t=e.value.length,n=Math.min(chatInputSelection.start??t,t),s=Math.min(chatInputSelection.end??t,t);e.setSelectionRange(n,s)}function adjustChatInputHeight(e){if(!e)return;e.style.height="auto";const t=Math.min(e.scrollHeight,160);e.style.height=`${Math.max(t,36)}px`}function attachChatInputHandlers(){const e=document.getElementById("chat-input");e&&(e.addEventListener("keydown",handleChatInputKeydown),e.addEventListener("blur",()=>cacheChatInputSelection(e)),e.addEventListener("focus",()=>{restoreChatInputSelection(e),adjustChatInputHeight(e)}),e.addEventListener("input",()=>adjustChatInputHeight(e)),adjustChatInputHeight(e))}async function compressImage(e,t=1200,n=.8){return new Promise(s=>{const o=new Image;o.onload=()=>{const a=document.createElement("canvas");let i=o.width,r=o.height;i>t&&(r=r*t/i,i=t),a.width=i,a.height=r,a.getContext("2d").drawImage(o,0,0,i,r);const l=a.toDataURL("image/jpeg",n);s(l)},o.src=e})}function processImageFile(e){const t=new FileReader;t.onload=async n=>{let s=n.target.result;s.length>200*1024&&(s=await compressImage(s)),pendingImages.push({id:"img-"+Date.now()+"-"+Math.random().toString(36).substr(2,5),data:s,name:e.name,type:"image/jpeg"}),renderImagePreviews()},t.readAsDataURL(e)}function renderImagePreviews(){const e=document.getElementById("image-preview-container");if(e){if(pendingImages.length===0){e.classList.remove("visible"),e.innerHTML="";return}e.classList.add("visible"),e.innerHTML=pendingImages.map((t,n)=>`
        <div class="image-preview-wrapper">
            <img src="${t.data}" alt="Preview ${n+1}" />
            <button onclick="removeImagePreview('${t.id}')" class="image-preview-close">\u2715</button>
        </div>
    `).join("")}}function removeImagePreview(e){if(pendingImages=pendingImages.filter(t=>t.id!==e),renderImagePreviews(),pendingImages.length===0){const t=document.getElementById("image-upload");t&&(t.value="")}}function clearImagePreviews(){pendingImages=[],renderImagePreviews();const e=document.getElementById("image-upload");e&&(e.value="")}async function sendChatMessage(){const e=document.getElementById("chat-input"),t=e.value.trim();if(!t&&pendingImages.length===0)return;if(!gateway||!gateway.isConnected()){showToast("Not connected to Gateway. Please connect first.","warning");return}const n=[...pendingImages],s=n.length>0;if(s){const o=n.length,a=t||(o>1?`\u{1F4F7} ${o} Images`:"\u{1F4F7} Image"),i=n.map(r=>r.data);addLocalChatMessage(a,"user",i)}else addLocalChatMessage(t,"user");e.value="",clearImagePreviews(),adjustChatInputHeight(e),chatInputSelection={start:0,end:0},isProcessing=!0,renderChat(),renderChatPage();try{if(console.log(`[Chat] Sending message with model: ${currentModel}`),s){const o=n.map(a=>a.data);await gateway.sendMessageWithImages(t||"Image",o)}else await gateway.sendMessage(t)}catch(o){console.error("Failed to send message:",o),addLocalChatMessage(`Failed to send: ${o.message}`,"system")}}function addLocalChatMessage(e,t,n=null,s=null){state.chat||(state.chat={messages:[]}),state.system||(state.system={messages:[]});let o=[],a=s;n&&(Array.isArray(n)?o=n.filter(c=>c&&typeof c=="string"&&c.includes("data:")):typeof n=="string"&&(n.includes("data:image")||n.includes("data:application")?o=[n]:(n.includes("/")||n.includes("claude")||n.includes("gpt")||n.includes("MiniMax"))&&(a=n))),console.log(`[Chat] addLocalChatMessage: text="${e?.slice(0,50)}", from=${t}, images=${o.length}, model=${a}`);const i={id:"m"+Date.now(),from:t,text:e,time:Date.now(),image:o[0]||null,images:o,model:a};isSystemMessage(e,t)?(state.system.messages.push(i),state.system.messages.length>GATEWAY_CONFIG.maxMessages&&(state.system.messages=state.system.messages.slice(-GATEWAY_CONFIG.maxMessages)),persistSystemMessages(),renderSystemPage()):(state.chat.messages.push(i),state.chat.messages.length>GATEWAY_CONFIG.maxMessages&&(state.chat.messages=state.chat.messages.slice(-GATEWAY_CONFIG.maxMessages)),t!=="user"&&typeof notifyChatPageNewMessage=="function"&&notifyChatPageNewMessage(),persistChatMessages(),syncChatToVPS(),renderChat(),renderChatPage())}function syncChatToVPS(){chatSyncTimeout&&clearTimeout(chatSyncTimeout),chatSyncTimeout=setTimeout(async()=>{try{await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:state.chat.messages.slice(-100)})})}catch{}},2e3)}function renderChat(){const e=document.getElementById("chat-messages");if(!e)return;const t=state.chat?.messages||[],n=gateway?.isConnected(),s=e.scrollHeight-e.scrollTop<=e.clientHeight+5,o=e.scrollHeight-e.scrollTop-e.clientHeight;if(e.innerHTML="",t.length===0&&!streamingText){const a=document.createElement("div");a.style.cssText="color: var(--text-muted); font-size: 13px; text-align: center; padding: var(--space-8) 0;",a.textContent=n?"\u{1F4AC} Connected! Send a message to start chatting.":"\u{1F50C} Connect to Gateway in Settings to start chatting",e.appendChild(a);return}if(t.forEach(a=>{const i=createChatMessageElement(a);i&&e.appendChild(i)}),streamingText){const a=createChatMessageElement({id:"streaming",from:"solobot",text:streamingText,time:Date.now(),isStreaming:!0});a&&e.appendChild(a)}if(isProcessing&&!streamingText){const a=document.createElement("div");a.className="typing-indicator",a.innerHTML=`
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <span style="margin-left: 8px; color: var(--text-muted); font-size: 12px;">Thinking...</span>
        `,e.appendChild(a)}s?e.scrollTop=e.scrollHeight:e.scrollTop=e.scrollHeight-e.clientHeight-o}function createChatMessageElement(e){if(!e||typeof e.text!="string"||!e.text.trim()&&!e.image)return null;const t=e.from==="user",n=e.from==="system",s=document.createElement("div");s.style.marginBottom="var(--space-3)";const o=document.createElement("div");o.style.padding="var(--space-3)",o.style.borderRadius="var(--radius-md)",o.style.maxWidth="85%",o.style.wordWrap="break-word",t?(o.style.backgroundColor="rgba(188, 32, 38, 0.15)",o.style.border="1px solid rgba(188, 32, 38, 0.25)",o.style.marginLeft="auto",o.style.textAlign="right"):n?(o.style.backgroundColor="var(--warning-muted)",o.style.border="1px solid rgba(234, 179, 8, 0.2)"):(o.style.backgroundColor=(e.isStreaming,"var(--surface-2)"),o.style.border="1px solid var(--border-default)",o.style.marginRight="auto",e.isStreaming&&(o.style.opacity="0.8"));const a=document.createElement("div");a.style.display="flex",a.style.alignItems="center",a.style.gap="var(--space-2)",a.style.marginBottom="var(--space-2)",a.style.fontSize="12px",t&&(a.style.justifyContent="flex-end");const i=document.createElement("span");if(i.style.fontWeight="500",t)i.style.color="var(--brand-red)",i.textContent="You";else if(n)i.style.color="var(--warning)",i.textContent="System";else{i.style.color="var(--success)";const d=getAgentDisplayName(currentAgentId);i.textContent=e.isStreaming?`${d} (typing...)`:d}if(!t&&!n&&e.model){const d=document.createElement("span");d.style.cssText="font-size: 10px; padding: 1px 5px; background: var(--surface-3); border-radius: 3px; color: var(--text-muted); margin-left: 4px;";const u=e.model.split("/").pop().replace(/-latest$/,"");d.textContent=u,d.title=e.model,a.appendChild(d)}const r=document.createElement("span");r.style.color="var(--text-muted)",r.textContent=formatTime(e.time),a.appendChild(i),a.appendChild(r);const c=document.createElement("div");c.style.fontSize="14px",c.style.color="var(--text-primary)",c.style.lineHeight="1.5",c.style.whiteSpace="pre-wrap",c.textContent=e.text;const l=e.images||(e.image?[e.image]:[]);if(l.length>0){const d=document.createElement("div");d.style.display="flex",d.style.flexWrap="wrap",d.style.gap="8px",d.style.marginBottom="var(--space-2)",l.forEach((u,m)=>{const p=document.createElement("img");p.src=u,p.style.maxWidth=l.length>1?"100px":"150px",p.style.maxHeight=l.length>1?"80px":"100px",p.style.borderRadius="var(--radius-md)",p.style.cursor="pointer",p.style.objectFit="cover",p.style.border="1px solid var(--border-default)",p.title=`Image ${m+1} of ${l.length} - Click to view`,p.onclick=()=>openImageModal(u),d.appendChild(p)}),o.appendChild(d)}return o.appendChild(a),o.appendChild(c),s.appendChild(o),s}function openImageModal(e){const t=document.createElement("div");t.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:1000;cursor:pointer;padding:40px;",t.onclick=()=>t.remove();const n=document.createElement("div");n.textContent="\u2715",n.style.cssText="position:absolute;top:20px;right:30px;color:white;font-size:28px;cursor:pointer;opacity:0.7;transition:opacity 0.2s;",n.onmouseenter=()=>n.style.opacity="1",n.onmouseleave=()=>n.style.opacity="0.7",t.appendChild(n);const s=document.createElement("div");s.style.cssText="max-width:85vw;max-height:85vh;box-shadow:0 25px 50px rgba(0,0,0,0.5);border-radius:8px;overflow:hidden;";const o=document.createElement("img");o.src=e,o.style.cssText="display:block;max-width:85vw;max-height:85vh;object-fit:contain;",o.onclick=i=>i.stopPropagation(),s.appendChild(o),t.appendChild(s);const a=document.createElement("div");a.textContent="Click anywhere to close",a.style.cssText="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);color:rgba(255,255,255,0.5);font-size:12px;",t.appendChild(a),document.body.appendChild(t)}let chatPagePendingImages=[],chatPageScrollPosition=null,chatPageUserScrolled=!1,chatPageNewMessageCount=0;function saveChatScrollPosition(){const e=document.getElementById("chat-page-messages");e&&e.scrollTop>0&&(sessionStorage.setItem("chatScrollPosition",e.scrollTop),sessionStorage.setItem("chatScrollHeight",e.scrollHeight))}function restoreChatScrollPosition(){const e=document.getElementById("chat-page-messages");if(!e)return;const t=sessionStorage.getItem("chatScrollPosition"),n=sessionStorage.getItem("chatScrollHeight");if(t&&n){const s=parseFloat(t)/parseFloat(n);e.scrollTop=s*e.scrollHeight}}window.saveChatScrollPosition=saveChatScrollPosition,window.restoreChatScrollPosition=restoreChatScrollPosition;function isAtBottom(e){return e?e.scrollHeight-e.scrollTop-e.clientHeight<5:!0}function isNearBottom(e){return e?e.scrollHeight-e.scrollTop-e.clientHeight<100:!0}function scrollChatToBottom(){const e=document.getElementById("chat-page-messages");e&&(e.scrollTop=e.scrollHeight,chatPageUserScrolled=!1,chatPageNewMessageCount=0,updateNewMessageIndicator())}function updateNewMessageIndicator(){const e=document.getElementById("chat-page-new-indicator");if(!e)return;const t=document.getElementById("chat-page-messages"),n=t&&!isAtBottom(t);n&&chatPageNewMessageCount>0?(e.textContent=`\u2193 ${chatPageNewMessageCount} new message${chatPageNewMessageCount>1?"s":""}`,e.classList.remove("hidden")):(e.classList.add("hidden"),n||(chatPageNewMessageCount=0))}function setupChatPageScrollListener(){const e=document.getElementById("chat-page-messages");!e||e.dataset.scrollListenerAttached||(e.addEventListener("scroll",()=>{updateNewMessageIndicator(),updateScrollToBottomButton(),saveChatScrollPosition()}),e.dataset.scrollListenerAttached="true")}function updateScrollToBottomButton(){const e=document.getElementById("chat-page-messages"),t=document.getElementById("scroll-to-bottom-btn");if(!e||!t)return;e.scrollHeight-e.scrollTop-e.clientHeight>200?t.classList.remove("hidden"):t.classList.add("hidden")}function forceRefreshHistory(){_doHistoryRefresh()}function renderChatPage(){const e=document.getElementById("chat-page-messages");if(!e)return;setupChatPageScrollListener();const t=document.getElementById("chat-page-status-dot"),n=document.getElementById("chat-page-status-text"),s=gateway?.isConnected();t&&(t.className=`status-dot ${s?"success":"idle"}`),n&&(n.textContent=s?"Connected":"Disconnected");const o=state.chat?.messages||[],a=isAtBottom(e),i=e.scrollHeight-e.scrollTop-e.clientHeight;if(e.innerHTML="",o.length===0&&!streamingText){const r=getAgentDisplayName(currentAgentId);e.innerHTML=`
            <div class="chat-page-empty">
                <div class="chat-page-empty-icon">\u{1F4AC}</div>
                <div class="chat-page-empty-text">
                    ${s?`Start a conversation with ${r}`:'Connect to Gateway in <a href="#" onclick="openSettingsModal(); return false;">Settings</a> to start chatting'}
                </div>
            </div>
        `;return}if(o.forEach(r=>{const c=createChatPageMessage(r);c&&e.appendChild(c)}),streamingText){const r=createChatPageMessage({id:"streaming",from:"solobot",text:streamingText,time:Date.now(),isStreaming:!0});r&&e.appendChild(r)}if(isProcessing&&!streamingText){const r=document.createElement("div");r.className="typing-indicator",r.style.cssText="margin: 12px 0 12px 12px;",r.innerHTML=`
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <span style="margin-left: 8px; color: var(--text-muted); font-size: 12px;">Thinking...</span>
        `,e.appendChild(r)}a?e.scrollTop=e.scrollHeight:e.scrollTop=e.scrollHeight-e.clientHeight-i}function createChatPageMessage(e){if(!e||typeof e.text!="string"||!e.text.trim()&&!e.image)return null;const t=e.from==="user",n=e.from==="system",s=!t&&!n,o=document.createElement("div");if(o.className=`chat-page-message ${e.from}${e.isStreaming?" streaming":""}`,!n){const u=document.createElement("div");if(u.className="chat-page-avatar",t)u.classList.add("user-avatar"),u.textContent="U";else{const m=currentAgentId||"main";u.setAttribute("data-agent",m);const p=["main","dev","exec","coo","cfo","cmp","family","smm"].includes(m)?`/avatars/${m==="main"?"solobot":m}.png`:m==="tax"||m==="sec"?`/avatars/${m}.svg`:"/avatars/solobot.png",g=document.createElement("img");g.src=p,g.alt=getAgentDisplayName(m),g.onerror=()=>{g.style.display="none",u.textContent="\u{1F916}"},u.appendChild(g)}o.appendChild(u)}const a=document.createElement("div");a.className="chat-page-bubble";const i=e.images||(e.image?[e.image]:[]);if(i.length>0){const u=document.createElement("div");u.style.display="flex",u.style.flexWrap="wrap",u.style.gap="8px",u.style.marginBottom="8px",i.forEach((m,p)=>{const g=document.createElement("img");g.src=m,g.className="chat-page-bubble-image",g.style.maxWidth=i.length>1?"100px":"200px",g.style.maxHeight=i.length>1?"100px":"150px",g.style.objectFit="cover",g.style.cursor="pointer",g.title=`Image ${p+1} of ${i.length} - Click to view`,g.onclick=()=>openImageModal(m),u.appendChild(g)}),a.appendChild(u)}const r=document.createElement("div");r.className="chat-page-bubble-header";const c=document.createElement("span");if(c.className="chat-page-sender",t)c.textContent="You";else if(n)c.textContent="System";else{const u=getAgentDisplayName(currentAgentId);c.textContent=e.isStreaming?`${u} is typing...`:u}const l=document.createElement("span");l.className="chat-page-bubble-time",l.textContent=formatSmartTime(e.time),l.title=formatTime(e.time),r.appendChild(c),r.appendChild(l),a.appendChild(r);const d=document.createElement("div");if(d.className="chat-page-bubble-content",d.textContent=e.text,a.appendChild(d),!e.isStreaming){const u=document.createElement("div");u.className="chat-page-bubble-actions";const m=document.createElement("button");m.className="chat-action-btn",m.innerHTML="\u{1F4CB}",m.title="Copy message",m.onclick=p=>{p.stopPropagation(),copyToClipboard(e.text),m.innerHTML="\u2713",m.classList.add("copied"),setTimeout(()=>{m.innerHTML="\u{1F4CB}",m.classList.remove("copied")},1500)},u.appendChild(m),a.appendChild(u)}return o.appendChild(a),o}function copyToClipboard(e){navigator.clipboard.writeText(e).then(()=>{showToast("Copied to clipboard!","success",2e3)}).catch(()=>{const t=document.createElement("textarea");t.value=e,t.style.cssText="position:fixed;opacity:0;",document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),showToast("Copied to clipboard!","success",2e3)})}function notifyChatPageNewMessage(){const e=document.getElementById("chat-page-messages");e&&!isAtBottom(e)&&(chatPageNewMessageCount++,updateNewMessageIndicator())}function handleChatPageImageSelect(e){const t=e.target.files;for(const n of t)n.type.startsWith("image/")&&processChatPageImageFile(n)}function handleChatPagePaste(e){const t=e.clipboardData?.items;if(t){for(const n of t)if(n.type.startsWith("image/")){e.preventDefault();const s=n.getAsFile();s&&processChatPageImageFile(s);return}}}function processChatPageImageFile(e){const t=new FileReader;t.onload=async n=>{let s=n.target.result;s.length>200*1024&&(s=await compressImage(s)),chatPagePendingImages.push({id:"img-"+Date.now()+"-"+Math.random().toString(36).substr(2,5),data:s,name:e.name,type:"image/jpeg"}),renderChatPageImagePreviews()},t.readAsDataURL(e)}function renderChatPageImagePreviews(){const e=document.getElementById("chat-page-image-preview");if(e){if(chatPagePendingImages.length===0){e.classList.add("hidden"),e.classList.remove("visible"),e.innerHTML="";return}e.classList.remove("hidden"),e.classList.add("visible"),e.innerHTML=chatPagePendingImages.map((t,n)=>`
        <div class="image-preview-wrapper">
            <img src="${t.data}" alt="Preview ${n+1}" />
            <button onclick="removeChatPageImagePreview('${t.id}')" class="image-preview-close">\u2715</button>
        </div>
    `).join("")}}function removeChatPageImagePreview(e){if(chatPagePendingImages=chatPagePendingImages.filter(t=>t.id!==e),renderChatPageImagePreviews(),chatPagePendingImages.length===0){const t=document.getElementById("chat-page-image-upload");t&&(t.value="")}}function clearChatPageImagePreviews(){chatPagePendingImages=[],renderChatPageImagePreviews();const e=document.getElementById("chat-page-image-upload");e&&(e.value="")}function resizeChatPageInput(){const e=document.getElementById("chat-page-input");if(!e)return;e.style.height="auto";const t=150;e.style.height=Math.min(e.scrollHeight,t)+"px"}function setupChatPageInput(){const e=document.getElementById("chat-page-input");e&&(e.addEventListener("input",resizeChatPageInput),e.addEventListener("keydown",t=>{t.key==="Enter"&&(t.isComposing||t.keyCode===229||t.shiftKey||!gateway||!gateway.isConnected()||(t.preventDefault(),sendChatPageMessage()))}),resizeChatPageInput())}function setActiveSidebarAgent(e){if(document.querySelectorAll(".sidebar-agent[data-agent]").forEach(n=>{e&&n.getAttribute("data-agent")===e?n.classList.add("active"):n.classList.remove("active")}),e){const n=e!==currentAgentId;currentAgentId=e;const s=document.getElementById("chat-page-agent-name");s&&(s.textContent=getAgentLabel(e)),n&&populateSessionDropdown()}}function getLastAgentSession(e){try{return JSON.parse(localStorage.getItem("agent_last_sessions")||"{}")[e]||null}catch{return null}}function saveLastAgentSession(e,t){try{const n=JSON.parse(localStorage.getItem("agent_last_sessions")||"{}");n[e]=t,localStorage.setItem("agent_last_sessions",JSON.stringify(n))}catch{}}function setupSidebarAgents(){const e=document.querySelectorAll(".sidebar-agent[data-agent]");if(!e.length)return;e.forEach(s=>{const o=s.querySelector(".sidebar-item-text");o&&!o.title&&(o.title=(o.textContent||"").trim()),s.addEventListener("click",async()=>{const a=s.getAttribute("data-agent");if(!a)return;currentAgentId=a;const i=getLastAgentSession(a)||`agent:${a}:main`;showPage("chat"),await switchToSession(i),setActiveSidebarAgent(a)})});const n=(GATEWAY_CONFIG?.sessionKey||"main").match(/^agent:([^:]+):/);n&&(currentAgentId=n[1],setActiveSidebarAgent(n[1]))}async function sendChatPageMessage(){const e=document.getElementById("chat-page-input"),t=e.value.trim();if(!t&&chatPagePendingImages.length===0)return;if(!gateway||!gateway.isConnected()){showToast("Not connected to Gateway. Please connect first in Settings.","warning");return}const n=[...chatPagePendingImages],s=n.length>0;if(s){const o=n.length,a=t||(o>1?`\u{1F4F7} ${o} Images`:"\u{1F4F7} Image"),i=n.map(r=>r.data);addLocalChatMessage(a,"user",i)}else addLocalChatMessage(t,"user");e.value="",resizeChatPageInput(),e.focus(),clearChatPageImagePreviews(),chatPageUserScrolled=!1,isProcessing=!0,renderChat(),renderChatPage();try{if(console.log(`[Chat] Sending message with model: ${currentModel}`),s){const o=n.map(a=>a.data);await gateway.sendMessageWithImages(t||"Image",o)}else await gateway.sendMessage(t)}catch(o){console.error("Failed to send:",o),addLocalChatMessage(`Failed: ${o.message}`,"system"),renderChat(),renderChatPage()}}
