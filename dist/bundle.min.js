window.state=window.state||{status:"idle",model:"opus 4.5",currentTask:null,subagent:null,tasks:{todo:[],progress:[],done:[],archive:[]},notes:[],activity:[],docs:[],pendingNotify:null,live:{status:"idle",task:null,taskStarted:null,thoughts:[],lastActive:null,tasksToday:0},console:{logs:[],expanded:!1},chat:{messages:[]},system:{messages:[]}},window._lastManualModelChange=window._lastManualModelChange||null;const AGENT_COLORS=window.AGENT_COLORS=new Proxy({},{get(e,t){if(typeof t!="string")return;const n=e[t];if(n)return n;const s=getComputedStyle(document.documentElement).getPropertyValue(`--agent-${t}`).trim();return s&&(e[t]=s),s||""}});function normalizeSessionKey(e){return!e||e==="main"?"agent:main:main":e}function chatStorageKey(e){return"solobot-chat-"+normalizeSessionKey(e||GATEWAY_CONFIG?.sessionKey||localStorage.getItem("gateway_session")||"agent:main:main")}const _sessionMessageCache=new Map;function cacheSessionMessages(e,t){!e||!t||_sessionMessageCache.set(e,t.slice(-100))}function getCachedSessionMessages(e){return _sessionMessageCache.get(e)||null}function loadPersistedMessages(){try{const e=localStorage.getItem("solobot-system-messages");if(e){const a=JSON.parse(e);if(Array.isArray(a)){const i=Date.now()-864e5;state.system.messages=a.filter(r=>r.time>i)}}const t=chatStorageKey(),n=localStorage.getItem(t),s=n?null:localStorage.getItem("solobot-chat-messages"),o=n||s;if(o){const a=JSON.parse(o);if(Array.isArray(a)&&a.length>0){const i=GATEWAY_CONFIG.sessionKey.toLowerCase();if(state.chat.messages=a.filter(r=>r._sessionKey?r._sessionKey.toLowerCase()===i:!0),s&&!n&&localStorage.setItem(t,o),state.chat.messages.length>0)return}}loadChatFromServer()}catch{loadChatFromServer()}}async function loadChatFromServer(){try{const t=await(await fetch("/api/state")).json();t.chat?.messages?.length>0&&(state.chat.messages=t.chat.messages,localStorage.setItem(chatStorageKey(),JSON.stringify(state.chat.messages)),typeof renderChatMessages=="function"&&renderChatMessages(),typeof renderChatPage=="function"&&renderChatPage())}catch{}}function persistSystemMessages(){try{const e=state.system.messages.slice(-30);localStorage.setItem("solobot-system-messages",JSON.stringify(e))}catch{}}function persistChatMessages(){try{const e=state.chat.messages.slice(-200),t=chatStorageKey();localStorage.setItem(t,JSON.stringify(e)),cacheSessionMessages(currentSessionName||GATEWAY_CONFIG.sessionKey,e),syncChatToServer(e)}catch{}}let chatSyncTimeout=null;function syncChatToServer(e){chatSyncTimeout&&clearTimeout(chatSyncTimeout),chatSyncTimeout=setTimeout(async()=>{try{await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:e})})}catch{}},2e3)}loadPersistedMessages();const GATEWAY_CONFIG={host:localStorage.getItem("gateway_host")||"",port:parseInt(localStorage.getItem("gateway_port"))||443,token:localStorage.getItem("gateway_token")||"",sessionKey:normalizeSessionKey(localStorage.getItem("gateway_session")||"agent:main:main"),maxMessages:500};function saveGatewaySettings(e,t,n,s){const o=normalizeSessionKey(s);localStorage.setItem("gateway_host",e),localStorage.setItem("gateway_port",t.toString()),localStorage.setItem("gateway_token",n),localStorage.setItem("gateway_session",o),GATEWAY_CONFIG.host=e,GATEWAY_CONFIG.port=t,GATEWAY_CONFIG.token=n,GATEWAY_CONFIG.sessionKey=o,console.log("[saveGatewaySettings] Saved sessionKey:",o)}let gateway=null,streamingText="",_streamingSessionKey="",isProcessing=!1,lastProcessingEndTime=0,historyPollInterval=null,sessionVersion=0,newTaskPriority=1,newTaskColumn="todo",selectedTasks=new Set,editingTaskId=null,currentModalTask=null,currentModalColumn=null,refreshIntervalId=null,taskModalOpen=!1;const DISABLE_SYSTEM_FILTER=!1;async function loadState(){const e=state.chat,t=state.system,n=state.console,s=i=>{if(!i||!i.tasks)return 0;const r=i.tasks;return(r.todo?.length||0)+(r.progress?.length||0)+(r.done?.length||0)+(r.archive?.length||0)};let o=null;try{const i=localStorage.getItem("solovision-dashboard");if(i){const r=JSON.parse(i);r.tasks&&s(r)>0&&(o=JSON.parse(JSON.stringify(r.tasks)))}}catch{}!o&&s(state)>0&&(o=JSON.parse(JSON.stringify(state.tasks)));try{const i=await fetch("/api/state",{cache:"no-store"});if(i.ok){const r=await i.json();r.tasks||(r.tasks={todo:[],progress:[],done:[],archive:[]}),r.tasks.archive||(r.tasks.archive=[]),delete r.pendingChat,delete r.chat,state={...state,...r,tasks:r.tasks,activity:r.activity||[],_taskVersion:r._taskVersion||0,chat:e,system:t,console:n},console.log(`[loadState] Loaded from server: ${s(r)} tasks, ${(r.activity||[]).length} activity, v${r._taskVersion||0}`),localStorage.setItem("solovision-dashboard",JSON.stringify(state));return}}catch{}const a=localStorage.getItem("solovision-dashboard");if(a){const i=JSON.parse(a);delete i.system,delete i.console,state={...state,...i,chat:e,system:t,console:n}}else initSampleData()}const SYNC_API="/api/sync";async function saveState(e=null){state.localModified=Date.now(),e&&(state.lastChange=e);try{const t=JSON.parse(JSON.stringify(state));t.chat&&t.chat.messages&&(t.chat.messages=t.chat.messages.slice(-200)),t.console&&t.console.logs&&(t.console.logs=t.console.logs.slice(-500)),t.activity&&(t.activity=t.activity.slice(-200)),localStorage.setItem("solovision-dashboard",JSON.stringify(t))}catch(t){t.name==="QuotaExceededError"?(console.warn("[Dashboard] localStorage full, clearing old data..."),localStorage.removeItem("solovision-dashboard"),localStorage.removeItem("solobot-chat"),localStorage.removeItem("solobot-system-messages")):console.error("[Dashboard] saveState error:",t)}updateLastSync(),await syncToServer()}async function syncToServer(){try{let e=0,t=0,n=0;try{const a=await fetch("/api/state",{cache:"no-store"});if(a.ok){const i=await a.json(),r=i.tasks||{};if(e=(r.todo?.length||0)+(r.progress?.length||0)+(r.done?.length||0)+(r.archive?.length||0),t=Array.isArray(i.activity)?i.activity.length:0,n=i._taskVersion||0,n>(state._taskVersion||0)){console.log(`[Sync] Server tasks are newer (v${n} > v${state._taskVersion||0}) \u2014 adopting server tasks`),state.tasks=i.tasks,state._taskVersion=n;try{localStorage.setItem("solovision-dashboard",JSON.stringify(state))}catch{}renderTasks()}}}catch{}const s=JSON.parse(JSON.stringify(state));delete s.tasks,delete s._taskVersion,delete s.activity,delete s.chat,delete s.system,delete s.console;const o=await fetch(SYNC_API,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(o.ok){const a=await o.json();(a.protected?.tasks||a.protected?.activity)&&console.log("[Sync] Server protected data:",a.protected),state.console&&state.console.logs&&(state.console.logs.push({text:"State synced to server",type:"info",time:Date.now()}),state.console.logs.length>500&&(state.console.logs=state.console.logs.slice(-500)),renderConsole())}}catch(e){console.error("Sync error:",e)}}function initSampleData(){state.tasks={todo:[],progress:[],done:[],archive:[]},state.notes=[],state.activity=[],state.docs=[],saveState()}function initDashboardTasks(){console.log("[Dashboard] Task initialization skipped \u2014 tasks managed server-side")}function formatTime(e){if(!e)return"";const t=new Date(e);return isNaN(t.getTime())?"":t.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"})}function formatSmartTime(e){if(!e)return"";const n=Date.now()-e;return n<3e4?"just now":n<6e4?`${Math.floor(n/1e3)}s ago`:n<36e5?`${Math.floor(n/6e4)}m ago`:n<864e5?`${Math.floor(n/36e5)}h ago`:n<6048e5?`${Math.floor(n/864e5)}d ago`:new Date(e).toLocaleDateString("en-US",{month:"short",day:"numeric"})}function formatTimeShort(e){return e?new Date(e).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}):""}function formatRelativeTime(e){if(!e)return"Unknown";const t=Date.now()-e,n=Math.floor(t/6e4);if(n<1)return"Just now";if(n<60)return`${n}m ago`;const s=Math.floor(n/60);return s<24?`${s}h ago`:formatDate(e)}function formatDate(e){return new Date(e).toLocaleDateString("en-US",{month:"short",day:"numeric"})}function updateLastSync(){document.getElementById("last-sync").textContent=formatTime(Date.now())}function getPriorityClass(e){return e===0?"badge-error":e===1?"badge-warning":"badge-default"}function getPriorityBadgeClass(e){return e===0?"badge-error":e===1?"badge-warning":"badge-default"}function getLogColor(e){switch(e){case"command":return"text-green-400";case"success":return"text-green-300";case"error":return"text-red-400";case"warning":return"text-yellow-400";case"info":return"text-blue-400";case"thinking":return"text-purple-400";case"output":return"text-gray-300";default:return"text-gray-400"}}function getLogPrefix(e){switch(e){case"command":return"$ ";case"thinking":return"\u{1F9E0} ";case"success":return"\u2713 ";case"error":return"\u2717 ";case"warning":return"\u26A0 ";default:return""}}function getDocIcon(e){return getDocIconSymbol(e,"")}function addActivity(e,t="info"){state.activity.push({time:Date.now(),action:e,type:t}),state.activity.length>500&&(state.activity=state.activity.slice(-500))}function updateArchiveBadge(){const e=document.getElementById("archive-badge");if(!e)return;const t=(state.tasks.archive||[]).length;e.textContent=t,t>0?e.classList.remove("hidden"):e.classList.add("hidden")}let confirmResolver=null;function showToast(e,t="info",n=4e3){const s=document.getElementById("toast-container");if(!s)return;const o=document.createElement("div");switch(o.style.cssText=`
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        animation: slideIn 0.3s ease;
        max-width: 350px;
        word-wrap: break-word;
    `,t){case"success":o.style.background="var(--success)";break;case"error":o.style.background="var(--error)";break;case"warning":o.style.background="#f59e0b";break;default:o.style.background="var(--accent)";break}o.textContent=e,s.appendChild(o),setTimeout(()=>{o.style.animation="fadeOut 0.3s ease",setTimeout(()=>o.remove(),300)},n)}window.showConfirm=showConfirm,window.closeConfirmModal=closeConfirmModal,window.showToast=showToast,window.alert=function(e){showToast(e,"info",5e3)};const _originalConfirm=window.confirm;window.confirm=function(e){return console.warn("[Dashboard] Native confirm() intercepted. Use showConfirm() for proper async handling."),showToast("Action blocked - please try again","warning"),showConfirm(e,"Confirm"),!1};let confirmModalCallback=null;function showConfirm(e,t,n="OK",s="Cancel",o=!1){return new Promise(a=>{const i=document.getElementById("confirm-modal-title"),r=document.getElementById("confirm-modal-message"),l=document.getElementById("confirm-modal-ok"),d=document.getElementById("confirm-modal-cancel");i&&(i.textContent=e),r&&(r.textContent=t),l&&(l.textContent=n,l.className=o?"btn btn-danger":"btn btn-primary"),d&&(d.textContent=s),confirmModalCallback=a,showModal("confirm-modal")})}function closeConfirmModal(e){hideModal("confirm-modal"),confirmModalCallback&&(confirmModalCallback(e),confirmModalCallback=null)}window.showConfirm=showConfirm,window.closeConfirmModal=closeConfirmModal;async function clearChatHistory(e=!1,t=!1){if(!e&&!await showConfirm("Clear Chat History","Clear all chat messages? They may reload from Gateway on next sync.","Clear","Cancel",!0))return;state.chat.messages=[],chatPageNewMessageCount=0,chatPageUserScrolled=!1,t&&localStorage.removeItem(chatStorageKey());const n=document.getElementById("chat-page-messages");n&&(n._renderedCount=0,n._sessionKey=null),renderChat(),renderChatPage()}function getTaskAgent(e){if(e.agent)return e.agent;const t=(e.title||"").toLowerCase(),n=(e.description||"").toLowerCase(),s=["dev","exec","coo","cfo","cmp","sec","smm","family","tax"];for(const o of s)if(t.startsWith(`${o}:`)||t.startsWith(`${o} -`)||t.startsWith(`${o} `))return o;return t.startsWith("solobot-android:")||t.startsWith("android:")||t.includes("dashboard:")||t.includes("android")||t.includes("api ")||t.includes("fix ")||t.includes("deploy")||t.includes("cache")||t.includes("sync")||t.includes("notification")||t.includes("server.js")?"dev":t.includes("marketing")||t.includes("social")||t.includes("content")?"cmp":t.includes("budget")||t.includes("invoice")||t.includes("financial")?"cfo":t.includes("security")||t.includes("audit")?"sec":"main"}function getAgentColor(e){return getComputedStyle(document.documentElement).getPropertyValue(`--agent-${e}`).trim()||"#888"}function getFilteredSortedTasks(e){let t=[...state.tasks[e]||[]];const n=(document.getElementById("task-search")?.value||"").toLowerCase().trim();n&&(t=t.filter(i=>(i.title||"").toLowerCase().includes(n)||(i.description||"").toLowerCase().includes(n)));const s=document.getElementById("task-filter-priority")?.value||"all";if(s!=="all"){const i=parseInt(s);t=t.filter(r=>(r.priority??1)===i)}const o=document.getElementById("task-filter-agent")?.value||"all";switch(o!=="all"&&(t=t.filter(i=>getTaskAgent(i)===o)),document.getElementById("task-sort")?.value||"newest"){case"newest":t.sort((i,r)=>(r.created||0)-(i.created||0));break;case"oldest":t.sort((i,r)=>(i.created||0)-(r.created||0));break;case"priority-high":t.sort((i,r)=>(i.priority??1)-(r.priority??1));break;case"priority-low":t.sort((i,r)=>(r.priority??1)-(i.priority??1));break;case"alpha-az":t.sort((i,r)=>(i.title||"").localeCompare(r.title||""));break;case"alpha-za":t.sort((i,r)=>(r.title||"").localeCompare(i.title||""));break}return t}function applyTaskFilters(){renderTasks(),updateBulkActionsUI()}function populateAgentFilter(){const e=document.getElementById("task-filter-agent");if(!e)return;const t=new Set;["todo","progress","done"].forEach(o=>{(state.tasks[o]||[]).forEach(a=>t.add(getTaskAgent(a)))});const n=e.value;e.innerHTML='<option value="all">All agents</option>';const s=[...t].sort();for(const o of s){const a=getAgentColor(o),i=document.createElement("option");i.value=o,i.textContent=o.toUpperCase(),i.style.color=a,e.appendChild(i)}e.value=n||"all"}function updateTaskStats(){const e=document.getElementById("task-stats");if(!e)return;const t=(state.tasks.todo||[]).length,n=(state.tasks.progress||[]).length,s=(state.tasks.done||[]).length,o=t+n+s,a=o>0?Math.round(s/o*100):0;e.innerHTML=`${o} tasks \u2022 ${a}% done`}function updateBulkActionsUI(){const e=document.getElementById("task-bulk-actions"),t=document.getElementById("task-selected-count");e&&(selectedTasks.size>0?(e.style.display="flex",t&&(t.textContent=`${selectedTasks.size} selected`)):e.style.display="none")}function bulkDelete(){selectedTasks.size!==0&&confirm(`Delete ${selectedTasks.size} task(s)?`)&&(["todo","progress","done"].forEach(e=>{state.tasks[e]=(state.tasks[e]||[]).filter(t=>!selectedTasks.has(t.id))}),selectedTasks.clear(),saveState("Bulk deleted tasks"),renderTasks())}function renderTasks(){populateAgentFilter(),["todo","progress","done"].forEach(e=>{const t=document.getElementById(`${e==="progress"?"progress":e}-tasks`),n=document.getElementById(`${e==="progress"?"progress":e}-count`);if(!t){console.warn("[renderTasks] Missing container for",e);return}const s=getFilteredSortedTasks(e),o=(state.tasks[e]||[]).length;if(s.length===0){const a=o>0?"No tasks match filters":"No tasks";t.innerHTML=`<div style="color: var(--text-muted); font-size: 13px; text-align: center; padding: var(--space-6) var(--space-2);">${a}</div>`,n&&(n.textContent=o);return}t.innerHTML=s.map((a,i)=>{const r=selectedTasks.has(a.id),l=e==="done"?"text-decoration: line-through; color: var(--text-muted);":"",d=getTaskAgent(a),c=getAgentColor(d),u=Math.floor((Date.now()-(a.created||0))/864e5),m=u===0?"today":u===1?"1d ago":`${u}d ago`;return`
            <div class="task-card priority-p${a.priority} ${r?"selected":""} ${a.images?.length?"has-attachments":""}"
                 data-task-id="${a.id}" data-column="${e}"
                 onclick="openTaskDetail('${a.id}', '${e}')">
                <div style="display: flex; align-items: flex-start; gap: var(--space-3);">
                    <span class="drag-handle" draggable="true"
                          ondragstart="handleDragStart(event, '${a.id}', '${e}')"
                          ondragend="handleDragEnd(event)"
                          title="Drag to move">\u283F</span>
                    <input type="checkbox"
                           style="margin-top: 2px; accent-color: var(--brand-red); cursor: pointer;"
                           ${r?"checked":""}
                           onclick="toggleTaskSelection('${a.id}', event)">
                    <div style="flex: 1; min-width: 0;">
                        <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: var(--space-2);">
                            <span class="task-title" style="${l}">${escapeHtml(a.title)}</span>
                            <div style="display: flex; gap: 4px; align-items: center; flex-shrink: 0;">
                                <span style="font-size: 9px; padding: 1px 5px; border-radius: 8px; background: ${c}22; color: ${c}; font-weight: 600; text-transform: uppercase;">${d}</span>
                                <span class="badge ${getPriorityBadgeClass(a.priority)}">P${a.priority}</span>
                            </div>
                        </div>
                        ${a.description?`<div style="font-size: 11px; color: var(--text-muted); margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 100%;">${escapeHtml(a.description.slice(0,80))}${a.description.length>80?"\u2026":""}</div>`:""}
                        <div class="task-meta">
                            ${m} \u2022 ${formatTime(a.created||a.completedAt||a.id?.replace("t",""))}
                            ${a.description?" \u2022 \u{1F4DD}":""}
                            ${a.images?.length?` \u2022 \u{1F4CE}${a.images.length}`:""}
                        </div>
                    </div>
                </div>

                <div class="task-quick-actions">
                    ${e==="todo"?`
                        <button onclick="quickMoveTask('${a.id}', '${e}', 'progress', event)"
                                class="btn btn-ghost" style="width: 28px; height: 28px; padding: 0; border-radius: 50%;"
                                title="Start Working">\u25B6</button>
                    `:""}
                    ${e!=="done"?`
                        <button onclick="quickMoveTask('${a.id}', '${e}', 'done', event)"
                                class="btn btn-primary" style="width: 28px; height: 28px; padding: 0; border-radius: 50%;"
                                title="Mark Done">\u2713</button>
                    `:""}
                    ${e==="done"?`
                        <button onclick="quickMoveTask('${a.id}', '${e}', 'todo', event)"
                                class="btn btn-ghost" style="width: 28px; height: 28px; padding: 0; border-radius: 50%;"
                                title="Reopen">\u21A9</button>
                    `:""}
                </div>
            </div>
        `}).join(""),n&&(n.textContent=s.length===o?o:`${s.length}/${o}`)}),updateTaskStats(),updateBulkActionsUI(),updateDoneColumnCollapse(),typeof updateQuickStats=="function"&&updateQuickStats()}let doneColumnCollapsed=localStorage.getItem("doneColumnCollapsed")!=="false";function updateDoneColumnCollapse(){const e=document.getElementById("done-tasks"),t=document.getElementById("done-collapsed-summary"),n=document.getElementById("done-toggle-btn"),s=document.getElementById("done-collapsed-text");if(!e)return;const o=(state.tasks.done||[]).length;if(s&&(s.textContent=`${o} completed task${o!==1?"s":""}`),o===0){e.classList.remove("done-hidden"),t&&(t.style.display="none"),n&&(n.textContent="Show");return}doneColumnCollapsed?(e.classList.add("done-hidden"),t&&(t.style.display=""),n&&(n.textContent="Show")):(e.classList.remove("done-hidden"),t&&(t.style.display="none"),n&&(n.textContent="Hide"))}function toggleDoneColumn(){doneColumnCollapsed=!doneColumnCollapsed,localStorage.setItem("doneColumnCollapsed",doneColumnCollapsed.toString()),updateDoneColumnCollapse()}function renderNotes(){const e=document.getElementById("notes-list");e.innerHTML=state.notes.map(t=>`
        <div class="note-item" style="${t.seen?"opacity: 0.6;":""}">
            <div style="display: flex; align-items: flex-start; justify-content: space-between;">
                <span class="note-text">${escapeHtml(t.text)}</span>
                ${t.seen?'<span class="badge badge-success">\u2713 Seen</span>':'<span class="badge badge-warning">Pending</span>'}
            </div>
            <div class="note-meta">${formatTime(t.created)}</div>
        </div>
    `).join("")||'<div style="text-align: center; color: var(--text-muted); padding: var(--space-4);">No notes yet</div>'}function renderActivity(){const e=document.getElementById("activity-log");if(!e)return;const t=state.activity.slice().reverse().slice(0,50);if(t.length===0){e.innerHTML='<div style="text-align: center; color: var(--text-muted); padding: var(--space-4);">No activity yet</div>';return}const n=Date.now(),s=new Date().toDateString(),o=new Date(n-864e5).toDateString(),a=n-7*864e5,i={today:[],yesterday:[],thisWeek:[],older:[]},r=[];t.forEach(c=>{const u=new Date(c.time).toDateString();if(/system|heartbeat|audit|auto/i.test(c.action)){r.push(c);return}u===s?i.today.push(c):u===o?i.yesterday.push(c):c.time>a?i.thisWeek.push(c):i.older.push(c)});const l=c=>{const u=formatTime(c.time);let m="\u{1F4CB}",g=escapeHtml(c.action);const f=c.action.toLowerCase();f.includes("completed")||f.includes("done")?m="\u2705":f.includes("started")||f.includes("began")?m="\u25B6\uFE0F":f.includes("created")||f.includes("added")?m="\u2795":f.includes("deleted")||f.includes("removed")?m="\u{1F5D1}\uFE0F":f.includes("updated")||f.includes("edited")?m="\u270F\uFE0F":(f.includes("error")||f.includes("failed"))&&(m="\u274C");const y=c.type==="success"?"success":c.type==="error"?"warning":"";return`
            <div class="activity-item">
                <span style="font-size: 14px; margin-right: 6px;">${m}</span>
                <div style="flex: 1; min-width: 0;">
                    <span class="activity-text ${y}">${g}</span>
                    <span class="activity-time" style="font-size: 10px; color: var(--text-muted); margin-left: 6px;">${u}</span>
                </div>
            </div>
        `};let d="";i.today.length>0&&(d+='<div class="activity-group-header">Today</div>',d+=i.today.map(l).join("")),i.yesterday.length>0&&(d+='<div class="activity-group-header">Yesterday</div>',d+=i.yesterday.map(l).join("")),i.thisWeek.length>0&&(d+='<div class="activity-group-header">This Week</div>',d+=i.thisWeek.map(l).join("")),i.older.length>0&&(d+='<div class="activity-group-header">Older</div>',d+=i.older.map(l).join("")),r.length>0&&(d+=`
            <div class="activity-system-toggle" onclick="toggleSystemActivity()" style="cursor: pointer; padding: var(--space-2); margin-top: var(--space-2); background: var(--surface-2); border-radius: var(--radius-md); text-align: center; font-size: 11px; color: var(--text-muted);">
                <span id="system-activity-toggle-text">Show ${r.length} system entries \u25BC</span>
            </div>
            <div id="system-activity-list" style="display: none;">
                <div class="activity-group-header">System</div>
                ${r.map(l).join("")}
            </div>
        `),e.innerHTML=d}function toggleSystemActivity(){const e=document.getElementById("system-activity-list"),t=document.getElementById("system-activity-toggle-text");if(!e||!t)return;const n=e.style.display==="none";e.style.display=n?"block":"none";const s=(state.activity||[]).filter(o=>/system|heartbeat|audit|auto/i.test(o.action)).length;t.textContent=n?"Hide system entries \u25B2":`Show ${s} system entries \u25BC`}function renderDocs(e=""){const t=document.getElementById("docs-grid");if(!t)return;renderMemoryFiles(e);const n=state.docs.filter(s=>s.name.toLowerCase().includes(e.toLowerCase()));if(n.length>0){t.innerHTML&&n.length>0&&(t.innerHTML+='<div class="docs-separator"><h3 class="category-title">Google Drive Documents</h3></div>');const s=n.map(o=>{const a=getDocIconClass(o.type,o.url),i=getDocIconSymbol(o.type,o.url);return`
            <a href="${o.url}" target="_blank" class="doc-card">
                <div style="display: flex; align-items: center; gap: var(--space-3);">
                    <div class="doc-icon ${a}">${i}</div>
                    <div style="min-width: 0; flex: 1;">
                        <div class="doc-title">${escapeHtml(o.name)}</div>
                        <div class="doc-meta">Updated: ${formatDate(o.updated)}</div>
                    </div>
                </div>
            </a>
        `}).join("");t.innerHTML+=s}t.innerHTML||(t.innerHTML='<div style="color: var(--text-muted); font-size: 13px; grid-column: 1 / -1; text-align: center; padding: var(--space-4);">No documents found</div>')}function getDocIconClass(e,t){return t?.includes("docs.google.com/document")?"gdoc":t?.includes("docs.google.com/spreadsheets")?"gsheet":e==="pdf"||t?.includes(".pdf")?"pdf":"default"}function getDocIconSymbol(e,t){return t?.includes("docs.google.com/document")?"\u{1F4C4}":t?.includes("docs.google.com/spreadsheets")?"\u{1F4CA}":e==="pdf"||t?.includes(".pdf")?"\u{1F4D5}":"\u{1F4C1}"}let statsState={tasksDoneThisWeek:0,messagesToday:0,streak:parseInt(localStorage.getItem("dashboardStreak")||"0"),sessionStartTime:Date.now(),history:{tasks:JSON.parse(localStorage.getItem("stats_history_tasks")||"[]"),messages:JSON.parse(localStorage.getItem("stats_history_messages")||"[]"),focus:JSON.parse(localStorage.getItem("stats_history_focus")||"[]"),activity:JSON.parse(localStorage.getItem("stats_history_activity")||"[]")}};function generateSparkline(e,t=60,n=24,s="neutral"){if(!e||e.length<2)return`<svg width="${t}" height="${n}" class="sparkline"><line x1="0" y1="${n/2}" x2="${t}" y2="${n/2}" stroke="var(--text-muted)" stroke-width="1" stroke-dasharray="2,2"/></svg>`;const o=Math.max(...e,1),a=Math.min(...e,0),i=o-a||1,r=e.map((c,u)=>{const m=u/(e.length-1)*t,g=n-(c-a)/i*n*.8-n*.1;return`${m},${g}`}).join(" "),l=`0,${n} ${r} ${t},${n}`;return`
        <svg width="${t}" height="${n}" class="sparkline ${s==="positive"?"sparkline-positive":s==="negative"?"sparkline-negative":"sparkline-neutral"}" viewBox="0 0 ${t} ${n}">
            <polygon points="${l}" class="sparkline-area" />
            <polyline points="${r}" class="sparkline-path" />
        </svg>
    `}function updateSparklineData(e,t){const n=statsState.history[e];n.push(t),n.length>7&&n.shift(),localStorage.setItem(`stats_history_${e}`,JSON.stringify(n))}function generateProgressRing(e,t,n=50,s=4,o=null){const a=(n-s)/2,i=2*Math.PI*a,r=Math.min(Math.max(e/t,0),1),l=i-r*i,d=o||"var(--brand-red)";return`
        <div class="progress-ring" style="width: ${n}px; height: ${n}px;">
            <svg width="${n}" height="${n}">
                <circle
                    class="progress-ring-bg"
                    cx="${n/2}" cy="${n/2}" r="${a}"
                    fill="none"
                    stroke-width="${s}"
                />
                <circle
                    class="progress-ring-circle"
                    cx="${n/2}" cy="${n/2}" r="${a}"
                    fill="none"
                    stroke="${d}"
                    stroke-width="${s}"
                    stroke-linecap="round"
                    stroke-dasharray="${i}"
                    stroke-dashoffset="${l}"
                />
            </svg>
            <span class="progress-ring-value">${Math.round(r*100)}%</span>
        </div>
    `}function generateMiniHeatmap(e,t=4,n=7){const s=[];for(let o=0;o<t*n;o++){const a=e[o]||0,i=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][o%7];s.push(`<div class="heatmap-cell level-${a}" title="${i}: Level ${a}"></div>`)}return`<div class="mini-heatmap" style="grid-template-columns: repeat(${n}, 1fr);">${s.join("")}</div>`}function generateActivityHeatmap(e){return`<div class="activity-heatmap">${e.map((n,s)=>{const o=`${s}:00`;return`<div class="activity-heatmap-cell ${n>0?"active":""}" style="opacity: ${.2+n/5*.8}" title="${o}: Level ${n}"></div>`}).join("")}</div>`}function generateActivityData(){const e=[];for(let t=0;t<28;t++){const n=Math.random();let s=0;n>.6&&(s=1),n>.75&&(s=2),n>.85&&(s=3),n>.93&&(s=4),n>.98&&(s=5),e.push(s)}return e}function generateHourlyActivityData(){const e=[];for(let t=0;t<24;t++){let n=0;t>=9&&t<=17&&(n=2),t>=13&&t<=15&&(n=3);const s=Math.random();let o=n;s>.7&&(o=Math.min(n+1,5)),s>.9&&(o=Math.min(n+2,5)),s<.3&&n>0&&(o=Math.max(n-1,0)),e.push(o)}return e}function updateQuickStats(){const e=state.tasks?.done?.length||0,t=document.getElementById("stat-tasks-done");t&&(t.textContent=e,updateSparklineData("tasks",e));const n=document.getElementById("stat-focus-sessions");n&&(n.textContent=focusTimer.sessions,updateSparklineData("focus",focusTimer.sessions));const s=new Date().toDateString(),o=(state.chat?.messages||[]).filter(d=>new Date(d.time).toDateString()===s).length,a=document.getElementById("stat-messages");a&&(a.textContent=o,updateSparklineData("messages",o)),updateStreak();const i=document.getElementById("stat-streak");i&&(i.textContent=statsState.streak);const r=document.getElementById("stat-uptime");if(r){const d=Math.floor((Date.now()-statsState.sessionStartTime)/6e4);if(d<60)r.textContent=`${d}m`;else{const c=Math.floor(d/60),u=d%60;r.textContent=`${c}h ${u}m`}}const l=document.getElementById("stats-last-updated");l&&(l.textContent="Updated just now"),renderSparklines(),renderHeatmaps(),renderProgressRings()}function renderSparklines(){const e=document.getElementById("sparkline-tasks");if(e){const s=statsState.history.tasks.length>1?statsState.history.tasks[statsState.history.tasks.length-1]-statsState.history.tasks[statsState.history.tasks.length-2]:0,o=s>0?"positive":s<0?"negative":"neutral";e.innerHTML=generateSparkline(statsState.history.tasks,60,24,o);const a=document.getElementById("trend-tasks");a&&(a.textContent=s>=0?`+${s}`:s,a.className=`stat-change ${s>0?"positive":s<0?"negative":""}`)}const t=document.getElementById("sparkline-messages");t&&(t.innerHTML=generateSparkline(statsState.history.messages,60,24,"neutral"));const n=document.getElementById("sparkline-focus");n&&(n.innerHTML=generateSparkline(statsState.history.focus,60,24,"positive"))}function renderHeatmaps(){const e=document.getElementById("activity-heatmap-container");if(e&&!e.dataset.initialized){const n=generateActivityData();e.innerHTML=generateMiniHeatmap(n,4,7),e.dataset.initialized="true"}const t=document.getElementById("hourly-heatmap-container");if(t&&!t.dataset.initialized){const n=generateHourlyActivityData();t.innerHTML=generateActivityHeatmap(n),t.dataset.initialized="true"}}function renderProgressRings(){const e=document.getElementById("progress-ring-tasks");if(e){const n=(state.tasks?.todo?.length||0)+(state.tasks?.progress?.length||0)+(state.tasks?.done?.length||0),s=state.tasks?.done?.length||0;e.innerHTML=generateProgressRing(s,n||1,36,3,"var(--success)")}const t=document.getElementById("progress-ring-daily");if(t){const n=new Date().toDateString(),s=(state.tasks?.done||[]).filter(o=>(o.completedAt?new Date(o.completedAt).toDateString():null)===n).length;t.innerHTML=generateProgressRing(s,10,36,3,"var(--brand-red)")}}function updateStreak(){const e=localStorage.getItem("lastActiveDate"),t=new Date().toDateString(),n=new Date(Date.now()-864e5).toDateString();e!==t&&(e===n?statsState.streak++:e!==t&&(statsState.streak=1),localStorage.setItem("dashboardStreak",statsState.streak.toString()),localStorage.setItem("lastActiveDate",t))}function initSparklineData(){["tasks","messages","focus","activity"].forEach(t=>{const n=localStorage.getItem(`stats_history_${t}`);if(!n||n==="[]"){const s=[];for(let o=0;o<7;o++)s.push(Math.floor(Math.random()*10)+5);localStorage.setItem(`stats_history_${t}`,JSON.stringify(s)),statsState.history[t]=s}})}initSparklineData(),setInterval(updateQuickStats,6e4),window.QuickStats={update:updateQuickStats,generateSparkline,generateProgressRing,generateMiniHeatmap,generateActivityHeatmap};const Sparklines={generatePath(e,t=60,n=24){if(!e||e.length<2)return"";const s=Math.min(...e),a=Math.max(...e)-s||1;return`M ${e.map((r,l)=>{const d=l/(e.length-1)*t,c=n-(r-s)/a*n;return`${d},${c}`}).join(" L ")}`},generateAreaPath(e,t=60,n=24){if(!e||e.length<2)return"";const s=Math.min(...e),a=Math.max(...e)-s||1;return`M ${e.map((r,l)=>{const d=l/(e.length-1)*t,c=n-(r-s)/a*n;return`${d},${c}`}).join(" L ")} L ${t},${n} L 0,${n} Z`},render(e,t,n="neutral"){const s=document.getElementById(e);if(!s||!t||t.length<2)return;const o=60,a=24,i=n==="positive"?"var(--success)":n==="negative"?"var(--error)":"var(--brand-red)",r=n==="positive"?"var(--success)":n==="negative"?"var(--error)":"var(--brand-red)",l=this.generatePath(t,o,a),d=this.generateAreaPath(t,o,a);s.innerHTML=`
            <svg class="sparkline sparkline-${n}" viewBox="0 0 ${o} ${a}" style="width: 100%; height: 100%;">
                <path class="sparkline-area" d="${d}" fill="${r}" opacity="0.15"></path>
                <path class="sparkline-path" d="${l}" stroke="${i}" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        `},generateSampleData(e=10,t="random"){const n=[];let s=50;for(let o=0;o<e;o++)t==="up"?s+=Math.random()*10-2:t==="down"?s-=Math.random()*10-2:s+=Math.random()*20-10,s=Math.max(0,Math.min(100,s)),n.push(s);return n}},ProgressRings={render(e,t,n="",s=48,o=4){const a=document.getElementById(e);if(!a)return;const i=(s-o)/2,r=2*Math.PI*i,l=r-t/100*r;let d="var(--brand-red)";t>=80?d="var(--success)":t>=50&&(d="var(--warning)"),a.innerHTML=`
            <div class="progress-ring" style="width: ${s}px; height: ${s}px;">
                <svg width="${s}" height="${s}">
                    <circle class="progress-ring-bg" 
                            cx="${s/2}" cy="${s/2}" r="${i}" 
                            fill="none" stroke-width="${o}"></circle>
                    <circle class="progress-ring-circle" 
                            cx="${s/2}" cy="${s/2}" r="${i}" 
                            fill="none" stroke="${d}" stroke-width="${o}"
                            stroke-dasharray="${r}" 
                            stroke-dashoffset="${l}"></circle>
                </svg>
                ${n?`<span class="progress-ring-value">${n}</span>`:""}
            </div>
        `},renderStats(e,t){const n=document.getElementById(e);if(!n||!t)return;const s=t.map(o=>{const l=2*Math.PI*18.5,d=l-o.percent/100*l;let c="var(--brand-red)";return o.percent>=80?c="var(--success)":o.percent>=50&&(c="var(--warning)"),`
                <div class="stat-ring-item" style="text-align: center;">
                    <div class="progress-ring" style="width: 40px; height: 40px; margin: 0 auto;">
                        <svg width="40" height="40">
                            <circle class="progress-ring-bg" 
                                    cx="${40/2}" cy="${40/2}" r="${18.5}" 
                                    fill="none" stroke-width="3"></circle>
                            <circle class="progress-ring-circle" 
                                    cx="${40/2}" cy="${40/2}" r="${18.5}" 
                                    fill="none" stroke="${c}" stroke-width="3"
                                    stroke-dasharray="${l}" 
                                    stroke-dashoffset="${d}"></circle>
                        </svg>
                        <span class="progress-ring-value" style="font-size: 11px;">${o.value}</span>
                    </div>
                    <div class="progress-ring-label">${o.label}</div>
                </div>
            `}).join("");n.innerHTML=`<div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">${s}</div>`}},MiniHeatmap={render(e,t,n="week"){const s=document.getElementById(e);if(!s)return;let o=7,a=1;n==="day"?(o=24,a=1):n==="hour"&&(o=12,a=1);const i=t.map((r,l)=>`<div class="heatmap-cell ${`level-${Math.min(5,Math.max(0,r))}`}" title="Activity level: ${r}"></div>`).join("");s.innerHTML=`
            <div class="mini-heatmap" style="grid-template-columns: repeat(${o}, 1fr);">
                ${i}
            </div>
        `},generateSampleData(e=28){return Array.from({length:e},()=>Math.floor(Math.random()*6))},renderWeekHeatmap(e,t){const n=document.getElementById(e);if(!n)return;const s=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],o=t.map((a,i)=>{const r=s[i%7];return`
                <div style="text-align: center;">
                    <div class="heatmap-cell ${`level-${Math.min(5,Math.max(0,a))}`}" title="${r}: Activity level ${a}"></div>
                    <div style="font-size: 9px; color: var(--text-muted); margin-top: 2px;">${r}</div>
                </div>
            `}).join("");n.innerHTML=`<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;">${o}</div>`}},QuickStatsEnhanced={init(){this.renderSparklines(),this.renderProgressRings(),this.renderActivityHeatmap()},renderSparklines(){const e=Sparklines.generateSampleData(10,"up"),t=Sparklines.generateSampleData(10,"random");document.querySelectorAll(".stat-item").forEach((s,o)=>{if(s.querySelector(".stat-value")&&!s.querySelector(".sparkline")){const i=`sparkline-stat-${o}`,r=document.createElement("div");r.id=r,r.className="sparkline",r.style.cssText="width: 40px; height: 16px; margin-top: 4px;";const l=s.querySelector(".stat-label");l&&l.after(r);const d=o%2===0?"positive":"neutral",c=o%2===0?e:t;Sparklines.render(r,c,d)}})},renderProgressRings(){const e=document.querySelector(".bento-task-board");if(e&&!e.querySelector(".progress-ring")){const t=e.querySelector(".bento-widget-header");if(t){const n=document.createElement("div");n.id="task-completion-ring",n.style.cssText="margin-left: auto;";const s=t.querySelector(".bento-widget-actions");if(s){s.before(n);const o=state.tasks?.todo?.length||0,a=state.tasks?.progress?.length||0,i=state.tasks?.done?.length||0,r=o+a+i,l=r>0?Math.round(i/r*100):0;ProgressRings.render("task-completion-ring",l,`${l}%`,36,3)}}}},renderActivityHeatmap(){const e=document.querySelector(".bento-activity");if(e&&!e.querySelector(".mini-heatmap")){const t=e.querySelector(".bento-widget-content");if(t){const n=document.createElement("div");n.id="activity-heatmap-mini",n.style.cssText="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-light);",n.innerHTML='<div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">Activity Pattern (Last 7 Days)</div>';const s=document.createElement("div");s.id="activity-heatmap-grid",n.appendChild(s),t.appendChild(n);const o=MiniHeatmap.generateSampleData(7);MiniHeatmap.renderWeekHeatmap("activity-heatmap-grid",o)}}},update(){this.renderProgressRings()}},WidgetAnimations={fadeInWidgets(){document.querySelectorAll(".bento-widget").forEach((t,n)=>{t.style.opacity="0",t.style.transform="translateY(10px)",t.style.transition="opacity 0.4s ease, transform 0.4s ease",setTimeout(()=>{t.style.opacity="1",t.style.transform="translateY(0)"},n*50)})},setupHoverEffects(){document.querySelectorAll(".bento-widget").forEach(e=>{e.addEventListener("mouseenter",()=>{e.style.transform="translateY(-3px)"}),e.addEventListener("mouseleave",()=>{e.style.transform="translateY(0)"})})}};document.addEventListener("DOMContentLoaded",()=>{setTimeout(()=>{QuickStatsEnhanced.init(),WidgetAnimations.fadeInWidgets(),WidgetAnimations.setupHoverEffects()},500)}),typeof module<"u"&&module.exports&&(module.exports={Sparklines,ProgressRings,MiniHeatmap,QuickStatsEnhanced,WidgetAnimations});let agentStatusInterval=null;function initAgentStatusPanel(){loadAgentStatuses(),agentStatusInterval&&clearInterval(agentStatusInterval),agentStatusInterval=setInterval(loadAgentStatuses,15e3)}async function loadAgentStatuses(){const e=document.getElementById("agent-status-list");if(e){if(!gateway||!gateway.isConnected()){e.innerHTML=`
            <div class="empty-state">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <div class="empty-state-title">No Agent Data</div>
                <div class="empty-state-desc">Connect to gateway to see agent status</div>
            </div>
        `;return}try{const n=(await gateway._request("sessions.list",{includeGlobal:!0}))?.sessions||[];renderAgentStatuses(n)}catch(t){console.warn("[Agents] Failed to fetch sessions:",t.message),e.innerHTML='<div style="color: var(--text-muted); font-size: 12px; text-align: center;">Failed to load</div>'}}}function renderAgentStatuses(e){const t=document.getElementById("agent-status-list");if(!t)return;const n={},s=["main","exec","coo","cfo","cmp","dev","family","tax","sec","smm"];for(const a of e){const i=a.key?.match(/^agent:([^:]+):/),r=i?window.resolveAgentId?window.resolveAgentId(i[1]):i[1]:"main";n[r]||(n[r]={sessions:[],lastActivity:0,lastPreview:""}),n[r].sessions.push(a);const l=a.updatedAt?new Date(a.updatedAt).getTime():0;l>n[r].lastActivity&&(n[r].lastActivity=l,n[r].lastPreview=a.displayName||a.key||"")}for(const a of s)n[a]||(n[a]={sessions:[],lastActivity:0,lastPreview:""});const o=Object.entries(n).sort((a,i)=>i[1].lastActivity-a[1].lastActivity);t.innerHTML=o.map(([a,i])=>{const r=typeof AGENT_PERSONAS<"u"&&AGENT_PERSONAS[a],l=r?`${r.name} (${r.role})`:a.toUpperCase(),d=i.sessions.length,c=i.lastActivity?timeAgo(i.lastActivity):"No activity",u=i.lastActivity&&Date.now()-i.lastActivity<3e5,m=i.lastActivity&&Date.now()-i.lastActivity<36e5,g=u?"success":m?"warning":"idle",f=u?"Active":m?"Recent":"Idle",y=getComputedStyle(document.documentElement).getPropertyValue(`--agent-${a}`).trim()||"#888";return`
        <div class="agent-status-row" onclick="switchToAgent('${a}')" style="cursor: pointer;">
            <span class="status-dot ${g}"></span>
            <div style="flex: 1; min-width: 0;">
                <div style="display: flex; align-items: center; gap: 6px;">
                    <span style="font-weight: 600; font-size: 13px; color: ${y};">${l}</span>
                    <span style="font-size: 10px; color: var(--text-muted);">${d} session${d!==1?"s":""}</span>
                </div>
                <div style="font-size: 11px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    ${c}${i.lastPreview?" \xB7 "+escapeHtml(i.lastPreview):""}
                </div>
            </div>
            <span style="font-size: 10px; padding: 2px 6px; border-radius: 8px; background: var(--surface-2); color: var(--text-muted);">${f}</span>
        </div>`}).join("")}function timeAgo(e){const t=Date.now()-e;return t<6e4?"just now":t<36e5?Math.floor(t/6e4)+"m ago":t<864e5?Math.floor(t/36e5)+"h ago":Math.floor(t/864e5)+"d ago"}let _switchingAgent=!1;function switchToAgent(e){if(_switchingAgent)return;_switchingAgent=!0,setTimeout(()=>_switchingAgent=!1,500),typeof showPage=="function"&&showPage("chat"),typeof setActiveSidebarAgent=="function"&&setActiveSidebarAgent(e),currentAgentId=e;const n=(typeof getLastAgentSession=="function"?getLastAgentSession(e):null)||`agent:${e}:main`;if(n===(currentSessionName||GATEWAY_CONFIG?.sessionKey)){typeof populateSessionDropdown=="function"&&populateSessionDropdown();return}typeof switchToSession=="function"&&switchToSession(n),typeof fetchSessions=="function"&&setTimeout(()=>fetchSessions(),100)}document.addEventListener("DOMContentLoaded",()=>{setTimeout(initAgentStatusPanel,2e3)});let channelStatusInterval=null;function initChannelStatus(){loadChannelStatuses(),channelStatusInterval&&clearInterval(channelStatusInterval),channelStatusInterval=setInterval(loadChannelStatuses,3e4)}async function loadChannelStatuses(){const e=document.getElementById("channel-status-list");if(e){if(!gateway||!gateway.isConnected()){e.innerHTML=`
            <div class="empty-state">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                <div class="empty-state-title">No Channel Data</div>
                <div class="empty-state-desc">Connect to gateway to view active channels</div>
            </div>
        `;return}try{const t=await gateway._request("channels.status",{});renderChannelStatuses(t?.channels||t||[])}catch{renderChannelStatuses([{name:"WhatsApp",status:"unknown"},{name:"Telegram",status:"unknown"},{name:"Discord",status:"unknown"},{name:"Signal",status:"unknown"},{name:"Webchat",status:"connected"}])}}}function renderChannelStatuses(e){const t=document.getElementById("channel-status-list");if(!t)return;const n={whatsapp:"\u{1F4F1}",telegram:"\u2708\uFE0F",discord:"\u{1F3AE}",signal:"\u{1F512}",webchat:"\u{1F4AC}",email:"\u{1F4E7}",sms:"\u{1F4F2}"};let s=Array.isArray(e)?e:Object.entries(e).map(([o,a])=>({name:o,...typeof a=="object"?a:{status:a}}));s.length===0&&(s=[{name:"WhatsApp",status:"unknown"},{name:"Telegram",status:"unknown"},{name:"Discord",status:"unknown"},{name:"Signal",status:"unknown"},{name:"Webchat",status:"connected"}]),t.innerHTML=s.map(o=>{const a=o.name||o.channel||"Unknown",i=(o.status||o.state||"unknown").toLowerCase(),r=n[a.toLowerCase()]||"\u{1F4E1}",l=i==="connected"||i==="online"||i==="ready"?"success":i==="error"||i==="disconnected"||i==="failed"?"error":"warning",d=o.lastMessageAt?timeAgo(new Date(o.lastMessageAt).getTime()):"";return`
        <div class="channel-status-row">
            <span style="font-size: 16px;">${r}</span>
            <div style="flex: 1; min-width: 0;">
                <span style="font-weight: 500; font-size: 13px;">${escapeHtml(a)}</span>
                ${d?`<span style="font-size: 10px; color: var(--text-muted); margin-left: 6px;">${d}</span>`:""}
            </div>
            <span class="status-dot ${l}"></span>
        </div>`}).join("")}document.addEventListener("DOMContentLoaded",()=>{setTimeout(initChannelStatus,2500)});let costsInterval=null;function initCostTracker(){loadCostData(),costsInterval&&clearInterval(costsInterval),costsInterval=setInterval(loadCostData,6e4)}async function loadCostData(){const e=document.getElementById("cost-tracker-content");if(e){if(!gateway||!gateway.isConnected()){e.innerHTML=`
            <div class="empty-state">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div class="empty-state-title">No Cost Data</div>
                <div class="empty-state-desc">Connect to gateway to view usage & costs</div>
            </div>
        `;return}try{const n=(await gateway._request("sessions.list",{includeGlobal:!0}))?.sessions||[];let s=null;try{s=await gateway._request("status",{})}catch{}renderCostData(n,s)}catch(t){console.warn("[Costs] Failed:",t.message)}}}function renderCostData(e,t){const n=document.getElementById("cost-tracker-content");if(!n)return;const s={};let o=0,a=0,i=0;for(const c of e){const u=c.key?.match(/^agent:([^:]+):/),m=u?window.resolveAgentId?window.resolveAgentId(u[1]):u[1]:"main";s[m]||(s[m]={input:0,output:0,total:0});const g=c.inputTokens||0,f=c.outputTokens||0,y=c.totalTokens||g+f;s[m].input+=g,s[m].output+=f,s[m].total+=y,o+=y,a+=g,i+=f}const r=((a*3+i*15)/1e6).toFixed(2),l=Object.entries(s).sort((c,u)=>u[1].total-c[1].total),d=l.length>0?l[0][1].total:1;n.innerHTML=`
        <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px;">
            <div>
                <span style="font-size: 20px; font-weight: 700; color: var(--text-primary);">${formatTokens(o)}</span>
                <span style="font-size: 11px; color: var(--text-muted);"> tokens</span>
            </div>
            <div style="text-align: right;">
                <span style="font-size: 16px; font-weight: 600; color: var(--success);">~$${r}</span>
                <div style="font-size: 10px; color: var(--text-muted);">est. cost</div>
            </div>
        </div>
        <div style="display: flex; gap: 12px; margin-bottom: 10px; font-size: 11px; color: var(--text-muted);">
            <span>\u2197 In: ${formatTokens(a)}</span>
            <span>\u2199 Out: ${formatTokens(i)}</span>
            <span>\u{1F4CA} ${e.length} sessions</span>
        </div>
        <div style="space-y: 4px;">
            ${l.slice(0,6).map(([c,u])=>{const m=getComputedStyle(document.documentElement).getPropertyValue(`--agent-${c}`).trim()||"#888",g=d>0?u.total/d*100:0,f=typeof getAgentLabel=="function"?getAgentLabel(c):c.toUpperCase();return`
                <div style="margin-bottom: 6px;">
                    <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 2px;">
                        <span style="color: ${m}; font-weight: 600;">${f}</span>
                        <span style="color: var(--text-muted);">${formatTokens(u.total)}</span>
                    </div>
                    <div style="height: 4px; background: var(--surface-2); border-radius: 2px; overflow: hidden;">
                        <div style="height: 100%; width: ${g}%; background: ${m}; border-radius: 2px;"></div>
                    </div>
                </div>`}).join("")}
        </div>
    `}function formatTokens(e){return e>=1e6?(e/1e6).toFixed(1)+"M":e>=1e3?(e/1e3).toFixed(1)+"K":e.toString()}document.addEventListener("DOMContentLoaded",()=>{setTimeout(initCostTracker,3e3)});let analyticsInterval=null;function initAnalytics(){loadAnalyticsData(),analyticsInterval&&clearInterval(analyticsInterval),analyticsInterval=setInterval(loadAnalyticsData,6e4)}async function loadAnalyticsData(){const e=document.getElementById("analytics-content");if(e){if(!gateway||!gateway.isConnected()){e.innerHTML=`
            <div class="empty-state">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                <div class="empty-state-title">No Analytics Data</div>
                <div class="empty-state-desc">Connect to gateway to view session analytics</div>
            </div>
        `;return}try{const n=(await gateway._request("sessions.list",{includeGlobal:!0}))?.sessions||[];renderAnalytics(n)}catch(t){console.warn("[Analytics] Failed:",t.message)}}}function renderAnalytics(e){const t=document.getElementById("analytics-content");if(!t)return;const n={},s={},o=Date.now();for(const l of e){const d=l.key?.match(/^agent:([^:]+):/),c=d?window.resolveAgentId?window.resolveAgentId(d[1]):d[1]:"main",u=l.totalTokens||(l.inputTokens||0)+(l.outputTokens||0);if(n[c]||(n[c]=0),n[c]+=u>0?1:0,l.updatedAt){const m=new Date(l.updatedAt),g=m.toLocaleDateString("en-US",{weekday:"short"}),f=m.getTime();o-f<7*864e5&&(s[g]||(s[g]=0),s[g]++)}}const a=[...e].filter(l=>l.updatedAt).sort((l,d)=>new Date(d.updatedAt).getTime()-new Date(l.updatedAt).getTime()).slice(0,5),i=Math.max(...Object.values(n),1),r=Math.max(...Object.values(s),1);t.innerHTML=`
        <div style="margin-bottom: 12px;">
            <div style="font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 6px;">Sessions by Agent</div>
            ${Object.entries(n).sort((l,d)=>d[1]-l[1]).slice(0,6).map(([l,d])=>{const c=getComputedStyle(document.documentElement).getPropertyValue(`--agent-${l}`).trim()||"#888",u=d/i*100;return`<div style="display: flex; align-items: center; gap: 6px; margin-bottom: 3px;">
                    <span style="width: 40px; font-size: 10px; color: ${c}; font-weight: 600; text-align: right;">${l.toUpperCase()}</span>
                    <div style="flex: 1; height: 6px; background: var(--surface-2); border-radius: 3px; overflow: hidden;">
                        <div style="height: 100%; width: ${u}%; background: ${c}; border-radius: 3px;"></div>
                    </div>
                    <span style="width: 24px; font-size: 10px; color: var(--text-muted);">${d}</span>
                </div>`}).join("")}
        </div>
        <div style="margin-bottom: 12px;">
            <div style="font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 6px;">Activity (7 days)</div>
            <div style="display: flex; align-items: flex-end; gap: 4px; height: 40px;">
                ${Object.entries(s).slice(-7).map(([l,d])=>`<div style="flex: 1; text-align: center;">
                        <div style="height: ${Math.max(4,d/r*36)}px; background: var(--brand-red); border-radius: 2px; margin: 0 auto; width: 80%;"></div>
                        <div style="font-size: 9px; color: var(--text-muted); margin-top: 2px;">${l}</div>
                    </div>`).join("")}
            </div>
        </div>
        <div>
            <div style="font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Most Active</div>
            ${a.map(l=>{const d=l.displayName||l.key?.replace(/^agent:[^:]+:/,"")||"unnamed",c=l.updatedAt?timeAgo(new Date(l.updatedAt).getTime()):"";return`<div style="font-size: 11px; padding: 2px 0; display: flex; justify-content: space-between;">
                    <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(d)}</span>
                    <span style="color: var(--text-muted); flex-shrink: 0; margin-left: 8px;">${c}</span>
                </div>`}).join("")}
        </div>
    `}document.addEventListener("DOMContentLoaded",()=>{setTimeout(initAnalytics,3500)});let focusTimer={running:!1,isBreak:!1,timeLeft:1500,interval:null,sessions:parseInt(localStorage.getItem("focusSessions")||"0"),workDuration:1500,breakDuration:300,sessionStart:null};function toggleFocusTimer(){focusTimer.running?pauseFocusTimer():startFocusTimer()}function startFocusTimer(){focusTimer.running=!0,focusTimer.sessionStart=Date.now(),updateFocusTimerUI(),focusTimer.interval=setInterval(()=>{focusTimer.timeLeft--,updateFocusTimerDisplay(),focusTimer.timeLeft<=0&&completeFocusSession()},1e3),showToast(focusTimer.isBreak?"\u2615 Break started!":"\u{1F3AF} Focus session started!","success",2e3)}function pauseFocusTimer(){focusTimer.running=!1,clearInterval(focusTimer.interval),updateFocusTimerUI(),showToast("\u23F8\uFE0F Timer paused","info",1500)}function resetFocusTimer(){focusTimer.running=!1,focusTimer.isBreak=!1,clearInterval(focusTimer.interval),focusTimer.timeLeft=focusTimer.workDuration,updateFocusTimerUI(),updateFocusTimerDisplay(),showToast("\u{1F504} Timer reset","info",1500)}function completeFocusSession(){if(clearInterval(focusTimer.interval),focusTimer.running=!1,focusTimer.isBreak)showToast("\u2615 Break over! Ready for another focus session?","info",3e3),focusTimer.isBreak=!1,focusTimer.timeLeft=focusTimer.workDuration;else{focusTimer.sessions++,localStorage.setItem("focusSessions",focusTimer.sessions.toString()),localStorage.setItem("focusSessionsDate",new Date().toDateString()),updateQuickStats();try{const e=new Audio("data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2telehn2d7DYv49iHxtfns/hoGwaCEGWz9+1aTIOO4nK2sBxIg0zdsXN0HgsEjFnusbRgjQXKVmrxNKTPSkfSJ28zZpDKhhAd6/J0p9JLRlAd6/J0p9JLRlAd6/K0p9JLRlAd6/K0p9JLRk/dq/K0p9JLRk/dq/K0aBKLRk/dq/K0aBKLRk=");e.volume=.3,e.play().catch(()=>{})}catch{}showToast(`\u{1F389} Focus session complete! (${focusTimer.sessions} today)`,"success",3e3),focusTimer.isBreak=!0,focusTimer.timeLeft=focusTimer.breakDuration}updateFocusTimerUI(),updateFocusTimerDisplay()}function updateFocusTimerUI(){const e=document.getElementById("focus-timer"),t=document.getElementById("focus-play-icon"),n=document.getElementById("focus-pause-icon"),s=document.getElementById("focus-sessions");e&&(e.classList.remove("active","break"),focusTimer.running&&e.classList.add(focusTimer.isBreak?"break":"active"),t&&n&&(t.style.display=focusTimer.running?"none":"block",n.style.display=focusTimer.running?"block":"none"),s&&(s.textContent=`${focusTimer.sessions} \u{1F3AF}`))}function updateFocusTimerDisplay(){const e=document.getElementById("focus-timer-display");if(!e)return;const t=Math.floor(focusTimer.timeLeft/60),n=focusTimer.timeLeft%60;e.textContent=`${t.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`}function checkFocusSessionsReset(){const e=localStorage.getItem("focusSessionsDate"),t=new Date().toDateString();e!==t&&(focusTimer.sessions=0,localStorage.setItem("focusSessions","0"),localStorage.setItem("focusSessionsDate",t))}function showShortcutsModal(){showModal("shortcuts-modal")}window.toggleFocusTimer=toggleFocusTimer,window.resetFocusTimer=resetFocusTimer,window.showShortcutsModal=showShortcutsModal,document.addEventListener("DOMContentLoaded",()=>{checkFocusSessionsReset(),updateFocusTimerUI(),updateFocusTimerDisplay(),updateQuickStats()});let commandPaletteOpen=!1,commandPaletteSelectedIndex=0;const commands=[{id:"chat",icon:"\u{1F4AC}",title:"Go to Chat",desc:"Open chat page",shortcut:"C",action:()=>showPage("chat")},{id:"system",icon:"\u{1F527}",title:"System Messages",desc:"View system/debug messages",shortcut:"S",action:()=>showPage("system")},{id:"health",icon:"\u{1F3E5}",title:"Model Health",desc:"Check model status",shortcut:"H",action:()=>showPage("health")},{id:"memory",icon:"\u{1F9E0}",title:"Memory Lane",desc:"Browse memory files",shortcut:"M",action:()=>showPage("memory")},{id:"settings",icon:"\u2699\uFE0F",title:"Settings",desc:"Open settings modal",shortcut:",",action:()=>openSettingsModal()},{id:"theme",icon:"\u{1F3A8}",title:"Themes",desc:"Open theme picker",shortcut:"T",action:()=>toggleTheme()},{id:"new-session",icon:"\u2795",title:"New Session",desc:"Create a new chat session",shortcut:"N",action:()=>createNewSession()},{id:"refresh",icon:"\u{1F504}",title:"Refresh Sessions",desc:"Reload session list",shortcut:"R",action:()=>fetchSessions()},{id:"focus-chat",icon:"\u2328\uFE0F",title:"Focus Chat Input",desc:"Jump to chat input",shortcut:"/",action:()=>focusChatInput()}];function initCommandPalette(){if(document.getElementById("command-palette"))return;const e=document.createElement("div");e.id="command-palette-backdrop",e.className="command-palette-backdrop",e.onclick=closeCommandPalette;const t=document.createElement("div");t.id="command-palette",t.className="command-palette",t.innerHTML=`
        <input type="text" class="command-palette-input" placeholder="Type a command... (\u2191\u2193 to navigate, Enter to select)" id="command-palette-input">
        <div class="command-palette-results" id="command-palette-results"></div>
    `,document.body.appendChild(e),document.body.appendChild(t);const n=document.getElementById("command-palette-input");n.addEventListener("input",s=>filterCommands(s.target.value)),n.addEventListener("keydown",handlePaletteKeydown),renderCommands(commands)}function renderCommands(e){const t=document.getElementById("command-palette-results");t&&(t.innerHTML=e.map((n,s)=>`
        <div class="command-palette-item${s===commandPaletteSelectedIndex?" selected":""}" 
             data-index="${s}" 
             onclick="executeCommand('${n.id}')">
            <span class="command-palette-item-icon">${n.icon}</span>
            <div class="command-palette-item-text">
                <div class="command-palette-item-title">${n.title}</div>
                <div class="command-palette-item-desc">${n.desc}</div>
            </div>
            ${n.shortcut?`<span class="command-palette-shortcut">${n.shortcut}</span>`:""}
        </div>
    `).join(""))}function filterCommands(e){const t=e.toLowerCase().trim();let n=commands;t&&(n=commands.filter(s=>s.title.toLowerCase().includes(t)||s.desc.toLowerCase().includes(t)||s.id.toLowerCase().includes(t))),commandPaletteSelectedIndex=0,renderCommands(n)}function handlePaletteKeydown(e){const t=document.querySelectorAll(".command-palette-item"),n=t.length-1;switch(e.key){case"ArrowDown":e.preventDefault(),commandPaletteSelectedIndex=Math.min(commandPaletteSelectedIndex+1,n),updatePaletteSelection();break;case"ArrowUp":e.preventDefault(),commandPaletteSelectedIndex=Math.max(commandPaletteSelectedIndex-1,0),updatePaletteSelection();break;case"Enter":e.preventDefault();const s=t[commandPaletteSelectedIndex];if(s){const o=parseInt(s.dataset.index),a=getFilteredCommands();a[o]&&executeCommand(a[o].id)}break;case"Escape":closeCommandPalette();break}}function getFilteredCommands(){const t=(document.getElementById("command-palette-input")?.value||"").toLowerCase().trim();return t?commands.filter(n=>n.title.toLowerCase().includes(t)||n.desc.toLowerCase().includes(t)||n.id.toLowerCase().includes(t)):commands}function updatePaletteSelection(){document.querySelectorAll(".command-palette-item").forEach((t,n)=>{t.classList.toggle("selected",n===commandPaletteSelectedIndex),n===commandPaletteSelectedIndex&&t.scrollIntoView({block:"nearest"})})}window.executeCommand=function(e){const t=commands.find(n=>n.id===e);t&&(closeCommandPalette(),t.action())};function openCommandPalette(){initCommandPalette(),commandPaletteOpen=!0,commandPaletteSelectedIndex=0;const e=document.getElementById("command-palette-backdrop"),t=document.getElementById("command-palette"),n=document.getElementById("command-palette-input");e&&e.classList.add("visible"),t&&t.classList.add("visible"),n&&(n.value="",n.focus()),renderCommands(commands)}function closeCommandPalette(){commandPaletteOpen=!1;const e=document.getElementById("command-palette-backdrop"),t=document.getElementById("command-palette");e&&e.classList.remove("visible"),t&&t.classList.remove("visible")}function focusChatInput(){showPage("chat"),setTimeout(()=>{const e=document.getElementById("chat-page-input");e&&e.focus()},100)}function createNewSession(){const t=`session-${new Date().toISOString().slice(0,16).replace("T","-").replace(":","")}`;typeof switchToSession=="function"?(switchToSession(t),showToast(`Created new session: ${t}`,"success")):showToast("Session creation not available","warning")}document.addEventListener("keydown",e=>{const t=e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"||e.target.isContentEditable;if((e.metaKey||e.ctrlKey)&&e.key==="k"){e.preventDefault(),commandPaletteOpen?closeCommandPalette():openCommandPalette();return}if(e.key==="Escape"){if(commandPaletteOpen){closeCommandPalette();return}const n=document.querySelector(".modal-overlay.visible");if(n){n.classList.remove("visible");return}}if(!t){switch(e.key.toLowerCase()){case"c":showPage("chat");break;case"s":e.shiftKey?syncFromVPS():showPage("system");break;case"h":showPage("health");break;case"m":showPage("memory");break;case"d":showPage("dashboard");break;case"p":showPage("products");break;case"t":toggleTheme();break;case"f":e.shiftKey?resetFocusTimer():toggleFocusTimer();break;case"n":e.ctrlKey||e.metaKey?(e.preventDefault(),createNewSession()):openAddTask("todo");break;case"/":e.preventDefault(),focusChatInput();break;case"?":e.preventDefault(),showModal("shortcuts-modal");break;case",":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),openSettingsModal());break}if(e.key>="1"&&e.key<="9"&&!e.ctrlKey&&!e.metaKey&&!e.altKey){const n=parseInt(e.key)-1,s=filterSessionsForAgent(availableSessions,currentAgentId);s[n]&&(switchToSession(s[n].key),showToast(`Switched to session ${e.key}`,"success",1500))}}}),document.addEventListener("DOMContentLoaded",()=>{initCommandPalette()});let currentMemoryFile=null;window.viewMemoryFile=async function(e){const t=document.getElementById("memory-file-title"),n=document.getElementById("memory-file-content"),s=document.getElementById("memory-save-btn");if(!(!t||!n)){t.textContent=e,n.value="Loading...",n.disabled=!0,s&&(s.disabled=!0),currentMemoryFile=e,showModal("memory-file-modal");try{const a=await(await fetch(`/api/memory/${encodeURIComponent(e)}`)).json();if(a.error){n.value=`Error: ${a.error}`;return}n.value=a.content||"",n.disabled=!1,s&&(s.disabled=!1),a.botUpdated&&!a.acknowledged?t.innerHTML=`
                ${escapeHtml(a.name)}
                <span class="badge badge-warning" style="margin-left: 8px;">\u{1F916} Updated by SoLoBot</span>
                <button onclick="this.style.color='var(--text-muted)'; this.textContent='\u2713 Read'; this.disabled=true; window.acknowledgeUpdate && window.acknowledgeUpdate('${escapeHtml(e)}')" 
                        class="btn btn-ghost" style="margin-left: 8px; font-size: 12px; color: var(--error);">
                    \u2713 Mark as Read
                </button>
            `:t.textContent=a.name,typeof window.loadVersionHistory=="function"&&window.loadVersionHistory(e)}catch(o){console.error("Error loading memory file:",o),n.value=`Error loading file: ${o.message}`}}},window.saveMemoryFile=async function(){if(!currentMemoryFile)return;const e=document.getElementById("memory-file-content"),t=document.getElementById("memory-save-btn");if(!e)return;const n=e.value;t&&(t.disabled=!0,t.textContent="Saving...");try{const o=await(await fetch(`/api/memory/${encodeURIComponent(currentMemoryFile)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:n})})).json();if(o.ok)t&&(t.textContent="\u2713 Saved!",setTimeout(()=>{t.textContent="Save",t.disabled=!1},1500)),typeof renderMemoryFilesForPage=="function"&&renderMemoryFilesForPage("");else throw new Error(o.error||"Save failed")}catch(s){console.error("Error saving memory file:",s),showToast(`Failed to save: ${s.message}`,"error"),t&&(t.textContent="Save",t.disabled=!1)}},window.closeMemoryModal=function(){currentMemoryFile=null,hideModal("memory-file-modal")};let memoryTree=[],memorySearchResults=[];function initMemoryBrowser(){loadMemoryTree()}async function loadMemoryTree(){const e=document.getElementById("memory-tree");if(e){if(e.innerHTML='<div style="color: var(--text-muted); font-size: 12px; padding: 8px;">Loading...</div>',gateway&&gateway.isConnected())try{const t=await gateway._request("memory.list",{recursive:!0});memoryTree=t?.files||t||[],renderMemoryTree(memoryTree);return}catch(t){console.warn("[Memory] Gateway memory.list not available:",t.message)}try{const t=typeof fetchMemoryFiles=="function"?await fetchMemoryFiles():[];memoryTree=t,renderMemoryTree(t)}catch{e.innerHTML='<div style="color: var(--text-muted); font-size: 12px; padding: 8px;">Could not load memory files</div>'}}}function renderMemoryTree(e){const t=document.getElementById("memory-tree");if(!t)return;if(!e||e.length===0){t.innerHTML='<div style="color: var(--text-muted); font-size: 12px; padding: 8px;">No files found</div>';return}const n={};for(const s of e){const o=s.path||s.name||"",a=o.split("/").filter(Boolean);let i=n;for(let r=0;r<a.length;r++){const l=a[r];r===a.length-1?(i._files||(i._files=[]),i._files.push({...s,fileName:l})):(i[l]||(i[l]={}),i=i[l])}a.length<=1&&(n._files||(n._files=[]),n._files.find(r=>r.fileName===(a[0]||o))||n._files.push({...s,fileName:a[0]||o}))}t.innerHTML=renderTreeNode(n,"")}function renderTreeNode(e,t){let n="";const s=Object.keys(e).filter(a=>a!=="_files").sort();for(const a of s){const i=t?`${t}/${a}`:a,r=countFiles(e[a]);n+=`
        <div class="memory-tree-dir" onclick="toggleTreeDir(this)">
            <span class="tree-chevron">\u25B6</span>
            <span style="font-size: 13px;">\u{1F4C1} ${escapeHtml(a)}</span>
            <span style="font-size: 10px; color: var(--text-muted); margin-left: 4px;">(${r})</span>
        </div>
        <div class="memory-tree-children hidden">
            ${renderTreeNode(e[a],i)}
        </div>`}const o=e._files||[];for(const a of o.sort((i,r)=>(i.fileName||"").localeCompare(r.fileName||""))){const i=a.path||a.name||a.fileName;n+=`
        <div class="memory-tree-file" onclick="previewMemoryFile('${escapeHtml(i)}')">
            <span style="font-size: 12px;">\u{1F4C4}</span>
            <span style="font-size: 12px;">${escapeHtml(a.fileName||i)}</span>
        </div>`}return n}function countFiles(e){let t=(e._files||[]).length;for(const n of Object.keys(e).filter(s=>s!=="_files"))t+=countFiles(e[n]);return t}window.toggleTreeDir=function(e){const t=e.nextElementSibling;if(!t)return;const n=e.querySelector(".tree-chevron");t.classList.contains("hidden")?(t.classList.remove("hidden"),n&&(n.textContent="\u25BC")):(t.classList.add("hidden"),n&&(n.textContent="\u25B6"))},window.previewMemoryFile=async function(e){const t=document.getElementById("memory-file-preview");if(!t){typeof viewMemoryFile=="function"&&viewMemoryFile(e);return}t.innerHTML='<div style="color: var(--text-muted); padding: 12px;">Loading...</div>';try{let n="";if(gateway&&gateway.isConnected())try{const s=await gateway._request("memory.read",{path:e});n=s?.content||s||""}catch{const o=await fetch(`/api/memory/file?path=${encodeURIComponent(e)}`);n=o.ok?await o.text():"Could not load file"}else{const s=await fetch(`/api/memory/file?path=${encodeURIComponent(e)}`);n=s.ok?await s.text():"Could not load file"}t.innerHTML=`
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-bottom: 1px solid var(--border-default);">
                <span style="font-weight: 600; font-size: 13px;">\u{1F4C4} ${escapeHtml(e)}</span>
                <div style="display: flex; gap: 4px;">
                    <button onclick="editMemoryFile('${escapeHtml(e)}')" class="btn btn-ghost" style="font-size: 11px; padding: 2px 8px;">Edit</button>
                </div>
            </div>
            <pre style="padding: 12px; margin: 0; font-size: 12px; white-space: pre-wrap; word-break: break-word; overflow-y: auto; max-height: 500px; color: var(--text-primary);">${escapeHtml(typeof n=="string"?n:JSON.stringify(n,null,2))}</pre>
        `}catch(n){t.innerHTML=`<div style="color: var(--error); padding: 12px;">Error: ${n.message}</div>`}},window.editMemoryFile=function(e){typeof viewMemoryFile=="function"&&viewMemoryFile(e)},window.searchMemoryFiles=async function(){const e=document.getElementById("memory-browser-search")?.value?.trim();if(!e){renderMemoryTree(memoryTree);return}const t=e.toLowerCase(),n=memoryTree.filter(s=>{const o=(s.name||s.path||"").toLowerCase(),a=(s.description||"").toLowerCase();return o.includes(t)||a.includes(t)});renderMemoryTree(n)},document.addEventListener("DOMContentLoaded",()=>{setTimeout(initMemoryBrowser,1e3)});function isSystemMessage(e,t){if(DISABLE_SYSTEM_FILTER||!e)return!1;const n=e.trim(),s=n.toLowerCase();if(t==="system"||n.startsWith("{")&&n.includes('"')||n.startsWith("Successfully replaced text in")||n.startsWith("Successfully wrote")||n==="(no output)"||n.startsWith("[main ")&&n.includes("file changed")||n.startsWith("To https://github.com")||/^\[main [a-f0-9]+\]/.test(n)||n.startsWith("Exported ")&&n.includes(" activities")||n.startsWith("Posted ")&&n.includes(" activities")||/^ghp_[A-Za-z0-9]+$/.test(n)||/^sk_[A-Za-z0-9]+$/.test(n)||n.startsWith("# ")&&n.length>500||/^\d+:\s*(if|const|let|var|function|class|return|import|export)\s/.test(n)||/^\d+[-:].*\.(js|ts|py|md|json|html|css)/.test(n))return!0;const o=/^\d+:/,a=n.split(`
`);if(a.length>2&&a.filter(i=>o.test(i.trim())).length>a.length/2||n.includes("state.chat.messages")||n.includes("GATEWAY_CONFIG")||n.includes("maxMessages:")&&/\d+:/.test(n)||n==="HEARTBEAT_OK"||n==="NO_REPLY"||n==="NO"||n==="REPLY_SKIP"||n==="ANNOUNCE_SKIP"||n.startsWith("Agent-to-agent announce")||n==="[read-sync]"||n==="[[read_ack]]"||n.startsWith("[[read_ack]]")||n===`[read-sync]

[[read_ack]]`||/^\[read-sync\]\s*\n*\s*\[\[read_ack\]\]$/s.test(n)||n.startsWith("System: [")||n.startsWith("System:")||/^System:\s*\[/i.test(n)||n.includes("] HEARTBEAT:")||n.includes("] Cron:")||n.includes("] EMAIL CHECK:")||n.startsWith("Read HEARTBEAT.md if it exists"))return!0;if(t==="solobot"&&n.length<200){const i=["following heartbeat routine","following the heartbeat routine","checking current status via heartbeat"];for(const r of i)if(s.startsWith(r))return!0}return!1}window.changeProvider=function(){const e=document.getElementById("provider-select");if(!e)return;const t=e.value,n=document.getElementById("provider-name");n&&(n.textContent=t),updateModelDropdown(t)},window.updateProviderDisplay=function(){const e=document.getElementById("provider-select");if(!e)return;const t=e.value,n=document.getElementById("provider-name");n&&(n.textContent=t),updateModelDropdown(t)};async function populateProviderDropdown(){const e=[document.getElementById("provider-select"),document.getElementById("setting-provider")].filter(Boolean);if(e.length===0)return console.warn("[Dashboard] No provider-select elements found"),[];try{const t=await fetch("/api/models/list");if(!t.ok)throw new Error(`API returned ${t.status}`);const n=await t.json(),s=Object.keys(n);for(const o of e)o.innerHTML="",s.forEach(a=>{const i=document.createElement("option");i.value=a,i.textContent=a.split("-").map(r=>r.charAt(0).toUpperCase()+r.slice(1)).join(" "),a===currentProvider&&(i.selected=!0),o.appendChild(i)});return s}catch(t){return console.error("[Dashboard] Failed to fetch providers:",t),[]}}window.onSettingsProviderChange=async function(){const e=document.getElementById("setting-provider"),t=document.getElementById("setting-model");if(!e||!t)return;const n=e.value,s=await getModelsForProvider(n);t.innerHTML="",s.forEach(o=>{const a=document.createElement("option");a.value=o.value,a.textContent=o.name,o.selected&&(a.selected=!0),t.appendChild(a)})},window.refreshModels=async function(){showToast("Refreshing models from CLI...","info");try{const t=await(await fetch("/api/models/refresh",{method:"POST"})).json();if(t.ok){showToast(`${t.message}`,"success"),await populateProviderDropdown();const s=document.getElementById("provider-select")?.value||currentProvider||"anthropic";await updateModelDropdown(s);try{const a=await(await fetch("/api/models/current")).json();a?.modelId&&a?.provider&&syncModelDisplay(a.modelId,a.provider)}catch(o){console.warn("[Dashboard] Failed to refresh current model info:",o.message)}}else showToast(t.message||"Failed to refresh models","warning")}catch(e){console.error("[Dashboard] Failed to refresh models:",e),showToast("Failed to refresh models: "+e.message,"error")}},window.changeSessionModel=async function(){const t=document.getElementById("model-select")?.value;if(!t){showToast("Please select a model","warning");return}if(t==="global/default")console.log("[Dashboard] User selected Global Default - will revert to system default");else if(!t.includes("/")){showToast("Invalid model format. Please select a valid model.","warning");return}if(!gateway||!gateway.isConnected()){showToast("Not connected to gateway","warning");return}window._lastManualModelChange=Date.now();try{let n=window.currentAgentId||"main";if(typeof window._activePage=="function"&&window._activePage()==="agents"&&window._memoryCards&&window._memoryCards.getCurrentDrilledAgent){const o=window._memoryCards.getCurrentDrilledAgent();o&&(n=o.id)}const s=n;if(console.log(`[Dashboard] Applying model change for agent: ${s}, model: ${t}`),window._configModelLocks&&(window._configModelLocks[window.currentSessionName]=t,console.log(`[Dashboard] Updated lock for ${window.currentSessionName} to ${t}`)),gateway&&gateway.isConnected()&&gateway.request("sessions.patch",{key:window.currentSessionName,model:t}),t==="global/default"){await fetch("/api/models/set-agent",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({agentId:s,modelId:"global/default"})});try{await gateway.patchSession(window.currentSessionName,{model:null})}catch{}const a=await(await fetch("/api/models/current")).json();if(a?.modelId){currentModel=a.modelId;const i=a.provider||window.getProviderFromModelId(currentModel)||currentModel.split("/")[0];currentProvider=i,syncModelDisplay(currentModel,currentProvider),showToast("Reverted to Global Default","success")}}else{const o=currentAgentId||"main",a=await fetch("/api/models/set-agent",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({agentId:o,modelId:t})}),i=await a.json();if(!a.ok)throw new Error(i.error||"Failed to set agent model");try{await gateway.patchSession(window.currentSessionName,{model:t})}catch(u){console.warn("[Dashboard] sessions.patch model failed (may need gateway restart):",u.message)}currentModel=t;const r=window.getProviderFromModelId(t)||t.split("/")[0];currentProvider=r,localStorage.setItem("selected_model",t),localStorage.setItem("selected_provider",r),window._configModelLocks&&(window._configModelLocks[window.currentSessionName]=t);const l=document.getElementById("current-model-display");l&&(l.textContent=t);const d=document.getElementById("current-provider-display");d&&(d.textContent=r);const c=document.getElementById("provider-select");if(c){if(!Array.from(c.options).find(m=>m.value===r)){const m=document.createElement("option");m.value=r,m.textContent=r.split("-").map(g=>g.charAt(0).toUpperCase()+g.slice(1)).join(" "),c.appendChild(m)}c.value=r}showToast(`Model set to ${t.split("/").pop()}`,"success"),document.dispatchEvent(new CustomEvent("modelChanged",{detail:{agentId:o,modelId:t,source:"header-dropdown"}}))}}catch(n){console.error("[Dashboard] Failed to change model:",n),showToast(`Failed: ${n.message}`,"error")}},window.changeGlobalModel=async function(){const e=document.getElementById("setting-model"),t=document.getElementById("setting-provider"),n=e?.value,s=t?.value;if(!n){showToast("Please select a model","warning");return}if(!n.includes("/")){showToast("Invalid model format. Please select a valid model.","warning");return}if(n.includes("ERROR")){showToast("Cannot change model - configuration error","error");return}if(!s){showToast("Please select a provider","warning");return}try{console.log(`[Dashboard] Changing global default model to: ${n}`);const o=await fetch("/api/models/set",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({modelId:n})}),a=await o.json();if(o.ok){currentModel=n;const i=window.getProviderFromModelId(n)||currentProvider;currentProvider=i,localStorage.setItem("selected_provider",i),localStorage.setItem("selected_model",n);const r=document.getElementById("current-model-display"),l=document.getElementById("current-provider-display");r&&(r.textContent=n),l&&(l.textContent=i),selectModelInDropdowns(n),showToast(`Global default \u2192 ${n.split("/").pop()}. Gateway restarting...`,"success")}else showToast(`Failed: ${a.error||"Unknown error"}`,"error")}catch(o){console.error("[Dashboard] Error changing global model:",o),showToast(`Failed: ${o.message}`,"error")}},window.changeModel=window.changeSessionModel,window.loadAgentModel=async function(e){if(e)try{const n=await(await fetch(`/api/models/agent/${e}`)).json();if(!n?.modelId||n.modelId==="global/default"){console.log(`[Dashboard] Agent ${e} has no model override \u2014 using global default`);return}console.log(`[Dashboard] Loaded model for ${e}: ${n.modelId}`),currentModel=n.modelId,currentProvider=n.provider||window.getProviderFromModelId(n.modelId)||currentProvider,localStorage.setItem("selected_model",currentModel),localStorage.setItem("selected_provider",currentProvider);const s=window.currentSessionName;s&&(window._configModelLocks=window._configModelLocks||{},window._configModelLocks[s]=currentModel),syncModelDisplay(currentModel,currentProvider);const o=document.getElementById("provider-select");o&&(o.value=currentProvider,await updateHeaderModelDropdown(currentProvider));const a=document.getElementById("model-select");a&&(a.value=currentModel)}catch(t){console.warn(`[Dashboard] Failed to load model for ${e}:`,t.message)}},document.addEventListener("modelChanged",async e=>{const{agentId:t,modelId:n,source:s}=e.detail;if(s==="agents-dashboard"&&(console.log(`[Dashboard] Model changed in agents dashboard for ${t} to ${n}, forcing header update`),window.currentAgentId=t,await window.loadAgentModel(t)),(s==="header-dropdown"||s==="settings-modal")&&typeof window._activePage=="function"&&window._activePage()==="agents"&&window._memoryCards&&typeof window._memoryCards.getCurrentDrilledAgent=="function"){const o=window._memoryCards.getCurrentDrilledAgent();o&&(o.id===t||s==="settings-modal"||t==="main")&&(console.log(`[Dashboard] Model changed in header for ${t}, reloading agents dashboard config`),setTimeout(()=>window._memoryCards.loadAgentModelConfig(o.id),100))}});async function updateHeaderModelDropdown(e){const t=await getModelsForProvider(e),n=document.getElementById("model-select");if(!n)return;n.innerHTML="";const s=document.createElement("option");s.value="global/default",s.textContent="Global Default \u{1F310}",s.style.fontWeight="bold",n.appendChild(s);const o=document.createElement("option");o.disabled=!0,o.textContent="\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500",n.appendChild(o),t.forEach(a=>{const i=document.createElement("option");i.value=a.value,i.textContent=a.name,a.selected&&(i.selected=!0),n.appendChild(i)})}async function updateSettingsModelDropdown(e){const t=await getModelsForProvider(e),n=document.getElementById("setting-model");n&&(n.innerHTML="",t.forEach(s=>{const o=document.createElement("option");o.value=s.value,o.textContent=s.name,s.selected&&(o.selected=!0),n.appendChild(o)}))}async function updateModelDropdown(e){await Promise.all([updateHeaderModelDropdown(e),updateSettingsModelDropdown(e)])}async function getModelsForProvider(e){if(window._gatewayModels&&window._gatewayModels[e])return window._gatewayModels[e].map(n=>({value:n.id,name:n.name,selected:n.id===currentModel}));try{const t=await fetch("/api/models/list");if(!t.ok)throw new Error(`API returned ${t.status}`);return((await t.json())[e]||[]).map(a=>({value:a.id,name:a.name,selected:a.id===currentModel}))}catch(t){return console.error("[Dashboard] Failed to get models from API:",t),[]}}async function fetchModelsFromGateway(){if(!(!gateway||!gateway.isConnected()))try{const e=await gateway.getConfig();let t=e;typeof e=="string"&&(t=JSON.parse(e)),t?.raw&&(t=JSON.parse(t.raw));const n=t?.agents?.defaults?.model;if(!n)return;const s=n.primary,o=n.fallbacks||[],a=n.picker||[],i=Object.keys(t?.agents?.defaults?.models||{}),r=[...new Set([...s?[s]:[],...a,...o,...i])];if(r.length===0)return;const l={};for(const u of r){const m=window.getProviderFromModelId(u)||"unknown",g=u.indexOf("/"),f=g!==-1?u.substring(g+1):u;l[m]||(l[m]=[]);const y=u===s,p=f+(y?" \u2B50":"");l[m].some(v=>v.id===u)||l[m].push({id:u,name:p,tier:y?"default":"fallback"})}const d=document.getElementById("provider-select");if(d){const u=Object.keys(l);d.innerHTML="",u.forEach(m=>{const g=document.createElement("option");g.value=m,g.textContent=m.split("-").map(f=>f.charAt(0).toUpperCase()+f.slice(1)).join(" "),m===currentProvider&&(g.selected=!0),d.appendChild(g)})}window._gatewayModels=l;const c=d?.value||currentProvider;c&&(await updateModelDropdown(c),currentModel&&selectModelInDropdowns(currentModel)),console.log(`[Dashboard] Gateway models: ${r.length} models from ${Object.keys(l).length} providers`);try{fetch("/api/models/sync",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)})}catch{}}catch(e){console.warn("[Dashboard] Failed to fetch models from gateway:",e.message)}}function getConfiguredModels(){try{const e=require("child_process").execSync,t=e("moltbot models list 2>/dev/null | tail -n +4",{encoding:"utf8"}),n=[],s=t.split(`
`).filter(o=>o.trim());for(const o of s){const a=o.trim().split(/\s+/);if(a.length>=2){const i=a[0],r=a[a.length-1]||"";n.push({value:i,name:i.split("/").pop()||i,selected:r.includes("default")||r.includes("configured")})}}return n}catch{return[]}}window.currentProvider=window.currentProvider||null,window.currentModel=window.currentModel||null;function resolveFullModelId(e){if(!e)return e;if(e.includes("moonshotai/")||e.includes("minimax/")||e.includes("deepseek/"))return e.startsWith("openrouter/")?e:`openrouter/${e}`;if(e.includes("/"))return e;const t={claude:"anthropic",gpt:"openai-codex",o1:"openai",o3:"openai",gemini:"google",kimi:"moonshot"};for(const[n,s]of Object.entries(t))if(e.startsWith(n))return`${s}/${e}`;return e}window.getProviderFromModelId=function(e){if(!e||typeof e!="string")return"";if(e.startsWith("openrouter/"))return"openrouter";const t=e.indexOf("/");return t!==-1?e.substring(0,t):""};function syncModelDisplay(e,t){if(!e)return;const n=Date.now();if(window._lastManualModelChange&&n-window._lastManualModelChange<5e3){console.log("[Dashboard] Skipping model sync due to recent manual change");return}const s=window.currentSessionName||"";if(window._configModelLocks&&window._configModelLocks[s]){const a=window._configModelLocks[s];if(e!==a){console.log(`[Dashboard] IGNORING gateway model override (${e}) \u2014 Session is locked to openclaw.json value: ${a}`);return}}if(e=resolveFullModelId(e),e===currentModel&&t===currentProvider)return;console.log(`[Dashboard] Model sync: ${currentModel} \u2192 ${e} (provider: ${t||currentProvider})`),currentModel=e,t||(t=window.getProviderFromModelId(e)),t&&(currentProvider=t),localStorage.setItem("selected_model",e),t&&localStorage.setItem("selected_provider",t);const o=document.getElementById("current-model-display");if(o&&(o.textContent=e),t){const a=document.getElementById("current-provider-display");a&&(a.textContent=t);const i=document.getElementById("provider-select");if(i){if(!Array.from(i.options).find(d=>d.value===t)){const d=document.createElement("option");d.value=t,d.textContent=t.split("-").map(c=>c.charAt(0).toUpperCase()+c.slice(1)).join(" "),i.appendChild(d)}i.value=t}const r=document.getElementById("setting-provider");r&&(r.value=t),updateModelDropdown(t).then(()=>{selectModelInDropdowns(e)}).catch(l=>{console.warn("[Dashboard] Failed to update model dropdowns:",l),selectModelInDropdowns(e)})}else selectModelInDropdowns(e)}window._configModelLocks=window._configModelLocks||{};async function applySessionModelOverride(e){if(!e)return;const t=e.match(/^agent:([^:]+):/)?.[1],n=t?window.resolveAgentId?window.resolveAgentId(t):t:null;let s=null;if(n)try{const o=await fetch(`/api/models/agent/${n}`).then(a=>a.json());o?.modelId&&o.modelId!=="global/default"&&(s=o.modelId,console.log(`[Dashboard] LOCKING model for ${n} to config value: ${s}`),window._configModelLocks[e]=s)}catch{}if(!s)try{const o=await fetch("/api/models/current");if(o.ok){const a=await o.json();a?.modelId&&(s=a.modelId,console.log(`[Dashboard] LOCKING model to global default: ${s}`),window._configModelLocks[e]=s)}}catch{}if(s){s=resolveFullModelId(s);const o=window.getProviderFromModelId(s)||currentProvider;syncModelDisplay(s,o)}else console.warn(`[Dashboard] No model found for session ${e}, keeping current display`)}function selectModelInDropdowns(e){const t=e.split("/").pop()||e,n=document.getElementById("model-select"),s=document.getElementById("setting-model");[n,s].forEach(o=>{if(!o)return;if(Array.from(o.options).find(r=>r.value===e))o.value=e;else{const r=document.createElement("option");r.value=e,r.textContent=t,r.selected=!0,o.appendChild(r)}})}document.addEventListener("DOMContentLoaded",async function(){try{let e=localStorage.getItem("selected_model"),t=localStorage.getItem("selected_provider");if(e){t=t||window.getProviderFromModelId(e),window.currentModel=e,window.currentProvider=t;const i=document.getElementById("current-model-display");i&&(i.textContent=e);const r=document.getElementById("current-provider-display");r&&(r.textContent=t)}try{const r=await(await fetch("/api/models/current")).json();r?.modelId&&(localStorage.getItem("selected_model")||(e=r.modelId,t=r.provider||window.getProviderFromModelId(e)),console.log(`[Dashboard] Model from API global default: ${r.modelId} (provider: ${r.provider||window.getProviderFromModelId(r.modelId)})`))}catch(i){console.warn("[Dashboard] Failed to fetch current model from API:",i.message)}e||(e=null),!t&&e&&(t=window.getProviderFromModelId(e)||e.split("/")[0]),window.currentProvider=t,window.currentModel=e,console.log(`[Dashboard] Init model: ${window.currentModel} (provider: ${window.currentProvider})`),await populateProviderDropdown();const n=document.getElementById("current-provider-display"),s=document.getElementById("current-model-display"),o=document.getElementById("provider-select");n&&(n.textContent=window.currentProvider),s&&(s.textContent=window.currentModel),o&&(o.value=window.currentProvider);const a=document.getElementById("setting-provider");a&&(a.value=window.currentProvider),setInterval(async()=>{try{const r=await(await fetch("/api/models/current")).json();r?.modelId&&r?.provider&&(r.modelId!==window.currentModel||r.provider!==window.currentProvider)&&(console.log(`[Dashboard] Model changed on server: ${window.currentModel} \u2192 ${r.modelId}`),syncModelDisplay(r.modelId,r.provider))}catch{}},300*1e3),await updateModelDropdown(window.currentProvider),selectModelInDropdowns(window.currentModel)}catch(e){console.error("[Dashboard] Failed to initialize model display:",e)}});const defaultSettings={pickupFreq:"disabled",priorityOrder:"priority",refreshInterval:"10000",defaultPriority:"1",compactMode:!1,showLive:!0,showActivity:!0,showNotes:!0,showProducts:!0,showDocs:!0},READ_ACK_PREFIX="[[read_ack]]",unreadSessions=new Map,NOTIFICATION_DEBUG=!1;function notifLog(...e){NOTIFICATION_DEBUG&&console.log(...e)}function requestNotificationPermission(){"Notification"in window&&Notification.permission==="default"&&Notification.requestPermission().then(e=>{console.log(`[Notifications] Permission: ${e}`)})}function subscribeToAllSessions(){if(!gateway||!gateway.isConnected())return;const t=[...availableSessions].filter(n=>n.key&&n.updatedAt).sort((n,s)=>(s.updatedAt||0)-(n.updatedAt||0)).slice(0,20).map(n=>n.key);t.length>0&&(gateway.subscribeToAllSessions(t),console.log(`[Notifications] Subscribed to ${t.length} recent sessions (of ${availableSessions.length} total)`))}function handleCrossSessionNotification(e){const{sessionKey:t,content:n,images:s}=e;if(notifLog(`[Notifications] \u{1F4E5} Cross-session notification received: session=${t}, content=${(n||"").slice(0,80)}..., images=${s?.length||0}`),typeof n=="string"&&n.startsWith(READ_ACK_PREFIX)){notifLog(`[Notifications] Ignoring read-ack cross-session event for ${t}`),t&&clearUnreadForSession(t);return}if(typeof n=="string"){const i=n.trim();if(i==="NO_REPLY"||i==="NO"||i==="HEARTBEAT_OK"||i==="ANNOUNCE_SKIP"||i==="REPLY_SKIP"){notifLog(`[Notifications] Ignoring silent placeholder notification for ${t}: ${i}`);return}if(i==="[read-sync]"||i.startsWith("[[read_ack]]")||/^\[read-sync\]\s*\n*\s*\[\[read_ack\]\]$/s.test(i)){notifLog(`[Notifications] Ignoring read-sync notification for ${t}`),t&&clearUnreadForSession(t);return}}if(t&&typeof currentSessionName<"u"&&t===currentSessionName&&document.visibilityState==="visible"){notifLog(`[Notifications] Ignoring notification for active session ${t}`);return}const o=getFriendlySessionName(t),a=n.length>120?n.slice(0,120)+"\u2026":n;if(notifLog(`[Notifications] \u{1F514} Message from ${o}: ${a.slice(0,60)}`),unreadSessions.set(t,(unreadSessions.get(t)||0)+1),updateUnreadBadges(),notifLog(`[Notifications] Unread total: ${Array.from(unreadSessions.values()).reduce((i,r)=>i+r,0)}`),showNotificationToast(o,a,t),"Notification"in window&&Notification.permission==="granted")try{const i=new Notification(`${o}`,{body:a,icon:"/solobot-avatar.png",tag:`session-${t}`,silent:!1});i.onclick=()=>{window.focus(),navigateToSession(t),i.close()},setTimeout(()=>i.close(),8e3)}catch(i){console.warn("[Notifications] Browser notification failed:",i)}playNotificationSound()}function navigateToSession(e){typeof showPage=="function"&&showPage("chat");const t=e.match(/^agent:([^:]+):/);if(t&&typeof setActiveSidebarAgent=="function"){const n=window.resolveAgentId?window.resolveAgentId(t[1]):t[1];setActiveSidebarAgent(n)}typeof switchToSessionKey=="function"&&switchToSessionKey(e),unreadSessions.delete(e),updateUnreadBadges()}function showNotificationToast(e,t,n){let s=document.getElementById("notification-toast-container");s||(s=document.createElement("div"),s.id="notification-toast-container",s.style.cssText="position: fixed; top: 12px; right: 12px; z-index: 10000; display: flex; flex-direction: column; gap: 8px; max-width: 360px; pointer-events: none;",document.body.appendChild(s));const o=n?.match(/^agent:([^:]+):/);if(o){const c=window.resolveAgentId?window.resolveAgentId(o[1]):o[1];typeof updateAgentChatButton=="function"&&updateAgentChatButton(c)}const a=o?window.resolveAgentId?window.resolveAgentId(o[1]):o[1]:"main",r={main:"#BC2026",dev:"#6366F1",exec:"#F59E0B",coo:"#10B981",cfo:"#EAB308",cmp:"#EC4899",family:"#14B8A6",tax:"#78716C",sec:"#3B82F6",smm:"#8B5CF6"}[a]||"#BC2026",l=document.createElement("div");l.className="notification-toast",l.style.cssText=`
        pointer-events: auto; cursor: pointer;
        background: var(--card-bg, #1a1a2e); color: var(--text-primary, #e0e0e0);
        border: 1px solid color-mix(in srgb, ${r} 60%, transparent);
        border-left: 4px solid ${r}; border-radius: 8px;
        padding: 10px 14px; box-shadow: 0 6px 24px rgba(0,0,0,0.35);
        opacity: 0; transform: translateX(100%);
        transition: all 0.3s ease; max-width: 360px;
        font-family: var(--font-family, system-ui);
        backdrop-filter: blur(6px);
    `,l.innerHTML=`
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
            <span style="width: 8px; height: 8px; border-radius: 50%; background: ${r}; flex-shrink: 0; box-shadow: 0 0 0 2px color-mix(in srgb, ${r} 30%, transparent);"></span>
            <strong style="color: var(--text-primary, #e0e0e0); font-size: 13px;">${e}</strong>
            <span style="margin-left: auto; color: var(--text-muted, #666); font-size: 11px; cursor: pointer;" class="toast-close">\u2715</span>
        </div>
        <div style="color: var(--text-secondary, #c9c9c9); font-size: 12px; line-height: 1.4; padding-left: 16px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">${t.replace(/</g,"&lt;")}</div>
    `,l.addEventListener("click",c=>{if(c.target.classList?.contains("toast-close")){dismissToast(l);return}navigateToSession(n),dismissToast(l)}),s.appendChild(l),notifLog(`[Notifications] Toast rendered for ${e} (session=${n})`),requestAnimationFrame(()=>{l.style.opacity="1",l.style.transform="translateX(0)"});const d=setTimeout(()=>dismissToast(l),12e3);for(l._dismissTimer=d;s.children.length>4;)dismissToast(s.firstChild)}function dismissToast(e){!e||e._dismissed||(e._dismissed=!0,clearTimeout(e._dismissTimer),e.style.opacity="0",e.style.transform="translateX(100%)",setTimeout(()=>e.remove(),300))}function toggleNotificationPanel(){if(unreadSessions.size===0){const n=document.getElementById("notification-bell");n&&(n.style.animation="none",n.offsetHeight,n.style.animation="bellPulse 0.3s ease-in-out");return}let e=null,t=0;for(const[n,s]of unreadSessions)s>t&&(t=s,e=n);e&&navigateToSession(e)}function playNotificationSound(){try{const e=new(window.AudioContext||window.webkitAudioContext),t=e.createOscillator(),n=e.createGain();t.connect(n),n.connect(e.destination),t.frequency.setValueAtTime(880,e.currentTime),t.frequency.setValueAtTime(1047,e.currentTime+.1),n.gain.setValueAtTime(.08,e.currentTime),n.gain.exponentialRampToValueAtTime(.001,e.currentTime+.3),t.start(e.currentTime),t.stop(e.currentTime+.3)}catch{}}function updateUnreadBadges(){document.querySelectorAll(".session-option, [data-session-key]").forEach(s=>{const o=s.dataset?.sessionKey||s.getAttribute("data-session-key");if(!o)return;let a=s.querySelector(".unread-badge");const i=unreadSessions.get(o)||0;i>0?(a||(a=document.createElement("span"),a.className="unread-badge",s.appendChild(a)),a.textContent=i>99?"99+":i,a.style.cssText="background: var(--brand-red, #BC2026); color: white; border-radius: 50%; min-width: 18px; height: 18px; font-size: 11px; font-weight: 700; display: inline-flex; align-items: center; justify-content: center; padding: 0 4px; margin-left: 6px;"):a&&a.remove()}),document.querySelectorAll(".sidebar-agent[data-agent]").forEach(s=>{const o=s.getAttribute("data-agent");if(!o)return;let a=0;for(const[r,l]of unreadSessions)(r.startsWith(`agent:${o}:`)||o==="main"&&r==="main")&&(a+=l);let i=s.querySelector(".agent-unread-dot");a>0?(i||(i=document.createElement("span"),i.className="agent-unread-dot",i.style.cssText="position: absolute; top: 2px; right: 2px; background: var(--brand-red, #BC2026); color: white; border-radius: 50%; min-width: 16px; height: 16px; font-size: 10px; font-weight: 700; display: flex; align-items: center; justify-content: center; padding: 0 3px; pointer-events: none;",s.style.position="relative",s.appendChild(i)),i.textContent=a>99?"99+":a):i&&i.remove()});const e=Array.from(unreadSessions.values()).reduce((s,o)=>s+o,0),t=document.getElementById("notification-bell-badge");t&&(e>0?(t.textContent=e>99?"99+":e,t.style.display="flex"):t.style.display="none");const n="SoLoVision Dashboard";document.title=e>0?`(${e}) ${n}`:n}async function sendReadAck(e){try{gateway&&gateway.isConnected()&&await gateway.injectChat(e,READ_ACK_PREFIX,"read-sync")}catch(t){console.warn("[Notifications] Failed to send read ack:",t.message)}}function clearUnreadForSession(e){unreadSessions.has(e)&&(unreadSessions.delete(e),updateUnreadBadges(),sendReadAck(e))}function connectToGateway(){const e=document.getElementById("gateway-host")?.value||GATEWAY_CONFIG.host,t=parseInt(document.getElementById("gateway-port")?.value)||GATEWAY_CONFIG.port,n=document.getElementById("gateway-token")?.value||GATEWAY_CONFIG.token,s=document.getElementById("gateway-session")?.value||GATEWAY_CONFIG.sessionKey||"agent:main:main",o=s==="main"?"agent:main:main":s;if(!e){showToast("Please enter a gateway host in Settings","warning");return}if(gateway&&gateway.isConnected()&&gateway.sessionKey===o){console.log("[Dashboard] Already connected with correct session, skipping reconnect");return}GATEWAY_CONFIG.host=e,GATEWAY_CONFIG.port=t,GATEWAY_CONFIG.token=n,GATEWAY_CONFIG.sessionKey=o,saveGatewaySettings(e,t,n,o),updateConnectionUI("connecting","Connecting..."),gateway||initGateway(),gateway.sessionKey=o,gateway.connect(e,t,n)}function disconnectFromGateway(){gateway&&gateway.disconnect(),updateConnectionUI("disconnected","Disconnected")}window.requestGatewayRestart=async function(){if(!gateway||!gateway.isConnected()){showToast("Not connected to gateway","warning");return}showToast("Restarting gateway...","info");try{await gateway.restartGateway("manual restart from dashboard"),showToast("Gateway restart initiated. Reconnecting...","success")}catch(e){console.error("[Dashboard] Gateway restart failed:",e),showToast("Restart failed: "+e.message,"error")}};function updateConnectionUI(e,t){const n=document.getElementById("gateway-status"),s=document.getElementById("gateway-status-dot"),o=document.getElementById("settings-gateway-status"),a=document.getElementById("settings-gateway-dot"),i=document.getElementById("gateway-connect-btn"),r=document.getElementById("gateway-disconnect-btn"),l=t||e;n&&(n.textContent=l),o&&(o.textContent=l);const c=(()=>{switch(e){case"connected":return"success";case"connecting":return"warning pulse";case"error":return"error";default:return"idle"}})();s&&(s.className=`status-dot ${c}`),a&&(a.className=`status-dot ${c}`),i&&r&&(e==="connected"?(i.classList.add("hidden"),r.classList.remove("hidden")):(i.classList.remove("hidden"),r.classList.add("hidden"))),renderChat(),renderChatPage()}function handleChatEvent(e){window.ModelValidator&&typeof window.ModelValidator.handleGatewayEvent=="function"&&window.ModelValidator.handleGatewayEvent(e);const{state:t,content:n,images:s,role:o,errorMessage:a,model:i,provider:r,stopReason:l,sessionKey:d,runId:c}=e,u=currentSessionName?.toLowerCase(),m=d?.toLowerCase();if(!(m&&u&&m!==u)){if(n&&n.startsWith(READ_ACK_PREFIX)){d&&clearUnreadForSession(d);return}if(d&&d.startsWith("health-check-")){const g=pendingHealthChecks.get(d);g&&(t==="final"?(g.resolve({success:!0,content:n,model:i,provider:r}),pendingHealthChecks.delete(d)):t==="error"&&(g.reject(new Error(a||"Gateway error")),pendingHealthChecks.delete(d)));return}if(i){window._lastResponseModel=i,window._lastResponseProvider=r;const g=Date.now();!window._lastManualModelChange||g-window._lastManualModelChange>5e3?syncModelDisplay(i,r):notifLog("[Notifications] Skipping model sync from gateway (manual change active)")}if(o==="user"&&t==="final"&&n){const g=(currentSessionName||GATEWAY_CONFIG?.sessionKey||"").toLowerCase(),f=d?.toLowerCase();if(f&&g&&f!==g){notifLog(`[Notifications] Ignoring user message for session ${f} (current: ${g})`);return}state.chat.messages.some(p=>p.from==="user"&&p.text?.trim()===n.trim()&&Date.now()-p.time<5e3)||addLocalChatMessage(n,"user");return}switch(t){case"start":case"thinking":isProcessing=!0,streamingText="",renderChat(),renderChatPage();break;case"delta":streamingText=n,_streamingSessionKey=d||currentSessionName||"",isProcessing=!0,renderChat(),renderChatPage();break;case"final":const g=streamingText||n;if(g&&/^\s*\[read-sync\]\s*(\n\s*\[\[read_ack\]\])?\s*$/s.test(g)){streamingText="",isProcessing=!1,lastProcessingEndTime=Date.now();break}if(g&&o!=="user"){const f=g.trim();if(!state.chat.messages.some(p=>c&&p.runId===c||p.from==="solobot"&&p.text?.trim()===f&&Date.now()-p.time<1e4)){const p=addLocalChatMessage(g,"solobot",s,window._lastResponseModel,window._lastResponseProvider);p&&c&&(p.runId=c)}}streamingText="",isProcessing=!1,lastProcessingEndTime=Date.now(),setTimeout(_doHistoryRefresh,2e3),renderChat(),renderChatPage();break;case"error":addLocalChatMessage(`Error: ${a||"Unknown error"}`,"system"),streamingText="",isProcessing=!1,lastProcessingEndTime=Date.now(),renderChat(),renderChatPage();break}}}function loadHistoryMessages(e){const t=(currentSessionName||GATEWAY_CONFIG?.sessionKey||"").toLowerCase(),n=state.chat.messages.filter(c=>!(!c.id?.startsWith("m")||c._sessionKey&&c._sessionKey.toLowerCase()!==t)),s=[],o=[],a=c=>{if(!c)return{text:"",images:[]};let u="",m=[];if(Array.isArray(c.content))for(const g of c.content)if(g.type==="text")u+=g.text||"";else if(g.type==="input_text")u+=g.text||g.input_text||"";else if(g.type==="image")if(g.content&&g.mimeType)m.push(`data:${g.mimeType};base64,${g.content}`);else if(g.source?.data){const f=g.source.media_type||"image/jpeg";m.push(`data:${f};base64,${g.source.data}`)}else g.data&&m.push(`data:image/jpeg;base64,${g.data}`);else g.type==="image_url"&&g.image_url?.url&&m.push(g.image_url.url);else typeof c.content=="string"&&(u=c.content);if(Array.isArray(c.attachments))for(const g of c.attachments)g.type==="image"&&g.content&&g.mimeType&&m.push(`data:${g.mimeType};base64,${g.content}`);return!u&&typeof c.text=="string"&&(u=c.text),{text:(u||"").trim(),images:m}};e.forEach(c=>{if(c.role==="toolResult"||c.role==="tool"||c.model==="gateway-injected"||c.provider==="openclaw")return;let u=a(c);!u.text&&!u.images.length&&c.message&&(u=a(c.message));const m={id:c.id||"m"+Date.now()+Math.random(),from:c.role==="user"?"user":"solobot",text:u.text,image:u.images[0]||null,images:u.images,time:c.timestamp||Date.now(),model:c.model,_sessionKey:currentSessionName||GATEWAY_CONFIG?.sessionKey||"",_agentId:window.currentAgentId||"main"};isSystemMessage(u.text,m.from)?o.push(m):s.push(m)});const i=new Set(s.map(c=>c.id)),r=new Set(s.map(c=>c.text)),l=n.filter(c=>!i.has(c.id)&&!r.has(c.text)),d={};n.forEach(c=>{c.text&&(d[c.text.trim()]=c)}),s.forEach(c=>{const u=d[c.text?.trim()];u?.model&&(!c.model||c.model==="openrouter/free"||c.model==="unknown")&&(c.model=u.model,c.provider=u.provider)}),state.chat.messages=[...s,...l],console.log(`[Dashboard] Set ${state.chat.messages.length} chat messages (${s.length} from history, ${l.length} local)`),state.chat.messages.sort((c,u)=>c.time-u.time),state.chat.messages.length>GATEWAY_CONFIG.maxMessages&&(state.chat.messages=state.chat.messages.slice(-GATEWAY_CONFIG.maxMessages)),state.system.messages=[...state.system.messages,...o],state.system.messages.sort((c,u)=>c.time-u.time),state.system.messages.length>GATEWAY_CONFIG.maxMessages&&(state.system.messages=state.system.messages.slice(-GATEWAY_CONFIG.maxMessages)),persistSystemMessages(),persistChatMessages(),renderChat(),renderChatPage(),renderSystemPage()}let _historyRefreshFn=null,_historyVisibilityFn=null,_historyRefreshInFlight=!1,_lastHistoryLoadTime=0;const HISTORY_MIN_INTERVAL=8e3;function _doHistoryRefresh(){if(!gateway||!gateway.isConnected()||isProcessing||Date.now()-lastProcessingEndTime<1500||_historyRefreshInFlight||Date.now()-_lastHistoryLoadTime<HISTORY_MIN_INTERVAL)return;_historyRefreshInFlight=!0,_lastHistoryLoadTime=Date.now();const e=sessionVersion,t=GATEWAY_CONFIG?.sessionKey||"unknown";notifLog(`[Notifications] _doHistoryRefresh: session=${t}, version=${e}`),gateway.loadHistory().then(n=>{if(_historyRefreshInFlight=!1,e!==sessionVersion){notifLog(`[Notifications] _doHistoryRefresh: Skipped (version mismatch ${e} vs ${sessionVersion})`);return}n?.messages?(notifLog(`[Notifications] _doHistoryRefresh: Got ${n.messages.length} messages for session=${t}`),mergeHistoryMessages(n.messages)):notifLog("[Notifications] _doHistoryRefresh: No messages returned")}).catch(n=>{_historyRefreshInFlight=!1,notifLog(`[Notifications] _doHistoryRefresh: Error - ${n.message}`)})}function startHistoryPolling(){stopHistoryPolling(),historyPollInterval=setInterval(_doHistoryRefresh,3e4),_historyRefreshFn||(_historyRefreshFn=_doHistoryRefresh,_historyVisibilityFn=()=>{document.visibilityState==="visible"&&_doHistoryRefresh()},window.addEventListener("focus",_historyRefreshFn),document.addEventListener("visibilitychange",_historyVisibilityFn))}function stopHistoryPolling(){historyPollInterval&&(clearInterval(historyPollInterval),historyPollInterval=null),_historyRefreshFn&&(window.removeEventListener("focus",_historyRefreshFn),document.removeEventListener("visibilitychange",_historyVisibilityFn),_historyRefreshFn=null,_historyVisibilityFn=null)}function mergeHistoryMessages(e){const t=(currentSessionName||GATEWAY_CONFIG?.sessionKey||"").toLowerCase();if(!t){notifLog("[Notifications] mergeHistoryMessages: No active session, skipping merge");return}const n=new Set(state.chat.messages.map(c=>c.id)),s=new Set(state.system.messages.map(c=>c.id)),o=new Set(state.chat.messages.map(c=>(c.text||"").trim())),a=new Set(state.system.messages.map(c=>(c.text||"").trim())),i=new Set(state.chat.messages.filter(c=>c.runId).map(c=>c.runId));let r=0,l=0;const d=c=>{if(!c)return"";let u="";if(Array.isArray(c.content))for(const m of c.content)m.type==="text"&&(u+=m.text||""),m.type==="input_text"&&(u+=m.text||m.input_text||"");else typeof c.content=="string"&&(u=c.content);return!u&&typeof c.text=="string"&&(u=c.text),(u||"").trim()};for(const c of e){const u=c.id||"m"+c.timestamp;if(!(n.has(u)||s.has(u))&&!(c.role==="toolResult"||c.role==="tool")&&!(c.model==="gateway-injected"||c.provider==="openclaw")){let m=d(c);if(!m&&c.message&&(m=d(c.message)),m){const g=isSystemMessage(m,c.role==="user"?"user":"solobot");if(c.runId&&i.has(c.runId)||g&&a.has(m)||!g&&o.has(m)||c.role!=="user"&&state.chat.messages.some(p=>p.from==="solobot"&&Date.now()-p.time<5e3)&&!n.has(u)&&state.chat.messages.some(v=>v.from==="solobot"&&Date.now()-v.time<5e3&&v.text?.trim()===m))continue;const f={id:u,from:c.role==="user"?"user":"solobot",text:m,time:c.timestamp||Date.now(),model:c.model||null,provider:c.provider||null};g?(state.system.messages.push(f),a.add(m),l++):(state.chat.messages.push(f),n.add(u),o.add(m),r++)}}}if(r>0||l>0){notifLog(`[Notifications] mergeHistoryMessages: Merged ${r} chat, ${l} system messages for session ${t}`),state.chat.messages.sort((m,g)=>m.time-g.time),state.chat.messages.length>GATEWAY_CONFIG.maxMessages&&(state.chat.messages=state.chat.messages.slice(-GATEWAY_CONFIG.maxMessages)),state.system.messages.sort((m,g)=>m.time-g.time),state.system.messages.length>GATEWAY_CONFIG.maxMessages&&(state.system.messages=state.system.messages.slice(-GATEWAY_CONFIG.maxMessages)),persistSystemMessages(),persistChatMessages();const c=window.getSelection();if(!(c&&c.toString().trim().length>0))renderChat(),renderChatPage(),renderSystemPage();else if(console.log("[Dashboard] Deferring render \u2014 text is selected"),!window._pendingRender){window._pendingRender=!0;const m=()=>{const g=window.getSelection();!g||g.toString().trim().length===0?(window._pendingRender=!1,renderChat(),renderChatPage(),renderSystemPage()):requestAnimationFrame(m)};requestAnimationFrame(m)}}}let securityInterval=null;function initSecurityPage(){loadSecurityData(),securityInterval&&clearInterval(securityInterval),securityInterval=setInterval(loadSecurityData,3e4)}async function loadSecurityData(){if(!gateway||!gateway.isConnected()){renderSecurityDisconnected();return}try{const e=await gateway._request("exec.approvals.list",{});renderExecApprovals(e?.items||e||[])}catch{renderExecApprovals([])}try{const e=await gateway._request("audit.events",{limit:50});renderConnectionLog(e?.events||e||[])}catch{renderConnectionLog([])}try{const e=await gateway._request("devices.list",{});renderDevices(e?.devices||e||[])}catch{renderDevices([])}}function renderSecurityDisconnected(){const e=document.getElementById("exec-approvals");e&&(e.innerHTML='<div class="empty-state">Connect to gateway</div>');const t=document.getElementById("connection-log");t&&(t.innerHTML="")}function renderExecApprovals(e){const t=document.getElementById("exec-approvals");if(t){if(e.length===0){t.innerHTML='<div style="color: var(--text-muted); font-size: 12px; text-align: center; padding: 16px;">No pending approvals</div>';return}t.innerHTML=e.map(n=>{const s=n.status||"pending",o=s==="approved"?"success":s==="denied"?"error":"warning",a=n.createdAt?new Date(n.createdAt).toLocaleString():"";return`
        <div style="background: var(--surface-1); border: 1px solid var(--border-default); border-radius: var(--radius-md); padding: 10px; margin-bottom: 6px;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div style="flex: 1; min-width: 0;">
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span class="status-dot ${o}"></span>
                        <span style="font-weight: 600; font-size: 13px;">${escapeHtml(n.command||n.action||"Unknown")}</span>
                    </div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">
                        ${n.agent?`Agent: ${escapeHtml(n.agent)} \xB7 `:""}${a}
                    </div>
                    ${n.reason?`<div style="font-size: 11px; color: var(--text-muted);">Reason: ${escapeHtml(n.reason)}</div>`:""}
                </div>
                ${s==="pending"?`
                <div style="display: flex; gap: 4px; flex-shrink: 0;">
                    <button onclick="approveExec('${n.id}')" class="btn btn-primary" style="padding: 4px 10px; font-size: 11px;">Approve</button>
                    <button onclick="denyExec('${n.id}')" class="btn btn-ghost" style="padding: 4px 10px; font-size: 11px; color: var(--error);">Deny</button>
                </div>`:""}
            </div>
        </div>`}).join("")}}window.approveExec=async function(e){try{await gateway._request("exec.approvals.approve",{id:e}),showToast("Approved","success"),loadSecurityData()}catch(t){showToast("Failed: "+t.message,"error")}},window.denyExec=async function(e){try{await gateway._request("exec.approvals.deny",{id:e}),showToast("Denied","success"),loadSecurityData()}catch(t){showToast("Failed: "+t.message,"error")}};function renderConnectionLog(e){const t=document.getElementById("connection-log");if(t){if(e.length===0){t.innerHTML='<div style="color: var(--text-muted); font-size: 12px; text-align: center; padding: 12px;">No events recorded</div>';return}t.innerHTML=e.slice(0,30).map(n=>{const s=n.type||n.event||"event",o=s.includes("connect")?"\u{1F517}":s.includes("disconnect")?"\u{1F50C}":s.includes("error")?"\u26A0\uFE0F":"\u{1F4CB}",a=n.timestamp?new Date(n.timestamp).toLocaleString():"";return`
        <div style="font-size: 11px; padding: 4px 0; display: flex; gap: 6px; border-bottom: 1px solid var(--border-default);">
            <span>${o}</span>
            <span style="flex: 1;">${escapeHtml(n.message||n.description||s)}</span>
            <span style="color: var(--text-muted); flex-shrink: 0;">${a}</span>
        </div>`}).join("")}}function renderDevices(e){const t=document.getElementById("devices-list");if(t){if(e.length===0){t.innerHTML='<div style="color: var(--text-muted); font-size: 12px; text-align: center; padding: 8px;">No devices</div>';return}t.innerHTML=e.map(n=>`
        <div style="display: flex; align-items: center; gap: 8px; padding: 6px 0; border-bottom: 1px solid var(--border-default);">
            <span style="font-size: 16px;">\u{1F4BB}</span>
            <div style="flex: 1;">
                <div style="font-size: 13px; font-weight: 500;">${escapeHtml(n.name||n.id||"Unknown")}</div>
                <div style="font-size: 10px; color: var(--text-muted);">${n.lastSeen?new Date(n.lastSeen).toLocaleString():""}</div>
            </div>
            <span class="status-dot ${n.online?"success":"idle"}"></span>
        </div>`).join("")}}const SESSION_DEBUG=!1;function sessLog(...e){SESSION_DEBUG&&console.log(...e)}const AGENT_PERSONAS={main:{name:"Halo",role:"PA"},exec:{name:"Elon",role:"CoS"},cto:{name:"Orion",role:"CTO"},coo:{name:"Atlas",role:"COO"},cfo:{name:"Sterling",role:"CFO"},cmp:{name:"Vector",role:"CMP"},dev:{name:"Dev",role:"ENG"},devops:{name:"Forge",role:"DEVOPS"},ui:{name:"Quill",role:"FE/UI"},swe:{name:"Chip",role:"SWE"},youtube:{name:"Snip",role:"YT"},sec:{name:"Knox",role:"SEC"},net:{name:"Sentinel",role:"NET"},smm:{name:"Nova",role:"SMM"},family:{name:"Haven",role:"FAM"},tax:{name:"Ledger",role:"TAX"},docs:{name:"Canon",role:"DOC"},art:{name:"Luma",role:"ART"}};function normalizeDashboardSessionKey(e){return!e||e==="main"?"agent:main:main":e}function getFriendlySessionName(e){if(!e)return"Halo (PA)";const t=e.match(/^agent:([^:]+):(.+)$/);if(t){const n=resolveAgentId(t[1]),s=t[2],o=AGENT_PERSONAS[n],a=o?o.name:n.toUpperCase();return s==="main"?a:`${a} (${s})`}return e}window.currentSessionName=window.currentSessionName||null;function initCurrentSessionName(){const e=localStorage.getItem("gateway_session"),t=typeof GATEWAY_CONFIG<"u"&&GATEWAY_CONFIG?.sessionKey?GATEWAY_CONFIG.sessionKey:null;window.currentSessionName=normalizeDashboardSessionKey(e||t||"agent:main:main"),console.log("[initCurrentSessionName] localStorage:",e),console.log("[initCurrentSessionName] GATEWAY_CONFIG:",t),console.log("[initCurrentSessionName] Final:",window.currentSessionName)}initCurrentSessionName(),window.toggleSessionMenu=function(){const e=document.getElementById("session-menu");e&&e.classList.toggle("hidden")},window.renameSession=async function(){toggleSessionMenu();const e=prompt("Enter new session name:",window.currentSessionName);if(!(!e||e===window.currentSessionName))try{const t=await fetch("/api/session/rename",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({oldName:window.currentSessionName,newName:e})});if(t.ok){window.currentSessionName=e;const n=document.getElementById("current-session-name");n&&(n.textContent=e),showToast(`Session renamed to "${e}"`,"success")}else{const n=await t.json();showToast(`Failed to rename: ${n.error||"Unknown error"}`,"error")}}catch(t){console.error("[Dashboard] Failed to rename session:",t),showToast("Failed to rename session","error")}},window.showSessionSwitcher=function(){toggleSessionMenu(),showToast("Session switcher coming soon","info")},window.toggleChatPageSessionMenu=function(){const e=document.getElementById("chat-page-session-menu");e&&e.classList.toggle("hidden")},document.addEventListener("click",function(e){const t=document.getElementById("chat-page-session-menu"),n=e.target.closest('[onclick*="toggleChatPageSessionMenu"]');t&&!t.classList.contains("hidden")&&!t.contains(e.target)&&!n&&t.classList.add("hidden")});let availableSessions=[];window.currentAgentId=window.currentAgentId||"main";let _switchInFlight=!1,_sessionSwitchQueue=[];const LEGACY_AGENT_MAP={chip:"swe",quill:"ui",forge:"devops",snip:"youtube",creative:"art"};function resolveAgentId(e){return e?(e=e.toLowerCase(),LEGACY_AGENT_MAP[e]||e):"main"}window.resolveAgentId=resolveAgentId;function getAgentIdFromSession(e){const t=e?.match(/^agent:([^:]+):/);return t?resolveAgentId(t[1]):"main"}function filterSessionsForAgent(e,t){return e.filter(n=>!!(getAgentIdFromSession(n.key)===t||n.key?.startsWith("agent:main:subagent:")&&(n.displayName||n.name||"").toLowerCase().startsWith(t.toLowerCase()+"-")))}function checkUrlSessionParam(){const t=new URLSearchParams(window.location.search).get("session");return t?(sessLog(`[Dashboard] URL session param detected: ${t}`),t):null}function handleSubagentSessionAgent(){if(!currentSessionName?.startsWith("agent:main:subagent:"))return;const e=availableSessions.find(s=>s.key===currentSessionName);if(!e){sessLog(`[Dashboard] Subagent session not found in available sessions: ${currentSessionName}`);return}const t=e.displayName||e.name||"";sessLog(`[Dashboard] Subagent session label: ${t}`);const n=t.match(/^([a-z]+)-/i);if(n){const s=n[1].toLowerCase();sessLog(`[Dashboard] Determined agent from label: ${s}`),currentAgentId=s,setActiveSidebarAgent(s);const o=document.getElementById("chat-page-agent-name");o&&(o.textContent=getAgentLabel(s))}}let _fetchSessionsInFlight=!1,_fetchSessionsQueued=!1;async function fetchSessions(){if(_fetchSessionsInFlight)return _fetchSessionsQueued=!0,availableSessions;_fetchSessionsInFlight=!0;try{const e=availableSessions.filter(r=>r.sessionId===null);if(gateway&&gateway.isConnected())try{const d=((await gateway.listSessions({}))?.sessions||[]).map(m=>{const g=getFriendlySessionName(m.key);return{key:m.key,name:g,displayName:g,updatedAt:m.updatedAt,totalTokens:m.totalTokens||(m.inputTokens||0)+(m.outputTokens||0),model:m.model||"unknown",sessionId:m.sessionId}}),c=new Set(d.map(m=>m.key)),u=e.filter(m=>!c.has(m.key));if(availableSessions=[...d,...u],sessLog(`[Dashboard] Fetched ${d.length} from gateway + ${u.length} local = ${availableSessions.length} total`),handleSubagentSessionAgent(),populateSessionDropdown(),typeof updateSidebarAgentsFromSessions=="function")try{updateSidebarAgentsFromSessions(availableSessions)}catch(m){console.warn("[SidebarAgents] update failed:",m.message)}return subscribeToAllSessions(),availableSessions}catch(r){console.warn("[Dashboard] Gateway sessions.list failed, falling back to server:",r.message)}const t=await fetch("/api/sessions");if(!t.ok)throw new Error(`HTTP ${t.status}`);const o=((await t.json()).sessions||[]).map(r=>{const l=getFriendlySessionName(r.key);return{key:r.key,name:l,displayName:r.displayName||l,updatedAt:r.updatedAt,totalTokens:r.totalTokens||(r.inputTokens||0)+(r.outputTokens||0),model:r.model||"unknown",sessionId:r.sessionId}}),a=new Set(o.map(r=>r.key)),i=e.filter(r=>!a.has(r.key));if(availableSessions=[...o,...i],sessLog(`[Dashboard] Fetched ${o.length} from server + ${i.length} local = ${availableSessions.length} total`),handleSubagentSessionAgent(),populateSessionDropdown(),typeof updateSidebarAgentsFromSessions=="function")try{updateSidebarAgentsFromSessions(availableSessions)}catch(r){console.warn("[SidebarAgents] update failed:",r.message)}return availableSessions}catch(e){return console.error("[Dashboard] Failed to fetch sessions:",e),[]}finally{_fetchSessionsInFlight=!1,_fetchSessionsQueued&&(_fetchSessionsQueued=!1,setTimeout(fetchSessions,100))}}function populateSessionDropdown(){const e=document.getElementById("chat-page-session-menu");if(!e)return;const t=filterSessionsForAgent(availableSessions,currentAgentId);sessLog(`[Dashboard] populateSessionDropdown: agent=${currentAgentId}, total=${availableSessions.length}, filtered=${t.length}`),sessLog("[Dashboard] Available sessions:",availableSessions.map(o=>o.key));let n="";const s=getAgentLabel(currentAgentId);if(n+=`<div style="padding: 8px 12px; font-size: 11px; text-transform: uppercase; color: var(--text-muted); border-bottom: 1px solid var(--border-default); display: flex; justify-content: space-between; align-items: center;">
        <span>${escapeHtml(s)} Sessions</span>
        <button onclick="startNewAgentSession('${currentAgentId}')" style="background: var(--brand-red); color: white; border: none; border-radius: 4px; padding: 2px 8px; font-size: 11px; cursor: pointer;" title="New session for ${s}">+ New</button>
    </div>`,t.length===0){n+='<div style="padding: 12px; color: var(--text-muted); font-size: 13px;">No sessions for this agent yet</div>',e.innerHTML=n;return}n+=t.map(o=>{const a=o.key===currentSessionName,i=o.updatedAt?new Date(o.updatedAt).toLocaleDateString():"",r=o.updatedAt?new Date(o.updatedAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"";return`
        <div class="session-dropdown-item ${a?"active":""}" data-session-key="${o.key}" onclick="if(event.target.closest('.session-edit-btn')) return; switchToSession('${o.key}')">
            <div class="session-info">
                <div class="session-name">${escapeHtml(o.displayName||o.name||o.key||"unnamed")}${unreadSessions.get(o.key)?` <span class="unread-badge" style="background: var(--brand-red, #BC2026); color: white; border-radius: 50%; min-width: 18px; height: 18px; font-size: 11px; font-weight: 700; display: inline-flex; align-items: center; justify-content: center; padding: 0 4px; margin-left: 4px;">${unreadSessions.get(o.key)}</span>`:""}</div>
                <div class="session-meta">${i} ${r} \u2022 ${o.totalTokens?.toLocaleString()||0} tokens</div>
            </div>
            <span class="session-model">${o.model}</span>
            <div class="session-actions">
                <button class="session-edit-btn" onclick="editSessionName('${o.key}', '${escapeHtml(o.displayName||o.name||o.key||"unnamed")}')" title="Rename session">
                    \u270F\uFE0F
                </button>
                <button class="session-edit-btn" onclick="deleteSession('${o.key}', '${escapeHtml(o.displayName||o.name||o.key||"unnamed")}')" title="Delete session" style="color: var(--error);">
                    \u{1F5D1}\uFE0F
                </button>
            </div>
        </div>
        `}).join(""),e.innerHTML=n}function getAgentLabel(e){const t=AGENT_PERSONAS[e];return t?t.name:e.toUpperCase()}function getAgentDisplayName(e){if(!e||e==="main")return"Halo (PA)";const t=AGENT_PERSONAS[e];return t?`${t.name} (${t.role})`:`SoLoBot-${e.toUpperCase()}`}function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}window.editSessionName=function(e,t){const n=prompt("Enter new session name:",t);!n||n===t||fetch("/api/session/rename",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({oldName:e,newName:n})}).then(s=>s.json()).then(s=>{if(s.ok){showToast("Session rename requested. Will update shortly.","success");const o=availableSessions.find(a=>a.key===e);if(o&&(o.displayName=n,populateSessionDropdown(),e===currentSessionName)){const a=document.getElementById("chat-page-session-name");a&&(a.textContent=e,a.title=e)}}else showToast(`Failed: ${s.error||"Unknown error"}`,"error")}).catch(s=>{console.error("[Dashboard] Failed to rename session:",s),showToast("Failed to rename session","error")})},window.deleteSession=async function(e,t){if(e===currentSessionName){showToast("Cannot delete the active session. Switch to another session first.","warning");return}if(confirm(`Delete session "${t}"?

This will permanently delete all messages in this session.`))try{if(gateway&&gateway.isConnected()){const n=await gateway.request("sessions.delete",{sessionKey:e});n&&n.ok?(showToast(`Session "${t}" deleted`,"success"),availableSessions=availableSessions.filter(s=>s.key!==e),populateSessionDropdown()):showToast(`Failed to delete: ${n?.error||"Unknown error"}`,"error")}else showToast("Not connected to gateway","error")}catch(n){console.error("[Dashboard] Failed to delete session:",n),showToast("Failed to delete session: "+n.message,"error")}},window.switchToSessionKey=window.switchToSession=async function(e){if(e=normalizeDashboardSessionKey(e),_sessionSwitchQueue.push({sessionKey:e,timestamp:Date.now()}),!_switchInFlight)for(;_sessionSwitchQueue.length>0;){const{sessionKey:t}=_sessionSwitchQueue.shift();if(t===currentSessionName){populateSessionDropdown();continue}await executeSessionSwitch(t)}};async function executeSessionSwitch(e){_switchInFlight=!0;try{toggleChatPageSessionMenu(),clearUnreadForSession(e),showToast(`Switching to ${getFriendlySessionName(e)}...`,"info"),streamingText="",_streamingSessionKey="",isProcessing=!1,state.chat.messages=[],renderChat(),renderChatPage(),await saveCurrentChat(),cacheSessionMessages(currentSessionName||GATEWAY_CONFIG.sessionKey,state.chat.messages),sessionVersion++,sessLog(`[Dashboard] Session version now ${sessionVersion}`);const t=currentSessionName;currentSessionName=e,GATEWAY_CONFIG.sessionKey=e,localStorage.setItem("gateway_session",e);const n=document.getElementById("gateway-session");n&&(n.value=e);const s=e.match(/^agent:([^:]+):/);s&&(currentAgentId=resolveAgentId(s[1]),typeof forceSyncActiveAgent=="function"&&forceSyncActiveAgent(currentAgentId)),await clearChatHistory(!0,!0);const o=getCachedSessionMessages(e);o&&o.length>0&&(state.chat.messages=o.slice(),typeof renderChatPage=="function"&&renderChatPage(),sessLog(`[Dashboard] Restored ${o.length} cached messages for ${e}`)),await new Promise(l=>setTimeout(l,50)),gateway&&gateway.isConnected()?gateway.setSessionKey(e):gateway&&(sessLog("[Dashboard] Gateway not connected, initiating connect..."),connectToGateway());const a=loadSessionHistory(e),i=applySessionModelOverride(e).catch(()=>{}),r=document.getElementById("chat-page-session-name");r&&(r.textContent=e,r.title=e),populateSessionDropdown(),await a,await i,s?(setActiveSidebarAgent(s[1]),saveLastAgentSession(s[1],e)):setActiveSidebarAgent(null),showToast(`Switched to ${getFriendlySessionName(e)}`,"success")}catch(t){console.error("[Dashboard] Failed to switch session:",t),showToast("Failed to switch session","error")}finally{_switchInFlight=!1}}window.goToSession=async function(e){if(e=normalizeDashboardSessionKey(e),!e){showToast("No session key provided","warning");return}if(sessLog(`[Dashboard] goToSession called with: ${e}`),!gateway||!gateway.isConnected()){showToast("Connecting to gateway...","info"),GATEWAY_CONFIG.sessionKey=e,currentSessionName=e,localStorage.setItem("gateway_session",e);const t=document.getElementById("gateway-session");t&&(t.value=e),GATEWAY_CONFIG.host?connectToGateway():showToast("Please configure gateway settings first","warning");return}showPage("chat"),await switchToSession(e)},window.getSessionUrl=function(e){return`${window.location.origin+window.location.pathname}?session=${encodeURIComponent(e)}`};async function saveCurrentChat(){try{const t=await(await fetch("/api/state")).json();t.archivedChats||(t.archivedChats={}),t.archivedChats[currentSessionName]={savedAt:Date.now(),messages:state.chat.messages.slice(-100)},await fetch("/api/sync",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}catch{}}async function loadSessionHistory(e){const t=sessionVersion;async function n(){if(!gateway||!gateway.isConnected())return!1;try{const o=await gateway.loadHistory();if(t!==sessionVersion)return sessLog(`[Dashboard] Ignoring stale history load for ${e}`),!0;if(o?.messages&&o.messages.length>0)return state.chat?.messages?.length>0?mergeHistoryMessages(o.messages):loadHistoryMessages(o.messages),sessLog(`[Dashboard] Loaded ${o.messages.length} messages from gateway for ${e}`),!0}catch(o){console.warn("[Dashboard] Gateway history failed:",o.message)}return!1}if(await n()||gateway&&!gateway.isConnected()&&(sessLog(`[Dashboard] Gateway disconnected during switch to ${e}, waiting for reconnect...`),await new Promise(o=>setTimeout(o,2e3)),t!==sessionVersion||await n()))return;const s=getCachedSessionMessages(e);if(s&&s.length>0){state.chat.messages=s.slice(),renderChat(),renderChatPage(),sessLog(`[Dashboard] Loaded ${s.length} cached messages for ${e}`);return}sessLog(`[Dashboard] No history available for ${e} \u2014 rendering empty`),renderChat(),renderChatPage()}async function loadArchivedChat(e){chatHistory=[],renderChat(),renderChatPage()}function initGateway(){gateway=new GatewayClient({sessionKey:GATEWAY_CONFIG.sessionKey,onConnected:(e,t)=>{sessLog(`[Dashboard] Connected to ${e}, session: ${t}`),updateConnectionUI("connected",e);const n=normalizeDashboardSessionKey(GATEWAY_CONFIG.sessionKey||currentSessionName||t);t!==n&&(sessLog(`[Dashboard] Reconnect mismatch: gateway=${t}, intended=${n}. Re-syncing gateway.`),gateway&&gateway.setSessionKey(n)),GATEWAY_CONFIG.sessionKey=n,currentSessionName=n,fetchModelsFromGateway().then(()=>applySessionModelOverride(n));const s=document.getElementById("current-session-name");s&&(s.textContent=n,s.title=n);const o=document.getElementById("chat-page-session-name");o&&(o.textContent=n,o.title=n);const a=n.match(/^agent:([^:]+):/);a&&saveLastAgentSession(resolveAgentId(a[1]),n),checkRestartToast(),_historyRefreshInFlight=!0,_lastHistoryLoadTime=Date.now();const i=sessionVersion;gateway.loadHistory().then(r=>{if(_historyRefreshInFlight=!1,i!==sessionVersion){sessLog(`[Dashboard] Ignoring stale history (version ${i} != ${sessionVersion})`);return}r?.messages&&(sessLog(`[Dashboard] onConnected: full history replace with ${r.messages.length} messages`),loadHistoryMessages(r.messages))}).catch(()=>{_historyRefreshInFlight=!1}),startHistoryPolling(),fetchSessions()},onDisconnected:e=>{updateConnectionUI("disconnected",e),isProcessing=!1,streamingText="",stopHistoryPolling()},onChatEvent:e=>{handleChatEvent(e)},onToolEvent:e=>{e.phase==="start"&&e.summary&&addTerminalLog(e.summary,"info",e.timestamp)},onCrossSessionMessage:e=>{handleCrossSessionNotification(e)},onError:e=>{console.error(`[Dashboard] Gateway error: ${e}`),updateConnectionUI("error",e)}})}let newSessionModalResolve=null;window.openNewSessionModal=function(e){return new Promise(t=>{newSessionModalResolve=t;const n=document.getElementById("new-session-modal"),s=document.getElementById("new-session-name-input");n&&s?(s.value=e||"",n.classList.add("visible"),setTimeout(()=>{s.focus(),s.select()},50)):t(null)})},window.closeNewSessionModal=function(e){const t=document.getElementById("new-session-modal");t&&t.classList.remove("visible"),newSessionModalResolve&&(newSessionModalResolve(e),newSessionModalResolve=null)},window.submitNewSessionModal=function(){const e=document.getElementById("new-session-name-input"),t=e?e.value:null;closeNewSessionModal(t)},document.addEventListener("keydown",function(e){const t=document.getElementById("new-session-modal");t&&t.classList.contains("visible")&&(e.key==="Enter"?(e.preventDefault(),submitNewSessionModal()):e.key==="Escape"&&(e.preventDefault(),closeNewSessionModal(null)))}),window.startNewAgentSession=async function(e){toggleChatPageSessionMenu();const t=new Date,n=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getDate()).padStart(2,"0"),o=t.getFullYear();let a=t.getHours();const i=a>=12?"PM":"AM";a=a%12,a=a||12;const r=String(t.getMinutes()).padStart(2,"0"),l=String(t.getSeconds()).padStart(2,"0"),d=`${n}/${s}/${o} ${String(a).padStart(2,"0")}:${r}:${l} ${i}`,c=getAgentLabel(e),u=await openNewSessionModal(d);if(!u||!u.trim())return;const m=`${e.toLowerCase()}-${u.trim()}`,g=`agent:${e}:${m}`;if(availableSessions.some(w=>w.key===g)){showToast(`Session "${u.trim()}" already exists. Switching to it.`,"info"),await switchToSession(g);return}showToast(`Creating new ${c} session "${u.trim()}"...`,"info"),sessionVersion++,sessLog(`[Dashboard] Session version now ${sessionVersion} (new agent session)`),state.chat.messages=[],state.system.messages=[],chatPageNewMessageCount=0,chatPageUserScrolled=!1,localStorage.removeItem(chatStorageKey()),currentAgentId=e,renderChat(),renderChatPage(),currentSessionName=g,GATEWAY_CONFIG.sessionKey=g,localStorage.setItem("gateway_session",g),typeof saveGatewaySettings=="function"?saveGatewaySettings(GATEWAY_CONFIG.host,GATEWAY_CONFIG.port,GATEWAY_CONFIG.token,g):typeof state<"u"&&state.gatewayConfig&&(state.gatewayConfig.sessionKey=g,typeof saveState=="function"&&saveState("Updated session for reload"));const f=document.getElementById("gateway-session");f&&(f.value=g);const y=u.trim(),p=document.getElementById("chat-page-session-name");p&&(p.textContent=y),streamingText="",isProcessing=!1,gateway&&gateway.isConnected()?gateway.setSessionKey(g):gateway&&connectToGateway();const v={key:g,name:m,displayName:y,updatedAt:Date.now(),totalTokens:0,model:currentModel||"unknown",sessionId:null};availableSessions.unshift(v),await fetchSessions(),availableSessions.some(w=>w.key===g)||availableSessions.unshift(v),populateSessionDropdown(),setActiveSidebarAgent(e),renderChat(),renderChatPage(),renderSystemPage(),showToast(`New ${c} session "${y}" created`,"success")},window.startNewSession=async function(){await startNewAgentSession(currentAgentId)};let sessionSearchQuery="";function filterSessionsBySearch(e,t){if(!t)return e;const n=t.toLowerCase();return e.filter(s=>{const o=(s.displayName||s.name||s.key||"").toLowerCase(),a=(s.model||"").toLowerCase();return o.includes(n)||a.includes(n)})}const originalPopulateSessionDropdown=window.populateSessionDropdown;typeof originalPopulateSessionDropdown=="function"&&(window.populateSessionDropdown=function(){originalPopulateSessionDropdown();const e=document.getElementById("chat-page-session-menu");if(e&&!e.querySelector(".session-search")){const t=document.createElement("div");t.className="session-search",t.innerHTML=`
                <input type="text" placeholder="Search sessions..." 
                       oninput="filterSessionDropdown(this.value)"
                       onclick="event.stopPropagation()">
            `,e.insertBefore(t,e.firstChild)}}),window.filterSessionDropdown=function(e){sessionSearchQuery=e;const t=document.getElementById("chat-page-session-menu");if(!t)return;const n=t.querySelectorAll(".session-menu-item"),s=e.toLowerCase();n.forEach(o=>{const a=o.textContent.toLowerCase();o.style.display=a.includes(s)?"":"none"})};async function checkRestartToast(){try{const e=await fetch("/api/state");if(!e.ok)return;const t=await e.json();t.restartPending&&(showToast("Gateway restarted successfully","success"),delete t.restartPending,await fetch("/api/sync",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}))}catch(e){console.warn("[Dashboard] Restart toast check failed:",e)}}const SIDEBAR_AGENTS_ORDER_KEY="sidebar_agents_order_v1",SIDEBAR_AGENTS_HIDDEN_KEY="sidebar_agents_hidden_v1",SIDEBAR_AGENTS_PREFS_KEY="sidebar_agents_prefs_v1";function getSidebarAgentsPrefs(){try{return JSON.parse(localStorage.getItem(SIDEBAR_AGENTS_PREFS_KEY)||"{}")}catch{return{}}}function setSidebarAgentsPrefs(e){try{localStorage.setItem(SIDEBAR_AGENTS_PREFS_KEY,JSON.stringify(e||{}))}catch{}}function getSidebarAgentsHiddenSet(){try{const e=JSON.parse(localStorage.getItem(SIDEBAR_AGENTS_HIDDEN_KEY)||"[]");return new Set(Array.isArray(e)?e:[])}catch{return new Set}}function setSidebarAgentsHiddenSet(e){try{localStorage.setItem(SIDEBAR_AGENTS_HIDDEN_KEY,JSON.stringify(Array.from(e||[])))}catch{}}function getSidebarAgentsOrder(){try{const e=JSON.parse(localStorage.getItem(SIDEBAR_AGENTS_ORDER_KEY)||"[]");return Array.isArray(e)?e:[]}catch{return[]}}function setSidebarAgentsOrder(e){try{localStorage.setItem(SIDEBAR_AGENTS_ORDER_KEY,JSON.stringify(e||[]))}catch{}}function getSidebarAgentsContainer(){return document.getElementById("sidebar-agents-list")}function getSidebarAgentElements(){const e=getSidebarAgentsContainer();return e?Array.from(e.querySelectorAll(".sidebar-agent[data-agent]")):[]}function applySidebarAgentsOrder(){const e=getSidebarAgentsContainer();if(!e)return;const t=getSidebarAgentsOrder();if(!t.length)return;const n=new Map;for(const o of getSidebarAgentElements())n.set(o.getAttribute("data-agent"),o);for(const o of t){const a=n.get(o);a&&e.appendChild(a),n.delete(o)}for(const o of n.values())e.appendChild(o);const s=getSidebarAgentElements().map(o=>o.getAttribute("data-agent"));setSidebarAgentsOrder(s)}function applySidebarAgentsHidden(){const e=getSidebarAgentsHiddenSet();for(const t of getSidebarAgentElements()){const n=t.getAttribute("data-agent"),s=e.has(n);t.classList.toggle("is-hidden",s)}}function computeLastActivityByAgent(e){const t={};for(const n of e||[]){const s=n.key?.match(/^agent:([^:]+):/),o=s?s[1]:"main",a=window.resolveAgentId?window.resolveAgentId(o):o,i=n.updatedAt?new Date(n.updatedAt).getTime():0;(!t[a]||i>t[a])&&(t[a]=i)}return t}function updateSidebarAgentActivityIndicators(e){const t=getSidebarAgentsPrefs(),n=t.hideInactive===!0,s=typeof t.inactivityMs=="number"?t.inactivityMs:900*1e3,o=computeLastActivityByAgent(e),a=Date.now();for(const i of getSidebarAgentElements()){const r=i.getAttribute("data-agent"),l=o[r]||0,d=l?a-l:1/0;i.dataset.lastActivity=String(l||""),i.classList.toggle("is-inactive",d>s),i.classList.toggle("is-never-active",!l);const c=n&&r!=="main"&&d>s;i.classList.toggle("auto-hidden",c)}}function updateSidebarAgentsFromSessions(e){updateSidebarAgentActivityIndicators(e),applySidebarAgentsHidden()}let sidebarAgentsDragging=!1;function setupSidebarAgentsDragAndDrop(){const e=getSidebarAgentElements();if(e.length){for(const t of e){if(t.setAttribute("draggable","true"),t.classList.add("draggable"),!t.querySelector(".agent-drag-handle")){const n=document.createElement("span");n.className="agent-drag-handle",n.title="Drag to reorder",n.textContent="\u283F",n.addEventListener("click",s=>s.stopPropagation()),n.addEventListener("mousedown",s=>s.stopPropagation()),t.insertBefore(n,t.firstChild)}t.addEventListener("dragstart",n=>{sidebarAgentsDragging=!0,t.classList.add("dragging"),n.dataTransfer.effectAllowed="move",n.dataTransfer.setData("text/plain",t.getAttribute("data-agent")||"")}),t.addEventListener("dragend",()=>{sidebarAgentsDragging=!1,t.classList.remove("dragging");const n=getSidebarAgentElements().map(s=>s.getAttribute("data-agent"));setSidebarAgentsOrder(n)}),t.addEventListener("dragover",n=>{n.preventDefault(),n.dataTransfer.dropEffect="move"}),t.addEventListener("drop",n=>{n.preventDefault();const s=getSidebarAgentsContainer();if(!s)return;const o=n.dataTransfer.getData("text/plain"),a=s.querySelector(`.sidebar-agent[data-agent="${CSS.escape(o)}"]`);!a||a===t||s.insertBefore(a,t)})}e.forEach(t=>{t.addEventListener("click",n=>{sidebarAgentsDragging&&(n.preventDefault(),n.stopPropagation())},!0)})}}function openSidebarAgentsModal(){const e=document.getElementById("sidebar-agents-modal");e&&(renderSidebarAgentsModal(),e.classList.add("visible"))}function closeSidebarAgentsModal(){const e=document.getElementById("sidebar-agents-modal");e&&e.classList.remove("visible")}function renderSidebarAgentsModal(){const e=document.getElementById("sidebar-agents-modal-list"),t=document.getElementById("sidebar-hide-inactive"),n=document.getElementById("sidebar-inactivity-threshold");if(!e||!t||!n)return;const s=getSidebarAgentsPrefs(),o=getSidebarAgentsHiddenSet();t.checked=s.hideInactive===!0;const a=typeof s.inactivityMs=="number"?s.inactivityMs:900*1e3;n.value=String(a);const i=getSidebarAgentElements().map(r=>{const l=r.getAttribute("data-agent"),d=r.querySelector(".sidebar-item-text"),c=d?d.textContent.trim():l,u=Number(r.dataset.lastActivity||0);return{id:l,label:c,last:u}});i.sort((r,l)=>0),e.innerHTML=i.map(r=>{const l=!o.has(r.id),d=r.last?typeof timeAgo=="function"?timeAgo(r.last):"":"no activity";return`
            <label class="sidebar-agent-pref-row">
                <input type="checkbox" data-agent="${r.id}" ${l?"checked":""} />
                <span class="sidebar-agent-pref-label">${r.label}</span>
                <span class="sidebar-agent-pref-meta">${d}</span>
            </label>
        `}).join(""),e.querySelectorAll('input[type="checkbox"][data-agent]').forEach(r=>{r.addEventListener("change",()=>{const l=r.getAttribute("data-agent");if(!l)return;const d=getSidebarAgentsHiddenSet();r.checked?d.delete(l):d.add(l),setSidebarAgentsHiddenSet(d),applySidebarAgentsHidden()})}),t.onchange=()=>{const r=getSidebarAgentsPrefs();r.hideInactive=t.checked,r.inactivityMs=Number(n.value||0)||900*1e3,setSidebarAgentsPrefs(r),updateSidebarAgentActivityIndicators(window.availableSessions||[]),applySidebarAgentsHidden()},n.onchange=()=>{const r=getSidebarAgentsPrefs();r.hideInactive=t.checked,r.inactivityMs=Number(n.value||0)||900*1e3,setSidebarAgentsPrefs(r),updateSidebarAgentActivityIndicators(window.availableSessions||[]),applySidebarAgentsHidden()}}function resetSidebarAgentsOrder(){try{localStorage.removeItem(SIDEBAR_AGENTS_ORDER_KEY)}catch{}location.reload()}function setupSidebarAgentsManageButton(){const e=document.getElementById("sidebar-agents-manage-btn");e&&e.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),openSidebarAgentsModal()})}const AVATAR_EXTENSIONS=["png","svg"];function resolveAvatarUrl(e){return e==="main"?"/avatars/solobot.png":`/avatars/${e}.png`}function agentDisplayName(e){const t=e.id||e.name,n=typeof AGENT_PERSONAS<"u"&&AGENT_PERSONAS[t];if(n)return`${n.name} (${n.role})`;if(e.isDefault)return"Halo (PA)";const s=e.name||e.id;return s.charAt(0).toUpperCase()+s.slice(1)}async function loadSidebarAgents(){const e=document.getElementById("sidebar-agents-list");if(e)try{const s=(await(await fetch("/api/agents")).json()).agents||[],a=s.some(i=>i.isDefault||i.id==="main")?s:[{id:"main",name:"main",emoji:"",isDefault:!0},...s];a.sort((i,r)=>i.isDefault?-1:r.isDefault?1:i.id.localeCompare(r.id)),e.innerHTML=a.map(i=>{const r=resolveAvatarUrl(i.id),l=agentDisplayName(i),d=i.emoji||"",c=(i.name||i.id).charAt(0).toUpperCase();return`
                <div class="sidebar-agent" data-agent="${i.id}">
                    <img class="agent-avatar"
                         src="${r}"
                         alt="${i.id}"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <span class="agent-avatar-fallback" style="display:none; width:28px; height:28px; border-radius:50%; background:var(--surface-3); align-items:center; justify-content:center; font-size:14px; flex-shrink:0;">
                        ${d||c}
                    </span>
                    <span class="sidebar-item-text">${l}</span>
                </div>
            `}).join(""),applySidebarAgentsOrder(),applySidebarAgentsHidden(),setupSidebarAgentsDragAndDrop(),typeof setupSidebarAgents=="function"&&setupSidebarAgents(),window.availableSessions&&updateSidebarAgentActivityIndicators(window.availableSessions),console.log(`[Sidebar] Loaded ${a.length} agents dynamically`)}catch(t){console.warn("[Sidebar] Failed to load agents:",t.message)}}function initSidebarAgentsUI(){setupSidebarAgentsManageButton(),loadSidebarAgents()}document.addEventListener("DOMContentLoaded",()=>{setTimeout(initSidebarAgentsUI,50)}),window.openSidebarAgentsModal=openSidebarAgentsModal,window.closeSidebarAgentsModal=closeSidebarAgentsModal,window.resetSidebarAgentsOrder=resetSidebarAgentsOrder,window.updateSidebarAgentsFromSessions=updateSidebarAgentsFromSessions;let skillsList=[],skillsInterval=null,skillsPageBound=!1;const skillsUi={search:"",onlyIssues:!1,onlyInstalled:!0};function getHiddenSkills(){try{return JSON.parse(localStorage.getItem("hiddenSkills")||"[]")}catch{return[]}}function setHiddenSkills(e){localStorage.setItem("hiddenSkills",JSON.stringify(e))}function initSkillsPage(){bindSkillsPageControls(),loadSkills(),skillsInterval&&clearInterval(skillsInterval),skillsInterval=setInterval(loadSkills,6e4)}function bindSkillsPageControls(){if(skillsPageBound)return;skillsPageBound=!0;const e=document.getElementById("skills-search"),t=document.getElementById("skills-only-issues"),n=document.getElementById("skills-refresh");e&&e.addEventListener("input",()=>{skillsUi.search=(e.value||"").trim().toLowerCase(),renderSkills()}),t&&t.addEventListener("change",()=>{skillsUi.onlyIssues=!!t.checked,renderSkills()});const s=document.getElementById("skills-only-installed");s&&(s.checked=skillsUi.onlyInstalled,s.addEventListener("change",()=>{skillsUi.onlyInstalled=!!s.checked,renderSkills()}));const o=document.getElementById("skills-show-hidden");o&&o.addEventListener("change",()=>{skillsUi.showHidden=!!o.checked,renderSkills()}),n&&n.addEventListener("click",()=>loadSkills())}async function loadSkills(){const e=document.getElementById("skills-list");if(e){if(!gateway||!gateway.isConnected()){e.innerHTML='<div class="empty-state">Connect to gateway to view skills</div>';return}try{let t;try{t=await gateway._request("skills.status",{}),skillsList=t?.skills||[]}catch{t=await gateway._request("skills.list",{}),skillsList=t?.skills||t||[]}renderSkills()}catch(t){console.warn("[Skills] Failed:",t.message),e.innerHTML='<div class="empty-state">Could not load skills. The skills RPC may not be available.</div>'}}}function skillHasIssues(e){const t=e?.missing||{},n=(t.bins?.length||0)+(t.anyBins?.length||0)+(t.env?.length||0)+(t.config?.length||0)+(t.os?.length||0);return!!(e?.disabled||e?.blockedByAllowlist||e?.eligible===!1||n>0)}function renderMissingBadges(e){const t=e?.missing||{},n=[],s=(o,a)=>{if(!a||a.length===0)return;const i=a.map(escapeHtml).join(", ");n.push(`<div style="margin-top: 6px; font-size: 11px; color: var(--text-muted);">
            <span style="font-weight: 600; color: var(--warning);">Missing ${escapeHtml(o)}:</span> ${i}
        </div>`)};return s("bins",t.bins),s("any bins",t.anyBins),s("env",t.env),s("config",t.config),s("os",t.os),e?.blockedByAllowlist&&n.push(`<div style="margin-top: 6px; font-size: 11px; color: var(--error);">
            Blocked by bundled allowlist
        </div>`),n.join("")}function skillIsReady(e){const t=e?.missing||{};return(t.bins?.length||0)+(t.anyBins?.length||0)===0}function renderInstallButtons(e){const t=e?.install||[];if(!Array.isArray(t)||t.length===0)return"";const n=e?.name;if(!n)return"";const s=skillIsReady(e),o=e?.installed===!0||s,a=s?'<span class="badge" style="background: rgba(34,197,94,.12); border: 1px solid rgba(34,197,94,.25); color: var(--success); padding: 3px 8px; border-radius: 999px; font-size: 10px; font-weight: 600;">Ready</span>':"",i=t.map(r=>{const l=r?.label||"Install",d=r?.id;if(!d)return"";const c=o?"Reinstall":l;return`<button class="${o?"btn btn-ghost":"btn btn-primary"}" style="padding: 4px 10px; font-size: 11px;" onclick="installSkill('${escapeHtml(n)}','${escapeHtml(d)}')">${escapeHtml(c)}</button>`}).join("");return[a,i].filter(Boolean).join("")}function renderSkills(){const e=document.getElementById("skills-list");if(!e)return;if((!Array.isArray(skillsList)||skillsList.length===0)&&(typeof skillsList=="object"&&!Array.isArray(skillsList)&&(skillsList=Object.entries(skillsList).map(([s,o])=>({name:s,...typeof o=="object"?o:{status:o}}))),!skillsList||skillsList.length===0)){e.innerHTML='<div class="empty-state">No skills installed</div>';return}const t=skillsUi.search,n=skillsList.filter(s=>{const o=(s?.name||s?.id||"").toString(),a=(s?.description||"").toString(),i=(s?.skillKey||"").toString();return t?o.toLowerCase().includes(t)||a.toLowerCase().includes(t)||i.toLowerCase().includes(t):!0}).filter(s=>{if(!skillsUi.onlyInstalled)return!0;const o=s?.missing||{},a=(o.bins?.length||0)+(o.anyBins?.length||0);return(o.os||[]).length>0||a>0?!1:s?.installed===!0||s?.bundled===!0||s?.enabled!==!1}).filter(s=>skillsUi.onlyIssues?skillHasIssues(s):!0).filter(s=>{if(skillsUi.showHidden)return!0;const o=getHiddenSkills(),a=s?.skillKey||s?.name||"";return!o.includes(a)}).sort((s,o)=>(s?.name||"").localeCompare(o?.name||""));e.innerHTML=n.map(s=>{const o=s?.name||s?.id||"Unknown",a=s?.skillKey||o,i=s?.disabled?!1:s?.enabled!==!1,r=s?.eligible,l=typeof r=="boolean",d=!i||s?.disabled?"idle":r===!0?"success":r===!1?"error":"idle",c=s?.description||"",u=s?.emoji||"\u{1F9E9}",m=s?.source?`\u2022 ${escapeHtml(s.source)}`:"",g=[l?r?'<span style="font-size: 10px; color: var(--success);">Ready</span>':'<span style="font-size: 10px; color: var(--warning);">Needs attention</span>':"",s?.bundled?'<span style="font-size: 10px; color: var(--text-muted);">Bundled</span>':"",s?.always?'<span style="font-size: 10px; color: var(--text-muted);">Always</span>':""].filter(Boolean).join('<span style="opacity:.35">\u2022</span>'),f=renderInstallButtons(s),y=renderMissingBadges(s),p=s?.homepage?`<a href="${escapeHtml(s.homepage)}" target="_blank" style="font-size: 11px; color: var(--accent); text-decoration: none;">Homepage</a>`:"";return`
        <div style="background: var(--surface-1); border: 1px solid var(--border-default); border-radius: var(--radius-md); padding: 12px; margin-bottom: 10px;">
            <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 10px;">
                <div style="flex: 1; min-width: 0;">
                    <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                        <span class="status-dot ${d}"></span>
                        <span style="font-weight: 650; font-size: 14px;">${escapeHtml(u)} ${escapeHtml(o)}</span>
                        ${g?`<span style="font-size: 10px; color: var(--text-muted);">${g}</span>`:""}
                        ${m?`<span style="font-size: 10px; color: var(--text-muted);">${m}</span>`:""}
                    </div>
                    ${c?`<div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">${escapeHtml(c)}</div>`:""}
                    <div style="margin-top: 6px; display:flex; align-items:center; gap: 10px; flex-wrap: wrap;">
                        <span style="font-size: 10px; color: var(--text-faint);">skillKey: <span style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;">${escapeHtml(a)}</span></span>
                        ${p}
                    </div>
                    ${y}
                </div>

                <div style="display: flex; gap: 6px; align-items: center; flex-shrink: 0; flex-wrap: wrap; justify-content: flex-end;">
                    ${f}
                    <button onclick="viewSkillFiles('${escapeHtml(a)}', '${escapeHtml(s?.path||"")}')"
                            class="btn btn-ghost"
                            style="padding: 4px 10px; font-size: 11px;"
                            title="View and edit skill files">
                        \u{1F4C2} Files
                    </button>
                    <button onclick="toggleSkill('${escapeHtml(a)}', ${i?"false":"true"})"
                            class="btn ${i?"btn-ghost":"btn-primary"}"
                            style="padding: 4px 10px; font-size: 11px;">
                        ${i?"Disable":"Enable"}
                    </button>
                    <button onclick="promptSetApiKey('${escapeHtml(a)}', '${escapeHtml(s?.primaryEnv||"")}')" class="btn btn-ghost" style="padding: 4px 10px; font-size: 11px;">
                        Set key
                    </button>
                    <button onclick="promptSetEnv('${escapeHtml(a)}', ${escapeHtml(JSON.stringify(s?.missing?.env||[]))})" class="btn btn-ghost" style="padding: 4px 10px; font-size: 11px;">
                        Set env
                    </button>
                    ${s?.bundled?`<button onclick="toggleHideSkill('${escapeHtml(a)}')" class="btn btn-ghost" style="padding: 4px 10px; font-size: 11px; color: var(--text-muted);">
                            ${getHiddenSkills().includes(a)?"\u{1F441} Unhide":"\u{1F648} Hide"}
                          </button>`:`<button onclick="uninstallSkill('${escapeHtml(a)}')" class="btn btn-ghost" style="padding: 4px 10px; font-size: 11px; color: var(--error);">
                            \u{1F5D1} Uninstall
                          </button>`}
                </div>
            </div>
        </div>`}).join(""),e.innerHTML.trim()||(e.innerHTML='<div class="empty-state">No matching skills</div>')}function showInstallModal(e,t,n){const s=document.getElementById("skills-install-modal-title"),o=document.getElementById("skills-install-modal-subtitle"),a=document.getElementById("skills-install-modal-body");s&&(s.textContent=e||"Skill installer"),o&&(o.textContent=t||""),a&&(a.textContent=n||""),showModal("skills-install-modal")}window.installSkill=async function(e,t){if(!gateway||!gateway.isConnected()){showToast("Connect to gateway first","warning");return}showInstallModal(`Installing ${e}`,`Installer: ${t}`,"Running\u2026");try{const n=await gateway._request("skills.install",{name:e,installId:t},6e5),s=Array.isArray(n?.warnings)&&n.warnings.length>0?`

WARNINGS:
- ${n.warnings.join(`
- `)}`:"",o=[`ok: ${String(n?.ok)}`,n?.message?`message: ${n.message}`:"",typeof n?.code<"u"?`code: ${String(n.code)}`:"","",n?.stdout?`STDOUT:
${n.stdout}`:"STDOUT: (empty)","",n?.stderr?`STDERR:
${n.stderr}`:"STDERR: (empty)"].filter(Boolean).join(`
`);showInstallModal(`Install: ${e}`,`Installer: ${t}`,o+s),showToast(n?.ok?"Install complete":"Install failed",n?.ok?"success":"error"),loadSkills()}catch(n){showInstallModal(`Install: ${e}`,`Installer: ${t}`,`ERROR: ${n.message}`),showToast("Install failed: "+n.message,"error")}},window.toggleSkill=async function(e,t){try{await gateway._request("skills.update",{skillKey:e,enabled:t}),showToast(`Skill ${t?"enabled":"disabled"}`,"success"),loadSkills()}catch(n){showToast("Failed: "+n.message,"error")}},window.promptSetApiKey=async function(e,t){if(!gateway||!gateway.isConnected()){showToast("Connect to gateway first","warning");return}const n=t||`${e.toUpperCase().replace(/[^A-Z0-9]/g,"_")}_API_KEY`,s=window.prompt(`Enter API key for ${e} (${n}).

Leave blank to clear.`);if(s!==null)try{await gateway._request("skills.update",{skillKey:e,apiKey:s,env:{[n]:s}}),showToast(`Saved ${n}`,"success"),loadSkills()}catch(o){showToast("Failed: "+o.message,"error")}},window.promptSetEnv=async function(e,t){if(!gateway||!gateway.isConnected()){showToast("Connect to gateway first","warning");return}const n=Array.isArray(t)&&t.length>0?t[0]:"",s=window.prompt(`Env var name for ${e} (e.g., FOO_TOKEN).${n?`

Missing: ${t.join(", ")}`:""}

Leave blank to cancel.`,n);if(s===null)return;const o=(s||"").trim();if(!o)return;const a=window.prompt(`Enter value for ${o}.

Leave blank to clear this key.`);if(a!==null)try{await gateway._request("skills.update",{skillKey:e,env:{[o]:a}}),showToast(`Saved ${o}`,"success"),loadSkills()}catch(i){showToast("Failed: "+i.message,"error")}};let currentSkillFiles=[],currentSkillPath="",currentSkillName="",currentEditingFile=null;window.viewSkillFiles=async function(e,t){currentSkillPath=t||"",currentSkillName=e;const n=document.getElementById("skill-files-modal-title"),s=document.getElementById("skill-files-tree"),o=document.getElementById("skill-file-preview");n&&(n.textContent=`\u{1F4C2} ${e}`),s&&(s.innerHTML='<div style="color: var(--text-muted); padding: 8px;">Loading...</div>'),o&&(o.innerHTML='<div style="color: var(--text-muted); padding: 20px; text-align: center;">Select a file to view</div>'),showModal("skill-files-modal");try{const a=await fetch(`/api/skills/${encodeURIComponent(e)}/files`);if(!a.ok)throw new Error(await a.text()||"Failed to load files");const i=await a.json();if(currentSkillFiles=i?.files||[],currentSkillPath=i?.path||t||"",currentSkillFiles.length===0){s&&(s.innerHTML='<div style="color: var(--text-muted); padding: 8px;">No files found</div>');return}renderSkillFilesTree(currentSkillFiles);const r=currentSkillFiles.find(l=>l.name==="SKILL.md"||l.relativePath==="SKILL.md");r&&previewSkillFile(r.relativePath||"SKILL.md")}catch(a){console.warn("[Skills] Failed to load files:",a.message),s&&(s.innerHTML=`<div style="color: var(--error); padding: 8px;">Error: ${escapeHtml(a.message)}</div>`)}};function renderSkillFilesTree(e){const t=document.getElementById("skill-files-tree");if(!t)return;const n={};for(const s of e){const o=s.relativePath||s.name||"",a=o.split("/").filter(Boolean);let i=n;for(let r=0;r<a.length;r++){const l=a[r];r===a.length-1?(i._files||(i._files=[]),i._files.push({...s,fileName:l,relPath:o})):(i[l]||(i[l]={}),i=i[l])}}t.innerHTML=renderSkillTreeNode(n,"")}function renderSkillTreeNode(e,t){let n="";const s=Object.keys(e).filter(a=>a!=="_files").sort();for(const a of s)n+=`
        <div class="skill-tree-dir" onclick="toggleSkillTreeDir(this)" style="display: flex; align-items: center; gap: 4px; padding: 4px 8px; cursor: pointer; border-radius: 4px;">
            <span class="tree-chevron" style="font-size: 10px; color: var(--text-muted);">\u25B6</span>
            <span style="font-size: 12px;">\u{1F4C1} ${escapeHtml(a)}</span>
        </div>
        <div class="skill-tree-children hidden" style="padding-left: 16px;">
            ${renderSkillTreeNode(e[a],t?`${t}/${a}`:a)}
        </div>`;const o=e._files||[];for(const a of o.sort((i,r)=>(i.fileName||"").localeCompare(r.fileName||""))){const i=getFileIcon(a.fileName);n+=`
        <div class="skill-tree-file" onclick="previewSkillFile('${escapeHtml(a.relPath)}')"
             style="display: flex; align-items: center; gap: 4px; padding: 4px 8px; cursor: pointer; border-radius: 4px; font-size: 12px;"
             onmouseover="this.style.background='var(--surface-2)'" onmouseout="this.style.background='transparent'">
            <span>${i}</span>
            <span>${escapeHtml(a.fileName)}</span>
        </div>`}return n}function getFileIcon(e){if(!e)return"\u{1F4C4}";const t=e.split(".").pop()?.toLowerCase();return{md:"\u{1F4DD}",py:"\u{1F40D}",sh:"\u{1F527}",js:"\u{1F4DC}",json:"\u{1F4CB}",yaml:"\u{1F4CB}",yml:"\u{1F4CB}",txt:"\u{1F4C4}"}[t]||"\u{1F4C4}"}window.toggleSkillTreeDir=function(e){const t=e.nextElementSibling;if(!t)return;const n=e.querySelector(".tree-chevron");t.classList.contains("hidden")?(t.classList.remove("hidden"),n&&(n.textContent="\u25BC")):(t.classList.add("hidden"),n&&(n.textContent="\u25B6"))},window.previewSkillFile=async function(e){const t=document.getElementById("skill-file-preview");if(t){t.innerHTML='<div style="color: var(--text-muted); padding: 20px; text-align: center;">Loading...</div>',currentEditingFile=e;try{const n=await fetch(`/api/skills/${encodeURIComponent(currentSkillName)}/files/${encodeURIComponent(e)}`);if(!n.ok)throw new Error(await n.text()||"Failed to load file");const o=(await n.json())?.content||"",a=e.split("/").pop(),i=/\.(md|txt|py|sh|js|json|yaml|yml)$/i.test(a),r=!currentSkillPath.includes("/workspace/skills");t.innerHTML=`
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-bottom: 1px solid var(--border-default); background: var(--surface-1);">
                <span style="font-weight: 600; font-size: 12px; font-family: ui-monospace, monospace;">${escapeHtml(a)}</span>
                <div style="display: flex; gap: 6px; align-items: center;">
                    ${r?'<span style="font-size: 10px; color: var(--warning);">Read-only (bundled)</span>':""}
                    ${i&&!r?`<button onclick="editSkillFile('${escapeHtml(e)}')" class="btn btn-primary" style="font-size: 11px; padding: 4px 10px;">Edit</button>`:""}
                </div>
            </div>
            <pre id="skill-file-content" style="padding: 12px; margin: 0; font-size: 11px; line-height: 1.5; white-space: pre-wrap; word-break: break-word; overflow-y: auto; flex: 1; background: var(--surface-0); color: var(--text-primary);">${escapeHtml(o)}</pre>
        `}catch(n){t.innerHTML=`<div style="color: var(--error); padding: 20px;">Error: ${escapeHtml(n.message)}</div>`}}},window.editSkillFile=async function(e){const t=document.getElementById("skill-file-preview");if(t)try{const n=await fetch(`/api/skills/${encodeURIComponent(currentSkillName)}/files/${encodeURIComponent(e)}`);if(!n.ok)throw new Error(await n.text()||"Failed to load file");const o=(await n.json())?.content||"",a=e.split("/").pop();t.innerHTML=`
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-bottom: 1px solid var(--border-default); background: var(--surface-1);">
                <span style="font-weight: 600; font-size: 12px; font-family: ui-monospace, monospace;">\u270F\uFE0F Editing: ${escapeHtml(a)}</span>
                <div style="display: flex; gap: 6px;">
                    <button onclick="previewSkillFile('${escapeHtml(e)}')" class="btn btn-ghost" style="font-size: 11px; padding: 4px 10px;">Cancel</button>
                    <button onclick="saveSkillFile('${escapeHtml(e)}')" class="btn btn-primary" style="font-size: 11px; padding: 4px 10px;">\u{1F4BE} Save</button>
                </div>
            </div>
            <textarea id="skill-file-editor" style="width: 100%; flex: 1; padding: 12px; margin: 0; font-size: 11px; line-height: 1.5; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; border: none; resize: none; background: var(--surface-0); color: var(--text-primary);">${escapeHtml(o)}</textarea>
        `;const i=document.getElementById("skill-file-editor");i&&i.focus()}catch(n){showToast("Failed to load file: "+n.message,"error")}},window.uninstallSkill=async function(e){if(confirm(`Uninstall "${e}"? This will permanently delete the skill directory.`))try{const t=await fetch(`/api/skills/${encodeURIComponent(e)}`,{method:"DELETE"}),n=await t.json();if(!t.ok){showToast(n.error||"Uninstall failed","error");return}showToast(`${e} uninstalled`,"success"),loadSkills()}catch(t){showToast("Uninstall failed: "+t.message,"error")}},window.toggleHideSkill=function(e){const t=getHiddenSkills(),n=t.indexOf(e);n>=0?(t.splice(n,1),showToast(`${e} unhidden`,"success")):(t.push(e),showToast(`${e} hidden`,"success")),setHiddenSkills(t),renderSkills()},window.saveSkillFile=async function(e){const t=document.getElementById("skill-file-editor");if(!t)return;const n=t.value;try{const s=await fetch(`/api/skills/${encodeURIComponent(currentSkillName)}/files/${encodeURIComponent(e)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:n})});if(!s.ok){const o=await s.json().catch(()=>({}));throw new Error(o.error||"Failed to save file")}showToast("File saved","success"),previewSkillFile(e)}catch(s){showToast("Failed to save: "+s.message,"error")}};function renderSystemPage(){const e=document.getElementById("system-page-messages");if(!e)return;const t=state.system?.messages||[];if(e.innerHTML="",t.length===0){e.innerHTML=`
            <div class="chat-page-empty">
                <div class="chat-page-empty-icon">\u2699\uFE0F</div>
                <div class="chat-page-empty-text">
                    No system messages yet. This tab shows heartbeats, errors, and other system noise.
                </div>
            </div>
        `;return}t.forEach(n=>{const s=createSystemMessage(n);s&&e.appendChild(s)}),e.scrollTop=e.scrollHeight}function createSystemMessage(e){if(!e||typeof e.text!="string")return null;const t=document.createElement("div");t.className="system-message";const n=document.createElement("div");n.className="system-bubble";const s=document.createElement("div");s.className="system-bubble-header";const o=document.createElement("span");o.className="system-sender",o.textContent=e.from==="solobot"?"SoLoBot (System)":"System";const a=document.createElement("span");a.className="system-bubble-time",a.textContent=formatTime(e.time),s.appendChild(o),s.appendChild(a),n.appendChild(s);const i=document.createElement("div");return i.className="system-bubble-content",i.textContent=e.text,n.appendChild(i),t.appendChild(n),t}async function clearSystemHistory(){await showConfirm("Clear all system messages?","Clear History")&&(state.system.messages=[],persistSystemMessages(),renderSystemPage(),showToast("System messages cleared","success"))}function render(e={}){try{renderStatus(),renderConsole(),renderTasks(),renderNotes(),renderActivity(),renderDocs(),renderChat(),renderChatPage(),e.includeSystem&&renderSystemPage(),renderBulkActionBar(),updateArchiveBadge(),window.setupScrollContainment&&window.setupScrollContainment()}catch(t){console.error("[render] Error during render:",t)}}function renderStatus(){const e=document.getElementById("status-indicator"),t=document.getElementById("status-text"),n=document.getElementById("model-name"),s=document.getElementById("current-task"),o=document.getElementById("task-name"),a=document.getElementById("subagent-banner"),i=document.getElementById("subagent-task");if(e)switch(e.className="status-dot",state.status){case"working":e.classList.add("success","pulse");break;case"thinking":e.classList.add("warning","pulse");break;case"offline":e.classList.add("error");break;default:e.classList.add("success")}if(t)switch(state.status){case"working":t.textContent="WORKING";break;case"thinking":t.textContent="THINKING";break;case"offline":t.textContent="OFFLINE";break;default:t.textContent="IDLE"}n&&(n.textContent=state.model||"opus 4.5");const r=document.getElementById("provider-name");r&&(r.textContent=state.provider||"anthropic"),state.currentTask?(s?.classList.remove("hidden"),o&&(o.textContent=state.currentTask)):s?.classList.add("hidden"),state.subagent?(a?.classList.remove("hidden"),i&&(i.textContent=state.subagent)):a?.classList.add("hidden")}function renderConsole(){const e=state.live||{status:"idle"},t=state.console||{logs:[]},n=document.getElementById("console-status-badge");if(n){const o={working:{text:"WORKING",badgeClass:"badge-success"},thinking:{text:"THINKING",badgeClass:"badge-warning"},idle:{text:"IDLE",badgeClass:"badge-success"},offline:{text:"OFFLINE",badgeClass:"badge-default"}},a=o[e.status]||o.idle;n.textContent=a.text,n.className=`badge ${a.badgeClass}`}const s=document.getElementById("console-output");s&&t.logs&&t.logs.length>0&&(s.innerHTML=t.logs.map(o=>{const a=formatTimeShort(o.time),i=getLogColor(o.type),r=getLogPrefix(o.type);return`<div class="${i}"><span class="info">[${a}]</span> ${r}${escapeHtml(o.text)}</div>`}).join(""),s.scrollTop=s.scrollHeight)}function renderBulkActionBar(){const e=document.getElementById("bulk-action-bar");if(e)if(selectedTasks.size>0){e.classList.add("visible");const t=document.getElementById("bulk-count");t&&(t.textContent=`${selectedTasks.size} selected`)}else e.classList.remove("visible")}function showModal(e){document.getElementById(e)?.classList.add("visible")}function hideModal(e){document.getElementById(e)?.classList.remove("visible")}async function openSettingsModal(){showModal("settings-modal");const e=document.getElementById("setting-memory-layout");e&&window._memoryCards&&(e.value=window._memoryCards.getLayout());try{const i=await(await fetch("/api/models/current")).json();document.getElementById("current-provider-display").textContent=i.provider,document.getElementById("current-model-display").textContent=i.modelId,document.getElementById("setting-provider").value=i.provider,await updateModelDropdown(i.provider);const r=document.getElementById("setting-model");r&&i.modelId&&(r.value=i.modelId)}catch(a){console.error("[Dashboard] Failed to get current model:",a),document.getElementById("current-provider-display").textContent="anthropic",document.getElementById("current-model-display").textContent="anthropic/claude-opus-4-5",document.getElementById("setting-provider").value="anthropic",await updateModelDropdown("anthropic");const i=document.getElementById("setting-model");i&&(i.value="anthropic/claude-opus-4-5")}const t=document.getElementById("gateway-host"),n=document.getElementById("gateway-port"),s=document.getElementById("gateway-token"),o=document.getElementById("gateway-session");t&&(t.value=GATEWAY_CONFIG.host||""),n&&(n.value=GATEWAY_CONFIG.port||443),s&&(s.value=GATEWAY_CONFIG.token||""),o&&(o.value=GATEWAY_CONFIG.sessionKey||"agent:main:main")}function closeSettingsModal(){hideModal("settings-modal")}function syncFromVPS(){loadState().then(()=>{render(),updateLastSync()})}function openAddTask(e="todo"){newTaskColumn=e,showModal("add-task-modal"),document.getElementById("new-task-title")?.focus()}function closeAddTask(){hideModal("add-task-modal");const e=document.getElementById("new-task-title");e&&(e.value="")}function setTaskPriority(e){newTaskPriority=e,[0,1,2].forEach(t=>{const n=document.getElementById(`priority-btn-${t}`);n&&n.classList.toggle("bg-opacity-50",t!==e)})}function submitTask(){const t=document.getElementById("new-task-title")?.value?.trim();if(!t)return;const n={id:"t"+Date.now(),title:t,priority:newTaskPriority,created:Date.now()};state.tasks[newTaskColumn].push(n),saveState("Added task: "+t),closeAddTask(),renderTasks()}function openActionModal(e,t){currentModalTask=e,currentModalColumn=t;const n=state.tasks[t]?.find(s=>s.id===e);n&&(document.getElementById("action-modal-task-title").textContent=n.title,document.getElementById("action-priority-text").textContent=`Change Priority (P${n.priority})`,["todo","progress","done","archive"].forEach(s=>{const o=document.getElementById(`action-move-${s}`);o&&o.classList.toggle("hidden",s===t)}),showModal("task-action-modal"))}function closeActionModal(){hideModal("task-action-modal"),currentModalTask=null,currentModalColumn=null}function modalMoveTask(e){if(!currentModalTask||!currentModalColumn)return;const t=state.tasks[currentModalColumn].findIndex(s=>s.id===currentModalTask);if(t===-1)return;const[n]=state.tasks[currentModalColumn].splice(t,1);state.tasks[e].push(n),saveState(`Moved task to ${e}`),closeActionModal(),renderTasks(),updateArchiveBadge()}function modalEditTitle(){if(!currentModalTask||!currentModalColumn)return;const e=state.tasks[currentModalColumn]?.find(t=>t.id===currentModalTask);e&&(closeActionModal(),document.getElementById("edit-title-input").value=e.title,showModal("edit-title-modal"),document.getElementById("edit-title-input")?.focus())}function closeEditTitleModal(){hideModal("edit-title-modal")}function saveEditedTitle(){if(!currentModalTask||!currentModalColumn)return;const e=state.tasks[currentModalColumn]?.find(n=>n.id===currentModalTask);if(!e)return;const t=document.getElementById("edit-title-input")?.value?.trim();t&&(e.title=t,saveState("Edited task title"),renderTasks()),closeEditTitleModal()}function modalCyclePriority(){if(!currentModalTask||!currentModalColumn)return;const e=state.tasks[currentModalColumn]?.find(t=>t.id===currentModalTask);e&&(e.priority=(e.priority+1)%3,document.getElementById("action-priority-text").textContent=`Change Priority (P${e.priority})`,saveState("Changed priority"),renderTasks())}function modalDeleteTask(){document.getElementById("delete-modal-task-title").textContent=state.tasks[currentModalColumn]?.find(e=>e.id===currentModalTask)?.title||"",closeActionModal(),showModal("confirm-delete-modal")}function closeDeleteModal(){hideModal("confirm-delete-modal")}function confirmDeleteTask(){if(!currentModalTask||!currentModalColumn)return;const e=state.tasks[currentModalColumn].findIndex(t=>t.id===currentModalTask);e!==-1&&(state.tasks[currentModalColumn].splice(e,1),saveState("Deleted task"),renderTasks()),closeDeleteModal()}function quickMoveTask(e,t,n,s){s?.stopPropagation();const o=state.tasks[t].findIndex(i=>i.id===e);if(o===-1)return;const[a]=state.tasks[t].splice(o,1);state.tasks[n].push(a),saveState(`Moved task to ${n}`),renderTasks()}function toggleTaskSelection(e,t){t?.stopPropagation(),selectedTasks.has(e)?selectedTasks.delete(e):selectedTasks.add(e),renderTasks(),typeof renderBulkActionBar=="function"&&renderBulkActionBar()}function selectAllTasks(){["todo","progress","done"].forEach(e=>{state.tasks[e].forEach(t=>selectedTasks.add(t.id))}),renderTasks(),typeof renderBulkActionBar=="function"&&renderBulkActionBar()}function clearSelection(){selectedTasks.clear(),renderTasks(),typeof renderBulkActionBar=="function"&&renderBulkActionBar()}function bulkMoveTo(e){selectedTasks.size!==0&&(selectedTasks.forEach(t=>{["todo","progress","done"].forEach(n=>{const s=state.tasks[n].findIndex(o=>o.id===t);if(s!==-1){const[o]=state.tasks[n].splice(s,1);state.tasks[e].push(o)}})}),saveState(`Bulk moved ${selectedTasks.size} tasks to ${e}`),clearSelection(),renderTasks(),updateArchiveBadge())}function clearDone(){const e=state.tasks.done.splice(0);state.tasks.archive.push(...e),saveState("Archived done tasks"),renderTasks(),updateArchiveBadge()}function openArchiveModal(){renderArchive(),showModal("archive-modal")}function renderArchive(){const e=document.getElementById("archive-tasks-list"),t=document.getElementById("archive-modal-count");if(!e)return;const n=state.tasks.archive||[];t&&(t.textContent=n.length),e.innerHTML=n.map(s=>`
        <div class="task-card" style="display: flex; align-items: center; justify-content: space-between;">
            <div>
                <span class="task-title">${escapeHtml(s.title)}</span>
                <div class="task-meta">${formatTime(s.created)}</div>
            </div>
            <button onclick="restoreFromArchive('${s.id}')" class="btn btn-ghost" style="font-size: 12px;">
                Restore
            </button>
        </div>
    `).join("")||'<div style="color: var(--text-muted); font-size: 13px; text-align: center; padding: var(--space-8);">No archived tasks</div>'}function closeArchiveModal(){hideModal("archive-modal")}function restoreFromArchive(e){const t=state.tasks.archive.findIndex(s=>s.id===e);if(t===-1)return;const[n]=state.tasks.archive.splice(t,1);state.tasks.todo.push(n),saveState("Restored task from archive"),renderArchive(),renderTasks(),updateArchiveBadge()}async function clearArchive(){await showConfirm("Delete all archived tasks permanently?","Clear Archive","Delete All")&&(state.tasks.archive=[],saveState("Cleared archive"),renderArchive(),updateArchiveBadge(),showToast("Archive cleared","success"))}function addNote(){const e=document.getElementById("note-input"),t=e?.value?.trim();t&&(state.notes.push({id:"n"+Date.now(),text:t,created:Date.now(),seen:!1}),e.value="",saveState("Added note"),renderNotes())}function clearConsole(){state.console&&(state.console.logs=[]),saveState(),renderConsole()}function addTerminalLog(e,t="info",n=null){state.console||(state.console={logs:[]});const s={time:n||Date.now(),text:e,type:t},o=state.console.logs[state.console.logs.length-1];o&&o.text===e&&Math.abs(s.time-o.time)<5e3||(state.console.logs.push(s),state.console.logs.length>500&&(state.console.logs=state.console.logs.slice(-500)),renderConsole())}let lastActivitySync=0;async function syncActivitiesFromFile(){try{if(!gateway||!gateway.isConnected())return;const e=await fetch("/api/memory/recent-activity.json");if(!e.ok)return;const t=await e.json(),n=typeof t.content=="string"?JSON.parse(t.content):t.content;if(!n||!n.activities||n.updatedMs<=lastActivitySync)return;lastActivitySync=n.updatedMs;const s=n.activities.map(i=>({time:i.timestamp,text:i.text,type:"info"}));state.console||(state.console={logs:[]});const o=new Set(state.console.logs.map(i=>`${i.time}-${i.text}`));let a=0;for(const i of s){const r=`${i.time}-${i.text}`;o.has(r)||(state.console.logs.push(i),o.add(r),a++)}a>0&&(state.console.logs.sort((i,r)=>i.time-r.time),state.console.logs=state.console.logs.slice(-100),renderConsole())}catch{}}setInterval(syncActivitiesFromFile,3e4),setTimeout(syncActivitiesFromFile,2e3);function toggleConsoleExpand(){const e=document.getElementById("console-section"),t=document.getElementById("console-output"),n=document.getElementById("console-expand-btn");if(!e||!t||!n)return;t.classList.contains("h-[500px]")?(t.classList.remove("h-[500px]"),t.classList.add("h-[250px]"),n.textContent="Expand"):(t.classList.remove("h-[250px]"),t.classList.add("h-[500px]"),n.textContent="Collapse")}function updateSetting(e,t){if(e==="provider"||e==="model"){console.warn(`[Dashboard] Cannot change ${e} from dashboard - must be configured at OpenClaw gateway level`),showToast(`${e.charAt(0).toUpperCase()+e.slice(1)} must be configured at OpenClaw gateway level`,"warning");return}localStorage.setItem(`setting_${e}`,JSON.stringify(t))}async function resetToServerState(){await showConfirm("This will reload all data from the server. Continue?","Reset to Server","Reload")&&(localStorage.removeItem("solovision-dashboard"),location.reload())}async function clearAllData(){await showConfirm("This will delete ALL local data. Are you sure?","\u26A0\uFE0F Delete All Data","Delete Everything")&&(localStorage.clear(),state={status:"idle",model:"opus 4.5",tasks:{todo:[],progress:[],done:[],archive:[]},notes:[],activity:[],docs:[],console:{logs:[]},chat:{messages:[]}},saveState(),render())}let draggedTaskId=null,draggedFromColumn=null;function handleDragStart(e,t,n){draggedTaskId=t,draggedFromColumn=n,e.dataTransfer.effectAllowed="move";const s=e.target.closest(".task-card");s&&s.classList.add("opacity-50")}function handleDragEnd(e){const t=e.target.closest(".task-card");t&&t.classList.remove("opacity-50"),draggedTaskId=null,draggedFromColumn=null,document.querySelectorAll(".drop-zone").forEach(n=>{n.classList.remove("bg-slate-600/30","ring-2","ring-solo-primary")})}function handleDragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="move"}function handleDragEnter(e,t){e.preventDefault(),document.getElementById(`${t==="progress"?"progress":t}-tasks`)?.classList.add("bg-slate-600/30","ring-2","ring-solo-primary")}function handleDragLeave(e,t){document.getElementById(`${t==="progress"?"progress":t}-tasks`)?.classList.remove("bg-slate-600/30","ring-2","ring-solo-primary")}function handleDrop(e,t){if(e.preventDefault(),document.getElementById(`${t==="progress"?"progress":t}-tasks`)?.classList.remove("bg-slate-600/30","ring-2","ring-solo-primary"),!draggedTaskId||!draggedFromColumn||draggedFromColumn===t)return;const s=state.tasks[draggedFromColumn].findIndex(a=>a.id===draggedTaskId);if(s===-1)return;const[o]=state.tasks[draggedFromColumn].splice(s,1);state.tasks[t].push(o),saveState(`Moved task to ${t}`),renderTasks()}function closeAllTaskMenus(){document.querySelectorAll(".task-menu").forEach(e=>e.classList.add("hidden"))}let cronJobs=[],cronInterval=null;function initCronPage(){loadCronJobs(),cronInterval&&clearInterval(cronInterval),cronInterval=setInterval(loadCronJobs,3e4)}async function loadCronJobs(){const e=document.getElementById("cron-jobs-list");if(e){if(!gateway||!gateway.isConnected()){e.innerHTML='<div class="empty-state">Connect to gateway to manage cron jobs</div>';return}try{const t=await gateway._request("cron.list",{});cronJobs=t?.jobs||t||[],renderCronJobs()}catch(t){console.warn("[Cron] Failed to fetch jobs:",t.message),e.innerHTML='<div class="empty-state">Could not load cron jobs. The cron RPC may not be available.</div>'}}}function renderCronJobs(){const e=document.getElementById("cron-jobs-list");if(e){if(cronJobs.length===0){e.innerHTML='<div class="empty-state">No cron jobs configured</div>';return}e.innerHTML=cronJobs.map((t,n)=>{const s=t.enabled!==!1,o=t.lastRunStatus||t.lastStatus||"--",a=o==="success"?"success":o==="error"?"error":"",i=t.nextRun?new Date(t.nextRun).toLocaleString():"--",r=t.lastRun?timeAgo(new Date(t.lastRun).getTime()):"Never";return`
        <div class="cron-job-card" style="background: var(--surface-1); border: 1px solid var(--border-default); border-radius: var(--radius-md); padding: 12px; margin-bottom: 8px;">
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">
                <div style="flex: 1; min-width: 0;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-weight: 600; font-size: 14px;">${escapeHtml(t.name||t.id||"Unnamed Job")}</span>
                        ${s?"":'<span class="badge" style="background: var(--surface-2); font-size: 10px;">Disabled</span>'}
                        ${a?`<span class="badge badge-${a}" style="font-size: 10px;">${o}</span>`:""}
                    </div>
                    <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">
                        <code style="background: var(--surface-2); padding: 1px 4px; border-radius: 3px; font-size: 11px;">${escapeHtml(t.schedule||t.cron||"--")}</code>
                        <span style="margin-left: 8px;">Next: ${i}</span>
                        <span style="margin-left: 8px;">Last: ${r}</span>
                    </div>
                    ${t.description?`<div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">${escapeHtml(t.description)}</div>`:""}
                </div>
                <div style="display: flex; gap: 4px; align-items: center; flex-shrink: 0;">
                    <button onclick="toggleCronJob('${t.id||n}', ${!s})" class="btn btn-ghost" style="padding: 4px 8px; font-size: 11px;" title="${s?"Disable":"Enable"}">
                        ${s?"\u23F8":"\u25B6"}
                    </button>
                    <button onclick="runCronJob('${t.id||n}')" class="btn btn-ghost" style="padding: 4px 8px; font-size: 11px;" title="Run Now">
                        \u{1F680}
                    </button>
                    <button onclick="showCronHistory('${t.id||n}')" class="btn btn-ghost" style="padding: 4px 8px; font-size: 11px;" title="History">
                        \u{1F4CB}
                    </button>
                </div>
            </div>
            <div id="cron-history-${t.id||n}" class="cron-history hidden" style="margin-top: 8px; border-top: 1px solid var(--border-default); padding-top: 8px;"></div>
        </div>`}).join("")}}async function toggleCronJob(e,t){try{await gateway._request("cron.toggle",{id:e,enabled:t}),showToast(`Job ${t?"enabled":"disabled"}`,"success"),loadCronJobs()}catch(n){showToast("Failed: "+n.message,"error")}}async function runCronJob(e){try{await gateway._request("cron.run",{id:e}),showToast("Job triggered","success")}catch(t){showToast("Failed: "+t.message,"error")}}async function showCronHistory(e){const t=document.getElementById(`cron-history-${e}`);if(t){if(!t.classList.contains("hidden")){t.classList.add("hidden");return}t.innerHTML='<div style="font-size: 11px; color: var(--text-muted);">Loading...</div>',t.classList.remove("hidden");try{const s=(await gateway._request("cron.runs",{id:e,limit:10}))?.runs||[];if(s.length===0){t.innerHTML='<div style="font-size: 11px; color: var(--text-muted);">No run history</div>';return}t.innerHTML=s.map(o=>{const a=o.status||"unknown",i=o.startedAt?new Date(o.startedAt).toLocaleString():"--";return`<div style="font-size: 11px; padding: 2px 0;"><span style="${a==="success"?"color: var(--success)":a==="error"?"color: var(--error)":""}">${a}</span> \u2014 ${i}${o.duration?` (${o.duration}ms)`:""}</div>`}).join("")}catch{t.innerHTML='<div style="font-size: 11px; color: var(--error);">Failed to load history</div>'}}}window.openAddCronModal=function(){const e=document.getElementById("add-cron-modal");e&&e.classList.add("visible")},window.closeAddCronModal=function(){const e=document.getElementById("add-cron-modal");e&&e.classList.remove("visible")},window.submitNewCronJob=async function(){const e=document.getElementById("cron-new-name")?.value?.trim(),t=document.getElementById("cron-new-schedule")?.value?.trim(),n=document.getElementById("cron-new-command")?.value?.trim();if(!e||!t){showToast("Name and schedule are required","warning");return}try{await gateway._request("cron.add",{name:e,schedule:t,command:n}),showToast("Cron job added","success"),closeAddCronModal(),loadCronJobs()}catch(s){showToast("Failed: "+s.message,"error")}};let healthTestResults={},healthTestInProgress=!1,pendingHealthChecks=new Map;function initHealthPage(){updateHealthGatewayStatus(),loadHealthModels()}function updateHealthGatewayStatus(){const e=document.getElementById("health-gateway-status");e&&(gateway&&gateway.isConnected()?e.innerHTML=`
            <span style="font-size: 20px;">\u2705</span>
            <span style="font-weight: 500; color: var(--success);">Connected</span>
        `:e.innerHTML=`
            <span style="font-size: 20px;">\u274C</span>
            <span style="font-weight: 500; color: var(--error);">Disconnected</span>
        `)}async function loadHealthModels(){try{const e=await fetch("/api/models/list");if(!e.ok)throw new Error("Failed to fetch models");const t=await e.json();let n=[];if(t.models)n=t.models;else for(const o of Object.keys(t))Array.isArray(t[o])&&(n=n.concat(t[o]));const s=document.getElementById("health-model-count");return s&&(s.textContent=n.length),renderHealthModelList(n,{}),n}catch(e){console.error("[Health] Failed to load models:",e);const t=document.getElementById("health-model-count");return t&&(t.textContent="?"),[]}}async function testSingleModel(e){const t=Date.now();try{if(!gateway||!gateway.isConnected())return{success:!1,error:"Gateway not connected",latencyMs:Date.now()-t};const n="health-check-"+e.replace(/\//g,"-").replace(/[^a-zA-Z0-9-]/g,"");console.log(`[Health] Setting model for session ${n} to ${e}`);try{await gateway._request("sessions.patch",{key:n,model:e},1e4)}catch(i){return console.error(`[Health] Failed to patch session model: ${i.message}`),{success:!1,error:`Model config failed: ${i.message}`,latencyMs:Date.now()-t}}const s=new Promise((i,r)=>{const l=setTimeout(()=>{pendingHealthChecks.has(n)&&(pendingHealthChecks.delete(n),r(new Error("Response timeout (60s)")))},6e4);pendingHealthChecks.set(n,{resolve:d=>{clearTimeout(l),i(d)},reject:d=>{clearTimeout(l),r(d)}})});console.log(`[Health] Sending test message to ${e}`),await gateway._request("chat.send",{message:"Respond with exactly: OK",sessionKey:n,idempotencyKey:crypto.randomUUID()},1e4);const o=await s,a=Date.now()-t;return{success:!0,response:o?.content||"OK",latencyMs:a}}catch(n){return{success:!1,error:n.message||"Test failed",latencyMs:Date.now()-t}}}window.runAllModelTests=async function(){if(healthTestInProgress){showToast("Health check already in progress","warning");return}healthTestInProgress=!0,healthTestResults={};const e=document.getElementById("test-all-btn"),t=document.getElementById("health-test-progress");e&&(e.disabled=!0,e.innerHTML="\u23F3 Testing...");try{const n=await loadHealthModels();if(n.length===0){showToast("No models found to test","warning");return}n.forEach(r=>{healthTestResults[r.id]={status:"testing"}}),renderHealthModelList(n,healthTestResults);let s=0,o=0,a=0;for(const r of n){s++,t&&(t.textContent=`Testing ${s}/${n.length}...`);const l=await testSingleModel(r.id);healthTestResults[r.id]={status:l.success?"success":"error",error:l.error,latencyMs:l.latencyMs,response:l.response},l.success?o++:a++,renderHealthModelList(n,healthTestResults)}const i=document.getElementById("health-last-test");i&&(i.textContent=new Date().toLocaleTimeString()),t&&(t.textContent=`\u2705 ${o} passed, \u274C ${a} failed`),showToast(`Health check complete: ${o}/${n.length} models working`,a>0?"warning":"success")}catch(n){console.error("[Health] Test failed:",n),showToast("Health check failed: "+n.message,"error")}finally{healthTestInProgress=!1,e&&(e.disabled=!1,e.innerHTML="\u{1F680} Test All Models")}};function renderHealthModelList(e,t){const n=document.getElementById("health-model-list");if(n){if(e.length===0){n.innerHTML=`
            <div style="padding: var(--space-4); color: var(--text-muted); text-align: center;">
                <p>No models available. Check gateway connection.</p>
            </div>
        `;return}n.innerHTML=e.map(s=>{const o=t[s.id]||{status:"pending"};let a,i,r;switch(o.status){case"success":a="\u2705",i="var(--success)",r=`${o.latencyMs}ms`;break;case"error":a="\u274C",i="var(--error)",r=o.error||"Failed";break;case"testing":a="\u23F3",i="var(--warning)",r="Testing...";break;default:a="\u26AA",i="var(--text-muted)",r="Not tested"}const l=window.getProviderFromModelId?window.getProviderFromModelId(s.id):s.id.split("/")[0]||"unknown",d=s.id.split("/").slice(1).join("/")||s.id;return`
            <div style="display: flex; align-items: center; justify-content: space-between; padding: var(--space-3) var(--space-4); border-bottom: 1px solid var(--border-subtle);">
                <div style="display: flex; align-items: center; gap: var(--space-3);">
                    <span style="font-size: 18px;">${a}</span>
                    <div>
                        <div style="font-weight: 500; color: var(--text-primary);">${d}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">
                            <span style="background: var(--surface-3); padding: 1px 6px; border-radius: 3px;">${l}</span>
                            ${s.displayName?`<span style="margin-left: 8px;">${s.displayName}</span>`:""}
                        </div>
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="color: ${i}; font-size: 13px; font-weight: 500; margin-bottom: 2px;">${r}</div>
                    ${o.status!=="testing"&&!healthTestInProgress?`
                        <button onclick="testSingleModelUI('${s.id}')" class="btn btn-ghost" style="font-size: 10px; padding: 1px 6px; height: auto;">
                            ${o.status==="pending"?"Test":"Re-test"}
                        </button>
                    `:""}
                </div>
            </div>
        `}).join("")}}window.testSingleModelUI=async function(e){const t=await loadHealthModels();healthTestResults[e]={status:"testing"},renderHealthModelList(t,healthTestResults);const n=await testSingleModel(e);healthTestResults[e]={status:n.success?"success":"error",error:n.error,latencyMs:n.latencyMs},renderHealthModelList(t,healthTestResults),showToast(n.success?`${e.split("/").pop()} is working!`:`${e.split("/").pop()} failed: ${n.error}`,n.success?"success":"error")};const originalShowPage=window.showPage;typeof originalShowPage=="function"&&(window.showPage=function(e,t=!0){originalShowPage(e,t),e==="health"&&initHealthPage(),e==="chat"&&forceRefreshHistory()});const CHAT_DEBUG=!1;function chatLog(...e){CHAT_DEBUG&&console.log(...e)}function linkifyText(e){return e?e.split(/(```[\s\S]*?```|`[^`]+`)/g).map((n,s)=>{if(s%2===1)return n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");let o=n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");return o=o.replace(/\[([^\]]+)\]\((https?:\/\/[^\)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>'),o=o.replace(/(^|[^"'>])(https?:\/\/[^\s<]+)/g,'$1<a href="$2" target="_blank" rel="noopener noreferrer">$2</a>'),o=o.replace(/\n/g,"<br>"),o}).join(""):""}function getBestModel(e){const t=n=>!n||n==="unknown"||n==="openrouter/free"||n==="free";return t(e?.model)?t(window._lastResponseModel)?{model:window.currentModel,provider:window.currentProvider}:{model:window._lastResponseModel,provider:window._lastResponseProvider}:{model:e.model,provider:e.provider}}function formatModelDisplay(e,t){return e?e.startsWith("openrouter/")?e.replace("openrouter/","openrouter "):t==="openrouter"?"openrouter "+e:e.includes("/")?e:t?`${t}/${e}`:e:""}let voiceRecognition=null,voiceInputState="idle",voiceAutoSend=localStorage.getItem("voice_auto_send")==="true",lastVoiceTranscript="",accumulatedTranscript="";function showLiveTranscriptIndicator(){}function hideLiveTranscriptIndicator(){}function updateLiveTranscriptIndicator(e,t){}function initVoiceInput(){const e=window.SpeechRecognition||window.webkitSpeechRecognition,t=[document.getElementById("voice-input-btn"),document.getElementById("voice-input-btn-chatpage")];if(!e){for(const n of t)n&&(n.disabled=!0,n.title="Voice input not supported in this browser",n.innerHTML='<span class="voice-unsupported">\u{1F3A4}\u2717</span>');chatLog("[Voice] Web Speech API not supported");return}t.every(n=>!n)||(voiceRecognition=new e,voiceRecognition.continuous=!0,voiceRecognition.interimResults=!0,voiceRecognition.lang="en-US",voiceRecognition.maxAlternatives=1,voiceRecognition.onstart=()=>{chatLog("[Voice] Started listening, target input:",activeVoiceTarget),setVoiceState("listening");const n=document.getElementById(activeVoiceTarget);n&&(n.focus(),n.placeholder="Listening... (speak now)",accumulatedTranscript&&(n.value=accumulatedTranscript))},voiceRecognition.onaudiostart=()=>{chatLog("[Voice] Audio capture started - microphone is working")},voiceRecognition.onsoundstart=()=>{chatLog("[Voice] Sound detected")},voiceRecognition.onspeechstart=()=>{chatLog("[Voice] Speech detected - processing...");const n=document.getElementById(activeVoiceTarget);n&&(n.placeholder="Hearing you...")},voiceRecognition.onresult=n=>{chatLog("[Voice] onresult fired, resultIndex:",n.resultIndex,"results.length:",n.results.length,"target:",activeVoiceTarget);const s=document.getElementById(activeVoiceTarget);if(!s){console.error("[Voice] Input not found:",activeVoiceTarget,"- trying fallback");const l=document.getElementById("chat-page-input")||document.getElementById("chat-input");if(!l){console.error("[Voice] No input found at all!");return}chatLog("[Voice] Using fallback input:",l.id)}const o=s||document.getElementById("chat-page-input")||document.getElementById("chat-input");chatLog("[Voice] Updating input element:",o?.id,o?.tagName);let a="",i="";for(let l=0;l<n.results.length;l++){const d=n.results[l],c=d[0].transcript,u=d[0].confidence;chatLog(`[Voice] Result[${l}]: isFinal=${d.isFinal}, confidence=${u?.toFixed(2)||"n/a"}, text="${c}"`),d.isFinal?i+=c:a+=c}i&&(accumulatedTranscript&&!accumulatedTranscript.endsWith(" ")&&(accumulatedTranscript+=" "),accumulatedTranscript+=i);const r=accumulatedTranscript+a;chatLog("[Voice] Display text:",r,"(accumulated:",accumulatedTranscript.length,"interim:",a.length,")"),chatLog("[Voice] Setting targetInput.value to:",r),o.value=r,a?(o.style.fontStyle="italic",o.style.color="var(--text-secondary)"):i&&(o.style.fontStyle="normal",o.style.color="var(--text-primary)"),o.dispatchEvent(new Event("input",{bubbles:!0})),o.focus(),o.setSelectionRange&&o.setSelectionRange(o.value.length,o.value.length),i&&(lastVoiceTranscript=i,chatLog("[Voice] Final transcript stored:",i))},voiceRecognition.onerror=n=>{console.error("[Voice] Error:",n.error,n.message||""),n.error==="not-allowed"?(setVoiceState("idle"),showToast("Microphone access denied. Click the lock icon in your browser address bar to allow.","error")):n.error==="no-speech"?(chatLog("[Voice] No speech detected yet, still listening..."),(!voiceRecognition||voiceInputState!=="listening")&&showToast("No speech detected. Make sure your microphone is working.","info")):n.error==="audio-capture"?(setVoiceState("idle"),showToast("No microphone found. Please connect a microphone and try again.","error")):n.error==="network"?(setVoiceState("idle"),showToast("Network error. Speech recognition requires internet connection.","error")):n.error!=="aborted"&&(setVoiceState("idle"),showToast(`Voice error: ${n.error}`,"error"))},voiceRecognition.onend=()=>{chatLog("[Voice] Ended, accumulated transcript:",accumulatedTranscript);for(const n of["chat-input","chat-page-input"]){const s=document.getElementById(n);s&&(s.style.fontStyle="normal",s.style.color="var(--text-primary)",n==="chat-input"?s.placeholder="Type a message...":s.placeholder="Message SoLoBot...")}if(voiceAutoSend&&accumulatedTranscript.trim()){chatLog("[Voice] Auto-sending:",accumulatedTranscript),activeVoiceTarget==="chat-page-input"?sendChatPageMessage():sendChatMessage(),accumulatedTranscript="";const n=document.getElementById(activeVoiceTarget);n&&(n.value="")}setVoiceState("idle"),activeVoiceTarget="chat-input"},chatLog("[Voice] Initialized successfully"))}function startVoiceInput(){if(voiceRecognition)try{voiceRecognition.start(),chatLog("[Voice] Starting...")}catch(e){console.error("[Voice] Start error:",e),e.message.includes("already started")&&stopVoiceInput()}}function stopVoiceInput(){if(voiceRecognition)try{voiceRecognition.stop(),chatLog("[Voice] Stopping...")}catch(e){console.error("[Voice] Stop error:",e)}}function setVoiceState(e,t="chat-input"){voiceInputState=e,e==="idle"&&void 0;const n=[{btn:document.getElementById("voice-input-btn"),mic:document.getElementById("voice-icon-mic"),stop:document.getElementById("voice-icon-stop")},{btn:document.getElementById("voice-input-btn-chatpage"),mic:document.getElementById("voice-icon-mic-chatpage"),stop:document.getElementById("voice-icon-stop-chatpage")}];for(const{btn:s,mic:o,stop:a}of n)if(s)switch(s.classList.remove("listening","processing"),e){case"listening":s.classList.add("listening"),s.title="Listening... (click to stop)",o&&(o.style.display="none"),a&&(a.style.display="block");break;case"processing":s.classList.add("processing"),s.title="Processing...";break;default:s.title="Voice input (click to speak)",o&&(o.style.display="block"),a&&(a.style.display="none");break}}let activeVoiceTarget="chat-input";function toggleVoiceInputChatPage(){activeVoiceTarget="chat-page-input",toggleVoiceInput()}const originalToggleVoiceInput=toggleVoiceInput;function toggleVoiceInput(){if(activeVoiceTarget!=="chat-page-input"&&voiceInputState!=="listening"&&(activeVoiceTarget="chat-input"),!voiceRecognition){showToast("Voice input not available","error");return}voiceInputState==="listening"?stopVoiceInput():startVoiceInput()}function toggleVoiceAutoSend(){voiceAutoSend=!voiceAutoSend,localStorage.setItem("voice_auto_send",voiceAutoSend),updateVoiceAutoSendUI(),showToast(voiceAutoSend?"Voice auto-send enabled":"Voice auto-send disabled","info")}function updateVoiceAutoSendUI(){document.querySelectorAll(".voice-auto-send-toggle").forEach(t=>{t.classList.toggle("active",voiceAutoSend),t.title=voiceAutoSend?"Auto-send ON (click to disable)":"Auto-send OFF (click to enable)"})}function initPushToTalk(){document.addEventListener("keydown",e=>{e.code==="Space"&&e.altKey&&(e.preventDefault(),voiceInputState==="listening"?(chatLog("[Voice] Alt+Space toggle: stopping"),stopVoiceInput()):(activeVoiceTarget=document.getElementById("page-chat")?.classList.contains("active")?"chat-page-input":"chat-input",chatLog("[Voice] Alt+Space toggle: starting, target:",activeVoiceTarget),startVoiceInput()))}),chatLog("[Voice] Alt+Space toggle initialized (press to start/stop recording)")}function isTypingInInput(e){if(!e)return!1;const t=e.tagName.toLowerCase(),n=e.isContentEditable;return t==="input"||t==="textarea"||t==="select"||n}let pendingImages=[];function handleImageSelect(e){const t=e.target.files;for(const n of t)n.type.startsWith("image/")&&processImageFile(n)}function handlePaste(e){const t=e.clipboardData?.items;if(t){for(const n of t)if(n.type.startsWith("image/")){e.preventDefault();const s=n.getAsFile();s&&processImageFile(s);return}}}let chatInputSelection={start:0,end:0};function handleChatInputKeydown(e){const t=e.target;if(!(e.key!=="Enter"||!t)){if(e.ctrlKey||e.metaKey){e.preventDefault(),sendChatMessage();return}if(e.shiftKey){e.preventDefault();const n=t.selectionStart,s=t.selectionEnd,o=t.value,a=o.slice(0,n),i=o.slice(s),r=`${a}
${i}`;t.value=r;const l=n+1;t.setSelectionRange(l,l),adjustChatInputHeight(t);return}}}function cacheChatInputSelection(e){e&&(chatInputSelection.start=e.selectionStart,chatInputSelection.end=e.selectionEnd)}function restoreChatInputSelection(e){if(!e)return;const t=e.value.length,n=Math.min(chatInputSelection.start??t,t),s=Math.min(chatInputSelection.end??t,t);e.setSelectionRange(n,s)}function adjustChatInputHeight(e){if(!e)return;e.style.height="auto";const t=Math.min(e.scrollHeight,160);e.style.height=`${Math.max(t,36)}px`}function attachChatInputHandlers(){const e=document.getElementById("chat-input");e&&(e.addEventListener("keydown",handleChatInputKeydown),e.addEventListener("blur",()=>cacheChatInputSelection(e)),e.addEventListener("focus",()=>{restoreChatInputSelection(e),adjustChatInputHeight(e)}),e.addEventListener("input",()=>adjustChatInputHeight(e)),adjustChatInputHeight(e))}async function compressImage(e,t=1200,n=.8){return new Promise(s=>{const o=new Image;o.onload=()=>{const a=document.createElement("canvas");let i=o.width,r=o.height;i>t&&(r=r*t/i,i=t),a.width=i,a.height=r,a.getContext("2d").drawImage(o,0,0,i,r);const d=a.toDataURL("image/jpeg",n);s(d)},o.src=e})}function processImageFile(e){const t=new FileReader;t.onload=async n=>{let s=n.target.result;s.length>200*1024&&(s=await compressImage(s)),pendingImages.push({id:"img-"+Date.now()+"-"+Math.random().toString(36).substr(2,5),data:s,name:e.name,type:"image/jpeg"}),renderImagePreviews()},t.readAsDataURL(e)}function renderImagePreviews(){const e=document.getElementById("image-preview-container");if(e){if(pendingImages.length===0){e.classList.remove("visible"),e.innerHTML="";return}e.classList.add("visible"),e.innerHTML=pendingImages.map((t,n)=>`
        <div class="image-preview-wrapper">
            <img src="${t.data}" alt="Preview ${n+1}" />
            <button onclick="removeImagePreview('${t.id}')" class="image-preview-close">\u2715</button>
        </div>
    `).join("")}}function removeImagePreview(e){if(pendingImages=pendingImages.filter(t=>t.id!==e),renderImagePreviews(),pendingImages.length===0){const t=document.getElementById("image-upload");t&&(t.value="")}}function clearImagePreviews(){pendingImages=[],renderImagePreviews();const e=document.getElementById("image-upload");e&&(e.value="")}async function sendChatMessage(){voiceInputState==="listening"&&(chatLog("[Voice] Stopping recording before send"),stopVoiceInput());const e=document.getElementById("chat-input"),t=e.value.trim();if(!t&&pendingImages.length===0)return;if(!gateway||!gateway.isConnected()){showToast("Not connected to Gateway. Please connect first.","warning");return}const n=[...pendingImages],s=n.length>0;if(s){const o=n.length,a=t||(o>1?`\u{1F4F7} ${o} Images`:"\u{1F4F7} Image"),i=n.map(r=>r.data);addLocalChatMessage(a,"user",i)}else addLocalChatMessage(t,"user");e.value="",accumulatedTranscript="",clearImagePreviews(),adjustChatInputHeight(e),chatInputSelection={start:0,end:0},isProcessing=!0,renderChat(),renderChatPage();try{if(chatLog(`[Chat] Sending message with model: ${currentModel}`),s){const o=n.map(a=>a.data);await gateway.sendMessageWithImages(t||"Image",o)}else await gateway.sendMessage(t)}catch(o){console.error("Failed to send message:",o),addLocalChatMessage(`Failed to send: ${o.message}`,"system")}}function addLocalChatMessage(e,t,n=null,s=null,o=null){const a=(n?._sessionKey||"").toLowerCase(),i=(currentSessionName||GATEWAY_CONFIG?.sessionKey||"").toLowerCase();if(a&&i&&a!==i)return chatLog(`[Chat] BLOCKED addLocalChatMessage: incoming session=${a}, current=${i}`),null;state.chat||(state.chat={messages:[]}),state.system||(state.system={messages:[]});let r=[],l=s;n&&(Array.isArray(n)?r=n.filter(u=>u&&typeof u=="string"&&u.includes("data:")):typeof n=="string"&&(n.includes("data:image")||n.includes("data:application")?r=[n]:(n.includes("/")||n.includes("claude")||n.includes("gpt")||n.includes("MiniMax"))&&(l=n))),chatLog(`[Chat] addLocalChatMessage: text="${e?.slice(0,50)}", from=${t}, images=${r.length}, model=${l}`);const d={id:"m"+Date.now(),from:t,text:e,time:Date.now(),image:r[0]||null,images:r,model:l,provider:o,_sessionKey:window.currentSessionName||GATEWAY_CONFIG?.sessionKey||"",_agentId:window.currentAgentId||"main"};return isSystemMessage(e,t)?(state.system.messages.push(d),state.system.messages.length>GATEWAY_CONFIG.maxMessages&&(state.system.messages=state.system.messages.slice(-GATEWAY_CONFIG.maxMessages)),persistSystemMessages(),renderSystemPage()):(state.chat.messages.push(d),state.chat.messages.length>GATEWAY_CONFIG.maxMessages&&(state.chat.messages=state.chat.messages.slice(-GATEWAY_CONFIG.maxMessages)),t!=="user"&&typeof notifyChatPageNewMessage=="function"&&notifyChatPageNewMessage(),persistChatMessages(),syncChatToVPS(),renderChat(),renderChatPage()),d}function syncChatToVPS(){chatSyncTimeout&&clearTimeout(chatSyncTimeout),chatSyncTimeout=setTimeout(async()=>{try{await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:state.chat.messages.slice(-100)})})}catch{}},2e3)}function renderChat(){const e=document.getElementById("chat-messages");if(!e)return;const t=state.chat?.messages||[],n=gateway?.isConnected(),s=e.scrollHeight-e.scrollTop<=e.clientHeight+5,o=e.scrollHeight-e.scrollTop-e.clientHeight;if(e.innerHTML="",t.length===0&&!streamingText){const r=document.createElement("div");r.style.cssText="color: var(--text-muted); font-size: 13px; text-align: center; padding: var(--space-8) 0;",r.textContent=n?"\u{1F4AC} Connected! Send a message to start chatting.":"\u{1F50C} Connect to Gateway in Settings to start chatting",e.appendChild(r);return}const a=(currentSessionName||GATEWAY_CONFIG?.sessionKey||"").toLowerCase();t.forEach(r=>{const l=(r._sessionKey||"").toLowerCase();if(l&&a&&l!==a){chatLog(`[Chat] RENDER BLOCKED: msg session=${l}, current=${a}`);return}const d=createChatMessageElement(r);d&&e.appendChild(d)});const i=(currentSessionName||"").toLowerCase();if(streamingText&&_streamingSessionKey&&_streamingSessionKey.toLowerCase()===i){const r=createChatMessageElement({id:"streaming",from:"solobot",text:streamingText,time:Date.now(),isStreaming:!0,model:window._lastResponseModel||window.currentModel});r&&e.appendChild(r)}if(isProcessing&&!streamingText){const r=document.createElement("div");r.className="typing-indicator",r.innerHTML=`
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <span style="margin-left: 8px; color: var(--text-muted); font-size: 12px;">Thinking...</span>
        `,e.appendChild(r)}s?e.scrollTop=e.scrollHeight:e.scrollTop=e.scrollHeight-e.clientHeight-o}function createChatMessageElement(e){if(!e||typeof e.text!="string"||!e.text.trim()&&!e.image)return null;const t=e.from==="user",n=e.from==="system",s=document.createElement("div");s.style.marginBottom="var(--space-3)";const o=document.createElement("div");o.style.padding="var(--space-3)",o.style.borderRadius="var(--radius-md)",o.style.maxWidth="85%",o.style.wordWrap="break-word",t?(o.style.backgroundColor="rgba(188, 32, 38, 0.15)",o.style.border="1px solid rgba(188, 32, 38, 0.25)",o.style.marginLeft="auto",o.style.textAlign="right"):n?(o.style.backgroundColor="var(--warning-muted)",o.style.border="1px solid rgba(234, 179, 8, 0.2)"):(o.style.backgroundColor=(e.isStreaming,"var(--surface-2)"),o.style.border="1px solid var(--border-default)",o.style.marginRight="auto",e.isStreaming&&(o.style.opacity="0.8"));const a=document.createElement("div");a.style.display="flex",a.style.alignItems="center",a.style.gap="var(--space-2)",a.style.marginBottom="var(--space-2)",a.style.fontSize="12px",t&&(a.style.justifyContent="flex-end");const i=document.createElement("span");if(i.style.fontWeight="500",t)i.style.color="var(--brand-red)",i.textContent="You";else if(n)i.style.color="var(--warning)",i.textContent="System";else{i.style.color="var(--success)";const c=getAgentDisplayName(e._agentId||currentAgentId);i.textContent=e.isStreaming?`${c} (typing...)`:c}const r=document.createElement("span");if(r.style.cssText="color: var(--text-muted); font-size: 12px;",r.textContent=formatTime(e.time),a.appendChild(r),a.appendChild(i),!t&&!n){const{model:c,provider:u}=getBestModel(e);if(c){const m=document.createElement("span");m.style.cssText="color: var(--text-muted); font-size: 12px; margin-left: 4px;";const g=formatModelDisplay(c,u);m.textContent=e.isStreaming?`\xB7 **${g}**`:`\xB7 ${g}`,m.title=c,a.appendChild(m)}}const l=document.createElement("div");l.style.fontSize="14px",l.style.color="var(--text-primary)",l.style.lineHeight="1.5",l.style.whiteSpace="pre-wrap",l.innerHTML=linkifyText(e.text);const d=e.images||(e.image?[e.image]:[]);if(d.length>0){const c=document.createElement("div");c.style.display="flex",c.style.flexWrap="wrap",c.style.gap="8px",c.style.marginBottom="var(--space-2)",d.forEach((u,m)=>{const g=document.createElement("img");g.src=u,g.style.maxWidth=d.length>1?"100px":"150px",g.style.maxHeight=d.length>1?"80px":"100px",g.style.borderRadius="var(--radius-md)",g.style.cursor="pointer",g.style.objectFit="cover",g.style.border="1px solid var(--border-default)",g.title=`Image ${m+1} of ${d.length} - Click to view`,g.onclick=()=>openImageModal(u),c.appendChild(g)}),o.appendChild(c)}return o.appendChild(a),o.appendChild(l),s.appendChild(o),s}function openImageModal(e){const t=document.createElement("div");t.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:1000;cursor:pointer;padding:40px;",t.onclick=()=>t.remove();const n=document.createElement("div");n.textContent="\u2715",n.style.cssText="position:absolute;top:20px;right:30px;color:white;font-size:28px;cursor:pointer;opacity:0.7;transition:opacity 0.2s;",n.onmouseenter=()=>n.style.opacity="1",n.onmouseleave=()=>n.style.opacity="0.7",t.appendChild(n);const s=document.createElement("div");s.style.cssText="max-width:85vw;max-height:85vh;box-shadow:0 25px 50px rgba(0,0,0,0.5);border-radius:8px;overflow:hidden;";const o=document.createElement("img");o.src=e,o.style.cssText="display:block;max-width:85vw;max-height:85vh;object-fit:contain;",o.onclick=i=>i.stopPropagation(),s.appendChild(o),t.appendChild(s);const a=document.createElement("div");a.textContent="Click anywhere to close",a.style.cssText="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);color:rgba(255,255,255,0.5);font-size:12px;",t.appendChild(a),document.body.appendChild(t)}let chatPagePendingImages=[],chatPageScrollPosition=null,chatPageUserScrolled=!1,chatPageNewMessageCount=0,chatPageLastRenderKey=null,suppressChatRenderUntil=0;document.addEventListener("contextmenu",e=>{const t=document.getElementById("chat-page-messages");t&&t.contains(e.target)&&(suppressChatRenderUntil=Date.now()+1500)});function saveChatScrollPosition(){const e=document.getElementById("chat-page-messages");e&&e.scrollTop>0&&(sessionStorage.setItem("chatScrollPosition",e.scrollTop),sessionStorage.setItem("chatScrollHeight",e.scrollHeight))}function restoreChatScrollPosition(){const e=document.getElementById("chat-page-messages");if(!e)return;const t=sessionStorage.getItem("chatScrollPosition"),n=sessionStorage.getItem("chatScrollHeight");if(t&&n){const s=parseFloat(t)/parseFloat(n);e.scrollTop=s*e.scrollHeight}}window.saveChatScrollPosition=saveChatScrollPosition,window.restoreChatScrollPosition=restoreChatScrollPosition;function isAtBottom(e){return e?e.scrollHeight-e.scrollTop-e.clientHeight<5:!0}function isNearBottom(e){return e?e.scrollHeight-e.scrollTop-e.clientHeight<100:!0}function scrollChatToBottom(){const e=document.getElementById("chat-page-messages");e&&(e.scrollTop=e.scrollHeight,chatPageUserScrolled=!1,chatPageNewMessageCount=0,updateNewMessageIndicator())}function updateNewMessageIndicator(){const e=document.getElementById("chat-page-new-indicator");if(!e)return;const t=document.getElementById("chat-page-messages"),n=t&&!isAtBottom(t);n&&chatPageNewMessageCount>0?(e.textContent=`\u2193 ${chatPageNewMessageCount} new message${chatPageNewMessageCount>1?"s":""}`,e.classList.remove("hidden")):(e.classList.add("hidden"),n||(chatPageNewMessageCount=0))}function setupChatPageScrollListener(){const e=document.getElementById("chat-page-messages");!e||e.dataset.scrollListenerAttached||(e.addEventListener("scroll",()=>{updateNewMessageIndicator(),updateScrollToBottomButton(),saveChatScrollPosition()}),e.dataset.scrollListenerAttached="true")}function updateScrollToBottomButton(){const e=document.getElementById("chat-page-messages"),t=document.getElementById("scroll-to-bottom-btn");if(!e||!t)return;e.scrollHeight-e.scrollTop-e.clientHeight>200?t.classList.remove("hidden"):t.classList.add("hidden")}function forceRefreshHistory(){_doHistoryRefresh()}function renderChatPage(){const e=document.getElementById("chat-page-messages");if(!e)return;setupChatPageScrollListener();const t=document.getElementById("chat-page-status-dot"),n=document.getElementById("chat-page-status-text"),s=gateway?.isConnected();t&&(t.className=`status-dot ${s?"success":"idle"}`),n&&(n.textContent=s?"Connected":"Disconnected");const o=state.chat?.messages||[],a=window.getSelection();if(a&&a.toString().trim().length>0&&(a.anchorNode&&e.contains(a.anchorNode)||a.focusNode&&e.contains(a.focusNode))||Date.now()<suppressChatRenderUntil)return;const l=o[o.length-1],d=[o.length,l?.id||"",l?.time||"",streamingText||"",isProcessing?1:0].join("|");if(d===chatPageLastRenderKey)return;chatPageLastRenderKey=d;const c=isAtBottom(e),u=e.scrollHeight-e.scrollTop-e.clientHeight;if(o.length===0&&!streamingText){const h=getAgentDisplayName(currentAgentId);e.innerHTML=`
            <div class="chat-page-empty">
                <div class="chat-page-empty-icon">\u{1F4AC}</div>
                <div class="chat-page-empty-text">
                    ${s?`Start a conversation with ${h}`:'Connect to Gateway in <a href="#" onclick="openSettingsModal(); return false;">Settings</a> to start chatting'}
                </div>
            </div>
        `,e._renderedCount=0;return}e.querySelector(".chat-page-empty")&&(e.innerHTML="",e._renderedCount=0),((e._renderedCount||0)>o.length||e._sessionKey!==(currentSessionName||GATEWAY_CONFIG?.sessionKey))&&(e.innerHTML="",e._renderedCount=0,e._sessionKey=currentSessionName||GATEWAY_CONFIG?.sessionKey);const y=e._renderedCount||0;e.querySelectorAll(".streaming, .typing-indicator").forEach(h=>h.remove());const v=(currentSessionName||GATEWAY_CONFIG?.sessionKey||"").toLowerCase();if(o.length>y){const h=document.createDocumentFragment();for(let x=y;x<o.length;x++){const S=o[x],b=(S._sessionKey||"").toLowerCase();if(b&&v&&b!==v){chatLog(`[Chat] RENDER BLOCKED: msg session=${b}, current=${v}`);continue}const k=createChatPageMessage(S);k&&h.appendChild(k)}e.appendChild(h),e._renderedCount=o.length}const w=(currentSessionName||"").toLowerCase();if(streamingText&&_streamingSessionKey&&_streamingSessionKey.toLowerCase()===w){const h=createChatPageMessage({id:"streaming",from:"solobot",text:streamingText,time:Date.now(),isStreaming:!0,model:window._lastResponseModel||window.currentModel});h&&e.appendChild(h)}if(isProcessing&&!streamingText){const h=document.createElement("div");h.className="typing-indicator",h.style.cssText="margin: 12px 0 12px 12px;",h.innerHTML=`
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <span style="margin-left: 8px; color: var(--text-muted); font-size: 12px;">Thinking...</span>
        `,e.appendChild(h)}c?e.scrollTop=e.scrollHeight:e.scrollTop=e.scrollHeight-e.clientHeight-u}function createChatPageMessage(e){if(!e||typeof e.text!="string"||!e.text.trim()&&!e.image)return null;const t=e.from==="user",n=e.from==="system",s=!t&&!n,o=document.createElement("div");if(o.className=`chat-page-message ${e.from}${e.isStreaming?" streaming":""}`,o.setAttribute("data-msg-id",e.id||""),!n){const u=document.createElement("div");if(u.className="chat-page-avatar",t)u.classList.add("user-avatar"),u.textContent="U";else{const m=currentAgentId||"main";u.setAttribute("data-agent",m);const g=["main","dev","exec","coo","cfo","cmp","family","smm"].includes(m)?`/avatars/${m==="main"?"solobot":m}.png`:m==="tax"||m==="sec"?`/avatars/${m}.svg`:"/avatars/solobot.png",f=document.createElement("img");f.src=g,f.alt=getAgentDisplayName(m),f.onerror=()=>{f.style.display="none",u.textContent="\u{1F916}"},u.appendChild(f)}o.appendChild(u)}const a=document.createElement("div");a.className="chat-page-bubble";const i=e.images||(e.image?[e.image]:[]);if(i.length>0){const u=document.createElement("div");u.style.display="flex",u.style.flexWrap="wrap",u.style.gap="8px",u.style.marginBottom="8px",i.forEach((m,g)=>{const f=document.createElement("img");f.src=m,f.className="chat-page-bubble-image",f.style.maxWidth=i.length>1?"100px":"200px",f.style.maxHeight=i.length>1?"100px":"150px",f.style.objectFit="cover",f.style.cursor="pointer",f.title=`Image ${g+1} of ${i.length} - Click to view`,f.onclick=()=>openImageModal(m),u.appendChild(f)}),a.appendChild(u)}const r=document.createElement("div");r.className="chat-page-bubble-header";const l=document.createElement("span");if(l.className="chat-page-sender",t)l.textContent="You";else if(n)l.textContent="System";else{const u=getAgentDisplayName(e._agentId||currentAgentId);l.textContent=e.isStreaming?`${u} is typing...`:u}const d=document.createElement("span");if(d.className="chat-page-bubble-time",d.textContent=formatSmartTime(e.time),d.title=formatTime(e.time),r.appendChild(l),r.appendChild(d),s){const{model:u,provider:m}=getBestModel(e);if(u){const g=document.createElement("span");g.className="chat-page-bubble-time",g.style.marginLeft="4px";const f=formatModelDisplay(u,m);g.textContent=e.isStreaming?`\xB7 **${f}**`:`\xB7 ${f}`,g.title=u,r.appendChild(g)}}a.appendChild(r);const c=document.createElement("div");if(c.className="chat-page-bubble-content",c.innerHTML=linkifyText(e.text),a.appendChild(c),!e.isStreaming){const u=document.createElement("div");u.className="chat-page-bubble-actions";const m=document.createElement("button");m.className="chat-action-btn",m.innerHTML="\u{1F4CB}",m.title="Copy message",m.onclick=g=>{g.stopPropagation(),copyToClipboard(e.text),m.innerHTML="\u2713",m.classList.add("copied"),setTimeout(()=>{m.innerHTML="\u{1F4CB}",m.classList.remove("copied")},1500)},u.appendChild(m),a.appendChild(u)}return o.appendChild(a),o}function copyToClipboard(e){navigator.clipboard.writeText(e).then(()=>{showToast("Copied to clipboard!","success",2e3)}).catch(()=>{const t=document.createElement("textarea");t.value=e,t.style.cssText="position:fixed;opacity:0;",document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),showToast("Copied to clipboard!","success",2e3)})}function notifyChatPageNewMessage(){const e=document.getElementById("chat-page-messages");e&&!isAtBottom(e)&&(chatPageNewMessageCount++,updateNewMessageIndicator())}function handleChatPageImageSelect(e){const t=e.target.files;for(const n of t)n.type.startsWith("image/")&&processChatPageImageFile(n)}function handleChatPagePaste(e){const t=e.clipboardData?.items;if(t){for(const n of t)if(n.type.startsWith("image/")){e.preventDefault();const s=n.getAsFile();s&&processChatPageImageFile(s);return}}}function processChatPageImageFile(e){const t=new FileReader;t.onload=async n=>{let s=n.target.result;s.length>200*1024&&(s=await compressImage(s)),chatPagePendingImages.push({id:"img-"+Date.now()+"-"+Math.random().toString(36).substr(2,5),data:s,name:e.name,type:"image/jpeg"}),renderChatPageImagePreviews()},t.readAsDataURL(e)}function renderChatPageImagePreviews(){const e=document.getElementById("chat-page-image-preview");if(e){if(chatPagePendingImages.length===0){e.classList.add("hidden"),e.classList.remove("visible"),e.innerHTML="";return}e.classList.remove("hidden"),e.classList.add("visible"),e.innerHTML=chatPagePendingImages.map((t,n)=>`
        <div class="image-preview-wrapper">
            <img src="${t.data}" alt="Preview ${n+1}" />
            <button onclick="removeChatPageImagePreview('${t.id}')" class="image-preview-close">\u2715</button>
        </div>
    `).join("")}}function removeChatPageImagePreview(e){if(chatPagePendingImages=chatPagePendingImages.filter(t=>t.id!==e),renderChatPageImagePreviews(),chatPagePendingImages.length===0){const t=document.getElementById("chat-page-image-upload");t&&(t.value="")}}function clearChatPageImagePreviews(){chatPagePendingImages=[],renderChatPageImagePreviews();const e=document.getElementById("chat-page-image-upload");e&&(e.value="")}function resizeChatPageInput(){const e=document.getElementById("chat-page-input");if(!e)return;e.style.height="auto";const t=150;e.style.height=Math.min(e.scrollHeight,t)+"px"}function setupChatPageInput(){const e=document.getElementById("chat-page-input");e&&(e.addEventListener("input",resizeChatPageInput),e.addEventListener("keydown",t=>{t.key==="Enter"&&(t.isComposing||t.keyCode===229||t.shiftKey||!gateway||!gateway.isConnected()||(t.preventDefault(),sendChatPageMessage()))}),resizeChatPageInput())}function setActiveSidebarAgent(e){if(document.querySelectorAll(".sidebar-agent[data-agent]").forEach(n=>{e&&n.getAttribute("data-agent")===e?n.classList.add("active"):n.classList.remove("active")}),e){const n=e!==currentAgentId;currentAgentId=e;const s=document.getElementById("chat-page-agent-name");s&&(s.textContent=getAgentLabel(e)),n&&(populateSessionDropdown(),typeof loadAgentModel=="function"&&loadAgentModel(e))}}function forceSyncActiveAgent(e){document.querySelectorAll(".sidebar-agent[data-agent]").forEach(s=>{const o=s.getAttribute("data-agent");e&&o===e?s.classList.add("active"):s.classList.remove("active")}),window.currentAgentId=e;const n=document.getElementById("chat-page-agent-name");n&&(n.textContent=getAgentLabel(e))}function getLastAgentSession(e){try{return JSON.parse(localStorage.getItem("agent_last_sessions")||"{}")[e]||null}catch{return null}}function saveLastAgentSession(e,t){try{const n=JSON.parse(localStorage.getItem("agent_last_sessions")||"{}");n[e]=t,localStorage.setItem("agent_last_sessions",JSON.stringify(n))}catch{}}function setupSidebarAgents(){const e=document.querySelectorAll(".sidebar-agent[data-agent]");if(!e.length)return;const t=o=>{const a=o.getAttribute("data-agent");if(!a)return;forceSyncActiveAgent(a),currentAgentId=a;const i=getLastAgentSession(a)||`agent:${a}:main`;showPage("chat"),switchToSession(i).catch(()=>{})};e.forEach(o=>{const a=o.querySelector(".sidebar-item-text");a&&!a.title&&(a.title=(a.textContent||"").trim()),!o._agentClickBound&&(o._agentClickBound=!0,o.addEventListener("mousedown",i=>{if(i.button!==0)return;const r=window.getSelection();if(r&&!r.isCollapsed)try{r.removeAllRanges()}catch{}i.preventDefault(),i.stopPropagation(),o._handledByMousedown=!0,t(o)}),o.addEventListener("click",i=>{if(o._handledByMousedown){o._handledByMousedown=!1;return}t(o)}))});const s=(GATEWAY_CONFIG?.sessionKey||"main").match(/^agent:([^:]+):/);if(s){const o=window.resolveAgentId?window.resolveAgentId(s[1]):s[1];currentAgentId=o,setActiveSidebarAgent(o)}}async function sendChatPageMessage(){voiceInputState==="listening"&&(chatLog("[Voice] Stopping recording before send"),stopVoiceInput());const e=document.getElementById("chat-page-input"),t=e.value.trim();if(!t&&chatPagePendingImages.length===0)return;if(!gateway||!gateway.isConnected()){showToast("Not connected to Gateway. Please connect first in Settings.","warning");return}const n=[...chatPagePendingImages],s=n.length>0;if(s){const o=n.length,a=t||(o>1?`\u{1F4F7} ${o} Images`:"\u{1F4F7} Image"),i=n.map(r=>r.data);addLocalChatMessage(a,"user",i)}else addLocalChatMessage(t,"user");e.value="",accumulatedTranscript="",resizeChatPageInput(),e.focus(),clearChatPageImagePreviews(),chatPageUserScrolled=!1,isProcessing=!0,renderChat(),renderChatPage();try{if(chatLog(`[Chat] Sending message with model: ${currentModel}`),s){const o=n.map(a=>a.data);await gateway.sendMessageWithImages(t||"Image",o)}else await gateway.sendMessage(t)}catch(o){console.error("Failed to send:",o),addLocalChatMessage(`Failed: ${o.message}`,"system"),renderChat(),renderChatPage()}}let chatSearchQuery="",chatSearchResults=[],chatSearchCurrentIndex=-1;function initChatSearch(){const e=document.getElementById("chat-search");e&&(e.addEventListener("input",t=>{chatSearchQuery=t.target.value.trim().toLowerCase(),performChatSearch()}),e.addEventListener("keydown",t=>{t.key==="Enter"?(t.preventDefault(),chatSearchResults.length>0&&(t.shiftKey?chatSearchCurrentIndex=(chatSearchCurrentIndex-1+chatSearchResults.length)%chatSearchResults.length:chatSearchCurrentIndex=(chatSearchCurrentIndex+1)%chatSearchResults.length,scrollToChatSearchResult(chatSearchResults[chatSearchCurrentIndex]))):t.key==="Escape"&&e.blur()}))}function performChatSearch(){if(!chatSearchQuery){clearChatSearchHighlights(),chatSearchResults=[],chatSearchCurrentIndex=-1;return}chatSearchResults=(state.chat?.messages||[]).filter(t=>(t.text?.toLowerCase()||"").includes(chatSearchQuery)),chatSearchResults.length>0?(chatSearchCurrentIndex=0,scrollToChatSearchResult(chatSearchResults[0]),showToast(`Found ${chatSearchResults.length} match${chatSearchResults.length!==1?"es":""}`,"info",2e3)):showToast("No matches found","warning",2e3)}function scrollToChatSearchResult(e){const t=document.getElementById("chat-page-messages");if(!t||!e)return;const n=t.querySelector(`[data-msg-id="${e.id}"]`);n&&(n.scrollIntoView({behavior:"smooth",block:"center"}),highlightChatSearchResult(n))}function highlightChatSearchResult(e){clearChatSearchHighlights(),e.classList.add("chat-search-highlight"),setTimeout(()=>{e.classList.remove("chat-search-highlight")},3e3)}function clearChatSearchHighlights(){const e=document.getElementById("chat-page-messages");e&&e.querySelectorAll(".chat-search-highlight").forEach(t=>{t.classList.remove("chat-search-highlight")})}document.addEventListener("DOMContentLoaded",()=>{setTimeout(initChatSearch,100)});
